"use strict";(self.webpackChunk=self.webpackChunk||[]).push([[6291],{14571:(Gs,He,b)=>{b.d(He,{o:()=>Ee});var v=b(52322),T=b(2784);class Ee extends T.Component{state={hadError:!1};componentDidCatch(be){this.setState({hadError:!0}),this.props.onError(be)}render(){return this.state.hadError?(0,v.jsx)(v.Fragment,{}):this.props.children}}},89820:(Gs,He,b)=>{b.d(He,{CW:()=>R,KV:()=>xe,ZP:()=>w});var v=b(52322),T=b(2043),Ee=b(7808),qe=b(12540),be=b(32199),ye=b(72283),et=b(87037),Ae=b(52296),at=b(41574),ot=b(8740),ve=b(93812),Ye=b(2784);const Z=240,Ze=(0,ot.ZL)()(K=>({root:{pointerEvents:"auto",backgroundColor:K.palette.background.default,width:280},content:{position:"relative"},iconButton:{fontSize:"1rem !important",[`& svg:not(.${Ee.Z.root})`]:{fontSize:"1rem !important"}},tabs:{minHeight:"auto",[`.${qe.Z.indicator}`]:{transform:"scaleX(0.75)",height:2},[`.${be.Z.root}`]:{minHeight:"auto",minWidth:"auto",padding:K.spacing(1,1.5,1.125),color:K.palette.text.secondary,"&.Mui-selected":{color:K.palette.text.primary}}}}));function xe({children:K}){return K}function R({children:K}){return(0,v.jsx)(ve.Z,{padding:1,overflowX:"hidden",overflowY:"auto",style:{maxHeight:Z},children:K})}function w({children:K,checked:wt,icon:c,onSelectTab:le,selectedTab:F,tooltip:B,dataTest:x}){const{classes:X}=Ze();if(!(F!=null)){let ce=F;return Ye.Children.forEach(K,Ke=>{ce==null&&(ce=Ke.props.name)}),(0,v.jsx)(ye.Z,{square:!1,elevation:4,style:{pointerEvents:"auto"},children:(0,v.jsx)(et.Z,{className:X.iconButton,color:wt===!0?"info":"default",title:B,"data-testid":`ExpandingToolbar-${B}`,onClick:()=>le(ce),children:c})})}let ke;Ye.Children.forEach(K,ce=>{(!ke||ce.props.name===F)&&(ke=ce)});const E=(ce,Ke)=>{Ke!=null&&le(Ke)};return(0,v.jsxs)(ye.Z,{className:X.root,"data-testid":x,square:!1,elevation:4,children:[(0,v.jsx)(ye.Z,{children:(0,v.jsxs)(ve.Z,{direction:"row",justifyContent:"space-between",alignItems:"center",children:[(0,v.jsx)(Ae.Z,{className:X.tabs,textColor:"inherit",value:F,onChange:E,children:Ye.Children.map(K,ce=>(0,v.jsx)(at.Z,{label:ce.props.name,value:ce.props.name}))}),(0,v.jsx)(et.Z,{className:X.iconButton,onClick:()=>le(void 0),children:(0,v.jsx)(T.iRs,{})})]})}),(0,v.jsx)("div",{className:X.content,children:ke})]})}},78324:(Gs,He,b)=>{b.d(He,{i:()=>et});var v=b(52322),T=b(3925),Ee=b(56961),qe=b(80078),be=b(2784),ye=b(84877);function et(Ae){const{getItems:at}=Ae,ot=(0,be.useRef)(null),[ve,Ye]=(0,be.useState)(),Z=(0,be.useCallback)(()=>Ye(void 0),[]),[Ze,xe]=(0,be.useState)([]);return(0,be.useEffect)(()=>{const R=ot.current?.closest(`.${ye.DY}`);if(!R)return;let w="none";const K=F=>{F.button===2&&w==="down"&&(Ye({x:F.clientX,y:F.clientY}),xe(at()),w="none")},wt=F=>{w="canceled"},c=F=>{F.button===2&&(w="down")},le=F=>{F.preventDefault()};return R.addEventListener("mousedown",c),R.addEventListener("mousemove",wt),R.addEventListener("mouseup",K),R.addEventListener("contextmenu",le),()=>{R.removeEventListener("mousedown",c),R.removeEventListener("mousemove",wt),R.removeEventListener("mouseup",K),R.removeEventListener("contextmenu",le)}},[at]),(0,v.jsx)("div",{ref:ot,onContextMenu:R=>R.preventDefault(),children:(0,v.jsx)(T.Z,{open:ve!=null,onClose:Z,anchorReference:"anchorPosition",anchorPosition:ve?{top:ve.y,left:ve.x}:void 0,MenuListProps:{dense:!0},children:Ze.map((R,w)=>R.type==="divider"?(0,v.jsx)(Ee.Z,{variant:"middle"},`divider_${w}`):(0,v.jsx)(qe.Z,{onClick:()=>{Z(),R.onclick()},disabled:R.disabled,children:R.label},`item_${w}_${R.label}`))})})}},76291:(Gs,He,b)=>{b.r(He),b.d(He,{ImagePanel:()=>J0,ThreeDeePanel:()=>X0});var v=b(52322),T=b(2784),Ee=b(28316),qe=b(7506),be=b(14571),ye=b(42893),et=b(12294),Ae=b(80204);function at(){const s=(0,T.useContext)(Ae.Z),[e]=(0,T.useState)(()=>(0,ye.M)(()=>({value:s})));return(0,T.useLayoutEffect)(()=>{e.setState({value:s})},[e,s]),e}function ot({forwardedAnalytics:s,children:e}){(0,qe.Iq)(s);const[t]=(0,T.useState)(()=>(0,ye.M)(()=>({value:s.getState().value})));(0,T.useEffect)(()=>s.subscribe(()=>t.setState({value:s.getState().value})),[s,t]);const{value:i}=(0,et.oR)(t);return(0,v.jsx)(Ae.Z.Provider,{value:i,children:e})}var ve=b(14075),Ye=b(77357),Z=b(76635),Ze=b(16003),xe=b(94225),R=b(23503),w=b(44668),K=b(93455),wt=b(88724),c=b(96995);const le="selected_id";class F extends c.Tme{isRenderable=!0;pickable=!0;pickableInstances=!1;renderer;userData;constructor(e,t,i){super(),this.name=e,this.renderer=t,this.userData=i}dispose(){this.children.length=0}idFromMessage(){}selectedIdVariable(){}details(){return{}}get topic(){return this.userData.topic}get pose(){return this.userData.pose}instanceDetails(e){}}var B=b(30686),x=b(24991),X=b(67067),V=b(97984),ke=b(91004),E=b(55708);const ce=new Set;_e(ce,"foxglove.FrameTransform");const Ke=new Set;_e(Ke,"foxglove.FrameTransforms");const Ot=new Set;_e(Ot,"foxglove.PointCloud");const rs=new Set;_e(rs,"foxglove.LaserScan");const It=new Set;_e(It,"foxglove.RawImage");const as=new Set;_e(as,"foxglove.CompressedImage");const Ft=new Set;_e(Ft,"foxglove.CameraCalibration");const Gi=new Set;_e(Gi,"foxglove.SceneUpdate");const Bi=new Set;_e(Bi,"foxglove.PoseInFrame");const Vi=new Set;_e(Vi,"foxglove.PosesInFrame");const $i=new Set;_e($i,"foxglove.Grid");const jr=new Set;_e(jr,"foxglove.ImageAnnotations");function _e(s,e){s.add(e);const t=e.split(".");if(t.length<2)throw new Error(`Invalid Foxglove schema: ${e}`);const i=t.slice(1).join("/");return s.add(`foxglove_msgs/${i}`),s.add(`foxglove_msgs/msg/${i}`),s}var Gr=b(1547);const bc=new c.Pa4(1,0,0),yc=new c.Pa4(0,1,0),Wi=new c.Pa4,Hi=new c.Pa4,Ut=new c.Pa4;function vc(s,e){const t=new c._fP(0,0,0,1);Wi.copy(s).normalize(),Hi.copy(e).normalize();const i=Wi.dot(Hi);if(i>=1)return t;if(i<1e-6-1){let n=Ut.copy(bc).cross(s);Sc(n)&&(n=Ut.copy(yc).cross(s)),n.normalize(),t.setFromAxisAngle(n,Math.PI)}else{const n=Math.sqrt((1+i)*2),r=1/n;Ut.copy(Wi).cross(Hi),t.x=Ut.x*r,t.y=Ut.y*r,t.z=Ut.z*r,t.w=n*.5,t.normalize()}return t}function Sc(s){return s.lengthSq()<1e-6*1e-6}function Yi(s,e,t=1e-5){return Math.abs(s-e)<t}function Zi(s,e){for(let t=0;t<s.length;t++)if(s[t]!==e[t])return!1;return!0}function Br(s,e,t=1e-5){return Yi(s[0],e[0],t)&&Yi(s[1],e[1],t)&&Yi(s[2],e[2],t)}function os(s,e,t){return Math.max(e,Math.min(t,s))}function Bs(s,e,t){return s+(e-s)*t}const Ki=new c.Ilk(0).convertSRGBToLinear(),Xi=new c.Ilk(16777215).convertSRGBToLinear();function U(s){return s<.04045?s*.0773993808:Math.pow(s*.9478672986+.0521327014,2.4)}function N(s,e){const t=(0,Gr.Z)(e);if(!t.isValid())return s.r=s.g=s.b=s.a=1,s;const i=t.toRgb();return s.r=i.r/255,s.g=i.g/255,s.b=i.b/255,s.a=i.a,s}function ie(){return{r:0,g:0,b:0,a:0}}function Ji(s,e){const t=(0,Gr.Z)(e);if(!t.isValid())return s.r=s.g=s.b=1,s;const i=t.toRgb();return s.r=i.r/255,s.g=i.g/255,s.b=i.b/255,s}function fe(s,e){return s.setRGB(e.r,e.g,e.b).convertSRGBToLinear()}function Q0(s){return("00000000"+(THREE.MathUtils.clamp(s.r*255,0,255)<<24^THREE.MathUtils.clamp(s.g*255,0,255)<<16^THREE.MathUtils.clamp(s.b*255,0,255)<<8^THREE.MathUtils.clamp(s.a*255,0,255)<<0).toString(16)).slice(-8)}function ne(s){const e=Math.trunc(s.r*255),t=Math.trunc(s.g*255),i=Math.trunc(s.b*255);return`rgba(${e}, ${t}, ${i}, ${s.a})`}function zt(s,e){return s.r=U(e.r),s.g=U(e.g),s.b=U(e.b),s.a=e.a,s}function Vs(s,e,t){return Math.hypot(.5468*s,.7662*e,.3376*t)}function Qi(s,e,t,i){const n=e.r*e.a,r=e.g*e.a,a=e.b*e.a,o=t.r*t.a,l=t.g*t.a,d=t.b*t.a;return s.r=Bs(n,o,i),s.g=Bs(r,l,i),s.b=Bs(a,d,i),s.a=Bs(e.a,t.a,i),s}const Vr={r:0,g:0,b:0,a:0},Tc={r:0,g:0,b:0,a:0},$r=["gradient","colormap"];function qi(s,e,t){switch(s.colorMode){case"flat":{const i=N(Vr,s.flatColor);return zt(i,i),(n,r)=>{n.r=i.r,n.g=i.g,n.b=i.b,n.a=i.a}}case"gradient":{const i=Math.max(t-e,Number.EPSILON),n=N(Vr,s.gradient[0]),r=N(Tc,s.gradient[1]);return zt(n,n),zt(r,r),(a,o)=>{const l=Math.max(0,Math.min((o-e)/i,1));Qi(a,n,r,l)}}case"colormap":{const i=Math.max(t-e,Number.EPSILON);switch(s.colorMap){case"turbo":return(n,r)=>{const a=Math.max(0,Math.min((r-e)/i,1));_c(n,a),n.a=s.explicitAlpha};case"rainbow":return(n,r)=>{const a=Math.max(0,Math.min((r-e)/i,1));xc(n,a),n.a=s.explicitAlpha}}throw new Error(`Unrecognized color map: ${s.colorMap}`)}case"rgb":return(i,n)=>{Wr(i,n),i.a=s.explicitAlpha};case"rgba":return Wr}}function Wr(s,e){const t=e>>>0;s.a=((t&4278190080)>>>24)/255,s.r=((t&16711680)>>>16)/255,s.g=((t&65280)>>>8)/255,s.b=((t&255)>>>0)/255}function xc(s,e){const t=(1-os(e,0,1))*5+1,i=Math.floor(t);let n=t%1;i%2<1&&(n=1-n);const r=U(1-n);i<=1?(s.r=r,s.g=0,s.b=1):i===2?(s.r=0,s.g=r,s.b=1):i===3?(s.r=0,s.g=1,s.b=r):i===4?(s.r=r,s.g=1,s.b=0):(s.r=1,s.g=r,s.b=0),s.a=1}const wc=new c.Ltg(.13572138,4.6153926,-42.66032258,132.13108234),Ic=new c.Ltg(.09140261,2.19418839,4.84296658,-14.18503333),Dc=new c.Ltg(.1066733,12.64194608,-60.58204836,110.36276771),Cc=new c.FM8(-152.94239396,59.28637943),Mc=new c.FM8(4.27729857,2.82956604),Ec=new c.FM8(-89.90310912,27.34824973),Dt=new c.Ltg,ls=new c.FM8;function Ac(s,e){const t=os(e,0,1)*.99+.01;Dt.set(1,t,t*t,t*t*t),ls.set(Dt.z,Dt.w),ls.multiplyScalar(Dt.z),s.r=U(os(Dt.dot(wc)+ls.dot(Cc),0,1)),s.g=U(os(Dt.dot(Ic)+ls.dot(Mc),0,1)),s.b=U(os(Dt.dot(Dc)+ls.dot(Ec),0,1)),s.a=1}let lt;const $s=65535;function _c(s,e){if(!lt){lt=new Float32Array($s*3);const i={r:0,g:0,b:0,a:0};for(let n=0;n<$s;n++){Ac(i,n/($s-1));const r=n*3;lt[r+0]=i.r,lt[r+1]=i.g,lt[r+2]=i.b}}const t=Math.trunc(e*($s-1))*3;s.r=lt[t+0],s.g=lt[t+1],s.b=lt[t+2],s.a=1}const en=new Set(["rgb","rgba"]),Hr=new Set(["intensity","i"]);function Pc(s,{supportsPackedRgbModes:e}){if(e){for(const t of s)if(en.has(t))return t}for(const t of s)if(Hr.has(t))return t;return s.find(t=>t==="x")||s[0]?s[0]:""}function Yr(s){let e=!1,t=!1,i=!1,n=!1;for(const r of s)switch(r){case"red":e=!0;break;case"green":t=!0;break;case"blue":i=!0;break;case"alpha":n=!0;break}return e&&t&&i&&n}function Zr(s,e,t,i,{supportsPackedRgbModes:n,supportsRgbaFieldsMode:r}){const a=e.colorMode??"flat",o=e.flatColor??"#ffffff",l=e.colorField??Pc(s,{supportsPackedRgbModes:n}),d=s.map(y=>({label:y,value:y})),h=e.gradient,f=e.colorMap??"turbo",p=e.explicitAlpha??1,u=e.minValue,m=e.maxValue,g={};if(g.colorMode={label:"Color mode",input:"select",options:[{label:"Flat",value:"flat"},{label:"Color map",value:"colormap"},{label:"Gradient",value:"gradient"}].concat(n?[{label:"BGR (packed)",value:"rgb"},{label:"BGRA (packed)",value:"rgba"}]:[]).concat(r&&Yr(s)?[{label:"RGBA (separate fields)",value:"rgba-fields"}]:[]),value:a},a==="flat")g.flatColor={label:"Flat color",input:"rgba",value:o};else if(a!=="rgba-fields"){switch(g.colorField={label:"Color by",input:"select",options:d,value:l},a){case"gradient":g.gradient={label:"Gradient",input:"gradient",value:h??i.gradient};break;case"colormap":g.colorMap={label:"Color map",input:"select",options:[{label:"Turbo",value:"turbo"},{label:"Rainbow",value:"rainbow"}],value:f};break;default:break}(a==="colormap"||a==="rgb")&&(g.explicitAlpha={label:"Opacity",input:"number",step:.1,placeholder:"1",precision:3,min:0,max:1,value:p}),$r.includes(a)&&(g.minValue={label:"Value min",input:"number",placeholder:"auto",precision:4,value:u},g.maxValue={label:"Value max",input:"number",placeholder:"auto",precision:4,value:m})}return{fields:g,order:t.name.toLocaleLowerCase(),visible:e.visible??i.visible}}const tn={r:0,g:0,b:0,a:0};function Ws(s){switch(s.colorMode){case"flat":return N(tn,s.flatColor).a<1;case"gradient":return N(tn,s.gradient[0]).a<1||N(tn,s.gradient[1]).a<1;case"colormap":case"rgb":return s.explicitAlpha<1;case"rgba":case"rgba-fields":return!0}}const Kr=`
vec3 sRGBToLinear(in vec3 value) {
	return vec3(mix(
    pow(value.rgb * 0.9478672986 + vec3(0.0521327014), vec3(2.4)),
    value.rgb * 0.0773993808,
    vec3(lessThanEqual(value.rgb, vec3(0.04045)))
  ));
}

vec4 sRGBToLinear(in vec4 value) {
  return vec4(sRGBToLinear(value.rgb), value.a);
}
`;var _;(function(s){s[s.ARROW=0]="ARROW",s[s.CUBE=1]="CUBE",s[s.SPHERE=2]="SPHERE",s[s.CYLINDER=3]="CYLINDER",s[s.LINE_STRIP=4]="LINE_STRIP",s[s.LINE_LIST=5]="LINE_LIST",s[s.CUBE_LIST=6]="CUBE_LIST",s[s.SPHERE_LIST=7]="SPHERE_LIST",s[s.POINTS=8]="POINTS",s[s.TEXT_VIEW_FACING=9]="TEXT_VIEW_FACING",s[s.MESH_RESOURCE=10]="MESH_RESOURCE",s[s.TRIANGLE_LIST=11]="TRIANGLE_LIST"})(_||(_={}));var re;(function(s){s[s.ADD=0]="ADD",s[s.MODIFY=0]="MODIFY",s[s.DELETE=2]="DELETE",s[s.DELETEALL=3]="DELETEALL"})(re||(re={}));var G;(function(s){s[s.UNKNOWN=0]="UNKNOWN",s[s.INT8=1]="INT8",s[s.UINT8=2]="UINT8",s[s.INT16=3]="INT16",s[s.UINT16=4]="UINT16",s[s.INT32=5]="INT32",s[s.UINT32=6]="UINT32",s[s.FLOAT32=7]="FLOAT32",s[s.FLOAT64=8]="FLOAT64"})(G||(G={}));const ct={sec:0,nsec:0},Xr=new Set;J(Xr,"geometry_msgs/TransformStamped");const sn=new Set;J(sn,"tf/tfMessage"),J(sn,"tf2_msgs/TFMessage");const nn=new Set;J(nn,"visualization_msgs/Marker");const Hs=new Set;J(Hs,"visualization_msgs/MarkerArray"),J(Hs,"studio_msgs/MarkerArray");const rn=new Set;J(rn,"nav_msgs/OccupancyGrid");const Ys=new Set;J(Ys,"sensor_msgs/PointCloud2");const an=new Set;J(an,"sensor_msgs/LaserScan");const on=new Set;J(on,"velodyne_msgs/VelodyneScan");const ln=new Set;J(ln,"geometry_msgs/PoseStamped");const cn=new Set;J(cn,"geometry_msgs/PoseWithCovarianceStamped");const dn=new Set;J(dn,"geometry_msgs/PoseArray");const cs=new Set;J(cs,"nav_msgs/Path");const kt=new Set;J(kt,"sensor_msgs/CameraInfo");const ds=new Set;J(ds,"sensor_msgs/Image");const hs=new Set;J(hs,"sensor_msgs/CompressedImage");const hn=new Set;J(hn,"geometry_msgs/PolygonStamped");const Jr=new Set;J(Jr,"sensor_msgs/JointState");const Qr=new Set;J(Qr,"visualization_msgs/ImageMarker");const qr=new Set;J(qr,"visualization_msgs/ImageMarkerArray");function J(s,e){s.add(e);const t=e.split("/");if(t.length>1){const i=t[0],n=t.slice(1).join("/");s.add(`${i}/msg/${n}`)}return s.add("ros."+e.split("/").join(".")),s}function ea(s,e){return(t,i)=>{const n=t.getInt8(i+s);return e?Math.max(n/127,-1):n}}function ta(s,e){return(t,i)=>{const n=t.getUint8(i+s);return e?n/255:n}}function sa(s,e){return(t,i)=>{const n=t.getInt16(i+s,!0);return e?Math.max(n/32767,-1):n}}function ia(s,e){return(t,i)=>{const n=t.getUint16(i+s,!0);return e?n/65535:n}}function na(s,e){return(t,i)=>{const n=t.getInt32(i+s,!0);return e?Math.max(n/2147483647,-1):n}}function ra(s,e){return(t,i)=>{const n=t.getUint32(i+s,!0);return e?n/4294967295:n}}function aa(s){return(e,t)=>e.getFloat32(t+s,!0)}function oa(s){return(e,t)=>e.getFloat64(t+s,!0)}function Ct(s){return!("count"in s&&s.count!==1)}function Se(s,e,t=!1,i){if(!Ct(s))return;const n=s.type;if(n==null)switch(i??s.datatype){case G.INT8:return s.offset+1<=e?ea(s.offset,t):void 0;case G.UINT8:return s.offset+1<=e?ta(s.offset,t):void 0;case G.INT16:return s.offset+2<=e?sa(s.offset,t):void 0;case G.UINT16:return s.offset+2<=e?ia(s.offset,t):void 0;case G.INT32:return s.offset+4<=e?na(s.offset,t):void 0;case G.UINT32:return s.offset+4<=e?ra(s.offset,t):void 0;case G.FLOAT32:return s.offset+4<=e?aa(s.offset):void 0;case G.FLOAT64:return s.offset+8<=e?oa(s.offset):void 0;default:return}else switch(i??n){case E.NumericType.INT8:return s.offset+1<=e?ea(s.offset,t):void 0;case E.NumericType.UINT8:return s.offset+1<=e?ta(s.offset,t):void 0;case E.NumericType.INT16:return s.offset+2<=e?sa(s.offset,t):void 0;case E.NumericType.UINT16:return s.offset+2<=e?ia(s.offset,t):void 0;case E.NumericType.INT32:return s.offset+4<=e?na(s.offset,t):void 0;case E.NumericType.UINT32:return s.offset+4<=e?ra(s.offset,t):void 0;case E.NumericType.FLOAT32:return s.offset+4<=e?aa(s.offset):void 0;case E.NumericType.FLOAT64:return s.offset+8<=e?oa(s.offset):void 0;default:return}}var Q=b(41531);function de(s){return s?{sec:s.sec??0,nsec:s.nsec??0}:{sec:0,nsec:0}}function jt(s){return s==null?new Uint8Array(0):s instanceof Uint8Array?s:Array.isArray(s)||s instanceof ArrayBuffer?new Uint8Array(s):new Uint8Array(0)}function Rc(s){return s==null?new Int8Array(0):s instanceof Int8Array?s:Array.isArray(s)||s instanceof ArrayBuffer?new Int8Array(s):new Int8Array(0)}function Zs(s){return s==null?new Float32Array(0):s instanceof Float32Array?s:Array.isArray(s)||s instanceof ArrayBuffer||s instanceof Float64Array?new Float32Array(s):new Float32Array(0)}function je(s){return s?{x:s.x??0,y:s.y??0,z:s.z??0}:{x:0,y:0,z:0}}function la(s){return s?s.map(je):[]}function Lc(s){return!s||s.length!==36||typeof s[0]!="number"?[1,0,0,0,0,0,0,1,0,0,0,0,0,0,1,0,0,0,0,0,0,1,0,0,0,0,0,0,1,0,0,0,0,0,0,1]:s}function un(s){return s?{x:s.x??0,y:s.y??0,z:s.z??0,w:s.w??0}:{x:0,y:0,z:0,w:1}}function Xe(s){return s?{r:s.r??0,g:s.g??0,b:s.b??0,a:s.a??1}:{r:0,g:0,b:0,a:1}}function fn(s){return s?s.map(Xe):[]}function ee(s){return{position:je(s?.position),orientation:un(s?.orientation)}}function Pe(s){return{frame_id:s?.frame_id??"",stamp:de(s?.stamp),seq:s?.seq}}function Nc(s){return{translation:je(s?.translation),rotation:un(s?.rotation)}}function ca(s){return{header:Pe(s?.header),child_frame_id:s?.child_frame_id??"",transform:Nc(s?.transform)}}function Oc(s){return{transforms:(s?.transforms??[]).map(ca)}}function da(s){return{timestamp:de(s?.timestamp),parent_frame_id:s?.parent_frame_id??"",child_frame_id:s?.child_frame_id??"",translation:je(s?.translation??s?.transform?.translation),rotation:un(s?.rotation??s?.transform?.rotation)}}function Fc(s){return{transforms:(s?.transforms??[]).map(da)}}function Uc(s){switch(s){case E.NumericType.UINT8:return G.UINT8;case E.NumericType.INT8:return G.INT8;case E.NumericType.UINT16:return G.UINT16;case E.NumericType.INT16:return G.INT16;case E.NumericType.UINT32:return G.UINT32;case E.NumericType.INT32:return G.INT32;case E.NumericType.FLOAT32:return G.FLOAT32;case E.NumericType.FLOAT64:return G.FLOAT64;default:return G.UNKNOWN}}function $(s,e){return e.has(s.schemaName)||(s.convertibleTo?.some(t=>e.has(t))??!1)}function tt(){return 0}const ha=["gradient","colormap"],zc="INVALID_FOXGLOVE_GRID",kc="turbo",jc={r:1,g:1,b:1,a:1},Gc={r:100/255,g:47/255,b:105/255,a:1},Bc={r:227/255,g:177/255,b:135/255,a:1},Ks={COLOR_MODE_FLAT:0,COLOR_MODE_RGBA:1,COLOR_MODE_GRADIENT:2,COLOR_MODE_COLORMAP:3},pn={COLOR_MAP_TURBO:0,COLOR_MAP_RAINBOW:1},Xs={visible:!1,frameLocked:!1,colorMode:"flat",minValue:void 0,maxValue:void 0,flatColor:ne(jc),colorField:void 0,gradient:[ne(Gc),ne(Bc)],colorMap:kc,explicitAlpha:1},ua={redReader:tt,greenReader:tt,blueReader:tt,alphaReader:tt};function Vc(s){return E.NumericType[s]??`${s}`}function fa(s){switch(s.colorMode){case"flat":return c.rnI;case"gradient":case"colormap":return c.rnI;case"rgba-fields":return c.knz}}const pe={r:0,g:0,b:0,a:1},pa=[0,0];class $c extends F{dispose(){this.userData.texture.dispose(),this.userData.material.dispose(),this.userData.pickingMaterial.dispose()}details(){return this.userData.foxgloveGrid}syncPickingMaterial(){const{pickingMaterial:e,material:t}=this.userData;e.uniforms=t.uniforms,e.needsUpdate=!0}#e(e,t){const{cell_stride:i}=t;for(const n of t.fields){const{name:r}=n;r==="red"?e.redReader=Se(n,i,!0)??tt:r==="green"?e.greenReader=Se(n,i,!0)??tt:r==="blue"?e.blueReader=Se(n,i,!0)??tt:r==="alpha"&&(e.alphaReader=Se(n,i,!0)??tt)}}#t(e,t){const{cell_stride:i}=e;for(const n of e.fields){const{type:r,offset:a,name:o}=n;if(o===t.colorField){const l=Se(n,i);if(!l){const d=E.NumericType[r],h=`Grid field "${o}" is invalid. type=${d}, offset=${a}, stride=${i}`;us(this.renderer,this.userData.topic,h);return}return l}}return tt}updateMaterial(e){const{colorMode:t}=e,{material:i}=this.userData;let n=!1,r=!1;t==="flat"?(N(pe,e.flatColor),r=pe.a<1):t==="gradient"?(N(pe,e.gradient[0]),r=pe.a<1,N(pe,e.gradient[1]),r=r||pe.a<1):t==="colormap"&&(r=e.explicitAlpha<1),r!==i.transparent&&(i.depthWrite=!r,i.transparent=r,n=!0),n&&(i.needsUpdate=!0)}updateUniforms(e,t){const{material:i}=this.userData,{uniforms:{colorMode:n,colorMap:r,colorMapOpacity:a,minValue:o,maxValue:l,minGradientColorLinear:d,maxGradientColorLinear:h}}=i;t.colorMode==="rgba-fields"?n.value=Ks.COLOR_MODE_RGBA:n.value=Ks[`COLOR_MODE_${t.colorMode.toUpperCase()}`],r.value=pn[`COLOR_MAP_${t.colorMap.toUpperCase()}`],a.value=t.explicitAlpha,qc(pa,t,e.fields.find(g=>t.colorField===g.name)?.type??E.NumericType.UNKNOWN);const[f,p]=pa;o.value=f,l.value=p;const u=N(pe,t.gradient[0]);zt(u,u),d.value.set(u.r,u.g,u.b,u.a);const m=N(pe,t.gradient[1]);zt(m,m),h.value.set(m.r,m.g,m.b,m.a)}updateTexture(e,t){let i=this.userData.texture;const n=this.#t(e,t);if(!n)return;const r=new DataView(e.data.buffer,e.data.byteOffset,e.data.byteLength),{column_count:a,row_stride:o,cell_stride:l}=e,d=e.data.length/o,h=a!==i.image.width||d!==i.image.height,f=ha.includes(t.colorMode);((f?i.format!==c.hEm:i.format!==c.wk1)||h)&&(i.dispose(),i=ma(e,t),i.generateMipmaps=!1,this.userData.texture=i,this.userData.material.uniforms.map.value=i);const u=fa(t);if(u!==i.encoding&&(i.encoding=u,i.needsUpdate=!0),f){const m=i.image.data;for(let g=0;g<d;g++)for(let y=0;y<a;y++){const S=g*o+y*l,D=n(r,S),A=g*a+y;m[A]=D}}else{const m=i.image.data;let g=!1;if(t.colorMode==="rgba-fields"){this.#e(ua,e);const{redReader:y,greenReader:S,blueReader:D,alphaReader:A}=ua;for(let M=0;M<d;M++)for(let I=0;I<a;I++){const P=M*o+I*l,z=(M*a+I)*4,Y=A(r,P);m[z+0]=y(r,P)*255|0,m[z+1]=S(r,P)*255|0,m[z+2]=D(r,P)*255|0,m[z+3]=Y*255|0,Y!==0&&Y!==1&&(g=!0)}}else if(t.colorMode==="flat"){const y=qi(t,0,1);for(let S=0;S<d;S++)for(let D=0;D<a;D++){const A=S*o+D*l,M=n(r,A);y(pe,M);const P=(S*a+D)*4;m[P+0]=Math.floor(pe.r*255),m[P+1]=Math.floor(pe.g*255),m[P+2]=Math.floor(pe.b*255),m[P+3]=Math.floor(pe.a*255),pe.a!==0&&pe.a!==1&&(g=!0)}}this.userData.material.transparent!==g&&(this.userData.material.transparent=g,this.userData.material.depthWrite=!g,this.userData.material.needsUpdate=!0)}this.userData.material.uniforms.map.value.needsUpdate=!0}}class Wc extends Q.d{#e=new Map;constructor(e){super("foxglove.Grid",e)}getSubscriptions(){return[{type:"schema",schemaNames:$i,subscription:{handler:this.#t}}]}settingsNodes(){const e=this.renderer.config.topics,t=this.handleSettingsAction,i=[];for(const n of this.renderer.topics??[]){if(!$(n,$i))continue;const r=e[n.name]??{},a=Zr(this.#e.get(n.name)??[],r,n,Xs,{supportsPackedRgbModes:!1,supportsRgbaFieldsMode:!0});a.icon="Cells",a.fields.frameLocked={label:"Frame lock",input:"boolean",value:r.frameLocked??Xs.frameLocked},a.handler=t,i.push({path:["topics",n.name],node:a})}return i}handleSettingsAction=e=>{const t=e.payload.path;if(e.action!=="update"||t.length!==3)return;this.saveSetting(t,e.payload.value);const i=t[1],n=this.renderables.get(i);if(n){const r=this.renderer.config.topics[i];n.userData.settings={...Xs,...r},n.updateMaterial(n.userData.settings),n.updateUniforms(n.userData.foxgloveGrid,n.userData.settings),(e.payload.path[2]==="colorMode"||e.payload.path[2]==="colorField"||e.payload.path[2]==="flatColor")&&n.updateTexture(n.userData.foxgloveGrid,n.userData.settings),n.syncPickingMaterial()}};#t=e=>{const t=e.topic,i=Qc(e.message),n=(0,w.toNanoSec)(e.receiveTime);let r=this.renderables.get(t);if(!this.#s(i,e.topic)){r&&(r.visible=!1);return}if(r)r.visible=!0;else{const o=this.renderer.config.topics[t],l={...Xs,...o};l.colorField==null&&this.#e.get(t)==null&&(td(l,i.fields,{supportsPackedRgbModes:!1}),this.renderer.updateConfig(m=>{const g={...o};g.colorField=l.colorField,g.colorMode=l.colorMode,g.colorMap=l.colorMap,m.topics[t]=g}));const d=ma(i,l),h=this.renderer.sharedGeometry.getGeometry(this.constructor.name,Hc),f=Yc(t,d,h),p=f.material,u=f.userData.pickingMaterial;r=new $c(t,this.renderer,{receiveTime:n,messageTime:(0,w.toNanoSec)(i.timestamp),frameId:this.renderer.normalizeFrameId(i.frame_id),pose:i.pose,settingsPath:["topics",t],settings:l,topic:t,foxgloveGrid:i,mesh:f,texture:d,material:p,pickingMaterial:u}),r.add(f),this.add(r),this.renderables.set(t,r)}let a=this.#e.get(t);(!a||a.length!==i.fields.length)&&(a=i.fields.map(o=>o.name),this.#e.set(t,a),this.updateSettingsTree()),this.#i(r,i,n,r.userData.settings)};#s(e,t){const{cell_stride:i,row_stride:n,column_count:r}=e,a=e.data.byteLength/n;if(e.fields.length===0)return us(this.renderer,t,"Grid has no fields. At least one field is required for the Grid to be displayed."),!1;if(Math.floor(r)!==r||Math.floor(a)!==a){const d=`Grid column count (${e.column_count}) or row count (${a} = data.byteLength ${e.data.byteLength} / row_stride ${n}) is not an integer.`;return us(this.renderer,t,d),!1}if(i*r>n){const d=`Grid row_stride (${n}) does not allow for requisite column_count (${r}) with cell stride (${i}). Minimum requisite bytes in row_stride needed: (${r*i}) `;return us(this.renderer,t,d),!1}let o=0,l;for(const d of e.fields){const h=Zc(d.type);d.offset+h>o&&(o=d.offset+h,l=d)}if(o>i){let d=`Grid cell_stride (${i}) is less than minimum bytes per cell (${o})`;return l&&(d+=` required by \u201C${l.name}\u201D field, type=${Vc(l.type)}, offset=${l.offset}`),us(this.renderer,t,d),!1}return!0}#i(e,t,i,n){e.userData.foxgloveGrid=t,e.userData.pose=t.pose,e.userData.receiveTime=i,e.userData.messageTime=(0,w.toNanoSec)(t.timestamp),e.userData.frameId=this.renderer.normalizeFrameId(t.frame_id);const{row_stride:r,column_count:a}=t,o=t.data.byteLength/r;e.updateMaterial(n),e.updateUniforms(t,n),e.updateTexture(t,n),e.scale.set(t.cell_size.x*a,t.cell_size.y*o,1),e.syncPickingMaterial()}}function Hc(){const s=new c._12(1,1,1,1);return s.translate(.5,.5,0),s.computeBoundingSphere(),s}function us(s,e,t){s.settings.errors.addToTopic(e,zc,t)}function ma(s,e){const{column_count:t,row_stride:i}=s,n=s.data.byteLength/i,r=isFinite(t*n)?t*n:0,a=ha.includes(e.colorMode),o=a?new Float32Array(r):new Uint8ClampedArray(r*4),l=a?c.hEm:c.wk1,d=a?c.VzW:c.ywz,h=new c.IEO(o,t,n,l,d,c.xfE,c.uWy,c.uWy,c.TyD,c.wem,1,fa(e));return h.generateMipmaps=!1,h}function Yc(s,e,t){const i=Kc(e,s),n=Xc(i),r=new c.Kj0(t,i);return r.castShadow=!0,r.receiveShadow=!0,r.userData.pickingMaterial=n,r}function Zc(s){switch(s){case E.NumericType.INT8:case E.NumericType.UINT8:return 1;case E.NumericType.INT16:case E.NumericType.UINT16:return 2;case E.NumericType.INT32:case E.NumericType.UINT32:case E.NumericType.FLOAT32:return 4;case E.NumericType.FLOAT64:return 8;default:return 0}}function Kc(s,e){return new c.jyz({name:`${e}:Material`,alphaTest:1e-4,side:c.ehD,uniforms:{objectId:{value:[NaN,NaN,NaN,NaN]},colorMode:{value:Ks.COLOR_MODE_RGBA},colorMap:{value:pn.COLOR_MAP_TURBO},colorMapOpacity:{value:1},minValue:{value:0},maxValue:{value:1},minGradientColorLinear:{value:new c.Ltg},maxGradientColorLinear:{value:new c.Ltg},map:{value:s}},vertexShader:`
      varying vec2 vUv;
      void main() {
        vUv = uv;
        gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
      }
    `,defines:{...Ks,...pn,PICKING:0},fragmentShader:`
      uniform vec4 objectId;

      uniform sampler2D map;

      uniform int colorMode;
      uniform float minValue;
      uniform float maxValue;

      uniform int colorMap;
      uniform float colorMapOpacity;

      uniform vec4 minGradientColorLinear;
      uniform vec4 maxGradientColorLinear;

      varying vec2 vUv;

      ${Kr}

      // adapted from https://gist.github.com/mikhailov-work/0d177465a8151eb6ede1768d51d476c7
      vec3 turboLinear(float x) {
        const vec4 kRedVec4 = vec4(0.13572138, 4.61539260, -42.66032258, 132.13108234);
        const vec4 kGreenVec4 = vec4(0.09140261, 2.19418839, 4.84296658, -14.18503333);
        const vec4 kBlueVec4 = vec4(0.10667330, 12.64194608, -60.58204836, 110.36276771);
        const vec2 kRedVec2 = vec2(-152.94239396, 59.28637943);
        const vec2 kGreenVec2 = vec2(4.27729857, 2.82956604);
        const vec2 kBlueVec2 = vec2(-89.90310912, 27.34824973);

        vec4 v4 = vec4(1.0, x, x * x, x * x * x);
        vec2 v2 = v4.zw * v4.z;
        return sRGBToLinear(vec3(
          (dot(v4, kRedVec4)   + dot(v2, kRedVec2)),
          (dot(v4, kGreenVec4) + dot(v2, kGreenVec2)),
          (dot(v4, kBlueVec4)  + dot(v2, kBlueVec2))
        ));
      }


      // taken from http://docs.ros.org/jade/api/rviz/html/c++/point__cloud__transformers_8cpp_source.html
      // line 47
      vec3 rainbowLinear(float pct) {
        vec3 colorOut = vec3(0.0);
        float h = (1.0 - clamp(pct, 0.0, 1.0)) * 5.0 + 1.0;
        float i = floor(h);
        float f = mod(h, 1.0);
        // if i is even
        if (mod(i, 2.0) < 1.0) {
          f = 1.0 - f;
        }
        float n = (1.0 - f);

        if (i <= 1.0) {
          colorOut.r = n;
          colorOut.g = 0.0;
          colorOut.b = 1.0;
        } else if (i == 2.0) {
          colorOut.r = 0.0;
          colorOut.g = n;
          colorOut.b = 1.0;
        } else if (i == 3.0) {
          colorOut.r = 0.0;
          colorOut.g = 1.0;
          colorOut.b = n;
        } else if (i == 4.0) {
          colorOut.r = n;
          colorOut.g = 1.0;
          colorOut.b = 0.0;
        } else {
          colorOut.r = 1.0;
          colorOut.g = n;
          colorOut.b = 0.0;
        }
        return sRGBToLinear(colorOut);
      }

      void main() {
        vec4 color = texture2D(map, vUv);
        if(colorMode == COLOR_MODE_RGBA) {
          // input color is in sRGB, texture.encoding is sRGB, so no conversion is needed
          gl_FragColor = color;
        } else if (colorMode == COLOR_MODE_FLAT) {
          // input color was already converted to linear by getColorConverter
          gl_FragColor = color;
        } else {
          // input color was already converted to linear by getColorConverter
          float delta = max(maxValue - minValue, 0.00001);
          float colorValue = color.r;
          float normalizedColorValue = clamp((colorValue - minValue) / delta, 0.0, 1.0);
          if(colorMode == COLOR_MODE_GRADIENT) {
            /**
            * Computes a gradient step from colors a to b using pre-multiplied alpha to
            * match CSS linear gradients. The inputs are assumed to not have pre-multiplied
            * alpha, and the output will have pre-multiplied alpha.
            */
            vec4 weightedMinColor = vec4(minGradientColorLinear.rgb * minGradientColorLinear.a, minGradientColorLinear.a);
            vec4 weightedMaxColor = vec4(maxGradientColorLinear.rgb * maxGradientColorLinear.a, maxGradientColorLinear.a);
            vec4 finalColor = mix(weightedMinColor, weightedMaxColor, normalizedColorValue);
            // gradient computation takes place in linear colorspace
            gl_FragColor = finalColor;
          } else if(colorMode == COLOR_MODE_COLORMAP) {
            // colormap
            if(colorMap == COLOR_MAP_TURBO) {
              gl_FragColor = vec4(turboLinear(normalizedColorValue), colorMapOpacity);
            } else if(colorMap == COLOR_MAP_RAINBOW) {
              gl_FragColor = vec4(rainbowLinear(normalizedColorValue), colorMapOpacity);
            }
          }
        }
        if(gl_FragColor.a < 0.00001) {
          discard;
        }
        if(PICKING == 1) {
          gl_FragColor = objectId;
        } else {
          #include <encodings_fragment>
        }
      }
    `})}function Xc(s){const e=new c.jyz;return e.copy(s),e.name="",e.defines.PICKING=1,e.uniformsNeedUpdate=!0,e.needsUpdate=!0,e}function Jc(s){return{name:s?.name??"",offset:s?.offset??0,type:s?.type??0}}function Qc(s){return{timestamp:de(s.timestamp),pose:ee(s.pose),frame_id:s.frame_id??"",row_stride:s.row_stride??0,cell_stride:s.cell_stride??0,column_count:s.column_count??0,cell_size:{x:s.cell_size?.x??1,y:s.cell_size?.y??1},fields:s.fields?.map(Jc)??[],data:jt(s.data)}}function qc(s,e,t){if(!$r.includes(e.colorMode))return;const[i,n]=ed[t],r=e.minValue??i,a=e.maxValue??n;s[0]=r,s[1]=a}const ed={[E.NumericType.UNKNOWN]:[0,1],[E.NumericType.UINT8]:[0,255],[E.NumericType.UINT16]:[0,65535],[E.NumericType.UINT32]:[0,Math.pow(2,32)-1],[E.NumericType.INT8]:[-128,127],[E.NumericType.INT16]:[-Math.pow(2,16-1),-Math.pow(2,16-1)-1],[E.NumericType.INT32]:[-Math.pow(2,32-1),-Math.pow(2,32-1)-1],[E.NumericType.FLOAT32]:[0,1],[E.NumericType.FLOAT64]:[0,1]};function td(s,e,{supportsPackedRgbModes:t}){if(t)for(const i of e){const n=i.name.toLowerCase();if(en.has(n)){switch(s.colorField=i.name,n){case"rgb":s.colorMode="rgb";break;default:case"rgba":s.colorMode="rgba";break}return}}if(Yr(e.map(i=>i.name))){s.colorMode="rgba-fields";return}if(e.length>0){const i=e[0];s.colorField=i.name,s.colorMode="colormap",s.colorMap="turbo";return}}var ga=b(57718),ba=b(77075),mn=b(21385);class sd extends c.nls{constructor(...e){super(...e),this.defines??={},this.defines.USE_INSTANCING=!0}}const id=1,ya=new c.FM8,nd=new c.JOQ(new c.Pa4(0,0,1),0);class rd extends B.Z{getCamera;#e;canvasSize;#t;#s;#i=new c.FM8;#n;#r=new c.iMs;constructor(e,t){super(),this.getCamera=t;const i=e.parentElement;if(!i)throw new Error("<canvas> must be parented to a DOM element");this.#e=e,this.canvasSize=new c.FM8,this.#a([]);const n=(0,Z.debounce)(this.#a);this.#t=new ResizeObserver(n),this.#t.observe(i),e.addEventListener("mousedown",this.#o),e.addEventListener("mousemove",this.#l),e.addEventListener("mouseup",this.#h),e.addEventListener("click",this.#c),e.addEventListener("wheel",this.#d),e.addEventListener("touchstart",this.#u,{passive:!1}),e.addEventListener("touchend",this.#f,{passive:!1}),e.addEventListener("touchmove",this.#p,{passive:!1}),e.addEventListener("touchcancel",this.#b,{passive:!1})}dispose(){const e=this.#e;this.removeAllListeners(),this.#t.disconnect(),e.removeEventListener("mousedown",this.#o),e.removeEventListener("mousemove",this.#l),e.removeEventListener("mouseup",this.#h),e.removeEventListener("click",this.#c),e.removeEventListener("wheel",this.#d),e.removeEventListener("touchstart",this.#u),e.removeEventListener("touchend",this.#f),e.removeEventListener("touchmove",this.#p),e.removeEventListener("touchcancel",this.#b)}trackDrag(e){const t=i=>{i.preventDefault(),this.#m(i),e(this.#i)};window.addEventListener("mousemove",t),window.addEventListener("mouseup",()=>{window.removeEventListener("mousemove",t)},{once:!0})}#a=e=>{if(this.#e.parentElement){const t=ad(this.#e.parentElement);if(isNaN(t.width)||isNaN(t.height))return;(t.width!==this.canvasSize.width||t.height!==this.canvasSize.height)&&(this.canvasSize.width=t.width,this.canvasSize.height=t.height,this.emit("resize",this.canvasSize))}};#o=e=>{this.#s=new c.FM8(e.offsetX,e.offsetY),this.#m(e),this.emit("mousedown",this.#i,this.#n,e)};#l=e=>{this.#m(e),this.emit("mousemove",this.#i,this.#n,e)};#h=e=>{this.#m(e),this.emit("mouseup",this.#i,this.#n,e)};#c=e=>{if(!this.#s)return;const t=this.#s.distanceTo(ya.set(e.offsetX,e.offsetY));this.#s=void 0,!(t>id)&&(this.#m(e),this.emit("click",this.#i,this.#n,e))};#d=e=>{this.#m(e),this.emit("wheel",this.#i,this.#n,e)};#u=e=>{const t=e.touches[0];t&&(this.#s=new c.FM8(t.clientX,t.clientY)),e.preventDefault()};#f=e=>{e.preventDefault()};#p=e=>{e.preventDefault()};#b=e=>{e.preventDefault()};#m(e){const t=this.#e.getBoundingClientRect(),i=e.clientX-t.left,n=e.clientY-t.top;this.#i.x=i,this.#i.y=n,this.#r.setFromCamera(ya.set(i/this.canvasSize.width*2-1,-(n/this.canvasSize.height*2-1)),this.getCamera()),this.#n=this.#r.ray.intersectPlane(nd,this.#n??new c.Pa4)??void 0}}function ad(s){const e=getComputedStyle(s),t=parseFloat(e.paddingLeft)+parseFloat(e.paddingRight),i=parseFloat(e.paddingTop)+parseFloat(e.paddingBottom),n=parseFloat(e.borderLeftWidth)+parseFloat(e.borderRightWidth),r=parseFloat(e.borderTopWidth)+parseFloat(e.borderBottomWidth),a=s.clientWidth-t-n,o=s.clientHeight-i-r;return{width:a,height:o}}var od=b(83829),ld=b(20111),cd=b(14666),dd=b(31031),hd=b(556),ud=b(81497),fd=b(28575),pd=b(30224),md="../../packages/studio-base/src/panels/ThreeDeeRender/ModelCache.ts";const Js=R.ZP.getLogger(md),gn="y_up",gd=new c.Ilk(2395903).convertSRGBToLinear(),bd=["model/gltf","model/gltf-binary","model/gltf+json"],yd=["model/stl","model/x.stl-ascii","model/x.stl-binary","application/sla"],vd=["model/vnd.collada+xml"],Sd=["model/obj","text/prs.wavefront-obj"];class Td{options;#e=new TextDecoder;#t=new Map;#s;#i;constructor(e){this.options=e,this.#s=e.edgeMaterial}async load(e,t,i){let n=this.#t.get(e);return n?await n:(n=this.#n(e,t,i).then(r=>xd(r,this.#s)).catch(async r=>{i(r)}),this.#t.set(e,n),await n)}async#n(e,t,i){const r=await fetch(e);if(!r.ok){const d=r.statusText;throw new Error(`Error ${r.status}${d?` (${d})`:""}`)}const a=await r.arrayBuffer();if(a.byteLength<4)throw new Error(`${a.byteLength} bytes received`);const o=new DataView(a),l=t.overrideMediaType??r.headers.get("content-type")??"";if(o.getUint32(0,!1)===1735152710||bd.includes(l)||/\.glb$/i.test(e)||/\.gltf$/i.test(e))return await this.#r(e,i);if(yd.includes(l)||/\.stl$/i.test(e))return this.#a(e,a,this.options.meshUpAxis);if(vd.includes(l)||/\.dae$/i.test(e)){const d=this.#e.decode(a);return await this.#o(e,d,this.options.ignoreColladaUpAxis,i)}if(Sd.includes(l)||/\.obj$/i.test(e)){const d=this.#e.decode(a);return await this.#l(e,d,this.options.meshUpAxis,i)}throw new Error(`Unknown ${a.byteLength} byte mesh (content-type: "${l}")`)}async#r(e,t){const i=o=>{const l=vn(o);Js.error(`Failed to load GLTF asset "${l}" for "${e}"`),t(new Error(`Failed to load GLTF asset "${l}"`))},n=new c.lLk(void 0,void 0,i);n.setURLModifier(yn);const r=new ud.E(n);r.setMeshoptDecoder(od.z$),r.setDRACOLoader(this.#h(n)),n.itemStart(e);const a=await r.loadAsync(e);return n.itemEnd(e),a.scene.rotateX(Math.PI/2),a.scene}#a(e,t,i){const r=new pd.j().parse(t);Js.debug(`Finished loading STL from ${e}`);const a=new c.Wid({name:e.slice(-32),color:gd,metalness:0,roughness:1,dithering:!0}),o=new c.Kj0(r,a),l=new c.ZAu;return l.add(o),i==="y_up"&&l.rotateX(Math.PI/2),l}async#o(e,t,i,n){const r=p=>{const u=vn(p);Js.error(`Failed to load COLLADA asset "${u}" for "${e}"`),n(new Error(`Failed to load COLLADA asset "${u}"`))},a=new DOMParser().parseFromString(t,"application/xml"),o=i?"Z_UP":(a.querySelector("up_axis")?.textContent??"Y_UP").trim().toUpperCase();a.querySelectorAll("up_axis").forEach(p=>p.remove());const l=a.documentElement.outerHTML,d=new c.lLk(void 0,void 0,r);d.setURLModifier(yn);const h=new dd.G(d);d.itemStart(e);const f=h.parse(l,Dd(e));return d.itemEnd(e),o==="Y_UP"&&f.scene.rotateX(Math.PI/2),wd(f.scene)}async#l(e,t,i,n){const r=d=>{const h=vn(d);Js.error(`Failed to load OBJ asset "${h}" for "${e}"`),n(new Error(`Failed to load OBJ asset "${h}"`))},a=new c.lLk(void 0,void 0,r);a.setURLModifier(yn);const o=new fd.L(a);a.itemStart(e);const l=o.parse(t);return a.itemEnd(e),i==="y_up"&&l.rotateX(Math.PI/2),Id(l)}#h(e){let t=this.#i;return t||(t=new hd._(e),t._loadLibrary=async function(i,n){if(i==="draco_wasm_wrapper.js"&&n==="text")return cd;if(i==="draco_decoder.wasm"&&n==="arraybuffer")return await(await fetch(ld)).arrayBuffer();throw new Error(`DRACOLoader attempt to load non-bundled asset: ${i} as ${n}`)},this.#i=t),t.manager=e,t}dispose(){this.#i?.dispose(),this.#i=void 0}}const bn="edges";function xd(s,e){const t=[];s.traverse(i=>{if(!(i instanceof c.Kj0))return;i.castShadow=!0,i.receiveShadow=!0;const n=new c.TOt(i.geometry,40),r=new c.ejS(n,e);r.name=bn,t.push([r,i])});for(const[i,n]of t)n.add(i);return s}function wd(s){return s.traverse(e=>{if(e instanceof c.Kj0)if(e.material instanceof c.YBo){const t=va(e.material);e.material.dispose(),e.material=t}else e.material instanceof c.Wid&&(e.material.dithering=!0)}),s}function Id(s){return s.traverse(e=>{if(e instanceof c.Kj0)if(e.material instanceof c.xoR){const t=va(e.material);e.material.dispose(),e.material=t}else e.material instanceof c.Wid&&(e.material.metalness=0,e.material.roughness=1,e.material.dithering=!0)}),s}function va(s){const e=new c.Wid({name:s.name}),t=s.shininess??0,i=s;return i.normalScale??=new c.FM8(1,1),e.copy(s),e.metalness=0,e.roughness=1-t/100,e.dithering=!0,e}function yn(s){return s.startsWith("package://")&&/\.tiff?$/i.test(s)?s.replace("package://","x-foxglove-converted-tiff://"):s}function vn(s){return s.startsWith("x-foxglove-converted-tiff://")?s.replace("x-foxglove-converted-tiff://","package://"):s}function Dd(s){return s.slice(0,s.lastIndexOf("/")+1)}const fs=31,Cd=new c.FM8(0,0),Sn=new c.Ilk(16777215),Sa=null;class Md{#e;#t;#s;#i=new Map;#n;#r;#a=new c.Ilk;#o;#l=!1;constructor(e,t){this.#e=e,this.#t=t,this.#o=new c.dd2(fs,fs,{minFilter:c.TyD,magFilter:c.TyD,format:c.wk1,encoding:c.rnI,generateMipmaps:!1}),this.#r=new Uint8Array(4),this.#n=new c.xsS}dispose(){for(const e of this.#i.values())e.dispose();this.#i.clear(),this.#o.dispose()}pick(e,t,i,n={}){this.#n.onAfterRender=this.#f,this.#s=i;const{xInView:r,yInView:a}=this.#h(e,t,n),o=this.#d();this.#e.render(this.#n,i),this.#e.readRenderTargetPixels(this.#o,r,a,1,1,this.#r),this.#u(o),this.#c(n);const l=(this.#r[0]<<24)+(this.#r[1]<<16)+(this.#r[2]<<8)+this.#r[3];return n.debug===!0&&this.pickDebugRender(i),l}pickInstance(e,t,i,n,r={}){this.#n.onAfterRender=this.#p(n),this.#s=i;const{xInView:a,yInView:o}=this.#h(e,t,r),l=this.#d();return this.#e.render(this.#n,this.#s),this.#e.readRenderTargetPixels(this.#o,a,o,1,1,this.#r),this.#u(l),this.#c(r),r.debug===!0&&this.pickInstanceDebugRender(i,n),(this.#r[0]<<24)+(this.#r[1]<<16)+(this.#r[2]<<8)+this.#r[3]}#h(e,t,i){(0,V.assert)(this.#s,"camera must be set before updating for pick");const n=this.#e.domElement.width,r=this.#e.domElement.height,a=this.#e.getPixelRatio();if(i.disableSetViewOffset!==!0){const o=fs/2|0,l=Math.max(0,e*a-o),d=Math.max(0,t*a-o);return this.#s.setViewOffset(n,r,l,d,fs,fs),{xInView:o,yInView:o}}else{(this.#o.width!==n||this.#o.height!==r)&&this.#o.setSize(n,r);const o=Math.max(0,e*a),l=Math.max(0,r-t*a);return{xInView:o,yInView:l}}}#c(e){(0,V.assert)(this.#s,"camera must be set before resetting from pick"),e.disableSetViewOffset!==!0&&this.#s.clearViewOffset()}#d(){const e=this.#e.getRenderTarget(),t=this.#e.getClearAlpha();return this.#e.getClearColor(this.#a),this.#e.setRenderTarget(this.#o),this.#e.setClearColor(Sn,1),this.#e.clear(),{originalRenderTarget:e,originalAlpha:t}}#u({originalRenderTarget:e,originalAlpha:t}){this.#e.setRenderTarget(e),this.#e.setClearColor(this.#a,t)}pickDebugRender(e){this.#l=!0,this.#n.onAfterRender=this.#f;const t=this.#e.getClearAlpha();this.#e.getClearColor(this.#a),this.#e.setClearColor(Sn,1),this.#e.clear(),this.#e.render(this.#n,e),this.#e.setClearColor(this.#a,t),this.#l=!1}pickInstanceDebugRender(e,t){this.#l=!0,this.#n.onAfterRender=this.#p(t);const i=this.#e.getClearAlpha();this.#e.getClearColor(this.#a),this.#e.setClearColor(Sn,1),this.#e.clear(),this.#e.render(this.#n,e),this.#e.setClearColor(this.#a,i),this.#l=!1}#f=()=>{const e=this.#e.renderLists.get(this.#t,0);e.opaque.forEach(this.#b),e.transmissive.forEach(this.#b),e.transparent.forEach(this.#b)};#p(e){return()=>{e.traverseVisible(t=>{const i=t;if(i.id!=null&&i.geometry&&i.material){const n={id:i.id,object:t,geometry:i.geometry,material:i.material,program:void 0,groupOrder:0,renderOrder:0,z:0,group:null};this.#m(n)}})}}#b=e=>{if(!this.#s)return;const t=e.object,i=this.#l?Ad(t.id):t.id,n=e.material,r=e.geometry;if(!r||e.object.userData.picking===!1)return;const a=n.type==="SpriteMaterial"?1:0,o=Cd.set(this.#o.width,this.#o.height),l=n.sizeAttenuation===!0?1:0,d=e.object.userData.pickingMaterial;d?.uniforms.resolution!=null&&d.uniforms.resolution.value.copy(o);const h=d??this.#v(a,l);a===1&&(h.uniforms.rotation={value:n.rotation},h.uniforms.center={value:t.center}),Ed(h,i),h.uniformsNeedUpdate=!0,this.#e.renderBufferDirect(this.#s,Sa,r,h,t,null)};#m=e=>{if(!this.#s)return;const t=e.object,i=e.geometry;if(!i||e.object.userData.picking===!1)return;const r=e.object.userData.instancePickingMaterial??this.#g();this.#e.renderBufferDirect(this.#s,Sa,i,r,t,null)};#v(e,t){const i=e<<0|t<<1;let n=this.#i.get(i);if(n)return n;let r=c.WdD.meshbasic_vert;return e===1&&(r=c.WdD.sprite_vert),t===1&&(r=`#define USE_SIZEATTENUATION

`+r),n=new c.jyz({vertexShader:r,fragmentShader:`
          uniform vec4 objectId;
          void main() {
            gl_FragColor = objectId;
          }
        `,side:c.ehD,uniforms:{objectId:{value:[NaN,NaN,NaN,NaN]}}}),this.#i.set(i,n),n}#g(){let t=this.#i.get(-1);if(t)return t;let i=c.WdD.meshbasic_vert;return i=i.replace("void main() {",`
      varying vec4 objectId;

      void main() {
        objectId = vec4(
          float((gl_InstanceID >> 24) & 255) / 255.0,
          float((gl_InstanceID >> 16) & 255) / 255.0,
          float((gl_InstanceID >> 8) & 255) / 255.0,
          float(gl_InstanceID & 255) / 255.0);
      `),t=new c.jyz({vertexShader:i,fragmentShader:`
          varying vec4 objectId;
          void main() {
            gl_FragColor = objectId;
          }
        `,side:c.ehD,uniforms:{objectId:{value:[NaN,NaN,NaN,NaN]}}}),this.#i.set(-1,t),t}}function Ed(s,e){const t=s.uniforms.objectId;if(!t)throw new Error("objectId uniform not found in picking material");t.value=[(e>>24&255)/255,(e>>16&255)/255,(e>>8&255)/255,(e&255)/255]}const he=new Uint32Array(1);function Ad(s){return he[0]=s|0,he[0]-=he[0]<<6,he[0]^=he[0]>>>17,he[0]-=he[0]<<9,he[0]^=he[0]<<4,he[0]-=he[0]<<3,he[0]^=he[0]<<10,he[0]^=he[0]>>>15,he[0]}class _d extends c.Tme{#e;constructor(e){super(),this.#e=new c.jyz({transparent:!0,uniforms:{color:{value:[1,0,1,1]}},vertexShader:`
        void main() {
          gl_Position = vec4(position.xy, 0.0, 1.0);
        }`,fragmentShader:`
        uniform vec4 color;
        void main() {
          gl_FragColor = color;
        }
      `});const t=e.sharedGeometry.getGeometry(this.constructor.name,Pd),i=new c.Kj0(t,this.#e);i.frustumCulled=!1,this.add(i)}setColor(e,t){const i=this.#e.uniforms.color.value;i[0]=e.r,i[1]=e.g,i[2]=e.b,i[3]=t}}function Pd(){return new c._12(2,2,1,1)}var Rd="../../packages/studio-base/src/panels/ThreeDeeRender/LayerErrors.ts";const Gt=["topics",""];class Qs{path;errorsById;children;constructor(e){this.path=e}errorMessage(){if(this.errorsById&&this.errorsById.size>0)return Array.from(this.errorsById.values()).join(", ")}errorAtPath(e){let t=this;for(const i of e)if(t=t.children?.get(i),!t)return;return t.errorMessage()}clone(){const e=new Qs(this.path);return e.errorsById=this.errorsById,e.children=this.children,e}}const Ld=R.ZP.getLogger(Rd);class Nd extends B.Z{errors=new Qs([]);add(e,t,i){let n=this.errors;for(const a of e)n.children||(n.children=new Map),n.children.has(a)||n.children.set(a,new Qs([...n.path,a])),n=n.children.get(a);n.errorsById??=new Map;const r=n.errorsById.get(t);r==null&&Ld.warn(`[${e.join(" > ")}] ${i}`),i!==r&&(n.errorsById.set(t,i),this.emit("update",e,t,i))}addToTopic(e,t,i){Gt[1]=e,this.add(Gt,t,i)}hasError(e,t){return this.#e(e)?.errorsById?.has(t)===!0}remove(e,t){const i=this.#e(e);i?.errorsById?.has(t)===!0&&(i.errorsById.delete(t),this.emit("remove",e,t))}removeFromTopic(e,t){Gt[1]=e,this.remove(Gt,t)}clearPath(e){const t=this.#e(e);if(!t)return;let i=!1;t.children&&t.children.size>0&&(t.children.clear(),i=!0),t.errorsById&&t.errorsById.size>0&&(t.errorsById.clear(),i=!0),i&&this.emit("clear",e)}clearTopic(e){Gt[1]=e,this.clearPath(Gt)}clear(){this.clearPath([])}#e(e){let t=this.errors;for(const i of e)if(t=t.children?.get(i),!t)return;return t}}class Od extends B.Z{errors=new Nd;#e=new Map;#t={children:{}};#s=[];constructor(e){super(),this.#t={children:e},this.errors.on("update",this.handleErrorUpdate),this.errors.on("remove",this.handleErrorUpdate),this.errors.on("clear",this.handleErrorUpdate)}setNodesForKey(e,t){t.forEach(i=>this.#s.forEach(n=>n(i,this.errors))),this.#t=(0,X.Uy)(this.#t,i=>{const n=this.#e.get(e);if(n)for(const{path:r}of n)Ta(i,r);for(const{path:r,node:a}of t)a.error??=this.errors.errors.errorAtPath(r),a.label??=r[r.length-1],a.defaultExpansionState??="collapsed",Fd(i,r,a)}),this.#e.set(e,t),this.emit("update")}setLabel(e,t){this.#t=(0,X.Uy)(this.#t,i=>{Ud(i,e,t)}),this.emit("update")}clearChildren(e){this.#t=(0,X.Uy)(this.#t,t=>{xa(t,e)}),this.emit("update")}tree(){return this.#t.children}handleAction=e=>{const t=e.payload.path;let i=this.#t;i.handler?.(e);for(const n of t){const r=i.children?.[n];if(!r)return;r.handler?.(e),i=r}};addNodeValidator=e=>{this.#s.push(e)};removeNodeValidator=e=>{this.#s=this.#s.filter(t=>t!==e)};handleErrorUpdate=e=>{this.#t=(0,X.Uy)(this.#t,t=>{if(e.length===0)return{...t};let i=t;for(const n of e){const r=i.children?.[n];if(!r)return i.children={...i.children},t;i=r}return i.error=this.errors.errors.errorAtPath(e),t}),this.emit("update")}}function Ta(s,e){if(e.length===0)return!1;const t=e[0],i=s.children?.[t];if(!i)return!1;if(e.length===1){const n=s.children?.[t]!=null;return n&&(s.children[t]=void 0),n}return Ta(i,e.slice(1))}function xa(s,e){if(e.length===0)return;const t=e[0],i=s.children?.[t];if(i){if(e.length===1){i.children=void 0;return}xa(i,e.slice(1))}}function Fd(s,e,t){if(e.length===0)throw new Error(`Empty path for settings node "${t.label}"`);let i=s;for(let r=0;r<e.length-1;r++){const a=e[r];i.children||(i.children={}),i.children[a]||(i.children[a]={}),i=i.children[a]}const n=e[e.length-1];i.children||(i.children={}),i.children[n]=t}function Ud(s,e,t){if(e.length===0)throw new Error(`Empty path for settings label "${t}"`);let i=s;for(let n=0;n<e.length;n++){const r=e[n];i.children||(i.children={}),i.children[r]||(i.children[r]={}),i=i.children[r]}i.label=t}class zd{#e=new Map;getGeometry(e,t){let i=this.#e.get(e);return i||(i=t(),this.#e.set(e,i)),i}dispose(){for(const e of this.#e.values())e.dispose();this.#e.clear()}}var me;(function(s){s[s.Low=0]="Low",s[s.Medium=1]="Medium",s[s.High=2]="High"})(me||(me={}));function kd(s){return s.maxSamples??0}function wa(s){switch(s){case me.Low:return 12;case me.Medium:return 20;case me.High:return 32}}function Ia(s){switch(s){case me.Low:return 12;case me.Medium:return 20;case me.High:return 32}}function jd(s){switch(s){case me.Low:return 12;case me.Medium:return 20;case me.High:return 32}}function Gd(s){switch(s){case me.Low:return 10;case me.Medium:return 24;case me.High:return 32}}var Bd=b(22041),L=b(61175),Bt=b(74354);const k=3,we=1;function Da(s,e,t){return{label:s,input:"number",min:0,step:.5,precision:k,value:e,placeholder:String(t)}}function Vd(s,e){return{label:s,input:"vec3",labels:["X","Y","Z"],step:.5,precision:k,value:e}}function Ca(s,e,t){return{label:s,input:"number",min:0,step:.005,precision:4,value:e,placeholder:String(t)}}function $d(s,e){return{label:s,input:"gradient",value:e}}const Ma="DISPLAY_FRAME_NOT_FOUND",Wd=new c.Pa4(1,0,0),Hd=new c.Pa4(0,0,1),Yd=Math.PI/2,dt=(0,L.N2)(),Zd=new c.Pa4,Ea=new c.$V,Kd=new c.USm,Tn=["general","followTf"];class Xd extends Q.d{#e;unfollowPoseSnapshot;#t;#s=!1;#i;#n;#r;#a;#o;constructor(e,t,i){super("foxglove.CameraStateSettings",e),e.on("transformTreeUpdated",this.#d),e.on("cameraMove",this.#c),e.settings.errors.on("update",this.#p),e.settings.errors.on("clear",this.#p),e.settings.errors.on("remove",this.#p),this.#i=t,this.#r=new c.cPb,this.#a=new c.iKG,this.#n=new c.ZAu,this.#n.add(this.#r),this.#n.add(this.#a),this.add(this.#n),this.#t=new Bd.z(this.#r,this.#i),this.#t.screenSpacePanning=!1,this.#t.mouseButtons.LEFT=c.RsA.PAN,this.#t.mouseButtons.RIGHT=c.RsA.ROTATE,this.#t.touches.ONE=c.QmN.PAN,this.#t.touches.TWO=c.QmN.DOLLY_ROTATE,this.#t.addEventListener("change",()=>{this.#s||e.emit("cameraMove",e)}),t.tabIndex=1e3,this.#o=i,this.#t.keys={LEFT:"KeyA",RIGHT:"KeyD",UP:"KeyW",BOTTOM:"KeyS"},this.#t.listenToKeyEvents(t)}dispose(){this.renderer.off("cameraMove",this.#c),this.renderer.off("transformTreeUpdated",this.#d),this.renderer.settings.errors.off("update",this.#p),this.renderer.settings.errors.off("clear",this.#p),this.renderer.settings.errors.off("remove",this.#p),super.dispose()}settingsNodes(){return[this.#l(),this.#h()]}#l(){const e=this.renderer.config,{cameraState:t}=e,i=this.handleSettingsAction;return{path:["cameraState"],node:{label:(0,x.t)("threeDee:view"),actions:[{type:"action",id:"reset-camera",label:(0,x.t)("threeDee:reset")}],handler:i,fields:{syncCamera:{label:(0,x.t)("threeDee:syncCamera"),input:"boolean",error:this.renderer.cameraSyncError(),value:e.scene.syncCamera??!1,help:(0,x.t)("threeDee:syncCameraHelp")},distance:{label:(0,x.t)("threeDee:distance"),input:"number",step:1,precision:k,value:t.distance},perspective:{label:(0,x.t)("threeDee:perspective"),input:"boolean",value:t.perspective},targetOffset:{label:(0,x.t)("threeDee:target"),input:"vec3",labels:["X","Y","Z"],precision:k,value:[...t.targetOffset]},thetaOffset:{label:(0,x.t)("threeDee:theta"),input:"number",step:1,precision:we,value:t.thetaOffset},...t.perspective&&{phi:{label:(0,x.t)("threeDee:phi"),input:"number",step:1,precision:we,value:t.phi},fovy:{label:(0,x.t)("threeDee:fovy"),input:"number",step:1,precision:we,value:t.fovy}},near:{label:(0,x.t)("threeDee:near"),input:"number",step:Bt.d.near,precision:k,value:t.near},far:{label:(0,x.t)("threeDee:far"),input:"number",step:1,precision:k,value:t.far}}}}}#h(){const e=this.renderer.config,t=this.handleSettingsAction;let i=this.renderer.coordinateFrameList;const n=this.renderer.followFrameId;this.#f();const r=e.followTf??n;r!=null&&!this.renderer.transformTree.hasFrame(r)&&(i=[{label:L.W$.DisplayName(r),value:r},...i]);const a=this.renderer.settings.errors.errors.errorAtPath(Tn),o=[{label:(0,x.t)("threeDee:pose"),value:"follow-pose"},{label:(0,x.t)("threeDee:position"),value:"follow-position"},{label:(0,x.t)("threeDee:fixed"),value:"follow-none"}],l=this.renderer.config.followMode;return{path:["general"],node:{label:(0,x.t)("threeDee:frame"),fields:{followTf:{label:(0,x.t)("threeDee:displayFrame"),help:(0,x.t)("threeDee:displayFrameHelp"),input:"select",options:i,value:r,error:a},followMode:{label:(0,x.t)("threeDee:followMode"),help:(0,x.t)("threeDee:followModeHelp"),input:"select",options:o,value:l}},defaultExpansionState:"expanded",handler:t}}}handleSettingsAction=e=>{if(e.action==="perform-node-action"&&e.payload.id==="reset-camera"){this.renderer.updateConfig(r=>{r.cameraState=(0,Z.cloneDeep)(Bt.d)}),this.updateSettingsTree();return}if(e.action!=="update"||e.payload.path.length===0)return;const{path:[t],path:i,value:n}=e.payload;if(t==="cameraState"&&(i[1]==="syncCamera"?this.renderer.updateConfig(r=>{r.scene.syncCamera=n}):this.renderer.updateConfig(r=>(0,Z.set)(r,i,n)),this.updateSettingsTree()),t==="general"){if(i[1]==="followTf"){const r=n;this.renderer.updateConfig(a=>{a.followTf=r}),this.#u(),this.renderer.settings.errors.clearPath(["general","followTf"])}else if(i[1]==="followMode"){const r=n;this.renderer.updateConfig(a=>{a.followMode==="follow-none"?(a.cameraState.targetOffset=[...Bt.d.targetOffset],a.cameraState.thetaOffset=Bt.d.thetaOffset):r==="follow-pose"&&(a.cameraState.thetaOffset=Bt.d.thetaOffset),a.followMode=r})}this.updateSettingsTree()}};startFrame(e,t,i){const n=this.renderer.config.followMode;if(n==="follow-pose"||i===L.W$.FALLBACK_FRAME_ID||t===L.W$.FALLBACK_FRAME_ID){this.#e=void 0,this.unfollowPoseSnapshot=void 0,this.#n.position.set(0,0,0),this.#n.quaternion.set(0,0,0,1);return}const r=this.#b(i,t,e),a=this.renderer.transformTree;if(r){if(!Boolean(a.apply(dt,r,t,i,i,e,e)))return;n==="follow-position"?this.#n.position.set(0,0,0):this.#n.position.set(dt.position.x,dt.position.y,dt.position.z),this.#n.quaternion.set(dt.orientation.x,dt.orientation.y,dt.orientation.z,dt.orientation.w)}}#c=()=>{this.updateSettingsTree()};#d=()=>{this.#u(),this.updateSettingsTree()};#u(){const{followTf:e}=this.renderer.config,{transformTree:t}=this.renderer;if(this.#f(),e!=null&&t.hasFrame(e)){this.renderer.setFollowFrameId(e);return}const n=t.getDefaultFollowFrameId();this.renderer.setFollowFrameId(n)}#f=()=>{const{followTf:e}=this.renderer.config,{transformTree:t}=this.renderer;e!=null&&(t.hasFrame(e)?this.renderer.settings.errors.remove(Tn,Ma):this.renderer.settings.errors.add(Tn,Ma,(0,x.t)("threeDee:frameNotFound",{frameId:e})))};#p=()=>{this.updateSettingsTree()};#b(e,t,i){const n=this.renderer.transformTree;return(this.#e?.fixed!==e||this.#e.render!==t)&&(this.unfollowPoseSnapshot=(0,L.N2)(),n.apply(this.unfollowPoseSnapshot,this.unfollowPoseSnapshot,e,e,t,i,i),this.#e={fixed:e,render:t}),this.unfollowPoseSnapshot}getActiveCamera(){return this.renderer.config.cameraState.perspective?this.#r:this.#a}handleResize(e,t,i){this.#o=e/t,this.setCameraState(this.renderer.config.cameraState)}getCameraState(){const e=this.renderer.config;return{perspective:e.cameraState.perspective,distance:this.#t.getDistance(),phi:c.M8C.radToDeg(this.#t.getPolarAngle()),thetaOffset:c.M8C.radToDeg(-this.#t.getAzimuthalAngle()),targetOffset:[this.#t.target.x,this.#t.target.y,this.#t.target.z],target:e.cameraState.target,targetOrientation:e.cameraState.targetOrientation,fovy:e.cameraState.fovy,near:e.cameraState.near,far:e.cameraState.far}}setCameraState(e){this.#s=!0,this.#m(e),this.renderer.config.followMode==="follow-pose"&&this.#t.update(),this.#s=!1}#m(e){const t=Zd,i=this.renderer.config;t.fromArray(e.targetOffset);const n=c.M8C.degToRad(e.phi),r=-c.M8C.degToRad(e.thetaOffset);if(Ea.set(e.distance,n,r),this.#r.position.setFromSpherical(Ea).applyAxisAngle(Wd,Yd),this.#r.position.add(t),this.#r.quaternion.setFromEuler(Kd.set(n,0,r,"ZYX")),this.#r.fov=e.fovy,this.#r.near=e.near,this.#r.far=e.far,this.#r.aspect=this.#o,this.#r.updateProjectionMatrix(),this.#t.target.copy(t),e.perspective)this.#t.minPolarAngle=0,this.#t.maxPolarAngle=Math.PI;else{const a=c.M8C.degToRad(i.cameraState.phi);this.#t.minPolarAngle=this.#t.maxPolarAngle=a,this.#a.position.set(t.x,t.y,e.far/2),this.#a.quaternion.setFromAxisAngle(Hd,r),this.#a.left=-e.distance/2*this.#o,this.#a.right=e.distance/2*this.#o,this.#a.top=e.distance/2,this.#a.bottom=-e.distance/2,this.#a.near=e.near,this.#a.far=e.far,this.#a.updateProjectionMatrix()}}}function Aa(s,e,t,i,n,r){r[n]=s+1.402*i,r[n+1]=s-.34414*e-.71414*i,r[n+2]=s+1.772*e,r[n+3]=255,r[n+4]=t+1.402*i,r[n+5]=t-.34414*e-.71414*i,r[n+6]=t+1.772*e,r[n+7]=255}function Jd(s,e,t,i){let n=0,r=0;const a=t*e;for(let o=0;o<=a;o+=2){const l=s[r]-128,d=s[r+1],h=s[r+2]-128,f=s[r+3];Aa(d,l,f,h,n,i),n+=8,r+=4}}function Qd(s,e,t,i){let n=0,r=0;const a=t*e;for(let o=0;o<=a;o+=2){const l=s[r],d=s[r+1]-128,h=s[r+2],f=s[r+3]-128;Aa(l,d,h,f,n,i),n+=8,r+=4}}function qd(s,e,t,i){let n=0,r=0;for(let a=0;a<e*t;a++){const o=s[n++],l=s[n++],d=s[n++];i[r++]=o,i[r++]=l,i[r++]=d,i[r++]=255}}function eh(s,e,t,i){let n=0,r=0;for(let a=0;a<e*t;a++){const o=s[n++],l=s[n++],d=s[n++],h=s[n++];i[r++]=o,i[r++]=l,i[r++]=d,i[r++]=h}}function th(s,e,t,i){let n=0,r=0;for(let a=0;a<e*t;a++){const o=s[n++],l=s[n++],d=s[n++],h=s[n++];i[r++]=d,i[r++]=l,i[r++]=o,i[r++]=h}}function sh(s,e,t,i){let n=0,r=0;for(let a=0;a<e*t;a++){const o=s[n++],l=s[n++],d=s[n++];i[r++]=d,i[r++]=l,i[r++]=o,i[r++]=255}}function ih(s,e,t,i,n){const r=new DataView(s.buffer,s.byteOffset);let a=0;for(let o=0;o<e*t*4;o+=4){const l=r.getFloat32(o,!i)*255;n[a++]=l,n[a++]=l,n[a++]=l,n[a++]=255}}function nh(s,e,t,i){let n=0,r=0;for(let a=0;a<e*t;a++){const o=s[n++];i[r++]=o,i[r++]=o,i[r++]=o,i[r++]=255}}function rh(s,e,t,i,n,r){const a=new DataView(s.buffer,s.byteOffset),o=r?.minValue??0;let l=r?.maxValue??1e4;l===o&&(l=o+1);let d=0;for(let h=0;h<e*t*2;h+=2){let f=a.getUint16(h,!i);f=(f-o)/(l-o)*255,n[d++]=f,n[d++]=f,n[d++]=f,n[d++]=255}}function qs(s,e,t,i){return new Function("data","width","height","output",`
  for (let i = 0; i < height / 2; i++) {
    let inIdx = i * 2 * width;
    let outTopIdx = i * 2 * width * 4; // Addresses top row
    let outBottomIdx = (i * 2 + 1) * width * 4; // Addresses bottom row
    for (let j = 0; j < width / 2; j++) {
      const tl = data[inIdx++];
      const tr = data[inIdx++];
      const bl = data[inIdx + width - 2];
      const br = data[inIdx + width - 1];

      const ${s} = tl;
      const ${e} = tr;
      const ${t} = bl;
      const ${i} = br;

      // Top row
      output[outTopIdx++] = r;
      output[outTopIdx++] = g0;
      output[outTopIdx++] = b;
      output[outTopIdx++] = 255;

      output[outTopIdx++] = r;
      output[outTopIdx++] = g0;
      output[outTopIdx++] = b;
      output[outTopIdx++] = 255;

      // Bottom row
      output[outBottomIdx++] = r;
      output[outBottomIdx++] = g1;
      output[outBottomIdx++] = b;
      output[outBottomIdx++] = 255;

      output[outBottomIdx++] = r;
      output[outBottomIdx++] = g1;
      output[outBottomIdx++] = b;
      output[outBottomIdx++] = 255;
    }
  }`)}const ah=qs("r","g0","g1","b"),oh=qs("b","g0","g1","r"),lh=qs("g0","b","r","g1"),ch=qs("g0","r","b","g1");class xn{D;K;P;R;width;height;constructor(e){const{binning_x:t,binning_y:i,roi:n,distortion_model:r,D:a,K:o,P:l,R:d,width:h,height:f}=e,p=l[0],u=l[5];if(h<=0||f<=0)throw new Error(`Invalid image size ${h}x${f}`);if(r.length>0&&r!=="plumb_bob"&&r!=="rational_polynomial")throw new Error(`Unrecognized distortion_model "${r}"`);if(o.length!==0&&o.length!==9)throw new Error(`K.length=${o.length}, expected 9`);if(l.length!==12)throw new Error(`P.length=${o.length}, expected 12`);if(d.length!==0&&d.length!==9)throw new Error(`R.length=${d.length}, expected 9`);if(p===0||u===0)throw new Error(`Invalid focal length (fx=${p}, fy=${u})`);const m=[...a];for(;m.length<8;)m.push(0);this.D=m,this.K=o.length===9?o:[1,0,0,0,1,0,0,0,1],this.P=l,this.R=d.length===9?d:[1,0,0,0,1,0,0,0,1],this.width=h,this.height=f;const g=t!==0?t:1,y=i!==0?i:1,S=g>1||y>1,D=n.x_offset!==0||n.y_offset!==0;if(S||D)throw new Error("Failed to initialize camera model: unable to handle adjusted binning and adjusted roi camera models.")}projectPixelTo3dPlane(e,t){const i=this.P,n=i[0],r=i[5],a=i[2],o=i[6],l=i[3],d=i[7];return e.x=(t.x-a-l)/n,e.y=(t.y-o-d)/r,e.z=1,e}projectPixelTo3dRay(e,t){this.projectPixelTo3dPlane(e,t);const i=1/Math.sqrt(e.x*e.x+e.y*e.y+e.z*e.z);return e.x*=i,e.y*=i,e.z*=i,e}undistortPixel(e,t,i=5){const{P:n,D:r}=this,[a,o,l,d,h]=r,f=n[0],p=n[5],u=n[2],m=n[6];let g=(t.x-u)/f,y=(t.y-m)/p;const S=g,D=y,A=a!==0||o!==0||l!==0||d!==0||h!==0?i:1;for(let M=0;M<A;M++){const I=g*g+y*y,P=1/(1+a*I+o*I*I+h*I*I*I),O=2*l*g*y+d*(I+2*g*g),z=l*(I+2*y*y)+2*d*g*y;g=(S-O)*P,y=(D-z)*P}return e.x=g*f+u,e.y=y*p+m,e}distortPixel(e,t){e.x=t.x,e.y=t.y;const{P:i,R:n,D:r,K:a}=this,o=i[0],l=i[5],d=i[2],h=i[6],f=i[3],p=i[7],u=(t.x-d-f)/o,m=(t.y-h-p)/l,g=n[0]*u+n[1]*m+n[2],y=n[3]*u+n[4]*m+n[5],S=n[6]*u+n[7]*m+n[8],D=g/S,A=y/S,M=D*D+A*A,I=M*M,P=I*M,O=2*D*A,z=r[0],Y=r[1],oe=r[2],rt=r[3],Qe=r[4];let yt=1+z*M+Y*I+Qe*P;yt/=1+r[5]*M+r[6]*I+r[7]*P;const $e=D*yt+oe*O+rt*(M+2*(D*D)),ks=A*yt+oe*(M+2*(A*A))+rt*O;return e.x=$e*a[0]+a[2],e.y=ks*a[4]+a[5],e}}var ps=b(8052),ms=b(16896);const ei=new c.Ilk,ti=new c.Ilk,st=[0,0,0,0];function Ge(s,e,t){return`${s}:${e?e+":":""}${t}`.replace(/\s/g,"_")}class Re extends F{constructor(e,t,i,n){const r=Ge(e,t.ns,t.id),a=t.lifetime.sec!==0||t.lifetime.nsec!==0;super(r,n,{receiveTime:i??0n,messageTime:(0,w.toNanoSec)(t.header.stamp),frameId:n.normalizeFrameId(t.header.frame_id),pose:t.pose,settingsPath:["topics",e],settings:{visible:!0,frameLocked:t.frame_locked},topic:e,marker:t,originalMarker:t,expiresIn:a?(0,w.toNanoSec)(t.lifetime):void 0})}idFromMessage(){return this.userData.marker.id}selectedIdVariable(){return this.getSettings()?.selectedIdVariable}getSettings(){return this.renderer.config.topics[this.userData.topic]}details(){return this.userData.originalMarker}update(e,t){const i=e.lifetime.sec!==0||e.lifetime.nsec!==0;t!=null&&(this.userData.receiveTime=t),this.userData.messageTime=(0,w.toNanoSec)(e.header.stamp),this.userData.frameId=this.renderer.normalizeFrameId(e.header.frame_id),this.userData.pose=e.pose,this.userData.marker=this.#e(e),this.userData.originalMarker=e,this.userData.expiresIn=i?(0,w.toNanoSec)(e.lifetime):void 0}_markerColorsToLinear(e,t,i){fe(ei,e.color);for(let n=0;n<t;n++){const r=e.colors[n];r?(fe(ti,r),st[0]=ti.r,st[1]=ti.g,st[2]=ti.b,st[3]=r.a):(st[0]=ei.r,st[1]=ei.g,st[2]=ei.b,st[3]=e.color.a),i(st,n)}}#e(e){const t=this.userData.topic,n=this.renderer.config.topics[t]?.color;if(n==null)return e;const r=N(ie(),n);return{...e,color:r,colors:[]}}}c.rBU.line={worldUnits:{value:1},linewidth:{value:1},resolution:{value:new c.FM8(1,1)},dashOffset:{value:0},dashScale:{value:1},dashSize:{value:1},gapSize:{value:1}},c.Vj0["foxglove.line"]={uniforms:c.rDY.merge([c.rBU.common,c.rBU.fog,c.rBU.line]),vertexShader:`
    #include <common>
    #include <color_pars_vertex>
    #include <fog_pars_vertex>
    #include <logdepthbuf_pars_vertex>
    #include <clipping_planes_pars_vertex>

    uniform float linewidth;
    uniform vec2 resolution;

    attribute vec3 instanceStart;
    attribute vec3 instanceEnd;

    attribute vec4 instanceColorStart;
    attribute vec4 instanceColorEnd;

    #ifdef WORLD_UNITS

      varying vec4 worldPos;
      varying vec3 worldStart;
      varying vec3 worldEnd;

      #ifdef USE_DASH

        varying vec2 vUv;

      #endif

    #else

      varying vec2 vUv;

    #endif

    #ifdef USE_DASH

      uniform float dashScale;
      attribute float instanceDistanceStart;
      attribute float instanceDistanceEnd;
      varying float vLineDistance;

    #endif

    #ifdef USE_COLOR

      varying float vAlpha;

    #endif

    void trimSegment( const in vec4 start, inout vec4 end ) {

      // trim end segment so it terminates between the camera plane and the near plane

      // conservative estimate of the near plane
      float a = projectionMatrix[ 2 ][ 2 ]; // 3nd entry in 3th column
      float b = projectionMatrix[ 3 ][ 2 ]; // 3nd entry in 4th column
      float nearEstimate = - 0.5 * b / a;

      float alpha = ( nearEstimate - start.z ) / ( end.z - start.z );

      end.xyz = mix( start.xyz, end.xyz, alpha );

    }

    void main() {

      #ifdef USE_COLOR

        vColor.xyz = ( position.y < 0.5 ) ? instanceColorStart.xyz : instanceColorEnd.xyz;
        vAlpha = ( position.y < 0.5 ) ? instanceColorStart.w : instanceColorEnd.w;

      #endif

      #ifdef USE_DASH

        vLineDistance = ( position.y < 0.5 ) ? dashScale * instanceDistanceStart : dashScale * instanceDistanceEnd;
        vUv = uv;

      #endif

      float aspect = resolution.x / resolution.y;

      // camera space
      vec4 start = modelViewMatrix * vec4( instanceStart, 1.0 );
      vec4 end = modelViewMatrix * vec4( instanceEnd, 1.0 );

      #ifdef WORLD_UNITS

        worldStart = start.xyz;
        worldEnd = end.xyz;

      #else

        vUv = uv;

      #endif

      // special case for perspective projection, and segments that terminate either in, or behind, the camera plane
      // clearly the gpu firmware has a way of addressing this issue when projecting into ndc space
      // but we need to perform ndc-space calculations in the shader, so we must address this issue directly
      // perhaps there is a more elegant solution -- WestLangley

      bool perspective = ( projectionMatrix[ 2 ][ 3 ] == - 1.0 ); // 4th entry in the 3rd column

      if ( perspective ) {

        if ( start.z < 0.0 && end.z >= 0.0 ) {

          trimSegment( start, end );

        } else if ( end.z < 0.0 && start.z >= 0.0 ) {

          trimSegment( end, start );

        }

      }

      // clip space
      vec4 clipStart = projectionMatrix * start;
      vec4 clipEnd = projectionMatrix * end;

      // ndc space
      vec3 ndcStart = clipStart.xyz / clipStart.w;
      vec3 ndcEnd = clipEnd.xyz / clipEnd.w;

      // direction
      vec2 dir = ndcEnd.xy - ndcStart.xy;

      // account for clip-space aspect ratio
      dir.x *= aspect;
      dir = normalize( dir );

      #ifdef WORLD_UNITS

        // get the offset direction as perpendicular to the view vector
        vec3 worldDir = normalize( end.xyz - start.xyz );
        vec3 offset;
        if ( position.y < 0.5 ) {

          offset = normalize( cross( start.xyz, worldDir ) );

        } else {

          offset = normalize( cross( end.xyz, worldDir ) );

        }

        // sign flip
        if ( position.x < 0.0 ) offset *= - 1.0;

        float forwardOffset = dot( worldDir, vec3( 0.0, 0.0, 1.0 ) );

        // don't extend the line if we're rendering dashes because we
        // won't be rendering the endcaps
        #ifndef USE_DASH

          // extend the line bounds to encompass  endcaps
          start.xyz += - worldDir * linewidth * 0.5;
          end.xyz += worldDir * linewidth * 0.5;

          // shift the position of the quad so it hugs the forward edge of the line
          offset.xy -= dir * forwardOffset;
          offset.z += 0.5;

        #endif

        // endcaps
        if ( position.y > 1.0 || position.y < 0.0 ) {

          offset.xy += dir * 2.0 * forwardOffset;

        }

        // adjust for linewidth
        offset *= linewidth * 0.5;

        // set the world position
        worldPos = ( position.y < 0.5 ) ? start : end;
        worldPos.xyz += offset;

        // project the worldpos
        vec4 clip = projectionMatrix * worldPos;

        // shift the depth of the projected points so the line
        // segements overlap neatly
        vec3 clipPose = ( position.y < 0.5 ) ? ndcStart : ndcEnd;
        clip.z = clipPose.z * clip.w;

      #else

        vec2 offset = vec2( dir.y, - dir.x );
        // undo aspect ratio adjustment
        dir.x /= aspect;
        offset.x /= aspect;

        // sign flip
        if ( position.x < 0.0 ) offset *= - 1.0;

        // endcaps
        if ( position.y < 0.0 ) {

          offset += - dir;

        } else if ( position.y > 1.0 ) {

          offset += dir;

        }

        // adjust for linewidth
        offset *= linewidth;

        // adjust for clip-space to screen-space conversion // maybe resolution should be based on viewport ...
        offset /= resolution.y;

        // select end
        vec4 clip = ( position.y < 0.5 ) ? clipStart : clipEnd;

        // back to clip space
        offset *= clip.w;

        clip.xy += offset;

      #endif

      gl_Position = clip;

      vec4 mvPosition = ( position.y < 0.5 ) ? start : end; // this is an approximation

      #include <logdepthbuf_vertex>
      #include <clipping_planes_vertex>
      #include <fog_vertex>

    }
    `,fragmentShader:`
    uniform vec3 diffuse;
    uniform float opacity;
    uniform float linewidth;

    #ifdef USE_DASH

      uniform float dashOffset;
      uniform float dashSize;
      uniform float gapSize;

    #endif

    varying float vLineDistance;

    #ifdef WORLD_UNITS

      varying vec4 worldPos;
      varying vec3 worldStart;
      varying vec3 worldEnd;

      #ifdef USE_DASH

        varying vec2 vUv;

      #endif

    #else

      varying vec2 vUv;

    #endif

    #ifdef USE_COLOR

      varying float vAlpha;

    #endif

    #include <common>
    #include <color_pars_fragment>
    #include <fog_pars_fragment>
    #include <logdepthbuf_pars_fragment>
    #include <clipping_planes_pars_fragment>

    vec2 closestLineToLine(vec3 p1, vec3 p2, vec3 p3, vec3 p4) {

      float mua;
      float mub;

      vec3 p13 = p1 - p3;
      vec3 p43 = p4 - p3;

      vec3 p21 = p2 - p1;

      float d1343 = dot( p13, p43 );
      float d4321 = dot( p43, p21 );
      float d1321 = dot( p13, p21 );
      float d4343 = dot( p43, p43 );
      float d2121 = dot( p21, p21 );

      float denom = d2121 * d4343 - d4321 * d4321;

      float numer = d1343 * d4321 - d1321 * d4343;

      mua = numer / denom;
      mua = clamp( mua, 0.0, 1.0 );
      mub = ( d1343 + d4321 * ( mua ) ) / d4343;
      mub = clamp( mub, 0.0, 1.0 );

      return vec2( mua, mub );

    }

    void main() {

      #include <clipping_planes_fragment>

      #ifdef USE_DASH

        if ( vUv.y < - 1.0 || vUv.y > 1.0 ) discard; // discard endcaps

        if ( mod( vLineDistance + dashOffset, dashSize + gapSize ) > dashSize ) discard; // todo - FIX

      #endif

      #ifdef USE_COLOR

      float alpha = vAlpha;

      #else

      float alpha = opacity;

      #endif

      #ifdef WORLD_UNITS

        // Find the closest points on the view ray and the line segment
        vec3 rayEnd = normalize( worldPos.xyz ) * 1e5;
        vec3 lineDir = worldEnd - worldStart;
        vec2 params = closestLineToLine( worldStart, worldEnd, vec3( 0.0, 0.0, 0.0 ), rayEnd );

        vec3 p1 = worldStart + lineDir * params.x;
        vec3 p2 = rayEnd * params.y;
        vec3 delta = p1 - p2;
        float len = length( delta );
        float norm = len / linewidth;

        #ifndef USE_DASH

          #ifdef USE_ALPHA_TO_COVERAGE

            float dnorm = fwidth( norm );
            alpha = 1.0 - smoothstep( 0.5 - dnorm, 0.5 + dnorm, norm );

          #else

            if ( norm > 0.5 ) {

              discard;

            }

          #endif

        #endif

      #else

        #ifdef USE_ALPHA_TO_COVERAGE

          // artifacts appear on some hardware if a derivative is taken within a conditional
          float a = vUv.x;
          float b = ( vUv.y > 0.0 ) ? vUv.y - 1.0 : vUv.y + 1.0;
          float len2 = a * a + b * b;
          float dlen = fwidth( len2 );

          if ( abs( vUv.y ) > 1.0 ) {

            alpha = 1.0 - smoothstep( 1.0 - dlen, 1.0 + dlen, len2 );

          }

        #else

          if ( abs( vUv.y ) > 1.0 ) {

            float a = vUv.x;
            float b = ( vUv.y > 0.0 ) ? vUv.y - 1.0 : vUv.y + 1.0;
            float len2 = a * a + b * b;

            if ( len2 > 1.0 ) discard;

          }

        #endif

      #endif

      vec4 diffuseColor = vec4( diffuse, alpha );

      #include <logdepthbuf_fragment>
      #include <color_fragment>

      gl_FragColor = vec4( diffuseColor.rgb, alpha );

      #include <tonemapping_fragment>
      #include <encodings_fragment>
      #include <fog_fragment>
      #include <premultiplied_alpha_fragment>

    }
    `};class si extends c.jyz{isLineMaterial=!0;constructor(e){super({type:"LineMaterial",uniforms:c.rDY.clone(c.Vj0["foxglove.line"].uniforms),vertexShader:c.Vj0["foxglove.line"].vertexShader,fragmentShader:c.Vj0["foxglove.line"].fragmentShader,clipping:!0}),this.setValues(e)}get color(){return this.uniforms.diffuse.value}set color(e){this.uniforms.diffuse.value=e}get worldUnits(){return"WORLD_UNITS"in this.defines}set worldUnits(e){e?this.defines.WORLD_UNITS="":delete this.defines.WORLD_UNITS}get lineWidth(){return this.uniforms.linewidth.value}set lineWidth(e){this.linewidth=e,this.uniforms.linewidth.value=e}get dashed(){return Boolean("USE_DASH"in this.defines)}set dashed(e){Boolean(e)!==Boolean("USE_DASH"in this.defines)&&(this.needsUpdate=!0),e?this.defines.USE_DASH="":delete this.defines.USE_DASH}get dashScale(){return this.uniforms.dashScale.value}set dashScale(e){this.uniforms.dashScale.value=e}get dashSize(){return this.uniforms.dashSize.value}set dashSize(e){this.uniforms.dashSize.value=e}get dashOffset(){return this.uniforms.dashOffset.value}set dashOffset(e){this.uniforms.dashOffset.value=e}get gapSize(){return this.uniforms.gapSize.value}set gapSize(e){this.uniforms.gapSize.value=e}get resolution(){return this.uniforms.resolution.value}set resolution(e){this.uniforms.resolution.value.copy(e)}}function ae(s){switch(s.type){case _.ARROW:case _.CUBE:case _.SPHERE:case _.CYLINDER:case _.TEXT_VIEW_FACING:case _.MESH_RESOURCE:return s.color.a<1;case _.LINE_STRIP:case _.LINE_LIST:case _.CUBE_LIST:case _.SPHERE_LIST:case _.POINTS:case _.TRIANGLE_LIST:default:for(const e of s.colors)if(e.a<1)return!0;return s.colors.length>=s.points.length?!1:s.color.a<1}}function Vt(s){return new c.Wid({color:new c.Ilk(s.r,s.g,s.b).convertSRGBToLinear(),metalness:0,roughness:1,dithering:!0,opacity:s.a,transparent:s.a<1,depthWrite:s.a===1})}function dh(s){const e=ae(s);return new c.Wid({metalness:0,roughness:1,dithering:!0,vertexColors:!0,side:c.ehD,opacity:1,transparent:e,depthWrite:!e})}function _a(s){const e=ae(s);return new c.Wid({metalness:0,roughness:1,dithering:!0,opacity:1,transparent:e,depthWrite:!e})}function Pa(s,e){const t=s.scale.x,i=ae(s),n=new si({worldUnits:e.worldUnits??!0,colorWrite:!1,transparent:i,depthWrite:!i,linewidth:t,resolution:e.resolution.clone(),stencilWrite:!0,stencilRef:1,stencilZPass:c.ce8});return n.lineWidth=t,n}function Ra(s,e){const t=s.scale.x,i=ae(s),n=new si({worldUnits:e.worldUnits??!0,vertexColors:!0,linewidth:t,transparent:i,depthWrite:!i,resolution:e.resolution.clone(),stencilWrite:!0,stencilRef:0,stencilFunc:c.RvT,stencilFail:c.ce8,stencilZPass:c.ce8});return n.lineWidth=t,n}function wn(s,e){return new c.jyz({vertexShader:c.Vj0["foxglove.line"].vertexShader,fragmentShader:`
      uniform vec4 objectId;
      void main() {
        gl_FragColor = objectId;
      }
    `,clipping:!0,uniforms:{objectId:{value:[NaN,NaN,NaN,NaN]},linewidth:{value:s},resolution:{value:e.resolution.clone()},dashOffset:{value:0},dashScale:{value:1},dashSize:{value:1},gapSize:{value:1}},defines:e.worldUnits??!0?{WORLD_UNITS:""}:{}})}function hh(s){const e=ae(s);return new c.UY4({vertexColors:!0,size:s.scale.x,sizeAttenuation:!0,transparent:e,depthWrite:!e})}class In extends Re{#e;#t;#s;#i=new Float32Array;#n=new Uint8Array;constructor(e,t,i,n,r={}){super(e,t,i,n),this.#e=new ms.z;const{worldUnits:a=!0}=r,o={resolution:this.renderer.input.canvasSize,worldUnits:a},l=Pa(t,o);this.#t=new ps.w(this.#e,l),this.#t.renderOrder=1,this.#t.userData.picking=!1,this.add(this.#t);const d=Ra(t,o);this.#s=new ps.w(this.#e,d),this.#s.renderOrder=2;const h=t.scale.x*1.2;this.#s.userData.pickingMaterial=wn(h,o),this.add(this.#s),this.update(t,i)}dispose(){this.#t.material.dispose(),this.#s.material.dispose(),this.#s.userData.pickingMaterial.dispose(),this.#e.dispose()}update(e,t){const i=this.userData.marker;super.update(e,t);const n=this.userData.marker;let r=n.points.length;r%2!==0&&r--;const a=n.scale.x,o=ae(n);o!==ae(i)&&(this.#t.material.transparent=o,this.#t.material.depthWrite=!o,this.#t.material.needsUpdate=!0,this.#s.material.transparent=o,this.#s.material.depthWrite=!o,this.#s.material.needsUpdate=!0);const l=this.#t.material;l.lineWidth=a;const d=this.#s.material;d.lineWidth=a;const h=this.#i.length/3;r>h&&(this.#e.dispose(),this.#e=new ms.z,this.#t.geometry=this.#e,this.#s.geometry=this.#e),this.#r(n,r),this.#a(n,r),this.#s.computeLineDistances()}#r(e,t){3*t>this.#i.length&&(this.#i=new Float32Array(3*t));const i=this.#i;for(let n=0;n<t;n++){const r=e.points[n],a=n*3;i[a+0]=r.x,i[a+1]=r.y,i[a+2]=r.z}this.#e.setPositions(i),this.#e.instanceCount=t>>>1}#a(e,t){if(4*t>this.#n.length){this.#n=new Uint8Array(4*t);const n=new c.$TI(this.#n,8,1);this.#e.setAttribute("instanceColorStart",new c.kB5(n,4,0,!0)),this.#e.setAttribute("instanceColorEnd",new c.kB5(n,4,4,!0))}else this.#e.getAttribute("instanceColorStart").needsUpdate=!0,this.#e.getAttribute("instanceColorEnd").needsUpdate=!0;const i=this.#n;this._markerColorsToLinear(e,t,(n,r)=>{const a=r*4;i[a+0]=Math.floor(255*n[0]),i[a+1]=Math.floor(255*n[1]),i[a+2]=Math.floor(255*n[2]),i[a+3]=Math.floor(255*n[3])})}}const gs={x:0,y:0},La={x:0,y:0,z:0},Na={x:0,y:0,z:0};function Mt(s,e,t,i){return t.undistortPixel(gs,e),i.planarProjectionFactor===0?t.projectPixelTo3dRay(s,gs):i.planarProjectionFactor===1?t.projectPixelTo3dPlane(s,gs):(t.projectPixelTo3dRay(La,gs),t.projectPixelTo3dPlane(Na,gs),fh(s,La,Na,i.planarProjectionFactor)),ph(s,i.distance),s}function Dn(s,e){if(!s||!e)return s===e;if(s===e)return!0;if(!(s.header.frame_id===e.header.frame_id&&s.width===e.width&&s.height===e.height&&s.distortion_model===e.distortion_model&&s.binning_x===e.binning_x&&s.binning_y===e.binning_y&&s.roi.x_offset===e.roi.x_offset&&s.roi.y_offset===e.roi.y_offset&&s.roi.height===e.roi.height&&s.roi.width===e.roi.width&&s.roi.do_rectify===e.roi.do_rectify&&s.D.length===e.D.length))return!1;for(let t=0;t<s.D.length;t++)if(s.D[t]!==e.D[t])return!1;for(let t=0;t<9;t++)if(s.K[t]!==e.K[t])return!1;for(let t=0;t<9;t++)if(s.R[t]!==e.R[t])return!1;for(let t=0;t<12;t++)if(s.P[t]!==e.P[t])return!1;return!0}function ii(s){const e=s.D??s.d,t=s.K??s.k,i=s.R??s.r,n=s.P??s.p,r=e?.length??0,a=t?.length??0,o=i?.length??0,l=n?.length??0;return{header:"timestamp"in s?{stamp:de(s.timestamp),frame_id:s.frame_id??""}:Pe(s.header),height:s.height??0,width:s.width??0,distortion_model:s.distortion_model??"",D:r>0?e:[],K:a===9?t:[],R:o===9?i:[],P:l===12?n:[],binning_x:s.binning_x??0,binning_y:s.binning_y??0,roi:uh(s.roi)}}function uh(s){return s?{x_offset:s.x_offset??0,y_offset:s.y_offset??0,height:s.height??0,width:s.width??0,do_rectify:s.do_rectify??!1}:{x_offset:0,y_offset:0,height:0,width:0,do_rectify:!1}}function fh(s,e,t,i){s.x=e.x+(t.x-e.x)*i,s.y=e.y+(t.y-e.y)*i,s.z=e.z+(t.z-e.z)*i}function ph(s,e){s.x*=e,s.y*=e,s.z*=e}var mh="../../packages/studio-base/src/panels/ThreeDeeRender/renderables/Cameras.ts";const gh=R.ZP.getLogger(mh),Oa=1,Fa=0,Ua=.01,bh={r:124/255,g:107/255,b:1,a:1},za=ne(bh),Cn="CameraModel",Mn={visible:!1,frameLocked:!0,distance:Oa,planarProjectionFactor:Fa,width:Ua,color:za};class yh extends F{dispose(){this.userData.lines?.dispose(),super.dispose()}details(){return this.userData.originalMessage??{}}}class vh extends Q.d{constructor(e){super("foxglove.Cameras",e)}getSubscriptions(){return[{type:"schema",schemaNames:kt,subscription:{handler:this.#e}},{type:"schema",schemaNames:Ft,subscription:{handler:this.#e}}]}settingsNodes(){const e=this.renderer.config.topics,t=this.handleSettingsAction,i=[];for(const n of this.renderer.topics??[]){if(!($(n,kt)||$(n,Ft)))continue;const r=e[n.name]??{},a={distance:{label:"Distance",input:"number",placeholder:String(Oa),step:.1,precision:k,value:r.distance},planarProjectionFactor:{label:"Planar Projection Factor",input:"number",placeholder:String(Fa),min:0,max:1,step:.1,precision:2,value:r.planarProjectionFactor},width:Ca("Line Width",r.width,Ua),color:{label:"Color",input:"rgba",value:r.color??za}};i.push({path:["topics",n.name],node:{icon:"Camera",fields:a,visible:r.visible??Mn.visible,handler:t,order:n.name.toLocaleLowerCase()}})}return i}handleSettingsAction=e=>{const t=e.payload.path;if(e.action!=="update"||t.length!==3)return;this.saveSetting(t,e.payload.value);const i=t[1],n=this.renderables.get(i);if(n){const{cameraInfo:r,receiveTime:a,originalMessage:o}=n.userData;if(r){const l=this.renderer.config.topics[i];this.#t(n,r,o,a,l)}}};#e=e=>{const t=e.topic,i=ii(e.message),n=(0,w.toNanoSec)(e.receiveTime);let r=this.renderables.get(t);if(!r){const a=(0,w.toNanoSec)(i.header.stamp),o=this.renderer.normalizeFrameId(i.header.frame_id),l=this.renderer.config.topics[t],d={...Mn,...l};r=new yh(t,this.renderer,{receiveTime:n,messageTime:a,frameId:o,pose:(0,L.N2)(),settingsPath:["topics",t],settings:d,topic:t,cameraInfo:void 0,originalMessage:void 0,cameraModel:void 0,lines:void 0}),this.add(r),this.renderables.set(t,r)}this.#t(r,i,e.message,n,r.userData.settings)};#t(e,t,i,n,r){const a=e.userData.settings,o={...Mn,...r},l=o.color===a.color&&o.distance===a.distance&&o.planarProjectionFactor===a.planarProjectionFactor&&o.width===a.width,d=e.userData.topic;e.userData.receiveTime=n,e.userData.messageTime=(0,w.toNanoSec)(t.header.stamp),e.userData.frameId=this.renderer.normalizeFrameId(t.header.frame_id),e.userData.settings=o;const h=Dn(e.userData.cameraInfo,t);if(!h)if(e.userData.cameraInfo=t,e.userData.originalMessage=i,t.P.length===12)try{e.userData.cameraModel=new xn(t)}catch(f){const p=f;this.renderer.settings.errors.addToTopic(d,Cn,p.message),e.userData.cameraModel=void 0,e.userData.lines&&(e.remove(e.userData.lines),e.userData.lines.dispose(),e.userData.lines=void 0)}else this.renderer.settings.errors.addToTopic(d,Cn,`P has length ${t.P.length}, not a 3x4 matrix`);if(e.userData.cameraModel!=null&&(!h||!l||!e.userData.lines)){this.renderer.settings.errors.removeFromTopic(d,Cn);const f=Sh(t,e.userData.cameraModel,e.userData.settings);e.userData.lines?e.userData.lines.update(f,void 0):(e.userData.lines=new In(d,f,void 0,this.renderer),e.add(e.userData.lines))}}}function $t(){return{x:0,y:0,z:0}}function Sh(s,e,t,i=10){const n={x:0,y:0},r=Mt($t(),n,e,t);n.x=s.width,n.y=0;const a=Mt($t(),n,e,t);n.x=0,n.y=s.height;const o=Mt($t(),n,e,t);n.x=s.width,n.y=s.height;const l=Mt($t(),n,e,t),d={x:0,y:0,z:0},h=[d,r,d,a,d,l,d,o];return h.push(r),ka(h,0,s,e,i,t),h.push(a),h.push(o),ka(h,s.height,s,e,i,t),h.push(l),h.push(r),ja(h,0,s,e,i,t),h.push(o),h.push(a),ja(h,s.width,s,e,i,t),h.push(l),{header:s.header,ns:"",id:0,type:_.LINE_LIST,action:re.ADD,pose:(0,L.N2)(),scale:{x:t.width,y:t.width,z:t.width},color:N(ie(),t.color),lifetime:ct,frame_locked:!0,points:h,colors:[],text:"",mesh_resource:"",mesh_use_embedded_materials:!1}}function ka(s,e,t,i,n,r){const a={x:0,y:0};for(let o=1;o<n;o++){a.x=o/n*t.width,a.y=e;const l=Mt($t(),a,i,r);s.push(l,l)}}function ja(s,e,t,i,n,r){const a={x:0,y:0};for(let o=1;o<n;o++){a.x=e,a.y=o/n*t.height;const l=Mt($t(),a,i,r);s.push(l,l)}}var ni=b(59677),Wt=b(11932),ri=b(40740);const bs=.154,Ga=.02,Ba=.046,Va=.05,ys=bs+Ba,$a=new c.Ilk(10238280).convertSRGBToLinear(),Wa=new c.Ilk(8969476).convertSRGBToLinear(),Ha=new c.Ilk(2855163).convertSRGBToLinear(),Ya={r:1,g:1,b:1,a:1},Ht=Math.PI/2,it=new c.yGw,ht=new c.Pa4;class vs extends c.Tme{#e;#t;#s;constructor(e,t){super(),this.name=e,this.#e=t;const i=this.#e.sharedGeometry.getGeometry(`${this.constructor.name}-shaft-${this.#e.maxLod}`,()=>Th(this.#e.maxLod));this.#t=new c.SPe(i,Za(Ya),3),this.#t.castShadow=!0,this.#t.receiveShadow=!0;const n=this.#e.sharedGeometry.getGeometry(`${this.constructor.name}-head-${this.#e.maxLod}`,()=>xh(this.#e.maxLod));this.#s=new c.SPe(n,Za(Ya),3),this.#s.castShadow=!0,this.#s.receiveShadow=!0,vs.#i(this.#t,this.#s,0),this.add(this.#t),this.add(this.#s)}dispose(){this.#t.material.dispose(),this.#t.dispose(),this.#s.material.dispose(),this.#s.dispose()}static#i(e,t,i){const n=i*3+0,r=i*3+1,a=i*3+2;ht.set(bs,Ga,Ga),e.setMatrixAt(n,it.identity().scale(ht)),e.setMatrixAt(r,it.makeRotationZ(Ht).scale(ht)),e.setMatrixAt(a,it.makeRotationY(-Ht).scale(ht)),ht.set(Ba,Va,Va),it.identity().scale(ht).setPosition(bs,0,0),t.setMatrixAt(n,it),it.makeRotationZ(Ht).scale(ht).setPosition(0,bs,0),t.setMatrixAt(r,it),it.makeRotationY(-Ht).scale(ht).setPosition(0,0,bs),t.setMatrixAt(a,it),e.setColorAt(n,$a),e.setColorAt(r,Wa),e.setColorAt(a,Ha),t.setColorAt(n,$a),t.setColorAt(r,Wa),t.setColorAt(a,Ha)}}function Th(s){const e=wa(s),t=new c.fHI(.5,.5,1,e,1,!1);return t.rotateZ(-Ht),t.translate(.5,0,0),t.computeBoundingSphere(),t}function xh(s){const e=Ia(s),t=new c.b_z(.5,1,e,1,!1);return t.rotateZ(-Ht),t.translate(.5,0,0),t.computeBoundingSphere(),t}function Za(s){return new c.Wid({color:new c.Ilk(s.r,s.g,s.b).convertSRGBToLinear(),metalness:0,roughness:1,dithering:!0,opacity:s.a,transparent:s.a<1,depthWrite:s.a===1})}const ai=1;class wh extends Q.d{constructor(e){super("foxglove.SceneSettings",e),e.labelPool.scaleFactor=e.config.scene.labelScaleFactor??ai}dispose(){super.dispose()}settingsNodes(){const e=this.renderer.config,t=this.handleSettingsAction,i={enableStats:{label:(0,x.t)("threeDee:renderStats"),input:"boolean",value:e.scene.enableStats},debugPicking:{label:(0,x.t)("threeDee:debugPicking"),input:"boolean",value:this.renderer.debugPicking},backgroundColor:{label:(0,x.t)("threeDee:background"),input:"rgb",value:e.scene.backgroundColor},labelScaleFactor:{label:(0,x.t)("threeDee:labelScale"),help:(0,x.t)("threeDee:labelScaleHelp"),input:"number",min:0,step:.1,precision:2,value:e.scene.labelScaleFactor,placeholder:String(ai)},ignoreColladaUpAxis:{label:(0,x.t)("threeDee:ignoreColladaUpAxis"),help:(0,x.t)("threeDee:ignoreColladaUpAxisHelp"),input:"boolean",value:e.scene.ignoreColladaUpAxis,error:(e.scene.ignoreColladaUpAxis??!1)!==this.renderer.modelCache.options.ignoreColladaUpAxis?(0,x.t)("threeDee:takeEffectAfterReboot"):void 0},meshUpAxis:{label:(0,x.t)("threeDee:meshUpAxis"),help:(0,x.t)("threeDee:meshUpAxisHelp"),input:"select",value:e.scene.meshUpAxis??gn,options:[{label:(0,x.t)("threeDee:YUp"),value:"y_up"},{label:(0,x.t)("threeDee:ZUp"),value:"z_up"}],error:(e.scene.meshUpAxis??gn)!==this.renderer.modelCache.options.meshUpAxis?(0,x.t)("threeDee:takeEffectAfterReboot"):void 0}};return delete i.debugPicking,[{path:["scene"],node:{label:(0,x.t)("threeDee:scene"),actions:[{type:"action",id:"reset-scene",label:(0,x.t)("threeDee:reset")}],fields:i,defaultExpansionState:"collapsed",handler:t}}]}handleSettingsAction=e=>{if(e.action==="perform-node-action"&&e.payload.id==="reset-scene"){this.renderer.updateConfig(r=>{r.scene={}}),this.updateSettingsTree();return}if(e.action!=="update"||e.payload.path.length===0)return;const t=e.payload.path,i=t[0],n=e.payload.value;if(i==="scene"){if(t[1]==="debugPicking"){this.renderer.debugPicking=n??!1,this.updateSettingsTree();return}if(this.renderer.updateConfig(r=>(0,Z.set)(r,t,n)),t[1]==="backgroundColor"){const r=n;this.renderer.setColorScheme(this.renderer.colorScheme,r)}else if(t[1]==="labelScaleFactor"){const r=n;this.renderer.labelPool.setScaleFactor(r??ai)}}else return;this.updateSettingsTree()}}const Ih=6,Dh=Math.PI/2,En=!1,oi=1,An=2,_n="#ffff00",li=.2,Ch={visible:!0,frameLocked:!0,xyzOffset:[0,0,0],rpyOffset:[0,0,0]};class Mh extends F{dispose(){this.renderer.labelPool.release(this.userData.label),super.dispose()}details(){const e=this.renderer.transformTree.frame(this.userData.frameId),t=e?.parent(),i=e?.root();return{child_frame_id:e?.displayName()??"<unknown>",parent_frame_id:t?.displayName()??"<unknown>",fixed_frame_id:i?.displayName()??"<unknown>"}}}const Eh=new c.Pa4,Ah=new c.Pa4,_h=[0n,L.wx.Identity()],Ka=[0n,L.wx.Identity()],Xa=new c._fP,ci=new c.USm,Ja=["transforms",""];class Ph extends Q.d{#e;#t;#s=1;#i=new c.Ilk;#n;#r;constructor(e,t){super("foxglove.FrameAxes",e);const i=this.renderer.config.scene.transforms?.lineWidth??An,n=Ji(new c.Ilk,this.renderer.config.scene.transforms?.lineColor??_n);this.#e=new ri.Y({linewidth:i}),this.#e.color=n;const r={resolution:e.input.canvasSize,worldUnits:!1};this.#n=this.renderer.sharedGeometry.getGeometry(this.constructor.name,Rh),this.#t=wn(Ih,r),e.on("transformTreeUpdated",this.#d),this.#r={...Ch,...t}}dispose(){this.renderer.off("transformTreeUpdated",this.#d),this.#e.dispose(),this.#t.dispose(),super.dispose()}removeAllRenderables(){}settingsNodes(){const e=this.renderer.config,t=e.transforms,i=this.handleSettingsAction,n=this.renderer.coordinateFrameList.length,r={settings:{label:(0,x.t)("threeDee:settings"),defaultExpansionState:"collapsed",order:0,fields:{editable:{label:(0,x.t)("threeDee:editable"),input:"boolean",value:e.scene.transforms?.editable??En},showLabel:{label:(0,x.t)("threeDee:labels"),input:"boolean",value:e.scene.transforms?.showLabel??!0},...(e.scene.transforms?.showLabel??!0)&&{labelSize:{label:(0,x.t)("threeDee:labelSize"),input:"number",min:0,step:.01,precision:2,placeholder:String(li),value:e.scene.transforms?.labelSize}},axisScale:Da((0,x.t)("threeDee:axisScale"),e.scene.transforms?.axisScale,oi),lineWidth:{label:(0,x.t)("threeDee:lineWidth"),input:"number",min:0,step:.5,precision:1,value:e.scene.transforms?.lineWidth,placeholder:String(An)},lineColor:{label:(0,x.t)("threeDee:lineColor"),input:"rgb",value:e.scene.transforms?.lineColor??_n},enablePreloading:{label:(0,x.t)("threeDee:enablePreloading"),input:"boolean",value:e.scene.transforms?.enablePreloading??!0}}}};let a=1;for(const{label:o,value:l}of this.renderer.coordinateFrameList){const d=`frame:${l}`,h=this.#c(t[d]??{}),f=this.renderer.transformTree.frame(l),p=Lh(f,this.renderer.currentTime,e);Ja[1]=d,r[d]={label:o,fields:p,visible:h.visible,order:a++,defaultExpansionState:"collapsed",error:this.renderer.settings.errors.errors.errorAtPath(Ja)}}return[{path:["transforms"],node:{label:`${(0,x.t)("threeDee:transforms")}${n>0?` (${n})`:""}`,actions:[{id:"show-all",type:"action",label:(0,x.t)("threeDee:showAll")},{id:"hide-all",type:"action",label:(0,x.t)("threeDee:hideAll")}],handler:i,children:r}}]}startFrame(e,t,i){this.#e.resolution=this.renderer.input.canvasSize,this.updateSettingsTree(),super.startFrame(e,t,i);const n=this.renderer.config.scene.transforms?.axisScale??oi,r=ys*n,a=this.renderer.config.scene.transforms?.labelSize??li,o=this.renderer.config.scene.labelScaleFactor??ai,l=r+a*o*1.5;for(const d of this.renderables.values()){if(!d.visible)continue;const h=d.userData.parentLine,p=this.renderer.transformTree.frame(d.userData.frameId)?.parent(),u=Ah;if(d.getWorldPosition(u),h.visible=!1,p){const g=this.renderables.get(p.id);if(g?.visible===!0){const y=Eh;g.getWorldPosition(y);const S=y.distanceTo(u);h.lookAt(y),h.rotateY(-Dh),h.scale.set(S,1,1),h.visible=!0}}const m=d.userData.label;m.visible=this.renderer.config.scene.transforms?.showLabel??!0,u.z+=l,d.worldToLocal(u),m.position.set(u.x,u.y,u.z)}}setColorScheme(e,t){const i=e==="dark"?1:0;this.#s=i,this.#i.setRGB(1-i,1-i,1-i),t&&(this.#s=Vs(t.r,t.g,t.b)>.5?0:1,this.#i.copy(t));for(const n of this.renderables.values())n.userData.label.setColor(this.#s,this.#s,this.#s),n.userData.label.setBackgroundColor(this.#i.r,this.#i.g,this.#i.b)}#a(e){for(const t of this.renderables.values())t.userData.label.setLineHeight(e)}#o(e){for(const t of this.renderables.values())t.userData.axis.scale.set(e,e,e)}#l(e){this.#e.linewidth=e}#h(e){Ji(this.#e.color,e)}handleSettingsAction=e=>{const t=e.payload.path,i=n=>{for(const r of this.renderables.values())r.userData.settings.visible=n;this.renderer.updateConfig(r=>{for(const a of this.renderables.keys()){const o=a==="settings"?"$settings":`frame:${a}`;r.transforms[o]??={},r.transforms[o].visible=n}}),this.updateSettingsTree()};if(e.action==="perform-node-action"){e.payload.id==="show-all"?i(!0):e.payload.id==="hide-all"&&i(!1);return}if(t.length===3)if(t[1]==="settings"){const n=t[2],r=e.payload.value;if(this.saveSetting(["scene","transforms",n],r),n==="editable")this.#f();else if(n==="labelSize"){const a=r;this.#a(a??li)}else if(n==="axisScale"){const a=r;this.#o(a??oi)}else if(n==="lineWidth"){const a=r;this.#l(a??An)}else if(n==="lineColor"){const a=r;this.#h(a??_n)}}else{this.saveSetting(t,e.payload.value);const n=t[1],r=n.replace(/^frame:/,""),a=this.renderables.get(r);if(a){const o=this.renderer.config.transforms[n];a.userData.settings=this.#c(o??{}),this.#p(a)}}};#c(e){return{...this.#r,...e}}#d=()=>{for(const e of this.renderer.transformTree.frames().keys())this.#u(e);this.updateSettingsTree()};#u(e){if(this.renderables.has(e))return;const t=this.renderer.config,i=this.renderer.transformTree.frame(e);if(!i)throw new Error(`CoordinateFrame "${e}" was not created`);const n=i.displayName(),r=this.renderer.labelPool.acquire();r.setBillboard(!0),r.setText(n),r.setLineHeight(t.scene.transforms?.labelSize??li),r.setColor(this.#s,this.#s,this.#s),r.setBackgroundColor(this.#i.r,this.#i.g,this.#i.b);const a=`frame:${e}`,o=t.transforms[a],l=this.#c(o??{}),d=new ni.w(this.#n,this.#e);d.castShadow=!0,d.receiveShadow=!1,d.userData.pickingMaterial=this.#t;const h=new vs(e,this.renderer),f=t.scene.transforms?.axisScale??oi;h.scale.set(f,f,f);const p=new Mh(e,this.renderer,{receiveTime:0n,messageTime:0n,frameId:e,pose:(0,L.N2)(),settingsPath:["transforms",a],settings:l,axis:h,label:r,parentLine:d});p.add(h),p.add(r),p.add(d),this.add(p),this.renderables.set(e,p),this.#p(p)}#f(){for(const e of this.renderables.values())this.#p(e)}#p(e){const t=this.renderer.transformTree.getOrCreateFrame(e.userData.frameId);if(!(this.renderer.config.scene.transforms?.editable??En)){t.offsetPosition=void 0,t.offsetEulerDegrees=void 0;return}const n=`frame:${e.userData.frameId}`;t.offsetPosition=so(this.renderer.config.transforms[n]?.xyzOffset),t.offsetEulerDegrees=so(this.renderer.config.transforms[n]?.rpyOffset)}}function Rh(){const s=new Wt.L;return s.setPositions([0,0,0,1,0,0]),s}function Lh(s,e,t){const i=s?`frame:${s.id}`:"",n=s?.parent()?.id;if(n==null)return{parent:{label:"Parent",input:"string",readonly:!0,value:"<root>"}};const r=String(s?.transformsSize()??0);let a,o,l;if(e!=null&&s&&s.findClosestTransforms(_h,Ka,e,L.Zf)){const[h,f]=Ka;a=h<e?Fh(e-h):"0 ns";const p=f.position(),u=f.rotation();o=[Yt(p[0],3),Yt(p[1],3),Yt(p[2],3)],Xa.set(u[0],u[1],u[2],u[3]),ci.setFromQuaternion(Xa,"XYZ"),l=[Yt(c.M8C.radToDeg(ci.x),3),Yt(c.M8C.radToDeg(ci.y),3),Yt(c.M8C.radToDeg(ci.z),3)]}const d={parent:{label:"Parent",input:"string",readonly:!0,value:n},age:{label:"Age",input:"string",readonly:!0,value:a},historySize:{label:"History Size",input:"string",readonly:!0,value:r},xyz:{label:"Translation",input:"vec3",precision:k,labels:["X","Y","Z"],readonly:!0,value:o},rpy:{label:"Rotation",input:"vec3",precision:we,labels:["R","P","Y"],readonly:!0,value:l}};if(t.scene.transforms?.editable??En){let h=t.transforms[i]?.xyzOffset,f=t.transforms[i]?.rpyOffset;h&&to(h)&&(h=void 0),f&&to(f)&&(f=void 0),d.xyzOffset={label:"Translation Offset",input:"vec3",precision:k,step:.1,labels:["X","Y","Z"],value:h},d.rpyOffset={label:"Rotation Offset",input:"vec3",precision:we,step:1,min:-180,max:180,labels:["R","P","Y"],value:f}}return d}const Nh=BigInt(1e5),Oh=BigInt(1e6),Qa=BigInt(1e9),qa=BigInt(6e10),eo=BigInt(36e11);function Fh(s){const e=Uh(s);return e<Nh?`${s} ns`:e<Qa?`${Number(s/Oh).toFixed(1)} ms`:e<qa?`${Number(s/Qa).toFixed(1)} s`:e<eo?`${Number(s/qa).toFixed(1)} min`:`${Number(s/eo).toFixed(1)} hr`}function Uh(s){return s<0n?-s:s}function Yt(s,e){return Number(s.toFixed(e))}function to(s,e=1e-6){return Math.abs(s[0])<e&&Math.abs(s[1])<e&&Math.abs(s[2])<e}function so(s){if(!s)return;const[e=0,t=0,i=0]=s;if(!(e===0&&t===0&&i===0))return[e,t,i]}var zh="../../packages/studio-base/src/panels/ThreeDeeRender/renderables/Grids.ts";const kh=R.ZP.getLogger(zh),Ss="foxglove.Grid",io=10,no=10,ro=1,ao="#248eff",jh=4096,Gh={worldUnits:!1},Pn={visible:!0,frameLocked:!0,label:"Grid",instanceId:"invalid",layerId:Ss,frameId:void 0,size:io,divisions:no,lineWidth:ro,color:ao,position:[0,0,0],rotation:[0,0,0]};class Bh extends F{dispose(){this.userData.lineList.dispose(),super.dispose()}}class Vh extends Q.d{constructor(e){super("foxglove.Grids",e),e.addCustomLayerAction({layerId:Ss,label:(0,x.t)("threeDee:addGrid"),icon:"Grid",handler:this.#e}),e.on("transformTreeUpdated",this.#t);for(const[t,i]of Object.entries(e.config.layers))i?.layerId===Ss&&this.#s(t,i)}dispose(){this.renderer.off("transformTreeUpdated",this.#t),super.dispose()}removeAllRenderables(){}settingsNodes(){const e=this.handleSettingsAction,t=[];for(const[i,n]of Object.entries(this.renderer.config.layers)){if(n?.layerId!==Ss)continue;const r=n,a=[{label:"<Display frame>",value:void 0},...this.renderer.coordinateFrameList],o={frameId:{label:(0,x.t)("threeDee:frame"),input:"select",options:a,value:r.frameId},size:{label:(0,x.t)("threeDee:size"),input:"number",min:0,step:.5,precision:k,value:r.size,placeholder:String(io)},divisions:{label:(0,x.t)("threeDee:divisions"),input:"number",min:1,max:jh,step:1,precision:0,value:r.divisions,placeholder:String(no)},lineWidth:{label:(0,x.t)("threeDee:lineWidth"),input:"number",min:0,step:.5,precision:1,value:r.lineWidth,placeholder:String(ro)},color:{label:(0,x.t)("threeDee:color"),input:"rgba",value:r.color??ao},position:{label:(0,x.t)("threeDee:position"),input:"vec3",labels:["X","Y","Z"],precision:k,value:r.position??[0,0,0]},rotation:{label:(0,x.t)("threeDee:rotation"),input:"vec3",labels:["R","P","Y"],precision:we,value:r.rotation??[0,0,0]}};t.push({path:["layers",i],node:{label:r.label??(0,x.t)("threeDee:grid"),icon:"Grid",fields:o,visible:r.visible??Pn.visible,actions:[{type:"action",id:"delete",label:(0,x.t)("threeDee:delete")}],order:n.order,handler:e}}),this.renderables.has(i)||this.#s(i,r)}return t}startFrame(e,t,i){for(const n of this.renderables.values())n.userData.frameId=n.userData.settings.frameId??t;super.startFrame(e,t,i)}handleSettingsAction=e=>{const t=e.payload.path;if(e.action==="perform-node-action"){if(t.length===2&&e.payload.id==="delete"){const r=t[1];this.renderer.updateConfig(a=>{delete a.layers[r]}),this.#s(r,void 0),this.updateSettingsTree(),this.renderer.updateCustomLayersCount()}return}if(t.length!==3)return;this.saveSetting(t,e.payload.value);const i=t[1],n=this.renderer.config.layers[i];this.#s(i,n)};#e=e=>{kh.info(`Creating ${Ss} layer ${e}`);const t={...Pn,instanceId:e};this.renderer.updateConfig(i=>{const r=1+((0,Z.maxBy)(Object.values(i.layers),a=>a?.order)?.order??0);i.layers[e]={...t,order:r}}),this.#s(e,t),this.updateSettingsTree()};#t=()=>{this.updateSettingsTree()};#s(e,t){let i=this.renderables.get(e);if(t==null){i!=null&&(i.userData.lineList.dispose(),this.remove(i),this.renderables.delete(e));return}const n={...Pn,...t};i||(i=this.#i(e,n),i.userData.pose=(0,L.EI)(n.position,n.rotation));const r=i.userData.settings,a=n.size===r.size&&n.divisions===r.divisions&&n.frameId===r.frameId&&n.lineWidth===r.lineWidth&&n.color===r.color;if(i.userData.settings=n,!a){const o=oo(n);i.userData.lineList.update(o,void 0)}(!Br(n.position,r.position)||!Br(n.rotation,r.rotation))&&(i.userData.pose=(0,L.EI)(n.position,n.rotation))}#i(e,t){const i=oo(t),n=`${e}:LINE_LIST`,r=new In(n,i,void 0,this.renderer,Gh),a=new Bh(e,this.renderer,{receiveTime:0n,messageTime:0n,frameId:"",pose:(0,L.N2)(),settingsPath:["layers",e],settings:t,lineList:r});return a.add(r),this.add(a),this.renderables.set(e,a),a}}function oo(s){const{size:e,divisions:t,color:i}=s,n=e/t,r=e/2,a=[];for(let l=0;l<=t;l++){const d=-r+l*n;a.push({x:d,y:-r,z:0}),a.push({x:d,y:r,z:0}),a.push({x:-r,y:d,z:0}),a.push({x:r,y:d,z:0})}const o={r:1,g:1,b:1,a:1};return N(o,i),{header:{frame_id:"",stamp:ct},ns:"",id:0,type:_.LINE_LIST,action:re.ADD,pose:(0,L.N2)(),scale:{x:s.lineWidth,y:1,z:1},color:o,lifetime:ct,frame_locked:!0,points:a,colors:[],text:"",mesh_resource:"",mesh_use_embedded_materials:!1}}var Ts=b(8220),$h=b(90758);class Wh{#e;#t;constructor(){this.#e=new Worker(new URL(b.p+b.u(2977),b.b)),this.#t=$h.Ud(this.#e)}async decode(e,t){return await this.#t.decode(e,t)}terminate(){this.#e.terminate()}}async function lo(s,e){const t=new Blob([s.data],{type:`image/${s.format}`});return await createImageBitmap(t,{resizeWidth:e})}function Hh(s,e,t){const{encoding:i,width:n,height:r}=s,a="is_bigendian"in s?s.is_bigendian:!1,o=s.data;switch(i){case"yuv422":case"uyuv":Jd(s.data,n,r,t);break;case"yuyv":Qd(s.data,n,r,t);break;case"rgb8":qd(o,n,r,t);break;case"rgba8":eh(o,n,r,t);break;case"bgra8":th(o,n,r,t);break;case"bgr8":case"8UC3":sh(o,n,r,t);break;case"32FC1":ih(o,n,r,a,t);break;case"bayer_rggb8":ah(o,n,r,t);break;case"bayer_bggr8":oh(o,n,r,t);break;case"bayer_gbrg8":lh(o,n,r,t);break;case"bayer_grbg8":ch(o,n,r,t);break;case"mono8":case"8UC1":nh(o,n,r,t);break;case"mono16":case"16UC1":rh(o,n,r,a,t,e);break;default:throw new Error(`Unsupported encoding ${i}`)}}const di="CreateBitmap",co=["imageMode","imageTopic"],Zt={visible:!1,frameLocked:!0,cameraInfoTopic:void 0,distance:1,planarProjectionFactor:0,color:"#ffffff"};class ho extends F{#e=!0;#t=!0;#s=!0;#i=!0;#n=!1;#r=!1;#a;#o;#l=0;#h=0;#c;#d=!1;constructor(e,t,i){super(e,t,i),this.#c={minValue:i.settings.minValue,maxValue:i.settings.maxValue}}dispose(){this.#d=!0,this.userData.texture?.dispose(),this.userData.material?.dispose(),this.userData.geometry?.dispose(),this.#o?.terminate(),super.dispose()}updateHeaderInfo(){(0,V.assert)(this.userData.image,"updateHeaderInfo called without image");const e=this.userData.image,t=this.userData.cameraInfo?.header.frame_id??("header"in e?e.header.frame_id:e.frame_id);this.userData.frameId=typeof t=="string"?this.renderer.normalizeFrameId(t):t,this.userData.messageTime=(0,w.toNanoSec)("header"in e?e.header.stamp:e.timestamp)}details(){return{image:this.userData.image,camera_info:this.userData.cameraInfo}}setRenderBehindScene(){this.#n=!0,this.#i=!0,this.#t=!0}setCameraModel=e=>{this.#e||=this.userData.cameraModel!==e,this.userData.cameraModel=e};setSettings(e){const t=this.userData.settings;if(t.cameraInfoTopic!==e.cameraInfoTopic&&(this.userData.mesh!=null&&this.remove(this.userData.mesh),this.userData.mesh=void 0,this.#e=!0),(t.distance!==e.distance||e.planarProjectionFactor!==t.planarProjectionFactor)&&(this.#e=!0),e.color!==t.color&&(this.#i=!0),t.minValue!==e.minValue||t.maxValue!==e.maxValue){this.#c.minValue=e.minValue,this.#c.maxValue=e.maxValue;const i=this.userData.image;i&&this.setImage(i)}this.userData.settings=e}setImage(e,t,i){this.userData.image=e;const n=++this.#l;("format"in e?lo(e,t):(this.#o??=new Wh).decode(e,this.#c)).then(a=>{this.#d||this.#h>n||(this.#h=n,this.#a=a,this.#s=!0,this.update(),i?.(a),this.renderer.settings.errors.remove(co,di),this.renderer.settings.errors.removeFromTopic(this.userData.topic,di),this.renderer.queueAnimationFrame())}).catch(a=>{this.#d||(this.renderer.settings.errors.add(co,di,`Error creating bitmap: ${a.message}`),this.renderer.settings.errors.addToTopic(this.userData.topic,di,`Error creating bitmap: ${a.message}`))})}update(){this.#r||(this.#r=!0,this.#s&&this.#a&&(this.#f(),this.#s=!1),this.userData.image&&this.updateHeaderInfo(),this.#e&&this.userData.cameraModel&&(this.#u(),this.#e=!1),this.#i&&(this.#p(),this.#i=!1),this.#t&&this.userData.texture&&this.userData.geometry&&this.userData.material&&(this.#m(),this.#t=!1),this.#r=!1)}#u(){(0,V.assert)(this.userData.cameraModel,"Camera model must be set before geometry can be updated"),this.userData.geometry?.dispose(),this.userData.geometry=void 0;const e=Kh(this.userData.cameraModel,this.userData.settings);this.userData.geometry=e,this.#t=!0}#f(){(0,V.assert)(this.#a,"Decoded image must be set before texture can be updated or created");const e=this.#a;if(e instanceof ImageBitmap){const t=this.userData.texture;t==null||!(t instanceof c.ROQ)||!Xh(e,t.image)?(t?.image instanceof ImageBitmap&&t.image.close(),t?.dispose(),this.userData.texture=Yh(e)):(t.image=e,t.needsUpdate=!0)}else{let t=this.userData.texture;t==null||!(t instanceof c.IEO)||t.image.width!==e.width||t.image.height!==e.height?(t?.dispose(),t=Zh(e),this.userData.texture=t):(t.image=e,t.needsUpdate=!0)}this.#i=!0}#p(){this.userData.material||(this.#b(),this.#t=!0);const e=this.userData.material,t=this.userData.texture;t&&(e.map=t),Ie=N(Ie,this.userData.settings.color);const i=Ie.a<1,n=new c.Ilk(Ie.r,Ie.g,Ie.b);e.color.set(n),e.opacity=Ie.a,e.transparent=i,e.depthWrite=!i,this.#n?(e.depthWrite=!1,e.depthTest=!1):e.depthTest=!0,e.needsUpdate=!0}#b(){N(Ie,this.userData.settings.color);const e=Ie.a<1,t=new c.Ilk(Ie.r,Ie.g,Ie.b);this.userData.material=new c.vBJ({name:`${this.userData.topic}:Material`,color:t,side:c.ehD,opacity:Ie.a,transparent:e,depthWrite:!e})}#m(){if((0,V.assert)(this.userData.geometry,"Geometry must be set before mesh can be updated or created"),(0,V.assert)(this.userData.material,"Material must be set before mesh can be updated or created"),this.userData.mesh?(this.userData.mesh.geometry=this.userData.geometry,this.userData.mesh.material=this.userData.material):(this.userData.mesh=new c.Kj0(this.userData.geometry,this.userData.material),this.add(this.userData.mesh)),!this.#n){this.userData.mesh.renderOrder=0;return}this.userData.mesh.renderOrder=-1*Number.MAX_SAFE_INTEGER}}let Ie={r:0,g:0,b:0,a:0};function Yh(s){const e=new c.ROQ(s,c.xfE,c.uWy,c.uWy,c.TyD,c.wem,c.wk1,c.ywz);return e.generateMipmaps=!1,e.encoding=c.knz,e}function Zh(s){const e=new c.IEO(s.data,s.width,s.height,c.wk1,c.ywz,c.xfE,c.uWy,c.uWy,c.TyD,c.wem,1,c.knz);return e.needsUpdate=!0,e}function Kh(s,e){const n=s.width,r=s.height,a=new c._12(1,1,10,10),o=10+1,l=10+1,d=o*l,h=n/10,f=r/10,p=.001,u={x:0,y:0},m={x:0,y:0,z:0},g=new Float32Array(d*3),y=new Float32Array(d*2);for(let S=0;S<l;S++)for(let D=0;D<o;D++){const A=(S*o+D)*3,M=(S*o+D)*2;u.x=D*h,u.y=S*f,Mt(m,u,s,e),g[A+0]=m.x,g[A+1]=m.y,g[A+2]=m.z-p,y[M+0]=D/10,y[M+1]=S/10}return a.setAttribute("position",new c.TlE(g,3)),a.setAttribute("uv",new c.TlE(y,2)),a.attributes.position.needsUpdate=!0,a.attributes.uv.needsUpdate=!0,a}const Xh=(s,e)=>s?.width===e?.width&&s?.height===e?.height,Jh=new Set([...kt,...Ft]);function uo(s){return"header"in s?s.header.frame_id:s.frame_id}function fo(s){return"header"in s?s.header.stamp:s.timestamp}const Qh={near:.001,far:1e3},qh=.5,eu=50;class tu extends c.cPb{#e;#t=Qh;#s=0;#i=!1;#n=!1;#r=new c.FM8;#a=new c.FM8;#o=new c.FM8(0,0);#l=1;updateCamera(e){this.#e=e,this.#h()}setPanOffset(e){this.#o.copy(e),this.#h()}getPanOffset(e){e.copy(this.#o)}resetModifications(){this.#o.set(0,0),this.#l=1,this.#h()}setRotation(e){switch(e){case 0:case 90:case 180:case 270:this.#s=e;break;default:this.#s=0;break}this.quaternion.setFromEuler(new c.USm(Math.PI,0,c.M8C.degToRad(e))),this.resetModifications()}setFlipHorizontal(e){this.#i=e,this.resetModifications()}setFlipVertical(e){this.#n=e,this.resetModifications()}updateZoomFromWheel(e,t){const i=c.M8C.clamp(this.#l*e,qh,eu),n=i/this.#l,r=this.#a.width/2,a=this.#a.height/2;this.#o.set((r+this.#o.x-t.x)*n-r+t.x,(a+this.#o.y-t.y)*n-a+t.y),this.#l=i,this.#h()}#h(){this.#d(),this.#e?(this.#c(this.projectionMatrix,this.#e),this.projectionMatrixInverse.copy(this.projectionMatrix).invert()):this.updateProjectionMatrix()}#c(e,t){const{width:i,height:n}=t,r=t.P[0],a=t.P[5],o=this.getEffectiveScale(),l=this.#i?-1:1,d=this.#n?-1:1;let h,f;switch(this.#s){case 0:h=this.#o.x*(r/a)*l,f=this.#o.y*d;break;case 90:h=this.#o.y*(r/a)*d,f=-this.#o.x*l;break;case 180:h=-this.#o.x*(r/a)*l,f=-this.#o.y*d;break;case 270:h=-this.#o.y*(r/a)*d,f=this.#o.x*l;break}const p=t.P[2]+h/o,u=t.P[6]+f/o,m=this.#t.near,g=this.#t.far;let y,S,D,A;const M=(1/this.#r.x-1)*i/2,I=(1/this.#r.y-1)*n/2,P=-(p+M)/r*m,O=(i-p+M)/r*m,z=(u+I)/a*m,Y=-(n-u+I)/a*m;switch(this.#s){case 0:y=P,S=O,D=z,A=Y;break;case 90:y=Y,S=z,D=-P,A=-O;break;case 180:y=-O,S=-P,D=-Y,A=-z;break;case 270:y=-z,S=-Y,D=O,A=P;break}if(this.#i){const oe=y;y=S,S=oe}if(this.#n){const oe=D;D=A,A=oe}e.makePerspective(y,S,D,A,m,g)}setCanvasSize(e,t){this.#a.set(e,t),this.#h()}getEffectiveScale(){if(!this.#e)return 1;let{width:e,height:t}=this.#a;if(this.#s===90||this.#s===270){const i=e;e=t,t=i}return Math.min(e/this.#e.width*this.#r.x,t/this.#e.height*this.#r.y)}#d(){const e=this.#e;if(!e)return;this.#r.set(this.#l,this.#l);const{width:t,height:i}=e,n=e.P[0],r=e.P[5];let a=this.#a.width/this.#a.height;const o=t/n/(i/r);(this.#s===90||this.#s===270)&&(a=1/a),o>a?this.#r.y=this.#r.y/o*a:this.#r.x=this.#r.x/a*o}}var su=b(63296);function po(s){return s==null?new Uint8Array(0):s instanceof Int8Array||s instanceof Uint8Array?s:new Uint8Array(0)}function mo(s){return{header:Pe(s.header),height:s.height??0,width:s.width??0,encoding:s.encoding??"",is_bigendian:s.is_bigendian??!1,step:s.step??0,data:po(s.data)}}function go(s){return{header:Pe(s.header),format:s.format??"",data:jt(s.data)}}function bo(s){return{timestamp:de(s.timestamp),frame_id:s.frame_id??"",height:s.height??0,width:s.width??0,encoding:s.encoding??"",step:s.step??0,data:po(s.data)}}function yo(s){return{timestamp:de(s.timestamp),frame_id:s.frame_id??"",format:s.format??"",data:jt(s.data)}}var Le;(function(s){s[s.CIRCLE=0]="CIRCLE",s[s.LINE_STRIP=1]="LINE_STRIP",s[s.LINE_LIST=2]="LINE_LIST",s[s.POLYGON=3]="POLYGON",s[s.POINTS=4]="POINTS",s[s.TEXT=5]="TEXT"})(Le||(Le={}));var vo;(function(s){s[s.ADD=0]="ADD",s[s.REMOVE=1]="REMOVE"})(vo||(vo={}));var So=b(36537);const To=12,xo=4,tb=null;function iu(s){switch(s){case E.PointsAnnotationType.UNKNOWN:case E.PointsAnnotationType.POINTS:return"points";case E.PointsAnnotationType.LINE_LOOP:return"polygon";case E.PointsAnnotationType.LINE_STRIP:return"line_strip";case E.PointsAnnotationType.LINE_LIST:return"line_list"}}function nu(s){const e=[],t=s.circles??[];for(let r=0;r<t.length;r++){const a=t[r],o=Rn(a.timestamp);e.push({type:"circle",stamp:o,fillColor:a.fill_color,outlineColor:a.outline_color,radius:a.diameter/2,thickness:a.thickness,position:a.position,messagePath:["circles",r]})}const i=s.points??[];for(let r=0;r<i.length;r++){const a=i[r],o=iu(a.type);if(!o)continue;const l=Rn(a.timestamp);e.push({type:"points",stamp:l,style:o,points:a.points,outlineColors:a.outline_colors,outlineColor:(0,So.N)(a).outline_color??{r:1,g:1,b:1,a:1},thickness:(0,So.N)(a).thickness??1,fillColor:a.fill_color,messagePath:["points",r]})}const n=s.texts??[];for(let r=0;r<n.length;r++){const a=n[r],o=Rn(a.timestamp);e.push({type:"text",stamp:o,position:a.position,text:a.text,textColor:a.text_color,backgroundColor:a.background_color,fontSize:a.font_size,padding:a.font_size/To*xo,messagePath:["texts",r]})}return e}function Rn(s){return typeof s=="bigint"?(0,w.fromNanoSec)(s):s}function ru(s){return(0,Ts.Z)(s.markers,(e,t)=>wo(e,["markers",t]))}function au(s){switch(s){case Le.LINE_LIST:return"line_list";case Le.LINE_STRIP:return"line_strip";case Le.POINTS:return"points";case Le.POLYGON:return"polygon"}}function wo(s,e){switch(s.type){case Le.CIRCLE:return{type:"circle",stamp:s.header.stamp,fillColor:s.filled?s.fill_color:void 0,outlineColor:s.outline_color,radius:s.scale,thickness:1,position:s.position,messagePath:e};case Le.TEXT:return{type:"text",stamp:s.header.stamp,position:s.position,text:s.text?.data??"",textColor:s.outline_color,backgroundColor:s.filled?s.fill_color:void 0,fontSize:s.scale*To,padding:xo*s.scale,messagePath:e};case Le.POINTS:return{type:"points",stamp:s.header.stamp,style:"points",points:s.points,outlineColors:s.outline_colors,outlineColor:s.outline_color,thickness:s.scale,fillColor:s.fill_color,messagePath:e};case Le.LINE_LIST:case Le.LINE_STRIP:case Le.POLYGON:{const t=au(s.type);return{type:"points",stamp:s.header.stamp,style:t,points:s.points,outlineColors:s.outline_colors,outlineColor:s.outline_color,thickness:s.scale,fillColor:s.filled?s.fill_color:void 0,messagePath:e}}}}function ou(s){return"toJSON"in s?s.toJSON():s}function lu(s,e){const t=ou(s);switch(e){case"visualization_msgs/ImageMarker":case"visualization_msgs/msg/ImageMarker":case"ros.visualization_msgs.ImageMarker":{const i=wo(t,[]);return i?[i]:[]}case"foxglove_msgs/ImageMarkerArray":case"foxglove_msgs/msg/ImageMarkerArray":case"studio_msgs/ImageMarkerArray":case"studio_msgs/msg/ImageMarkerArray":case"visualization_msgs/ImageMarkerArray":case"visualization_msgs/msg/ImageMarkerArray":case"ros.visualization_msgs.ImageMarkerArray":return ru(t);case"webviz_msgs/ImageMarkerArray":break;case"foxglove_msgs/ImageAnnotations":case"foxglove_msgs/msg/ImageAnnotations":case"foxglove.ImageAnnotations":return nu(t)}return[]}function Ln(s,e){let t=s;for(const i of e)i in t&&(t=t[i]);return t}class cu{#e;#t;#s;#i;#n=[];constructor(e){this.#e=e,this.#s={annotationsByTopic:new Map},this.#i=new su.AVLTree(w.compare)}addListener(e){this.#n.push(e)}removeListener(e){this.#n=this.#n.filter(t=>t!==e)}handleRosRawImage=e=>{this.#r(e,mo(e.message))};handleRosCompressedImage=e=>{this.#r(e,go(e.message))};handleRawImage=e=>{this.#r(e,bo(e.message))};handleCompressedImage=e=>{this.#r(e,yo(e.message))};#r(e,t){const i={...e,message:t};if(this.#e.synchronize!==!0){this.#s.image=i,this.#a();return}const n=this.#i.get(fo(t));n?n.image=i:this.#i.set(fo(t),{image:i,annotationsByTopic:new Map}),this.#a()}handleCameraInfo=e=>{const t=ii(e.message);this.#s.cameraInfo=t,this.#a()};handleAnnotations=e=>{const t=lu(e.message,e.schemaName),{topic:i}=e;if(this.#e.synchronize!==!0){this.#s.annotationsByTopic.set(i,{originalMessage:e,annotations:t}),this.#a();return}const n=new Map;for(const r of t){const a=(0,w.toNanoSec)(r.stamp),o=n.get(a);if(o){o.push(r);continue}n.set(a,[r])}for(const[r,a]of n){const o=(0,w.fromNanoSec)(r);let l=this.#i.get(o);l||(l={image:void 0,annotationsByTopic:new Map},this.#i.set(o,l)),l.annotationsByTopic.set(i,{originalMessage:e,annotations:a})}this.#a()};setConfig(e){let t=!1;if(e.synchronize!=null&&e.synchronize!==this.#e.synchronize&&(this.#i.clear(),t=!0),"imageTopic"in e&&this.#e.imageTopic!==e.imageTopic){for(const i of this.#i.values())i.image=void 0;this.#s.image=void 0,t=!0}if("calibrationTopic"in e&&this.#e.calibrationTopic!==e.calibrationTopic&&(this.#s.cameraInfo=void 0,t=!0),e.annotations!=null&&this.#e.annotations&&this.#e.annotations!==e.annotations){const i=new Set;for(const[n,r]of Object.entries(e.annotations))r?.visible===!0&&i.add(n);for(const n of this.#s.annotationsByTopic.keys())i.has(n)||(this.#s.annotationsByTopic.delete(n),t=!0);for(const n of this.#i.values())for(const r of n.annotationsByTopic.keys())i.has(r)||(n.annotationsByTopic.delete(r),t=!0)}this.#e={...this.#e,...e},t&&this.#a()}clear(){this.#s={annotationsByTopic:new Map},this.#i.clear(),this.#t=void 0,this.#a()}#a(){const e=this.getRenderState();this.#n.forEach(t=>t(e,this.#t)),this.#t=e}getRenderState(){if(this.#e.synchronize===!0){const e=du(this.#i,this.#o());return e?{cameraInfo:this.#s.cameraInfo,image:e[1].image,annotationsByTopic:e[1].annotationsByTopic}:{cameraInfo:this.#s.cameraInfo}}return{...this.#s}}#o(){const e=new Set;for(const[t,i]of Object.entries(this.#e.annotations??{}))i?.visible===!0&&e.add(t);return e}}function du(s,e){let t;for(const i of s.entries()){const n=i[1],r=e.size===n.annotationsByTopic.size&&Array.from(e.keys()).every(a=>n.annotationsByTopic.get(a)!=null);n.image&&r&&(t=i)}if(t){let i=s.minKey();for(;i&&(0,w.isLessThan)(i,t[0]);)s.shift(),i=s.minKey()}return t}const xs=1e5,ws={FILL:1+xs,LINE_PREPASS:2+xs,LINE:3+xs,POINTS:4+xs,TEXT:5+xs},Is={transparent:!0,depthWrite:!1,depthTest:!1},ut=new c.Pa4;class hu extends ri.Y{constructor(){super({worldUnits:!1,vertexColors:!1,linewidth:0,...Is}),this.uniforms.objectId={value:[NaN,NaN,NaN,NaN]}}onBeforeCompile(e,t){super.onBeforeCompile(e,t),e.fragmentShader=`
      uniform vec4 objectId;
      void main() {
        gl_FragColor = objectId;
      }
    `}}const Io={r:0,g:0,b:0,a:0};class Do extends F{#e;#t;#s;#i;#n;#r;#a;#o;#l=new Float32Array;#h=new Uint8Array;#c;#d;#u;#f=0;#p=0;#b=0;#m=!1;#v;#g;#T=!1;#S;#x=!1;constructor(e){super(e,void 0,{receiveTime:0n,messageTime:0n,frameId:"",pose:{position:{x:0,y:0,z:0},orientation:{x:0,y:0,z:0,w:0}},settingsPath:[],settings:{visible:!0},topic:e}),this.#e=new ms.z,this.#s=new ri.Y({worldUnits:!1,colorWrite:!1,vertexColors:!0,linewidth:0,stencilWrite:!0,stencilRef:1,stencilZPass:c.ce8,...Is}),this.#n=new ri.Y({worldUnits:!1,vertexColors:!0,linewidth:0,stencilWrite:!0,stencilRef:0,stencilFunc:c.RvT,stencilFail:c.ce8,stencilZPass:c.ce8,...Is}),this.#t=new ps.w(this.#e,this.#s),this.#t.renderOrder=ws.LINE_PREPASS,this.#t.userData.picking=!1,this.add(this.#t),this.#i=new ps.w(this.#e,this.#n),this.#i.renderOrder=ws.LINE,this.#i.userData.pickingMaterial=this.#r=new hu,this.add(this.#i)}dispose(){this.#e?.dispose(),this.#s.dispose(),this.#n.dispose(),this.#r.dispose(),this.#d?.dispose(),this.#u?.dispose(),super.dispose()}details(){return this.#v&&this.#g?{annotation:Ln(this.#v,this.#g.messagePath),originalMessage:this.#v}:{}}setScale(e,t,i,n){this.#m||=e!==this.#f||t!==this.#p||i!==this.#b,this.#f=e,this.#p=t,this.#b=i}setCameraModel(e){this.#x||=this.#S!==e,this.#S=e}setAnnotation(e,t){this.#T||=this.#g!==e,this.#v=t,this.#g=e}setAnnotationFromCircle(e,t){this.setAnnotation(uu(e),t)}update(){if(!this.#g||!this.#S){this.visible=!1;return}const{points:e,outlineColor:t,outlineColors:i,thickness:n,style:r,fillColor:a}=this.#g,o=e.length;if(o<2){this.visible=!1;return}this.visible=!0;const l=r==="polygon",d=r==="line_strip",h=r==="line_list";if((this.#T||this.#m)&&(this.#n.resolution.set(this.#p,this.#b),this.#n.linewidth=n*this.#f,this.#n.needsUpdate=!0,this.#s.resolution.set(this.#p,this.#b),this.#s.linewidth=n*this.#f,this.#s.needsUpdate=!0,this.#r.resolution.set(this.#p,this.#b),this.#r.linewidth=n*this.#f,this.#r.needsUpdate=!0,this.#m=!1),this.#T||this.#x){if(this.#T=!1,this.#x=!1,this.#o==null||!this.#e||o>this.#o||this.#a!==r){switch(this.#e?.dispose(),this.#o=o,this.#a=r,r){case"polygon":this.#l=new Float32Array((o+1)*3),this.#e=new Wt.L;break;case"line_strip":this.#l=new Float32Array(o*3),this.#e=new Wt.L;break;case"line_list":{this.#l=new Float32Array(o*3),this.#h=new Uint8Array(o*8),this.#e=new ms.z;const S=new c.$TI(this.#h,8,1);this.#e.setAttribute("instanceColorStart",new c.kB5(S,4,0,!0)),this.#e.setAttribute("instanceColorEnd",new c.kB5(S,4,4,!0));break}}this.#t.geometry=this.#e,this.#i.geometry=this.#e}const f=h,p=i.length===o/2,u=(l||d)&&a!=null&&a.a>0?a:void 0,m=u?new c.bnF:void 0,g=this.#l,y=this.#h;for(let S=0;S<o;S++){const D=e[S];if(this.#S.projectPixelTo3dPlane(ut,D),g[S*3+0]=ut.x,g[S*3+1]=ut.y,g[S*3+2]=ut.z,f){const A=p?i[S>>>1]:i[S]??t??Io;y[S*4+0]=U(A.r)*255,y[S*4+1]=U(A.g)*255,y[S*4+2]=U(A.b)*255,y[S*4+3]=A.a*255}S===0?m?.moveTo(ut.x,ut.y):m?.lineTo(ut.x,ut.y)}if(l&&(g[o*3+0]=g[0],g[o*3+1]=g[1],g[o*3+2]=g[2],f&&(y[o*4+0]=y[0],y[o*4+1]=y[1],y[o*4+2]=y[2],y[o*4+3]=y[3]),m?.closePath()),u?(this.#d&&(this.#d.dispose(),this.#d=void 0),this.#d=new c.oa8(m),this.#u??=new c.vBJ({side:c.ehD,...Is}),this.#c?this.#c.geometry=this.#d:(this.#c=new c.Kj0(this.#d,this.#u),this.#c.renderOrder=ws.FILL,this.add(this.#c)),this.#c.position.set(0,0,1),this.#u.color.setRGB(u.r,u.g,u.b).convertSRGBToLinear(),this.#u.opacity=u.a,this.#u.needsUpdate=!0):(this.#d?.dispose(),this.#u?.dispose(),this.#c?.removeFromParent(),this.#d=void 0,this.#u=void 0,this.#c=void 0),f)this.#s.vertexColors=!0,this.#n.vertexColors=!0,this.#n.color.setRGB(1,1,1),this.#e.getAttribute("instanceColorStart").needsUpdate=!0,this.#e.getAttribute("instanceColorEnd").needsUpdate=!0;else{const S=t??Io;this.#s.vertexColors=!1,this.#n.vertexColors=!1,this.#n.color.setRGB(S.r,S.g,S.b).convertSRGBToLinear(),this.#n.opacity=S.a}switch(this.#n.needsUpdate=!0,this.#e.setPositions(g),r){case"polygon":this.#e.instanceCount=o;break;case"line_strip":this.#e.instanceCount=o-1;break;case"line_list":this.#e.instanceCount=o>>>1;break}}}}function uu(s){const{position:{x:t,y:i},radius:n}=s;return{type:"points",stamp:s.stamp,style:"polygon",points:new Array(32).fill(void 0).map((r,a)=>{const o=2*Math.PI*a/32;return{x:t+n*Math.cos(o),y:i+n*Math.sin(o)}}),outlineColors:[],outlineColor:s.outlineColor,thickness:s.thickness,fillColor:s.fillColor,messagePath:s.messagePath}}class Et extends c.u9r{attributes={};#e=new Map;#t;#s=0;constructor(e=c.dj0){super(),this.#t=e}setUsage(e){this.#t=e;for(const t of Object.values(this.attributes))t.setUsage(e)}createAttribute(e,t,i,n){const r=new t(this.#s*i),a=new c.TlE(r,i,n);return a.setUsage(this.#t),this.#e.set(e,t),this.setAttribute(e,a)}resize(e){if(this.setDrawRange(0,e),e<=this.#s){for(const t of Object.values(this.attributes))t.count=e;return}for(const[t,i]of Object.entries(this.attributes)){const n=this.#e.get(t);if(!n)throw new Error(`DynamicBufferGeometry resize(${e}) failed, missing data constructor for attribute "${t}". Attributes must be created using createAttribute().`);const r=new n(e*i.itemSize),a=new c.TlE(r,i.itemSize,i.normalized);a.setUsage(this.#t),this.setAttribute(t,a)}this.#s=e}}const hi=new c.Pa4;class fu extends c.jyz{constructor(){super({vertexShader:c.WdD.points_vert,fragmentShader:`
        uniform vec4 objectId;
        void main() {
          gl_FragColor = objectId;
        }
      `,uniforms:{...c.rBU.points,...c.rBU.fog,objectId:{value:[NaN,NaN,NaN,NaN]}}})}}class pu extends F{#e;#t;#s;#i;#n=0;#r=0;#a=!1;#o;#l;#h=!1;#c;#d=!1;constructor(e){super(e,void 0,{receiveTime:0n,messageTime:0n,frameId:"",pose:{position:{x:0,y:0,z:0},orientation:{x:0,y:0,z:0,w:0}},settingsPath:[],settings:{visible:!0},topic:e}),this.#e=new Et,this.#e.createAttribute("position",Float32Array,3),this.#e.createAttribute("color",Uint8Array,4,!0),this.#s=new c.UY4({size:0,sizeAttenuation:!1,vertexColors:!0,...Is}),this.#i=new fu,this.#t=new c.woe(this.#e,this.#s),this.#t.renderOrder=ws.POINTS,this.#t.userData.pickingMaterial=this.#i,this.add(this.#t)}dispose(){this.#e.dispose(),this.#s.dispose(),this.#i.dispose(),super.dispose()}details(){return this.#o&&this.#l?{annotation:Ln(this.#o,this.#l.messagePath),originalMessage:this.#o}:{}}setScale(e,t,i,n){this.#a||=e!==this.#n||n!==this.#r,this.#n=e,this.#r=n}setCameraModel(e){this.#d||=this.#c!==e,this.#c=e}setAnnotation(e,t){this.#h||=this.#l!==e,this.#o=t,this.#l=e}update(){if(!this.#l||!this.#c){this.visible=!1;return}if(this.visible=!0,this.#h||this.#a){this.#a=!1;const{thickness:e}=this.#l;this.#s.size=e*2*this.#n,this.#s.needsUpdate=!0,this.#i.uniforms.size.value=e*2*this.#n*this.#r,this.#i.needsUpdate=!0}if(this.#h||this.#d){this.#h=!1,this.#d=!1;const{points:e,outlineColors:t,outlineColor:i,fillColor:n}=this.#l;this.#e.resize(e.length);const r=this.#e.getAttribute("position"),a=this.#e.getAttribute("color"),o=r.array,l=a.array,d=i&&i.a>0?i:n;for(let h=0;h<e.length;h++){const f=t[h]??d,p=e[h];this.#c.projectPixelTo3dPlane(hi,p),o[h*3+0]=hi.x,o[h*3+1]=hi.y,o[h*3+2]=hi.z,l[h*4+0]=U(f?.r??0)*255,l[h*4+1]=U(f?.g??0)*255,l[h*4+2]=U(f?.b??0)*255,l[h*4+3]=(f?.a??0)*255}r.needsUpdate=!0,a.needsUpdate=!0}}}class mu extends F{#e;#t;#s=0;#i=!1;#n;#r;#a=!1;#o;#l=!1;constructor(e,t){super(e,void 0,{receiveTime:0n,messageTime:0n,frameId:"",pose:{position:{x:0,y:0,z:0},orientation:{x:0,y:0,z:0,w:0}},settingsPath:[],settings:{visible:!0},topic:e}),this.#e=t,this.#t=t.acquire(),this.#t.mesh.renderOrder=ws.TEXT,this.#t.setAnchorPoint(0,0),this.#t.setBillboard(!0),this.#t.setSizeAttenuation(!1),this.add(this.#t)}dispose(){this.#t.mesh.renderOrder=0,this.#e.release(this.#t),super.dispose()}details(){return this.#n&&this.#r?{annotation:Ln(this.#n,this.#r.messagePath),originalMessage:this.#n}:{}}setScale(e,t,i,n){this.#i||=e!==this.#s,this.#s=e}setCameraModel(e){this.#l||=this.#o!==e,this.#o=e}setAnnotation(e,t){this.#a||=this.#r!==e,this.#n=t,this.#r=e}update(){if(!this.#r||!this.#o){this.visible=!1;return}this.visible=!0;const{position:e,text:t,textColor:i,backgroundColor:n,fontSize:r}=this.#r;(this.#a||this.#i)&&(this.#t.setLineHeight(r*this.#s),this.#i=!1),this.#a&&(this.#t.setText(t),this.#t.setColor(U(i.r),U(i.g),U(i.b)),this.#t.setOpacity(Math.min(i.a,.999)),n?this.#t.setBackgroundColor(U(n.r),U(n.g),U(n.b)):Vs(i.r,i.g,i.b)<.5?this.#t.setBackgroundColor(1,1,1):this.#t.setBackgroundColor(0,0,0)),(this.#a||this.#l)&&this.#o.projectPixelTo3dPlane(this.#t.position,e),this.#a=!1,this.#l=!1}}class gu extends c.Tme{#e;#t=[];#s=[];#i=[];#n=0;#r=0;#a=0;#o=0;#l=!1;#h=[];#c=!1;#d;#u=!1;#f;#p;constructor(e,t){super(),this.#e=t,this.#p=e}dispose(){for(const e of this.#t)e.dispose();for(const e of this.#s)e.dispose()}setScale(e,t,i,n){this.#l||=this.#n!==e,this.#n=e,this.#r=t,this.#a=i,this.#o=n}setOriginalMessage(e){this.#f=e}setCameraModel(e){this.#u||=this.#d!==e,this.#d=e}setAnnotations(e){this.#c||=this.#h!==e,this.#h=e}update(){if(this.#l){this.#l=!1;for(const r of this.#t)r.setScale(this.#n,this.#r,this.#a,this.#o);for(const r of this.#s)r.setScale(this.#n,this.#r,this.#a,this.#o);for(const r of this.#i)r.setScale(this.#n,this.#r,this.#a,this.#o)}if(this.#u){this.#u=!1;for(const r of this.#t)r.setCameraModel(this.#d);for(const r of this.#s)r.setCameraModel(this.#d);for(const r of this.#i)r.setCameraModel(this.#d)}const e=()=>{for(const r of this.#t)r.update();for(const r of this.#s)r.update();for(const r of this.#i)r.update()};if(!this.#c){e();return}this.#c=!1;const t=this.#t.reverse();this.#t=[];const i=this.#s.reverse();this.#s=[];const n=this.#i.reverse();this.#i=[];for(const r of this.#h)switch(r.type){case"circle":{let a=i.pop();a||(a=new Do(this.#p),a.setScale(this.#n,this.#r,this.#a,this.#o),a.setCameraModel(this.#d),this.add(a)),this.#s.push(a),a.setAnnotationFromCircle(r,this.#f);break}case"points":switch(r.style){case"points":{let a=t.pop();a||(a=new pu(this.#p),a.setScale(this.#n,this.#r,this.#a,this.#o),a.setCameraModel(this.#d),this.add(a)),this.#t.push(a),a.setAnnotation(r,this.#f);break}case"polygon":case"line_strip":case"line_list":{let a=i.pop();a||(a=new Do(this.#p),a.setScale(this.#n,this.#r,this.#a,this.#o),a.setCameraModel(this.#d),this.add(a)),this.#s.push(a),a.setAnnotation(r,this.#f);break}}break;case"text":{let a=n.pop();a||(a=new mu(this.#p,this.#e),a.setScale(this.#n,this.#r,this.#a,this.#o),a.setCameraModel(this.#d),this.add(a)),this.#i.push(a),a.setAnnotation(r,this.#f);break}}e();for(const r of t)r.removeFromParent(),r.dispose();for(const r of i)r.removeFromParent(),r.dispose();for(const r of n)r.removeFromParent(),r.dispose()}}const bu=/^.+\/(?=.)/;function Nn(s){return bu.exec(s)?.[0]}function On(s,e,t){const i=Nn(e);i!=null&&s.sort((n,r)=>{const a=t(n).startsWith(i),o=t(r).startsWith(i);return a===o?0:a?-1:1})}const yu=new Set(["foxglove_msgs/ImageMarkerArray","foxglove_msgs/msg/ImageMarkerArray","studio_msgs/ImageMarkerArray","studio_msgs/msg/ImageMarkerArray","webviz_msgs/ImageMarkerArray"]),Co=new Set([...jr,...Qr,...qr,...yu]);class vu extends c.Tme{#e;#t=new Map;#s;#i;#n;#r;#a;constructor(e){super(),this.#e=e,this.#i=e.initialScale,this.#n=e.initialCanvasWidth,this.#r=e.initialCanvasHeight,this.#a=e.initialPixelRatio,e.messageHandler.addListener(this.#o)}getSubscriptions(){return[{type:"schema",schemaNames:Co,subscription:{handler:this.#e.messageHandler.handleAnnotations}}]}dispose(){for(const e of this.#t.values())e.dispose();this.children.length=0,this.#t.clear()}removeAllRenderables(){for(const e of this.#t.values())e.dispose(),this.remove(e);this.#t.clear()}updateScale(e,t,i,n){this.#i=e,this.#n=t,this.#r=i,this.#a=n;for(const r of this.#t.values())r.setScale(e,t,i,n),r.update()}updateCameraModel(e){this.#s=e;for(const t of this.#t.values())t.setCameraModel(e),t.update()}#o=e=>{if(e.annotationsByTopic!=null)for(const{originalMessage:t,annotations:i}of e.annotationsByTopic.values())this.#l(t,i)};#l(e,t){let i=this.#t.get(e.topic);i||(i=new gu(e.topic,this.#e.labelPool),i.setScale(this.#i,this.#n,this.#r,this.#a),i.setCameraModel(this.#s),this.#t.set(e.topic,i),this.add(i)),i.setOriginalMessage(e.message),i.setAnnotations(t),i.update()}#h(e){if(e.action!=="update"||e.payload.path.length<2)return;const{value:t,path:i}=e.payload,n=i[1];i[0]==="imageAnnotations"&&i[2]==="visible"&&typeof t=="boolean"&&this.#c(n,t),this.#e.updateSettingsTree()}#c(e,t){this.#e.updateConfig(n=>{n.annotations??={};const r=n.annotations[e]??={};r.visible=t}),this.#e.messageHandler.setConfig({annotations:this.#e.config().annotations});const i=this.#t.get(e);i&&(i.visible=t)}settingsNodes(){const e=[];e.push({path:["imageAnnotations"],node:{label:(0,x.t)("threeDee:imageAnnotations"),enableVisibilityFilter:!0,defaultExpansionState:"expanded"}});const t=this.#e.config(),i=this.#e.topics().filter(n=>$(n,Co));t.imageTopic&&On(i,t.imageTopic,n=>n.name);for(const n of i){const r=t.annotations?.[n.name];e.push({path:["imageAnnotations",n.name],node:{label:n.name,visible:r?.visible??!1,handler:this.#h.bind(this)}})}return e}}const Kt=["imageMode","imageTopic"],At=["imageMode","calibrationTopic"],Mo="IMAGE_TOPIC_UNAVAILABLE",Eo="CALIBRATION_TOPIC_UNAVAILABLE",Ao="MISSING_CAMERA_INFO",_o="IMAGE_TOPIC_DIFFERENT_FRAME",Po="CameraModel",Su=500,Tu=50,Ro=new Set([...ds,...hs,...It,...as]),Fn=new Set([...kt,...Ft]),ui={synchronize:!1,flipHorizontal:!1,flipVertical:!1,rotation:0};class xu extends Q.d{#e;#t;#s;#i;#n;#r;#a=new c.FM8;#o=new c.FM8;#l=!1;#h;#c;constructor(e,{canvasSize:t,setHasCalibrationTopic:i}){super("foxglove.ImageMode",e),this.#c=i,this.#e=new tu;const n=this.#y();this.#e.setCanvasSize(t.width,t.height),this.#e.setRotation(n.rotation),this.#e.setFlipHorizontal(n.flipHorizontal),this.#e.setFlipVertical(n.flipVertical),this.#r=new cu(n),this.#r.addListener(this.#b),e.settings.errors.on("update",this.#w),e.settings.errors.on("clear",this.#w),e.settings.errors.on("remove",this.#w),this.#s=new vu({initialScale:this.#e.getEffectiveScale(),initialCanvasWidth:t.width,initialCanvasHeight:t.height,initialPixelRatio:e.getPixelRatio(),topics:()=>e.topics??[],config:()=>this.#y(),updateConfig:r=>{e.updateConfig(a=>r(a.imageMode))},updateSettingsTree:()=>{this.updateSettingsTree()},labelPool:e.labelPool,messageHandler:this.#r}),this.add(this.#s),e.input.on("mousedown",r=>{this.#e.getPanOffset(this.#a),this.#o.copy(r),e.input.trackDrag(a=>{this.#e.setPanOffset(a.clone().sub(this.#o).add(this.#a)),this.#l=!0,this.dispatchEvent({type:"hasModifiedViewChanged"}),this.renderer.queueAnimationFrame()})}),e.input.on("wheel",(r,a,o)=>{this.#e.updateZoomFromWheel(1-.01*c.M8C.clamp(o.deltaY,-30,30),r),this.#I(),this.#l=!0,this.dispatchEvent({type:"hasModifiedViewChanged"}),this.renderer.queueAnimationFrame()}),this.renderer.on("topicsChanged",this.#d),this.#d()}hasModifiedView(){return this.#l}resetViewModifications(){this.#l=!1,this.#e.resetModifications(),this.#I(),this.dispatchEvent({type:"hasModifiedViewChanged"})}getSubscriptions(){return[{type:"schema",schemaNames:Fn,subscription:{handler:this.#r.handleCameraInfo,shouldSubscribe:this.#f}},{type:"schema",schemaNames:ds,subscription:{handler:this.#r.handleRosRawImage,shouldSubscribe:this.#p}},{type:"schema",schemaNames:hs,subscription:{handler:this.#r.handleRosCompressedImage,shouldSubscribe:this.#p}},{type:"schema",schemaNames:It,subscription:{handler:this.#r.handleRawImage,shouldSubscribe:this.#p}},{type:"schema",schemaNames:as,subscription:{handler:this.#r.handleCompressedImage,shouldSubscribe:this.#p}}].concat(this.#s.getSubscriptions())}dispose(){this.renderer.settings.errors.off("update",this.#w),this.renderer.settings.errors.off("clear",this.#w),this.renderer.settings.errors.off("remove",this.#w),this.renderer.off("topicsChanged",this.#d),this.#s.dispose(),this.#i?.dispose(),super.dispose()}removeAllRenderables(){this.#n==null&&(this.#n=setTimeout(()=>{this.#n=void 0,this.#i?.dispose(),this.#i?.removeFromParent(),this.#i=void 0,this.#S()},Tu)),this.#s.removeAllRenderables(),this.#r.clear(),this.#h=void 0,super.removeAllRenderables()}#d=()=>{if(this.#y().imageTopic!=null)return;const e=this.renderer.topics?.find(i=>$(i,Ro));if(e==null)return;const t=this.#u(e.name);this.renderer.updateConfig(i=>{i.imageMode.imageTopic=e.name,t!=null&&(i.imageMode.calibrationTopic=t.name)}),t&&this.#c(!0)};#u(e){const t=Nn(e);if(t!=null)return this.renderer.topics?.find(i=>$(i,Fn)&&i.name.startsWith(t))}settingsNodes(){const e=this.handleSettingsAction,{imageTopic:t,calibrationTopic:i,synchronize:n,flipHorizontal:r,flipVertical:a,rotation:o,minValue:l,maxValue:d}=this.#y(),h=(0,Ts.Z)(this.renderer.topics??[],g=>{if($(g,Ro))return{label:g.name,value:g.name}}),f=(0,Ts.Z)(this.renderer.topics??[],g=>{if($(g,Fn))return{label:g.name,value:g.name}});t&&On(f,t,g=>g.label),f.unshift({label:"None",value:void 0}),t&&!h.some(g=>g.value===t)?this.renderer.settings.errors.add(Kt,Mo,`${t} is not available`):this.renderer.settings.errors.remove(Kt,Mo),i&&!f.some(g=>g.value===i)?this.renderer.settings.errors.add(At,Eo,`${i} is not available`):this.renderer.settings.errors.remove(At,Eo);const p=this.renderer.settings.errors.errors.errorAtPath(Kt),u=this.renderer.settings.errors.errors.errorAtPath(At),m={};return m.imageTopic={label:"Topic",input:"select",value:t,options:h,error:p},m.calibrationTopic={label:"Calibration",input:"select",value:i,options:f,error:u},m.synchronize={input:"boolean",label:"Sync annotations",value:n},m.flipHorizontal={input:"boolean",label:"Flip horizontal",value:r},m.flipVertical={input:"boolean",label:"Flip vertical",value:a},m.rotation={input:"toggle",label:"Rotation",value:o,options:[{label:"0\xB0",value:0},{label:"90\xB0",value:90},{label:"180\xB0",value:180},{label:"270\xB0",value:270}]},m.minValue={input:"number",label:"Min (depth images)",placeholder:"0",step:1,precision:0,value:l},m.maxValue={input:"number",label:"Max (depth images)",placeholder:"10000",step:1,precision:0,value:d},[{path:["imageMode"],node:{label:"General",defaultExpansionState:"expanded",handler:e,fields:m}},...this.#s.settingsNodes()]}handleSettingsAction=e=>{if(e.action!=="update"||e.payload.path.length===0)return;const t=e.payload.path,i=t[0],n=e.payload.value;if(i==="imageMode"){const r=this.#y();this.saveSetting(t,n);const a=this.#y();if(a.calibrationTopic!==r.calibrationTopic&&(a.calibrationTopic==null&&this.#c(!1),r.calibrationTopic==null&&this.#c(!0)),a.imageTopic!==r.imageTopic&&a.imageTopic!=null){const d=this.#u(a.imageTopic);d&&(this.renderer.updateConfig(h=>{h.imageMode.calibrationTopic=d.name}),this.#c(!0))}a.rotation!==r.rotation&&this.#e.setRotation(a.rotation),a.flipHorizontal!==r.flipHorizontal&&this.#e.setFlipHorizontal(a.flipHorizontal),a.flipVertical!==r.flipVertical&&this.#e.setFlipVertical(a.flipVertical),(a.minValue!==r.minValue||a.maxValue!==r.maxValue)&&this.#i?.setSettings({...this.#i.userData.settings,minValue:a.minValue,maxValue:a.maxValue}),a.synchronize!==r.synchronize&&this.removeAllRenderables(),this.#r.setConfig(a),this.#D()}else return;this.updateSettingsTree()};#f=e=>this.#y().calibrationTopic===e;#p=e=>this.#y().imageTopic===e;#b=(e,t)=>{e.image!=null&&e.image!==t?.image&&this.#v(e.image,e.image.message),e.cameraInfo!=null&&e.cameraInfo!==t?.cameraInfo&&this.#m(e.cameraInfo)};#m=e=>{this.#C(e),this.#D()};#v=(e,t)=>{const i=e.topic,n=(0,w.toNanoSec)(e.receiveTime),r="header"in t?t.header.frame_id:t.frame_id;this.#n!=null&&(clearTimeout(this.#n),this.#n=void 0);const a=this.#x(i,n,t,r);this.#h={topic:e.topic,image:t},this.#t&&(a.userData.cameraInfo=this.#t.info,a.setCameraModel(this.#t.model)),a.name=i,a.userData.receiveTime=n,a.setImage(t,void 0,o=>{this.#T()&&this.#g(o,uo(t))})};#g=(e,t)=>{const i=wu({frameId:t,height:e.height,width:e.width,focalLength:Su});this.#C(i),this.#D()};#T=()=>this.renderer.config.imageMode.calibrationTopic==null;#S=()=>{this.#t=void 0,this.#e.updateCamera(void 0),this.#e.updateProjectionMatrix()};#x(e,t,i,n){let r=this.#i;if(r)return r;const a=this.#y(),o={...Zt,minValue:a.minValue,maxValue:a.maxValue,planarProjectionFactor:1};return r=new ho(e,this.renderer,{receiveTime:t,messageTime:i?(0,w.toNanoSec)("header"in i?i.header.stamp:i.timestamp):0n,frameId:this.renderer.normalizeFrameId(n),pose:(0,L.N2)(),settingsPath:Kt,topic:e,settings:o,cameraInfo:void 0,cameraModel:void 0,image:i,texture:void 0,material:void 0,geometry:void 0,mesh:void 0}),this.add(r),this.#i=r,r.setRenderBehindScene(),r.visible=!0,r}#M(){const{imageMode:e}=this.renderer.config,{calibrationTopic:t,imageTopic:i}=e;if(t==null&&i==null)return;const n=this.#t?.info,r=this.#i?.userData.image,a=n?.header.frame_id,o=r&&uo(r);return o!=null&&(o!==a?this.renderer.settings.errors.add(Kt,_o,`Image topic's frame id (${o}) does not match camera info's frame id (${a})`):this.renderer.settings.errors.remove(Kt,_o)),a??o}#y(){const e={...this.renderer.config.imageMode};return{...e,synchronize:e.synchronize??ui.synchronize,rotation:e.rotation??ui.rotation,flipHorizontal:e.flipHorizontal??ui.flipHorizontal,flipVertical:e.flipVertical??ui.flipVertical}}#D(){if(this.#t?.info)this.renderer.settings.errors.remove(At,Ao);else{this.renderer.settings.errors.add(At,Ao,"Missing camera info for topic");return}if(this.renderer.setFollowFrameId(this.#M()),this.#t?.model){this.#e.updateCamera(this.#t.model),this.#I();const t=this.#i;t&&(t.userData.cameraInfo=this.#t.info,t.setCameraModel(this.#t.model),t.update())}}#C(e){const t=this.#t?.info;if(Dn(t,e)&&t!=null)return;const n=this.#E(e);n&&(this.#t={model:n,info:e},this.#s.updateCameraModel(n))}#E(e){let t;try{t=new xn(e),this.renderer.settings.errors.remove(At,Po)}catch(i){this.#t=void 0;const n=i;this.renderer.settings.errors.add(At,Po,n.message)}return t}getActiveCamera(){return this.#e}handleResize(e,t,i){this.#e.setCanvasSize(e,t),this.#I()}#I(){this.#s.updateScale(this.#e.getEffectiveScale(),this.renderer.input.canvasSize.width,this.renderer.input.canvasSize.height,this.renderer.getPixelRatio())}setCameraState(){this.#D()}getCameraState(){}#w=()=>{this.updateSettingsTree()};getLatestImage(){if(!this.#h)return;const e=this.#y();return{...this.#h,rotation:e.rotation,flipHorizontal:e.flipHorizontal,flipVertical:e.flipVertical,minValue:e.minValue,maxValue:e.maxValue}}}const wu=s=>{const{width:e,height:t,focalLength:i,frameId:n}=s,r=e/2,a=t/2,o=i,l=i;return ii({header:{seq:0,stamp:{sec:0,nsec:0},frame_id:n},height:t,width:e,distortion_model:"",R:[1,0,0,0,1,0,0,0,1],D:[],K:[o,0,r,0,l,a,0,0,1],P:[o,0,r,0,0,l,a,0,0,0,1,0]})};class Iu{#e=new Map;get(e){return this.#e.get(e)}set(e,t){const i=this.#e.get(e);i==null?this.#e.set(e,[t]):i.includes(t)||i.push(t)}delete(e,t){const i=this.#e.get(e);if(i!=null){const n=i.indexOf(t);n>=0&&(i.splice(n,1),i.length===0&&this.#e.delete(e))}}deleteAll(e){this.#e.delete(e)}clear(){this.#e.clear()}}var Du="../../packages/studio-base/src/panels/ThreeDeeRender/renderables/Images.ts";const Cu=R.ZP.getLogger(Du),Mu=512,fi="NoCameraInfo",Lo="CameraModel";class Eu extends Q.d{#e=new Set;#t=new Iu;#s=new Map;constructor(e){super("foxglove.Images",e),this.renderer.on("topicsChanged",this.#i),this.#i()}dispose(){this.renderer.off("topicsChanged",this.#i),super.dispose()}getSubscriptions(){return[{type:"schema",schemaNames:Jh,subscription:{handler:this.#c,shouldSubscribe:this.#n}},{type:"schema",schemaNames:ds,subscription:{handler:this.#r}},{type:"schema",schemaNames:hs,subscription:{handler:this.#a}},{type:"schema",schemaNames:It,subscription:{handler:this.#o}},{type:"schema",schemaNames:as,subscription:{handler:this.#l}}]}#i=()=>{this.#e=new Set;for(const e of this.renderer.topics??[])($(e,kt)||$(e,Ft))&&this.#e.add(e.name)};settingsNodes(){const e=this.renderer.config.topics,t=this.handleSettingsAction,i=[];for(const n of this.renderer.topics??[]){if(!($(n,ds)||$(n,hs)||$(n,It)||$(n,as)))continue;const r=n.name,a=e[r]??{},o=Array.from(this.#e,d=>({label:d,value:d}));o.sort(),On(o,r,d=>d.value);const l={cameraInfoTopic:{label:"Camera Info",input:"select",options:o,value:a.cameraInfoTopic},distance:{label:"Distance",input:"number",placeholder:String(Zt.distance),step:.1,precision:k,value:a.distance},planarProjectionFactor:{label:"Planar Projection Factor",input:"number",placeholder:String(Zt.planarProjectionFactor),min:0,max:1,step:.1,precision:2,value:a.planarProjectionFactor},color:{label:"Color",input:"rgba",value:a.color}};i.push({path:["topics",r],node:{icon:"ImageProjection",fields:l,visible:a.visible??Zt.visible,order:r.toLocaleLowerCase(),handler:t}})}return i}handleSettingsAction=e=>{const t=e.payload.path;if(e.action!=="update"||t.length!==3)return;const i=t[1],r=this.renderer.config.topics[i]?.cameraInfoTopic;this.saveSetting(t,e.payload.value);const a=this.renderer.config.topics[i],o=a?.cameraInfoTopic;o!==r&&o!=null&&this.#t.set(o,i);const l=this.renderables.get(i);if(!l||(l.setSettings({...Zt,...a}),r!=null&&this.#t.delete(r,i),!o))return;const d=this.#s.get(o);if(!d){this.renderer.settings.errors.addToTopic(i,fi,`No CameraInfo received on ${o}`);return}this.#d(l,d),l.update()};#n=e=>{for(const t of Object.values(this.renderer.config.topics)){const i=t;if(i.cameraInfoTopic===e&&i.visible===!0)return!0}return!1};#r=e=>{this.#h(e,mo(e.message))};#a=e=>{this.#h(e,go(e.message))};#o=e=>{this.#h(e,bo(e.message))};#l=e=>{this.#h(e,yo(e.message))};#h=(e,t)=>{const i=e.topic,n=(0,w.toNanoSec)(e.receiveTime),r="header"in t?t.header.frame_id:t.frame_id,a=this.#u(i,n,t,r);a.setImage(t,Mu),a.userData.receiveTime=n;const o=a.userData.settings;if(o.cameraInfoTopic==null){const d=Nn(i),h=d!=null?(0,Ts.Z)(this.#e,f=>f.startsWith(d)?f:void 0).sort()[0]:void 0;if(o.cameraInfoTopic=h,a.setSettings(o),h==null){this.renderer.settings.errors.addToTopic(i,fi,"No CameraInfo topic found");return}this.renderer.updateConfig(f=>{const p={...o};p.cameraInfoTopic=h,f.topics[i]=p}),this.updateSettingsTree()}(0,V.assert)(o.cameraInfoTopic!=null),this.#t.set(o.cameraInfoTopic,i);const l=this.#s.get(o.cameraInfoTopic);l?this.#d(a,l):this.renderer.settings.errors.addToTopic(i,fi,`No CameraInfo received on ${o.cameraInfoTopic}`)};#c=e=>{const t=ii(e.message);this.#s.set(e.topic,t);const i=this.#t.get(e.topic)??[];for(const n of i){const r=this.renderables.get(n);if(!r)continue;const a=r.userData.settings;!a.cameraInfoTopic||a.cameraInfoTopic!==e.topic||(this.renderer.settings.errors.removeFromTopic(n,fi),this.#d(r,t),r.update())}};#d(e,t){if(Dn(e.userData.cameraInfo,t)&&e.userData.cameraModel!=null)return;const n=e.userData.topic;try{e.setCameraModel(new xn(t)),e.userData.cameraInfo=t,this.renderer.settings.errors.removeFromTopic(n,Lo)}catch(r){const a=r;this.renderer.settings.errors.addToTopic(n,Lo,a.message)}}#u(e,t,i,n){let r=this.renderables.get(e);if(r)return r;const a=this.renderer.config.topics[e];return r=new ho(e,this.renderer,{receiveTime:t,messageTime:i?(0,w.toNanoSec)("header"in i?i.header.stamp:i.timestamp):0n,frameId:this.renderer.normalizeFrameId(n),pose:(0,L.N2)(),settingsPath:["topics",e],topic:e,settings:{...Zt,...a},cameraInfo:void 0,cameraModel:void 0,image:i,texture:void 0,material:void 0,geometry:void 0,mesh:void 0}),this.add(r),this.renderables.set(e,r),r}}var Be=b(93254),Ds=b(10336);const Au=1.5,_u="circle",Pu="turbo",Ru={r:1,g:1,b:1,a:1},Lu={r:100/255,g:47/255,b:105/255,a:1},Nu={r:227/255,g:177/255,b:135/255,a:1},pi={visible:!1,frameLocked:!1,pointSize:Au,pointShape:_u,decayTime:0,colorMode:"flat",flatColor:ne(Ru),colorField:void 0,gradient:[ne(Lu),ne(Nu)],colorMap:Pu,explicitAlpha:1,minValue:void 0,maxValue:void 0},No=["x","y","z"],Ou=[{label:"Circle",value:"circle"},{label:"Square",value:"square"}];function Un(s,e,t,i=pi){const n=t.pointSize,r=t.pointShape??"circle",a=t.decayTime,o=Zr(e,t,s,i,{supportsPackedRgbModes:Ys.has(s.schemaName),supportsRgbaFieldsMode:Ot.has(s.schemaName)});return o.fields={pointSize:{label:"Point size",input:"number",step:1,placeholder:"2",precision:2,value:n,min:0},pointShape:{label:"Point shape",input:"select",options:Ou,value:r},decayTime:{label:"Decay time",input:"number",step:.5,placeholder:"0 seconds",min:0,precision:3,value:a},...o.fields},o}function Oo(s,e,{supportsPackedRgbModes:t}){if(t)for(const n of e.fields){if(!Ct(n))continue;const r=n.name.toLowerCase();if(en.has(r)){switch(s.colorField=n.name,r){case"rgb":s.colorMode="rgb";break;default:case"rgba":s.colorMode="rgba";break}return}}for(const n of e.fields)if(Ct(n)&&Hr.has(n.name)){s.colorField=n.name,s.colorMode="colormap",s.colorMap="turbo";return}const i=e.fields.find(n=>Ct(n));if(i!=null){s.colorField=i.name,s.colorMode="colormap",s.colorMap="turbo";return}}function Fo(s,e){const t=new Et(e);return t.name=`${s}:PointScans:geometry`,t.createAttribute("position",Float32Array,3),t.createAttribute("color",Uint8Array,4,!0),t}function zn(s){switch(s.colorMode){case"flat":case"colormap":case"gradient":return"linear";case"rgb":case"rgba":case"rgba-fields":return"srgb"}}function mi(s,e,t,i,n,r){const a=new c.woe(t,i);return a.frustumCulled=!1,a.name=`${s}:PointCloud:points`,a.userData={pickingMaterial:n,instancePickingMaterial:r,pose:e},a}const Fu=`
outgoingLight = sRGBToLinear(outgoingLight);
`,Uu=`
vec2 cxy = 2.0 * gl_PointCoord - 1.0;
if (dot(cxy, cxy) > 1.0) { discard; }
`;function kn(s){const e=Ws(s),t=zn(s),i=s.pointSize,n=s.pointShape,r=new c.UY4({vertexColors:!0,size:i,sizeAttenuation:!1,transparent:e,depthWrite:!0});return r.customProgramCacheKey=()=>`${n}-${t}`,r.onBeforeCompile=a=>{const o="#include <output_fragment>";n==="circle"&&(a.fragmentShader=a.fragmentShader.replace(o,Uu+o)),t==="srgb"&&(a.fragmentShader=Kr+a.fragmentShader.replace(o,Fu+o))},r}function Uo(s){const t=Math.max(s.pointSize,8);return new c.jyz({vertexShader:`
      uniform float pointSize;
      void main() {
        gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
        gl_PointSize = pointSize;
      }
    `,fragmentShader:`
      uniform vec4 objectId;
      void main() {
        gl_FragColor = objectId;
      }
    `,side:c.ehD,uniforms:{pointSize:{value:t},objectId:{value:[NaN,NaN,NaN,NaN]}}})}function zo(s){const t=Math.max(s.pointSize,8);return new c.jyz({vertexShader:`
        uniform float pointSize;
        varying vec4 objectId;
        void main() {
          objectId = vec4(
            float((gl_VertexID >> 24) & 255) / 255.0,
            float((gl_VertexID >> 16) & 255) / 255.0,
            float((gl_VertexID >> 8) & 255) / 255.0,
            float(gl_VertexID & 255) / 255.0);
          gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
          gl_PointSize = pointSize;
        }
      `,fragmentShader:`
        varying vec4 objectId;
        void main() {
          gl_FragColor = objectId;
        }
      `,side:c.ehD,uniforms:{pointSize:{value:t}}})}class jn{#e;#t;#s;constructor({initial:e,renderer:t,parentRenderable:i}){this.#e=[e],this.#s=t,this.#t=i}addHistoryEntry(e){this.#e.push(e)}updateMaterial(e){for(const t of this.#e)t.object3d.material=e}updateHistoryFromCurrentTime(e){const t=this.#e,i=this.#t.userData.settings.decayTime,n=i>0?e-BigInt(Math.round(i*1e9)):L.Zf;for(;t.length>1&&t[0].receiveTime<n;){const r=this.#e.shift();this.#t.remove(r.object3d),r.object3d.geometry.dispose()}}updatePoses(e,t,i){let n=!1;for(const r of this.#e){const a=r.messageTime,o=this.#t.userData.frameId;if(!(0,Ds.S)(r.object3d,this.#s.transformTree,t,i,o,e,a)&&!n){const d=(0,Be.v)(t,i,o);this.#s.settings.errors.add(this.#t.userData.settingsPath,Be.o,d),n=!0}}}latest(){if(this.#e.length===0)throw new Error("RenderObjectHistory is empty");return this.#e[this.#e.length-1]}clearHistory(){for(const e of this.#e.splice(0,this.#e.length-1))e.object3d.geometry.dispose(),this.#t.remove(e.object3d)}dispose(){for(const e of this.#e)e.object3d.geometry.dispose();this.#e.length=0}}function Gn(){return{position:{x:0,y:0,z:0},orientation:{x:0,y:0,z:0,w:1}}}const ko=pi,zu=["range","intensity"],ku=new Set([...rs,...an]),ju="INVALID_LASERSCAN",Gu=new c.Pa4,Cs={r:0,g:0,b:0,a:0};function jo(s,e){const t=new Et(e);return t.name=`${s}:LaserScan:geometry`,t.createAttribute("position",Float32Array,1),t.createAttribute("color",Uint8Array,4,!0),t}class Bu extends F{pickableInstances=!0;#e;constructor(e,t,i){super(e,t,i);const n=i.settings.decayTime>0,r=jo(e,n?c.dj0:c.W2J),a=mi(e,i.laserScan.pose,r,i.material,i.pickingMaterial,i.instancePickingMaterial);this.#e=new jn({initial:{messageTime:i.receiveTime,receiveTime:i.receiveTime,object3d:a},parentRenderable:this,renderer:t}),this.add(a)}dispose(){this.userData.originalMessage=void 0,this.userData.material.dispose(),this.userData.pickingMaterial.dispose(),this.userData.instancePickingMaterial.dispose(),this.#e.dispose(),super.dispose()}details(){return this.userData.originalMessage??{}}instanceDetails(e){const t=e>=0&&e<this.userData.laserScan.ranges.length?this.userData.laserScan.ranges[e]:void 0,i=e>=0&&e<this.userData.laserScan.intensities.length?this.userData.laserScan.intensities[e]:void 0;return{range:t,intensity:i}}updateLaserScan(e,t,i,n){const r=(0,w.toNanoSec)(e.timestamp);this.userData.receiveTime=n,this.userData.messageTime=r,this.userData.frameId=this.renderer.normalizeFrameId(e.frame_id),this.userData.laserScan=e,this.userData.originalMessage=t,this.userData.settings=i;const{colorField:a}=i,{intensities:o,ranges:l}=e;if(o.length!==0&&o.length!==l.length){const I=`LaserScan intensities length (${o.length}) does not match ranges length (${l.length})`;Go(this.renderer,this,I);return}if(a!=="intensity"&&a!=="range"){const I=`LaserScan color field must be either 'intensity' or 'range', found '${a}'`;Go(this.renderer,this,I);return}const d=this.userData.material,h=this.userData.pickingMaterial,f=this.userData.topic,p=this.#e;if(i.decayTime>0){const I=jo(f,c.W2J),P=mi(f,e.pose,I,d,h,void 0);p.addHistoryEntry({receiveTime:n,messageTime:r,object3d:P}),this.add(P)}const m=p.latest();m.receiveTime=n,m.messageTime=r,m.object3d.userData.pose=e.pose;const g=m.object3d.geometry;g.resize(l.length);const y=g.attributes.position,S=g.attributes.color;y.set(l),d.update(i,e),h.update(i,e);let D=i.minValue??Number.POSITIVE_INFINITY,A=i.maxValue??Number.NEGATIVE_INFINITY;if(i.minValue==null||i.maxValue==null){let I=0;for(let P=0;P<l.length;P++){const O=l[P];Number.isFinite(O)&&(I=Math.max(I,O));const z=a==="range"?O:o[P];Number.isFinite(z)&&(D=Math.min(D,z),A=Math.max(A,z))}D=i.minValue??D,A=i.maxValue??A,m.object3d.geometry.boundingSphere??=new c.aLr,m.object3d.geometry.boundingSphere.set(Gu,I),m.object3d.frustumCulled=!0}else m.object3d.geometry.boundingSphere=null,m.object3d.frustumCulled=!1;const M=i.colorMode==="rgba-fields"?()=>NaN:qi(i,D,A);for(let I=0;I<l.length;I++){const P=a==="range"?l[I]:o[I]??0;M(Cs,P),S.setXYZW(I,Cs.r,Cs.g,Cs.b,Cs.a)}y.needsUpdate=!0,S.needsUpdate=!0}updateUniforms(){const t=this.userData.material.uniforms?.pixelRatio;t&&(t.value=this.renderer.getPixelRatio())}invalidateLastEntry(){this.#e.latest().object3d.geometry.resize(0)}startFrame(e,t,i){this.#e.updateHistoryFromCurrentTime(e),this.#e.updatePoses(e,t,i),this.updateUniforms()}}class Vu extends Q.d{constructor(e){super("foxglove.LaserScans",e)}getSubscriptions(){return[{type:"schema",schemaNames:an,subscription:{handler:this.#e}},{type:"schema",schemaNames:rs,subscription:{handler:this.#e}}]}settingsNodes(){const e=this.renderer.config.topics,t=this.handleSettingsAction,i=[];for(const n of this.renderer.topics??[]){if(!$(n,ku))continue;const a=e[n.name]??{},l=Un(n,zu,a);l.handler=t,l.icon="Radar",i.push({path:["topics",n.name],node:l})}return i}startFrame(e,t,i){for(const[n,r]of this.renderables){if(!r.userData.settings.visible){r.removeFromParent(),r.dispose(),this.renderables.delete(n);continue}r.startFrame(e,t,i),r.updateUniforms()}}handleSettingsAction=e=>{const t=e.payload.path;if(e.action!=="update"||t.length!==3)return;this.saveSetting(t,e.payload.value);const i=t[1],n=this.renderables.get(i);if(n){const r=this.renderer.config.topics[i],a={...ko,...r};n.updateLaserScan(n.userData.laserScan,n.userData.originalMessage,a,n.userData.receiveTime)}};#e=e=>{const t=e.topic,i="header"in e.message?Wu(e.message):$u(e.message),n=(0,w.toNanoSec)(e.receiveTime);let r=this.renderables.get(t);if(!r){const a=this.renderer.config.topics[t],o={...ko,...a};o.colorField==null&&(o.colorField="intensity",o.colorMode="colormap",o.colorMap="turbo",this.renderer.updateConfig(p=>{const u={...a};u.colorField=o.colorField,u.colorMode=o.colorMode,u.colorMap=o.colorMap,p.topics[t]=u}));const l=new gi,d=new gi({picking:!0}),h=new Bn;l.update(o,i),d.update(o,i);const f=(0,w.toNanoSec)(i.timestamp);r=new Bu(t,this.renderer,{receiveTime:n,messageTime:f,frameId:this.renderer.normalizeFrameId(i.frame_id),pose:i.pose,settingsPath:["topics",t],settings:o,topic:t,laserScan:i,originalMessage:e.message,material:l,pickingMaterial:d,instancePickingMaterial:h}),this.add(r),this.renderables.set(t,r)}r.updateLaserScan(i,e.message,r.userData.settings,n)}}class gi extends c.FIo{static#e=8;constructor({picking:e=!1}={}){super({vertexShader:`        #version 300 es
        precision highp float;
        precision highp int;
        uniform mat4 projectionMatrix, modelViewMatrix;

        uniform float pointSize;
        uniform float pixelRatio;
        uniform float angleMin, angleIncrement;
        uniform float rangeMin, rangeMax;
        in float position; // range, but must be named position in order for three.js to render anything
        in mediump vec4 color;
        out mediump vec4 vColor;
        void main() {
          if (position < rangeMin || position > rangeMax) {
            gl_PointSize = 0.0;
            return;
          }
          vColor = color;
          float angle = angleMin + angleIncrement * float(gl_VertexID);
          vec4 pos = vec4(position * cos(angle), position * sin(angle), 0, 1.0);
          gl_Position = projectionMatrix * modelViewMatrix * pos;
          ${e?`gl_PointSize = pixelRatio * max(pointSize, ${gi.#e.toFixed(1)});`:"gl_PointSize = pixelRatio * pointSize;"}

        }
      `,fragmentShader:`        #version 300 es
        #ifdef GL_FRAGMENT_PRECISION_HIGH
          precision highp float;
        #else
          precision mediump float;
        #endif
        uniform bool isCircle;
        ${e?"uniform vec4 objectId;":"in mediump vec4 vColor;"}
        out vec4 outColor;

        ${c.WdD.encodings_pars_fragment}

        void main() {
          if (isCircle) {
            vec2 cxy = 2.0 * gl_PointCoord - 1.0;
            if (dot(cxy, cxy) > 1.0) { discard; }
          }
          ${e?"outColor = objectId;":"outColor = LinearTosRGB(vColor);"}
        }
      `}),this.uniforms={isCircle:{value:!1},pointSize:{value:1},pixelRatio:{value:1},angleMin:{value:NaN},angleIncrement:{value:NaN},rangeMin:{value:NaN},rangeMax:{value:NaN}},e&&(this.uniforms.objectId={value:[NaN,NaN,NaN,NaN]})}update(e,t){this.uniforms.isCircle.value=e.pointShape==="circle",this.uniforms.pointSize.value=e.pointSize,this.uniforms.angleMin.value=t.start_angle,this.uniforms.angleIncrement.value=(t.end_angle-t.start_angle)/(t.ranges.length-1),this.uniforms.rangeMin.value=t.range_min,this.uniforms.rangeMax.value=t.range_max,this.uniformsNeedUpdate=!0;const i=Ws(e);i!==this.transparent&&(this.transparent=i,this.depthWrite=!this.transparent,this.needsUpdate=!0)}}class Bn extends c.FIo{static#e=8;constructor(){const e=Bn.#e.toFixed(1);super({vertexShader:`        #version 300 es
        precision highp float;
        precision highp int;
        uniform mat4 projectionMatrix, modelViewMatrix;

        uniform float pointSize;
        uniform float pixelRatio;
        uniform float angleMin, angleIncrement;
        uniform float rangeMin, rangeMax;
        in float position; // range, but must be named position in order for three.js to render anything
        varying vec4 objectId;
        void main() {
          if (position < rangeMin || position > rangeMax) {
            gl_PointSize = 0.0;
            return;
          }
          objectId = vec4(
            float((gl_VertexID >> 24) & 255) / 255.0,
            float((gl_VertexID >> 16) & 255) / 255.0,
            float((gl_VertexID >> 8) & 255) / 255.0,
            float(gl_VertexID & 255) / 255.0);
          float angle = angleMin + angleIncrement * float(gl_VertexID);
          vec4 pos = vec4(position * cos(angle), position * sin(angle), 0, 1.0);
          gl_Position = projectionMatrix * modelViewMatrix * pos;
          gl_PointSize = pixelRatio * max(pointSize, ${e});
        }
      `,fragmentShader:`        #version 300 es
        #ifdef GL_FRAGMENT_PRECISION_HIGH
          precision highp float;
        #else
          precision mediump float;
        #endif
        uniform bool isCircle;
        varying vec4 objectId;
        out vec4 outColor;

        void main() {
          if (isCircle) {
            vec2 cxy = 2.0 * gl_PointCoord - 1.0;
            if (dot(cxy, cxy) > 1.0) { discard; }
          }
          outColor = objectId;
        }
      `}),this.uniforms={isCircle:{value:!1},pointSize:{value:1},pixelRatio:{value:1},angleMin:{value:NaN},angleIncrement:{value:NaN},rangeMin:{value:NaN},rangeMax:{value:NaN}}}update(e,t){this.uniforms.isCircle.value=e.pointShape==="circle",this.uniforms.pointSize.value=e.pointSize,this.uniforms.angleMin.value=t.angle_min,this.uniforms.angleIncrement.value=t.angle_increment,this.uniforms.rangeMin.value=t.range_min,this.uniforms.rangeMax.value=t.range_max,this.uniformsNeedUpdate=!0}}function Go(s,e,t){s.settings.errors.addToTopic(e.userData.topic,ju,t),e.invalidateLastEntry()}function $u(s){return{timestamp:de(s.timestamp),frame_id:s.frame_id??"",pose:ee(s.pose),start_angle:s.start_angle??0,end_angle:s.end_angle??0,range_min:-1/0,range_max:1/0,ranges:Zs(s.ranges),intensities:Zs(s.intensities)}}function Wu(s){return{timestamp:de(s.header?.stamp),frame_id:s.header?.frame_id??"",pose:Gn(),start_angle:s.angle_min??0,end_angle:s.angle_max??0,range_min:s.range_min??-1/0,range_max:s.range_max??1/0,ranges:Zs(s.ranges),intensities:Zs(s.intensities)}}const Hu="INVALID_CUBE_LIST",Vn="INVALID_LINE_LIST",Bo="INVALID_LINE_STRIP",Yu="INVALID_MARKER_ACTION",Zu="INVALID_MARKER_TYPE",Ku="INVALID_POINTS_LIST",Xu="INVALID_SPHERE_LIST",Ju={visible:!0};class Qu{namespace;markersById=new Map;settings;constructor(e,t,i){this.namespace=t;const r=i.config.topics[e]?.namespaces?.[t];this.settings={...Ju,...r}}}class qu extends F{pickable=!1;namespaces=new Map;dispose(){for(const e of this.namespaces.values())for(const t of e.markersById.values())this.renderer.markerPool.release(t);this.children.length=0,this.namespaces.clear()}addMarkerMessage(e,t){switch(e.action){case re.ADD:case re.MODIFY:this.#e(e,t);break;case re.DELETE:this.#t(e.ns,e.id);break;case re.DELETEALL:{this.#s(e.ns);break}default:this.renderer.settings.errors.addToTopic(this.topic,Yu,`Invalid marker action ${e.action}`)}}update(){for(const e of this.namespaces.values())for(const t of e.markersById.values())t.update(t.userData.originalMarker,t.userData.receiveTime)}startFrame(e,t,i){if(this.visible=this.userData.settings.visible,!this.visible){this.renderer.settings.errors.clearTopic(this.topic);return}for(const n of this.namespaces.values())for(const r of n.markersById.values()){if(r.visible=n.settings.visible,!r.visible)continue;const a=r.userData.marker,o=r.userData.receiveTime,l=r.userData.expiresIn;if(l!=null&&e>o+l){this.#t(n.namespace,a.id);continue}const d=this.renderer.normalizeFrameId(a.header.frame_id),h=a.frame_locked?e:r.userData.messageTime,f=(0,Ds.S)(r,this.renderer.transformTree,t,i,d,e,h);r.visible=f;const p=r.userData.topic;if(f)this.renderer.settings.errors.removeFromTopic(p,Be.o);else{const u=(0,Be.v)(t,i,d);this.renderer.settings.errors.addToTopic(p,Be.o,u)}}}#e(e,t){let i=this.namespaces.get(e.ns);i||(i=new Qu(this.topic,e.ns,this.renderer),this.namespaces.set(e.ns,i));let n=i.markersById.get(e.id);if(n&&n.userData.marker.type!==e.type&&(this.#t(e.ns,e.id),n=void 0),!n){if(n=this.#i(e,t),!n)return;this.add(n),i.markersById.set(e.id,n)}n.update(e,t)}#t(e,t){const i=this.namespaces.get(e);if(i){const n=i.markersById.get(t);if(n)return this.remove(n),this.renderer.markerPool.release(n),i.markersById.delete(t),!0}return!1}#s(e){const t=i=>{for(const n of i.markersById.values())this.remove(n),this.renderer.markerPool.release(n);i.markersById.clear()};if(e.length===0)for(const i of this.namespaces.values())t(i);else{const i=this.namespaces.get(e);i&&t(i)}}#i(e,t){const i=this.renderer.markerPool;switch(e.type){case _.ARROW:return i.acquire(_.ARROW,this.topic,e,t);case _.CUBE:return i.acquire(_.CUBE,this.topic,e,t);case _.SPHERE:return i.acquire(_.SPHERE,this.topic,e,t);case _.CYLINDER:return i.acquire(_.CYLINDER,this.topic,e,t);case _.LINE_STRIP:if(e.points.length===0){const n=Ge(this.topic,e.ns,e.id);this.renderer.settings.errors.addToTopic(this.topic,Bo,`LINE_STRIP marker ${n} has no points`);return}else if(e.points.length===1){const n=Ge(this.topic,e.ns,e.id);this.renderer.settings.errors.addToTopic(this.topic,Bo,`LINE_STRIP marker ${n} only has one point`);return}return i.acquire(_.LINE_STRIP,this.topic,e,t);case _.LINE_LIST:if(e.points.length===0){const n=Ge(this.topic,e.ns,e.id);this.renderer.settings.errors.addToTopic(this.topic,Vn,`LINE_LIST marker ${n} has no points`);return}else if(e.points.length===1){const n=Ge(this.topic,e.ns,e.id);this.renderer.settings.errors.addToTopic(this.topic,Vn,`LINE_LIST marker ${n} only has one point`);return}else if(e.points.length%2!==0){const n=Ge(this.topic,e.ns,e.id);if(this.renderer.settings.errors.addToTopic(this.topic,Vn,`LINE_LIST marker ${n} has an odd number of points (${e.points.length})`),e.points.length===1)return}return i.acquire(_.LINE_LIST,this.topic,e,t);case _.CUBE_LIST:if(e.points.length===0){const n=Ge(this.topic,e.ns,e.id);this.renderer.settings.errors.addToTopic(this.topic,Hu,`CUBE_LIST marker ${n} has no points`);return}return i.acquire(_.CUBE_LIST,this.topic,e,t);case _.SPHERE_LIST:if(e.points.length===0){const n=Ge(this.topic,e.ns,e.id);this.renderer.settings.errors.addToTopic(this.topic,Xu,`SPHERE_LIST marker ${n} has no points`);return}return i.acquire(_.SPHERE_LIST,this.topic,e,t);case _.POINTS:if(e.points.length===0){const n=Ge(this.topic,e.ns,e.id);this.renderer.settings.errors.addToTopic(this.topic,Ku,`POINTS marker ${n} has no points`);return}return i.acquire(_.POINTS,this.topic,e,t);case _.TEXT_VIEW_FACING:return i.acquire(_.TEXT_VIEW_FACING,this.topic,e,t);case _.MESH_RESOURCE:{const n=i.acquire(_.MESH_RESOURCE,this.topic,e,t);return n.update(e,t,!0),n}case _.TRIANGLE_LIST:return i.acquire(_.TRIANGLE_LIST,this.topic,e,t);default:{const n=Ge(this.topic,e.ns,e.id);this.renderer.settings.errors.addToTopic(this.topic,Zu,`Marker ${n} has invalid type ${e.type}`);return}}}}const $n={visible:!1,showOutlines:!0,color:void 0,selectedIdVariable:void 0,namespaces:{}};class ef extends Q.d{constructor(e){super("foxglove.Markers",e)}getSubscriptions(){return[{type:"schema",schemaNames:Hs,subscription:{handler:this.#t}},{type:"schema",schemaNames:nn,subscription:{handler:this.#s}}]}settingsNodes(){const e=this.renderer.config.topics,t=[];for(const i of this.renderer.topics??[]){if(!($(i,Hs)||$(i,nn)))continue;const n=e[i.name]??{},r={label:i.name,icon:"Shapes",order:i.name.toLocaleLowerCase(),fields:{color:{label:"Color",input:"rgba",value:n.color},showOutlines:{label:"Show outline",input:"boolean",value:n.showOutlines},selectedIdVariable:{label:"Selection Variable",input:"string",help:"When selecting a marker, this global variable will be set to the marker ID",value:n.selectedIdVariable,placeholder:le}},visible:n.visible??$n.visible,handler:this.handleSettingsAction},a=this.renderables.get(i.name),o=Array.from(a?.namespaces.values()??[]).sort((l,d)=>l.namespace.localeCompare(d.namespace));if(o.length>1||o.length===1&&o[0].namespace!==""){r.children={};for(const l of o){const d={label:l.namespace!==""?l.namespace:'""',icon:"Shapes",visible:l.settings.visible,defaultExpansionState:o.length>1?"collapsed":"expanded",handler:this.#e};r.children[`ns:${l.namespace}`]=d}}t.push({path:["topics",i.name],node:r})}return t}startFrame(e,t,i){for(const n of this.renderables.values())n.startFrame(e,t,i)}handleSettingsAction=e=>{const t=e.payload.path;if(e.action!=="update"||t.length!==3)return;this.saveSetting(t,e.payload.value);const i=t[1],n=this.renderables.get(i);if(n){const r=this.renderer.config.topics[i];n.userData.settings={...$n,...r},n.update()}};#e=e=>{const t=e.payload.path;if(e.action!=="update"||t.length!==4)return;const i=t[1],n=t[2],r=t[3],a=n.slice(3);this.renderer.updateConfig(l=>{const d=["topics",i,"namespaces",a,r];(0,Z.set)(l,d,e.payload.value)});const o=this.renderables.get(i);if(o){const l=this.renderer.config.topics[i],d=o.namespaces.get(a);if(d){const h=l?.namespaces?.[a];d.settings={...d.settings,...h}}}this.updateSettingsTree()};#t=e=>{const t=e.topic,i=e.message,n=(0,w.toNanoSec)(e.receiveTime);for(const r of i.markers??[])if(r){const a=Vo(r);this.#i(t,a,n)}};#s=e=>{const t=e.topic,i=Vo(e.message),n=(0,w.toNanoSec)(e.receiveTime);this.#i(t,i,n)};#i(e,t,i){const n=this.#n(e,t,i),r=n.namespaces.size;n.addMarkerMessage(t,i),r!==n.namespaces.size&&this.updateSettingsTree()}addMarkerArray(e,t,i){const n=t[0];if(!n)return;const r=this.#n(e,n,i),a=r.namespaces.size;for(const o of t)r.addMarkerMessage(o,i);a!==r.namespaces.size&&this.updateSettingsTree()}#n(e,t,i){let n=this.renderables.get(e);if(!n){const r=this.renderer.config.topics[e];n=new qu(e,this.renderer,{receiveTime:i,messageTime:(0,w.toNanoSec)(t.header.stamp),frameId:this.renderer.normalizeFrameId(t.header.frame_id),pose:(0,L.N2)(),settingsPath:["topics",e],topic:e,settings:{...$n,...r}}),this.renderables.set(e,n),this.add(n)}return n}}function Vo(s){return{header:Pe(s.header),ns:s.ns??"",id:s.id??0,type:s.type??0,action:s.action??0,pose:ee(s.pose),scale:je(s.scale),color:Xe(s.color),lifetime:de(s.lifetime),frame_locked:s.frame_locked??!1,points:la(s.points),colors:fn(s.colors),text:s.text??"",mesh_resource:s.mesh_resource??"",mesh_use_embedded_materials:s.mesh_use_embedded_materials??!1}}const bi=9999999;class tf extends c.jyz{constructor({color:e,...t}){super({...t,vertexShader:`
        #include <common>
        uniform vec2 canvasSize;
        void main() {
          vec4 mvPosition = modelViewMatrix * vec4(0., 0., 0., 1.);

          // Adapted from THREE.ShaderLib.sprite
          vec2 scale;
          scale.x = length(vec3(modelMatrix[0].xyz));
          scale.y = length(vec3(modelMatrix[1].xyz));

          gl_Position = projectionMatrix * mvPosition;

          // Add position after projection to maintain constant pixel size
          gl_Position.xy += position.xy / canvasSize * scale * gl_Position.w;
        }
      `,fragmentShader:`
        uniform vec3 color;
        void main() {
          gl_FragColor = vec4(color, 1.0);
        }
      `,uniforms:{canvasSize:{value:[0,0]},color:{value:new c.Ilk(e).convertSRGBToLinear()}}})}}class sf extends Q.d{#e=new c.zf8(5,16);#t=new tf({color:16711680,depthTest:!1,depthWrite:!1});#s=new c.Kj0(this.#e,this.#t);#i=new c.Kj0(this.#e,this.#t);#n=new c.a$l([0,0,0,0,0,0],3);#r=new c.x12(new c.u9r,new c.nls({color:16711680}));#a=new c.x12(new c.u9r,new c.FT0({color:16711680,dashSize:1,gapSize:1,depthWrite:!1,depthFunc:c.w$m}));#o;#l=!1;#h=!1;#c;#d;state="idle";constructor(e){super("foxglove.MeasurementTool",e),this.#r.userData.picking=!1,this.#a.userData.picking=!1,this.#s.userData.picking=!1,this.#i.userData.picking=!1,this.#o=e.labelPool.acquire(),this.#o.visible=!1,this.#o.setBillboard(!0),this.#o.setSizeAttenuation(!1),this.#o.setLineHeight(12),this.#o.setColor(1,0,0),this.#o.renderOrder=bi,this.#o.material.depthTest=!1,this.#o.material.depthWrite=!1,this.#o.material.transparent=!0,this.#a.renderOrder=bi,this.#s.renderOrder=bi,this.#i.renderOrder=bi,this.#r.frustumCulled=!1,this.#a.frustumCulled=!1,this.#r.geometry.setAttribute("position",this.#n),this.#a.geometry.setAttribute("position",this.#n),this.#s.visible=!1,this.#i.visible=!1,this.add(this.#s),this.add(this.#i),this.add(this.#r),this.add(this.#a),this.add(this.#o),this.#u("idle")}dispose(){super.dispose(),this.renderer.labelPool.release(this.#o),this.#e.dispose(),this.#t.dispose(),this.#r.geometry.dispose(),this.#r.material.dispose(),this.#a.geometry.dispose(),this.#a.material.dispose(),this.renderer.input.removeListener("click",this.#b),this.renderer.input.removeListener("mousemove",this.#f)}startMeasuring(){this.#u("place-first-point")}stopMeasuring(){this.#c=this.#d=void 0,this.#u("idle")}startFrame(e,t,i){super.startFrame(e,t,i),this.#t.uniforms.canvasSize.value[0]=this.renderer.input.canvasSize.x,this.#t.uniforms.canvasSize.value[1]=this.renderer.input.canvasSize.y}#u(e){switch(this.state=e,e){case"idle":this.renderer.input.removeListener("click",this.#b),this.renderer.input.removeListener("mousemove",this.#f),this.dispatchEvent({type:"foxglove.measure-end"});break;case"place-first-point":this.#c=this.#d=void 0,this.renderer.input.addListener("click",this.#b),this.renderer.input.addListener("mousemove",this.#f),this.dispatchEvent({type:"foxglove.measure-start"});break;case"place-second-point":break}this.#p(),this.#m()}#f=(e,t,i)=>{if(t){switch(this.state){case"idle":break;case"place-first-point":(this.#c??=new c.Pa4).copy(t),this.#l=!0;break;case"place-second-point":(this.#d??=new c.Pa4).copy(t),this.#h=!0,this.#p();break}this.#m()}};#p(){this.#c&&this.#d&&this.#o.setText(this.#c.distanceTo(this.#d).toFixed(2))}#b=(e,t,i)=>{if(t){switch(this.state){case"idle":break;case"place-first-point":this.#c=t.clone(),this.#l=!0,this.#u("place-second-point");break;case"place-second-point":this.#d=t.clone(),this.#h=!0,this.#u("idle");break}this.#m()}};#m(){this.#c?(this.#s.visible=!0,this.#s.position.copy(this.#c),this.#l&&(this.#n.setXYZ(0,this.#c.x,this.#c.y,this.#c.z),this.#n.needsUpdate=!0,this.#a.computeLineDistances(),this.#l=!1)):this.#s.visible=!1,this.#d?(this.#i.visible=!0,this.#i.position.copy(this.#d),this.#h&&(this.#n.setXYZ(1,this.#d.x,this.#d.y,this.#d.z),this.#n.needsUpdate=!0,this.#a.computeLineDistances(),this.#h=!1)):this.#i.visible=!1,this.#c&&this.#d?(this.#r.visible=!0,this.#a.visible=!0,this.#o.visible=!0,this.#o.position.copy(this.#c).lerp(this.#d,.5)):(this.#r.visible=!1,this.#a.visible=!1,this.#o.visible=!1),this.renderer.queueAnimationFrame()}}const nf="INVALID_OCCUPANCY_GRID",rf={r:1,g:1,b:1,a:1},af={r:0,g:0,b:0,a:1},of={r:.5,g:.5,b:.5,a:1},lf={r:1,g:0,b:1,a:1},cf=1,df=ne(rf),hf=ne(af),uf=ne(of),ff=ne(lf),Wn={visible:!1,frameLocked:!1,colorMode:"custom",minColor:df,maxColor:hf,unknownColor:uf,invalidColor:ff,alpha:cf};class pf extends F{dispose(){this.userData.texture.dispose(),this.userData.material.dispose(),this.userData.pickingMaterial.dispose()}details(){return this.userData.occupancyGrid}}class mf extends Q.d{constructor(e){super("foxglove.OccupancyGrids",e)}getSubscriptions(){return[{type:"schema",schemaNames:rn,subscription:{handler:this.#e}}]}settingsNodes(){const e=this.renderer.config.topics,t=this.handleSettingsAction,i=[];for(const n of this.renderer.topics??[]){if(!$(n,rn))continue;const r={...Wn,...e[n.name]};let a={colorMode:{label:"Color mode",input:"select",value:r.colorMode,options:[{label:"Custom",value:"custom"},{label:"Map",value:"map"},{label:"Costmap",value:"costmap"},{label:"Raw",value:"raw"}]}};if(r.colorMode==="custom"){const o={minColor:{label:"Min color",input:"rgba",value:r.minColor},maxColor:{label:"Max color",input:"rgba",value:r.maxColor},unknownColor:{label:"Unknown color",input:"rgba",value:r.unknownColor},invalidColor:{label:"Invalid color",input:"rgba",value:r.invalidColor}};a={...a,...o}}else{const o={alpha:{label:"Alpha",input:"number",value:r.alpha,min:0,max:1,step:.1,placeholder:"auto"}};a={...a,...o}}a.frameLocked={label:"Frame lock",input:"boolean",value:r.frameLocked},i.push({path:["topics",n.name],node:{label:n.name,icon:"Cells",fields:a,visible:r.visible,order:n.name.toLocaleLowerCase(),handler:t}})}return i}handleSettingsAction=e=>{const t=e.payload.path;if(e.action!=="update"||t.length!==3)return;this.saveSetting(t,e.payload.value);const i=t[1],n=this.renderables.get(i);if(n){const r=Hn(n.userData.settings),a=this.renderer.config.topics[i];n.userData.settings={...Wn,...a};const o=Hn(n.userData.settings);r!==o&&(n.userData.material.transparent=o,n.userData.material.depthWrite=!o,n.userData.material.needsUpdate=!0),this.#t(n,n.userData.occupancyGrid,n.userData.receiveTime)}};#e=e=>{const t=e.topic,i=xf(e.message),n=(0,w.toNanoSec)(e.receiveTime);let r=this.renderables.get(t);if(!r){const a=this.renderer.config.topics[t],o={...Wn,...a},l=$o(i),d=this.renderer.sharedGeometry.getGeometry(this.constructor.name,gf),h=yf(t,d,l,o),f=h.material,p=h.userData.pickingMaterial;r=new pf(t,this.renderer,{receiveTime:n,messageTime:(0,w.toNanoSec)(i.header.stamp),frameId:this.renderer.normalizeFrameId(i.header.frame_id),pose:i.info.origin,settingsPath:["topics",t],settings:o,topic:t,occupancyGrid:i,mesh:h,texture:l,material:f,pickingMaterial:p}),r.add(h),this.add(r),this.renderables.set(t,r)}this.#t(r,i,n)};#t(e,t,i){e.userData.occupancyGrid=t,e.userData.pose=t.info.origin,e.userData.receiveTime=i,e.userData.messageTime=(0,w.toNanoSec)(t.header.stamp),e.userData.frameId=this.renderer.normalizeFrameId(t.header.frame_id);const n=t.info.width*t.info.height;if(t.data.length!==n){const d=`OccupancyGrid data length (${t.data.length}) is not equal to width ${t.info.width} * height ${t.info.height}`;bf(this.renderer,e,d);return}let r=e.userData.texture;const a=t.info.width,o=t.info.height,l=t.info.resolution;(a!==r.image.width||o!==r.image.height)&&(r.dispose(),r=$o(t),e.userData.texture=r,e.userData.material.map=r),vf(r,t,e.userData.settings),e.scale.set(l*a,l*o,1)}}function gf(){const s=new c._12(1,1,1,1);return s.translate(.5,.5,0),s.computeBoundingSphere(),s}function bf(s,e,t){s.settings.errors.addToTopic(e.userData.topic,nf,t)}function $o(s){const e=s.info.width,t=s.info.height,i=e*t,n=new Uint8ClampedArray(i*4),r=new c.IEO(n,e,t,c.wk1,c.ywz,c.xfE,c.uWy,c.uWy,c.TyD,c.wem,1,c.rnI);return r.generateMipmaps=!1,r}function yf(s,e,t,i){const n=Tf(t),r=Sf(t,s,i),a=new c.Kj0(e,r);return a.castShadow=!0,a.receiveShadow=!0,a.userData.pickingMaterial=n,a}const Ms={r:0,g:0,b:0,a:0},ft={r:0,g:0,b:0,a:0},pt={r:0,g:0,b:0,a:0},Ne={r:0,g:0,b:0,a:0},mt={r:0,g:0,b:0,a:0};function vf(s,e,t){const i=e.info.width*e.info.height,n=s.image.data;N(Ne,t.minColor),N(mt,t.maxColor),N(ft,t.unknownColor),N(pt,t.invalidColor),yi(Ne),yi(mt),yi(ft),yi(pt);const r=e.data;for(let a=0;a<i;a++){const o=r[a]|0,l=a*4;if(t.colorMode==="custom")if(o===-1)n[l+0]=ft.r,n[l+1]=ft.g,n[l+2]=ft.b,n[l+3]=ft.a;else if(o>=0&&o<=100){const d=o/100;n[l+0]=Ne.r+(mt.r-Ne.r)*d,n[l+1]=Ne.g+(mt.g-Ne.g)*d,n[l+2]=Ne.b+(mt.b-Ne.b)*d,n[l+3]=Ne.a+(mt.a-Ne.a)*d}else n[l+0]=pt.r,n[l+1]=pt.g,n[l+2]=pt.b,n[l+3]=pt.a;else wf(Ms,o,t.colorMode),n[l+0]=Ms.r,n[l+1]=Ms.g,n[l+2]=Ms.b,n[l+3]=Ms.a*t.alpha}s.needsUpdate=!0}function Sf(s,e,t){const i=Hn(t);return new c.vBJ({name:`${e}:Material`,alphaTest:1e-4,depthWrite:!i,map:s,side:c.ehD,transparent:i})}function Tf(s){return new c.jyz({vertexShader:`
      varying vec2 vUv;
      void main() {
        vUv = uv;
        gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
      }
    `,fragmentShader:`
      uniform sampler2D map;
      uniform vec4 objectId;
      varying vec2 vUv;
      void main() {
        vec4 color = texture2D(map, vUv);
        if (color.a == 0.0) {
          discard;
        }
        gl_FragColor = objectId;
      }
    `,side:c.ehD,uniforms:{map:{value:s},objectId:{value:[NaN,NaN,NaN,NaN]}}})}function Hn(s){return s.colorMode==="custom"?(N(Ne,s.minColor),N(mt,s.maxColor),N(ft,s.unknownColor),N(pt,s.invalidColor),Ne.a<1||mt.a<1||pt.a<1||ft.a<1):!0}function yi(s){s.r=Math.trunc(U(s.r)*255),s.g=Math.trunc(U(s.g)*255),s.b=Math.trunc(U(s.b)*255),s.a=Math.trunc(s.a*255)}function xf(s){const e=s.info??{};return{header:Pe(s.header),info:{map_load_time:de(e.map_load_time),resolution:e.resolution??0,width:e.width??0,height:e.height??0,origin:ee(e.origin)},data:Rc(s.data)}}let Yn,Zn,Xt;function wf(s,e,t){const i=e>=0?e:e+256;(i<0||i>255)&&(s.r=0,s.g=0,s.b=0,s.a=0);let n;switch(t){case"costmap":Yn||(Yn=Df()),n=Yn;break;case"map":Zn||(Zn=If()),n=Zn;break;case"raw":Xt||(Xt=Wo()),n=Xt;break;default:Xt||(Xt=Wo()),n=Xt}const r=n[Math.trunc(i)];s.r=r[0],s.g=r[1],s.b=r[2],s.a=r[3]}function If(){let s=0;const e=new Array(256).fill([0,0,0,0]);for(let t=0;t<=100;t++){const i=Math.trunc(255-255*t/100);e[s++]=[i,i,i,255]}for(let t=101;t<=127;t++)e[s++]=[0,255,0,255];for(let t=128;t<=254;t++)e[s++]=[255,Math.trunc(255*(t-128)/(254-128)),0,255];return e[s++]=[112,137,134,255],e}function Df(){let s=0;const e=new Array(256).fill([0,0,0,0]);e[s++]=[0,0,0,0];for(let t=1;t<=98;t++){const i=Math.trunc(255*t/100);e[s++]=[i,0,255-i,255]}e[s++]=[0,255,255,255],e[s++]=[255,0,255,255];for(let t=101;t<=127;t++)e[s++]=[0,255,0,255];for(let t=128;t<=254;t++)e[s++]=[255,Math.trunc(255*(t-128)/(254-128)),0,255];return e[s++]=[112,137,134,255],e}function Wo(){let s=0;const e=new Array(256).fill([0,0,0,0]);for(let t=0;t<256;t++)e[s++]=[t,t,t,255];return e}const Kn={...pi,stixelsEnabled:!1},Cf=["gradient","colormap"],Mf=new Set([...Ot,...Ys]),Xn="INVALID_POINTCLOUD",De={r:0,g:0,b:0,a:0},Ho=[0,0],Yo={xReader:ue,yReader:ue,zReader:ue,packedColorReader:ue,redReader:ue,greenReader:ue,blueReader:ue,alphaReader:ue};class Zo extends F{pickableInstances=!0;#e;#t;constructor(e,t,i){super(e,t,i);const n=i.settings.decayTime>0,r=Fo(e,n?c.W2J:c.dj0),a=mi(e,As(i.pointCloud),r,i.material,i.pickingMaterial,i.instancePickingMaterial);this.#e=new jn({initial:{messageTime:i.receiveTime,receiveTime:i.receiveTime,object3d:a},parentRenderable:this,renderer:t}),this.add(a);const o=Ko(e,n?c.W2J:c.dj0),l=Xo(e,As(i.pointCloud),o,i.stixelMaterial);this.#t=new jn({initial:{messageTime:i.receiveTime,receiveTime:i.receiveTime,object3d:l},parentRenderable:this,renderer:t}),this.add(l)}dispose(){this.userData.originalMessage=void 0,this.userData.material.dispose(),this.userData.pickingMaterial.dispose(),this.userData.instancePickingMaterial.dispose(),this.userData.stixelMaterial.dispose(),this.#e.dispose(),this.#t.dispose(),super.dispose()}details(){return this.userData.originalMessage??{}}instanceDetails(e){const t=this.userData.pointCloud,i=t.data,n=Es(t),r=new DataView(i.buffer,i.byteOffset,i.byteLength),a=Es(t),o={};for(const l of t.fields){const d=e*a,h=Se(l,n);h&&(o[l.name]=h(r,d))}return o}updatePointCloud(e,t,i,n){const r=(0,w.toNanoSec)(Nf(e));this.userData.receiveTime=n,this.userData.messageTime=r,this.userData.frameId=this.renderer.normalizeFrameId(Of(e)),this.userData.pointCloud=e,this.userData.originalMessage=t;const a=this.userData.settings,o=a.decayTime>0;this.userData.settings=i;let l=this.userData.material,d=this.userData.stixelMaterial;const h=Ws(i)!==l.transparent||zn(i)!==zn(a)||i.pointShape!==a.pointShape,f=this.#e,p=this.#t;h?(l.dispose(),l=kn(i),this.userData.material=l,f.updateMaterial(l),d.dispose(),d=Jn(i),this.userData.stixelMaterial=d,p.updateMaterial(d)):l.size=i.pointSize;const u=a.stixelsEnabled!==i.stixelsEnabled;if(!i.stixelsEnabled&&u&&p.clearHistory(),!this.#i(e)||!this.#a(Yo,e,i))return;const m=this.userData.topic,g=i.decayTime>0;if(g){const z=Fo(m,c.W2J),Y=mi(m,As(e),z,l,this.userData.pickingMaterial,void 0);if(f.addHistoryEntry({receiveTime:n,messageTime:r,object3d:Y}),this.add(Y),i.stixelsEnabled){const oe=Ko(m,c.W2J),rt=Xo(m,As(e),oe,d);p.addHistoryEntry({receiveTime:n,messageTime:r,object3d:rt}),this.add(rt)}}const y=f.latest();y.receiveTime=n,y.messageTime=r,y.object3d.userData.pose=As(e);const S=Math.trunc(e.data.length/Es(e)),D=y.object3d;y.object3d.geometry.resize(S);const A=D.geometry.attributes.position,M=D.geometry.attributes.color,I=p.latest();!g&&o!==g&&(y.object3d.geometry.setUsage(c.dj0),I.object3d.geometry.setUsage(c.dj0)),I.receiveTime=n,I.messageTime=r,I.object3d.userData.pose=y.object3d.userData.pose,i.stixelsEnabled?I.object3d.geometry.resize(S*2):I.object3d.geometry.resize(0);const P=I.object3d.geometry.attributes.position,O=I.object3d.geometry.attributes.color;this.#l(e,Yo,S,i,A,M,P,O)}startFrame(e,t,i){this.#e.updateHistoryFromCurrentTime(e),this.#e.updatePoses(e,t,i),this.userData.settings.stixelsEnabled&&(this.#t.updateHistoryFromCurrentTime(e),this.#t.updatePoses(e,t,i))}#s(e){this.renderer.settings.errors.addToTopic(this.userData.topic,Xn,e),this.#e.latest().object3d.geometry.resize(0)}#i(e){return e.header?this.#r(e):this.#n(e)}#n(e){const t=e.data;if(t.length%e.point_stride!==0){const i=`PointCloud data length ${t.length} is not a multiple of point_stride ${e.point_stride}`;return this.#s(i),!1}if(e.fields.length===0){const i="PointCloud has no fields";return this.#s(i),!1}return!0}#r(e){const t=e.data;if(e.is_bigendian){const i="PointCloud2 is_bigendian=true is not supported";return this.#s(i),!1}if(t.length%e.point_step!==0){const i=`PointCloud2 data length ${t.length} is not a multiple of point_step ${e.point_step}`;return this.#s(i),!1}if(e.fields.length===0){const i="PointCloud2 has no fields";return this.#s(i),!1}if(t.length<e.height*e.row_step){const i=`PointCloud2 data length ${t.length} is less than height ${e.height} * row_step ${e.row_step}`;this.renderer.settings.errors.addToTopic(this.userData.topic,Xn,i)}if(e.width*e.point_step>e.row_step){const i=`PointCloud2 width ${e.width} * point_step ${e.point_step} is greater than row_step ${e.row_step}`;this.renderer.settings.errors.addToTopic(this.userData.topic,Xn,i)}return!0}#a(e,t,i){let n,r,a,o,l,d,h,f;const p=Es(t);let u=0;for(let g=0;g<t.fields.length;g++){const y=t.fields[g];if(!Ct(y))continue;const S=y.type,D=S!=null?Uc(S):y.datatype;if(y.offset<0){const M=`PointCloud field "${y.name}" has invalid offset ${y.offset}. Must be >= 0`;return this.#s(M),!1}if(y.name==="x"){if(n=Se(y,p),!n){const I=`PointCloud field "x" is invalid. type=${vi(D)}, offset=${y.offset}, stride=${p}`;return this.#s(I),!1}}else if(y.name==="y"){if(r=Se(y,p),!r){const I=`PointCloud field "y" is invalid. type=${vi(D)}, offset=${y.offset}, stride=${p}`;return this.#s(I),!1}}else if(y.name==="z"){if(a=Se(y,p),!a){const I=`PointCloud field "z" is invalid. type=${vi(D)}, offset=${y.offset}, stride=${p}`;return this.#s(I),!1}}else y.name==="red"?l=Se(y,p,!0):y.name==="green"?d=Se(y,p,!0):y.name==="blue"?h=Se(y,p,!0):y.name==="alpha"&&(f=Se(y,p,!0));const A=Af(D);if(u=Math.max(u,y.offset+A),y.name===i.colorField){const M=(i.colorMode==="rgb"||i.colorMode==="rgba")&&A>=4?S!=null?E.NumericType.UINT32:G.UINT32:void 0;if(o=Se(y,p,!1,M),!o){const I=vi(D),P=`PointCloud field "${y.name}" is invalid. type=${I}, offset=${y.offset}, stride=${p}`;return this.#s(P),!1}}}if(u>p){const g=`PointCloud stride ${p} is less than minimum bytes per point ${u}`;return this.#s(g),!1}if((n?1:0)+(r?1:0)+(a?1:0)<2){const g="PointCloud must contain at least two of x/y/z fields";return this.#s(g),!1}return e.xReader=n??ue,e.yReader=r??ue,e.zReader=a??ue,e.packedColorReader=o??n??r??a??ue,e.redReader=l??ue,e.greenReader=d??ue,e.blueReader=h??ue,e.alphaReader=f??ue,!0}#o(e,t,i,n,r,a){let o=a.minValue??Number.POSITIVE_INFINITY,l=a.maxValue??Number.NEGATIVE_INFINITY;if(Cf.includes(a.colorMode)&&(a.minValue==null||a.maxValue==null)){for(let d=0;d<n;d++){const h=d*r,f=t(i,h);o=Math.min(o,f),l=Math.max(l,f)}o=a.minValue??o,l=a.maxValue??l}e[0]=o,e[1]=l}#l(e,t,i,n,r,a,o,l){const d=e.data,h=new DataView(d.buffer,d.byteOffset,d.byteLength),f=Es(e),{xReader:p,yReader:u,zReader:m,packedColorReader:g,redReader:y,greenReader:S,blueReader:D,alphaReader:A}=t;for(let M=0;M<i;M++){const I=M*f,P=p(h,I),O=u(h,I),z=m(h,I);r.setXYZ(M,P,O,z),n.stixelsEnabled&&(o.setXYZ(M*2,P,O,z),o.setXYZ(M*2+1,P,O,0))}if(n.colorMode==="rgba-fields")for(let M=0;M<i;M++){const I=M*f,P=y(h,I),O=S(h,I),z=D(h,I),Y=A(h,I);a.setXYZW(M,P,O,z,Y),n.stixelsEnabled&&(l.setXYZW(M*2,P,O,z,Y),l.setXYZW(M*2+1,P,O,z,Y))}else{this.#o(Ho,g,h,i,f,n);const[M,I]=Ho,P=qi(n,M,I);for(let O=0;O<i;O++){const z=O*f,Y=g(h,z);P(De,Y),a.setXYZW(O,De.r,De.g,De.b,De.a),n.stixelsEnabled&&(l.setXYZW(O*2,De.r,De.g,De.b,De.a),l.setXYZW(O*2+1,De.r,De.g,De.b,De.a))}}r.needsUpdate=!0,a.needsUpdate=!0,o.needsUpdate=!0,l.needsUpdate=!0}}class Ef extends Q.d{#e=new Map;constructor(e){super("foxglove.PointClouds",e)}getSubscriptions(){return[{type:"schema",schemaNames:Ys,subscription:{handler:this.#s}},{type:"schema",schemaNames:Ot,subscription:{handler:this.#t}}]}settingsNodes(){const e=this.renderer.config.topics,t=this.handleSettingsAction,i=[];for(const n of this.renderer.topics??[]){if(!$(n,Mf))continue;const a=e[n.name]??{},o=this.#e.get(n.name)??No,l=Un(n,o,a);l.fields.stixelsEnabled={label:"Stixel view",input:"boolean",value:a.stixelsEnabled??Kn.stixelsEnabled},l.handler=t,l.icon="Points",i.push({path:["topics",n.name],node:l})}return i}startFrame(e,t,i){for(const[n,r]of this.renderables){if(!r.userData.settings.visible){r.removeFromParent(),r.dispose(),this.renderables.delete(n);continue}r.startFrame(e,t,i)}}handleSettingsAction=e=>{const t=e.payload.path;if(e.action!=="update"||t.length!==3)return;this.saveSetting(t,e.payload.value);const i=t[1],n=this.renderables.get(i);if(n){const r=this.renderer.config.topics[i],a={...Kn,...r};n.updatePointCloud(n.userData.pointCloud,n.userData.originalMessage,a,n.userData.receiveTime)}};#t=e=>{const t=e.topic,i=Rf(e.message),n=(0,w.toNanoSec)(e.receiveTime),r=(0,w.toNanoSec)(i.timestamp),a=i.frame_id;let o=this.#e.get(t);(!o||o.length!==i.fields.length)&&(o=i.fields.map(l=>l.name),this.#e.set(t,o),this.updateSettingsTree()),this.#i(t,i,n,r,e.message,a)};#s=e=>{const t=e.topic,i=Lf(e.message),n=(0,w.toNanoSec)(e.receiveTime),r=(0,w.toNanoSec)(i.header.stamp),a=i.header.frame_id;let o=this.#e.get(t);const l=i.fields.reduce((d,h)=>d+(Ct(h)?1:0),0);(!o||o.length!==l)&&(o=(0,Ts.Z)(i.fields,d=>Ct(d)?d.name:void 0),this.#e.set(t,o),this.updateSettingsTree()),this.#i(t,i,n,r,e.message,a)};#i(e,t,i,n,r,a){let o=this.renderables.get(e);if(!o){const l=this.renderer.config.topics[e],d={...Kn,...l};d.colorField==null&&(Oo(d,t,{supportsPackedRgbModes:!0}),this.renderer.updateConfig(m=>{const g={...l};g.colorField=d.colorField,g.colorMode=d.colorMode,g.colorMap=d.colorMap,m.topics[e]=g}));const h=kn(d),f=Uo(d),p=zo(d),u=Jn(d);o=new Zo(e,this.renderer,{receiveTime:i,messageTime:n,frameId:this.renderer.normalizeFrameId(a),pose:(0,L.N2)(),settingsPath:["topics",e],settings:d,topic:e,pointCloud:t,originalMessage:r,material:h,pickingMaterial:f,instancePickingMaterial:p,stixelMaterial:u}),this.add(o),this.renderables.set(e,o)}o.updatePointCloud(t,r,o.userData.settings,i)}}function vi(s){return G[s]??`${s}`}function Af(s){switch(s){case G.INT8:case G.UINT8:return 1;case G.INT16:case G.UINT16:return 2;case G.INT32:case G.UINT32:case G.FLOAT32:return 4;case G.FLOAT64:return 8;default:return 0}}function ue(){return 0}function _f(s){return s?{name:s.name??"",offset:s.offset??0,datatype:s.datatype??G.UNKNOWN,count:s.count??0}:{name:"",offset:0,datatype:G.UNKNOWN,count:0}}function Pf(s){return{name:s?.name??"",offset:s?.offset??0,type:s?.type??0}}function Rf(s){return{timestamp:de(s.timestamp),frame_id:s.frame_id??"",pose:ee(s.pose),point_stride:s.point_stride??0,fields:s.fields?.map(Pf)??[],data:jt(s.data)}}function Lf(s){return{header:Pe(s.header),height:s.height??0,width:s.width??0,fields:s.fields?.map(_f)??[],is_bigendian:s.is_bigendian??!1,point_step:s.point_step??0,row_step:s.row_step??0,data:jt(s.data),is_dense:s.is_dense??!1}}function Nf(s){const e=s;return e.header?e.header.stamp:s.timestamp}function Of(s){const e=s;return e.header?e.header.frame_id:s.frame_id}function Es(s){const e=s;return e.point_step!=null?e.point_step:s.point_stride}function As(s){return s.pose??(0,L.N2)()}function Jn(s){const e=Ws(s);return new c.nls({vertexColors:!0,transparent:e,depthWrite:!0})}function Ko(s,e){const t=new Et(e);return t.name=`${s}:PointCloud:stixelGeometry`,t.createAttribute("position",Float32Array,3),t.createAttribute("color",Uint8Array,4,!0),t}function Xo(s,e,t,i){const n=new c.ejS(t,i);return n.frustumCulled=!1,n.name=`${s}:PointCloud:stixels`,n.userData={pose:e},n}const Ff=[0,0,0,0];class Qn extends Re{#e;#t;#s;#i=new Float32Array;#n=new Uint8Array;constructor(e,t,i,n){super(e,t,i,n),this.#e=new Wt.L;const r={resolution:n.input.canvasSize,worldUnits:!0},a=Pa(t,r);this.#t=new ni.w(this.#e,a),this.#t.renderOrder=1,this.#t.userData.picking=!1,this.add(this.#t);const o=Ra(t,r);this.#s=new ni.w(this.#e,o),this.#s.renderOrder=2;const l=t.scale.x*1.2;this.#s.userData.pickingMaterial=wn(l,r),this.add(this.#s),this.update(t,i)}dispose(){this.#t.material.dispose(),this.#s.material.dispose(),this.#s.userData.pickingMaterial.dispose(),this.#s.userData.pickingMaterial=void 0,super.dispose()}update(e,t){const i=this.userData.marker;super.update(e,t);const n=this.userData.marker,r=n.points.length,a=n.scale.x,o=ae(n);if(r===0){this.#t.visible=!1,this.#s.visible=!1;return}else this.#t.visible=!0,this.#s.visible=!0;o!==ae(i)&&(this.#t.material.transparent=o,this.#t.material.depthWrite=!o,this.#t.material.needsUpdate=!0,this.#s.material.transparent=o,this.#s.material.depthWrite=!o,this.#s.material.needsUpdate=!0);const l=this.#t.material;l.lineWidth=a;const d=this.#s.material;d.lineWidth=a;const h=this.#i.length/3;r>h&&(this.#e.dispose(),this.#e=new Wt.L,this.#t.geometry=this.#e,this.#s.geometry=this.#e),this.#r(n,r),this.#a(n,r),this.#t.computeLineDistances(),this.#s.computeLineDistances()}#r(e,t){3*t>this.#i.length&&(this.#i=new Float32Array(3*t));const i=this.#i;for(let n=0;n<t;n++){const r=e.points[n],a=n*3;i[a+0]=r.x,i[a+1]=r.y,i[a+2]=r.z}this.#e.setPositions(i),this.#e.instanceCount=t-1}#a(e,t){if(8*t>this.#n.length){this.#n=new Uint8Array(8*t);const r=new c.$TI(this.#n,8,1);this.#e.setAttribute("instanceColorStart",new c.kB5(r,4,0,!0)),this.#e.setAttribute("instanceColorEnd",new c.kB5(r,4,4,!0))}else this.#e.getAttribute("instanceColorStart").needsUpdate=!0,this.#e.getAttribute("instanceColorEnd").needsUpdate=!0;const i=this.#n,n=Ff;n[0]=0,n[1]=0,n[2]=0,n[3]=0,this._markerColorsToLinear(e,t,(r,a)=>{if(a===0){Jo(r,n);return}const l=(a-1)*8;i[l+0]=Math.floor(255*n[0]),i[l+1]=Math.floor(255*n[1]),i[l+2]=Math.floor(255*n[2]),i[l+3]=Math.floor(255*n[3]),i[l+4]=Math.floor(255*r[0]),i[l+5]=Math.floor(255*r[1]),i[l+6]=Math.floor(255*r[2]),i[l+7]=Math.floor(255*r[3]),Jo(r,n)})}}function Jo(s,e){e[0]=s[0],e[1]=s[1],e[2]=s[2],e[3]=s[3]}const Uf={r:124/255,g:107/255,b:1,a:1},Qo=.1,qo=ne(Uf),qn={visible:!1,lineWidth:Qo,color:qo};class zf extends F{dispose(){this.userData.lines?.dispose(),super.dispose()}details(){return this.userData.polygonStamped}}class kf extends Q.d{constructor(e){super("foxglove.Polygons",e)}getSubscriptions(){return[{type:"schema",schemaNames:hn,subscription:{handler:this.#e}}]}settingsNodes(){const e=this.renderer.config.topics,t=this.handleSettingsAction,i=[];for(const n of this.renderer.topics??[]){if(!$(n,hn))continue;const r=e[n.name]??{},a={lineWidth:{label:"Line Width",input:"number",min:0,placeholder:String(Qo),step:.005,precision:3,value:r.lineWidth},color:{label:"Color",input:"rgba",value:r.color??qo}};i.push({path:["topics",n.name],node:{label:n.name,icon:"Star",fields:a,visible:r.visible??qn.visible,handler:t}})}return i}handleSettingsAction=e=>{const t=e.payload.path;if(e.action!=="update"||t.length!==3)return;this.saveSetting(t,e.payload.value);const i=t[1],n=this.renderables.get(i);if(n){const r=this.renderer.config.topics[i];n.userData.settings={...qn,...r},this.#t(n,n.userData.polygonStamped,n.userData.receiveTime)}};#e=e=>{const t=e.topic,i=Bf(e.message),n=(0,w.toNanoSec)(e.receiveTime);let r=this.renderables.get(t);if(!r){const a=this.renderer.config.topics[t],o={...qn,...a};r=new zf(t,this.renderer,{receiveTime:n,messageTime:(0,w.toNanoSec)(i.header.stamp),frameId:this.renderer.normalizeFrameId(i.header.frame_id),pose:(0,L.N2)(),settingsPath:["topics",t],settings:o,topic:t,polygonStamped:i,lines:void 0}),this.add(r),this.renderables.set(t,r)}this.#t(r,i,n)};#t(e,t,i){const n=e.userData.settings;e.userData.receiveTime=i,e.userData.messageTime=(0,w.toNanoSec)(t.header.stamp),e.userData.frameId=this.renderer.normalizeFrameId(t.header.frame_id),e.userData.polygonStamped=t;const r=e.userData.topic,a=jf(t,n);e.userData.lines?e.userData.lines.update(a,i):(e.userData.lines=new Qn(r,a,i,this.renderer),e.add(e.userData.lines))}}function jf(s,e){const t=[...s.polygon.points];return t.length>0&&t.push(t[0]),{header:s.header,ns:"",id:0,type:_.LINE_STRIP,action:re.ADD,pose:(0,L.N2)(),scale:{x:e.lineWidth,y:1,z:1},color:N(ie(),e.color),lifetime:ct,frame_locked:!0,points:t,colors:[],text:"",mesh_resource:"",mesh_use_embedded_materials:!1}}function Gf(s){return{points:la(s?.points)}}function Bf(s){return{header:Pe(s.header),polygon:Gf(s.polygon)}}var Si=b(89380);const el=.77,tl=1,sl=.23,il=2,Vf=.23,$f=new c.Pa4(1,0,0),nl=new c.Pa4,rl=new c.Pa4,_s=new c.Pa4;class Ti extends Re{shaftMesh;headMesh;#e;#t;constructor(e,t,i,n){super(e,t,i,n);const r=this.renderer.sharedGeometry.getGeometry(`${this.constructor.name}-shaft-${n.maxLod}`,()=>Wf(n.maxLod)),a=this.renderer.sharedGeometry.getGeometry(`${this.constructor.name}-head-${n.maxLod}`,()=>Hf(n.maxLod)),o=this.renderer.sharedGeometry.getGeometry(`${this.constructor.name}-shaftedges-${n.maxLod}`,()=>Yf(r)),l=this.renderer.sharedGeometry.getGeometry(`${this.constructor.name}-headedges-${n.maxLod}`,()=>Zf(a));this.shaftMesh=new c.Kj0(r,Vt(t.color)),this.shaftMesh.castShadow=!0,this.shaftMesh.receiveShadow=!0,this.add(this.shaftMesh),this.headMesh=new c.Kj0(a,Vt(t.color)),this.headMesh.castShadow=!0,this.headMesh.receiveShadow=!0,this.add(this.headMesh),this.#e=new c.ejS(o,n.outlineMaterial),this.#e.userData.picking=!1,this.shaftMesh.add(this.#e),this.#t=new c.ejS(l,n.outlineMaterial),this.#t.userData.picking=!1,this.headMesh.add(this.#t),this.update(t,i)}dispose(){this.shaftMesh.material.dispose(),this.headMesh.material.dispose(),super.dispose()}update(e,t){super.update(e,t);const i=this.userData.marker,n=i.color.a<1;n!==this.shaftMesh.material.transparent&&(this.shaftMesh.material.transparent=n,this.shaftMesh.material.depthWrite=!n,this.shaftMesh.material.needsUpdate=!0,this.headMesh.material.transparent=n,this.headMesh.material.depthWrite=!n,this.headMesh.material.needsUpdate=!0),fe(this.shaftMesh.material.color,i.color),this.shaftMesh.material.opacity=i.color.a,this.headMesh.material.color.set(this.shaftMesh.material.color),this.headMesh.material.opacity=i.color.a;const r=this.getSettings();if(this.#e.visible=r?.showOutlines??!0,this.#t.visible=r?.showOutlines??!0,i.points.length===2){const a=i.points[0],o=i.points[1];nl.set(a.x,a.y,a.z),rl.set(o.x,o.y,o.z),_s.subVectors(rl,nl);const l=_s.length();let d=Vf*l;if(i.scale.z!==0){const m=i.scale.z;d=(0,Si.uZ)(m,0,l)}const h=l-d,f=i.scale.x,p=i.scale.y;this.shaftMesh.scale.set(h,f,f),this.headMesh.scale.set(d,p,p),this.scale.set(1,1,1),this.shaftMesh.position.set(a.x,a.y,a.z),this.shaftMesh.position.addScaledVector(_s,.5*(h/l)),this.headMesh.position.set(o.x,o.y,o.z),this.headMesh.position.addScaledVector(_s,-.5*(d/l));const u=vc($f,_s);this.shaftMesh.setRotationFromQuaternion(u),this.headMesh.rotation.copy(this.shaftMesh.rotation)}else{this.shaftMesh.scale.set(el,tl,tl),this.headMesh.scale.set(sl,il,il),this.scale.set(i.scale.x,i.scale.y,i.scale.z);const a=el/2,o=sl/2;this.shaftMesh.position.set(a,0,0),this.headMesh.position.set(a*2+o,0,0),this.shaftMesh.rotation.set(0,0,0),this.headMesh.rotation.set(0,0,0)}}}function Wf(s){const e=wa(s),t=new c.fHI(.5,.5,1,e,1,!1);return t.rotateZ(-Math.PI/2),t.computeBoundingSphere(),t}function Hf(s){const e=Ia(s),t=new c.b_z(.5,1,e,1,!1);return t.rotateZ(-Math.PI/2),t.computeBoundingSphere(),t}function Yf(s){const e=new c.TOt(s,40),t=e.getAttribute("position"),i=Array.from(t.array),n=i.length/3/2*3,r=i.slice(n,i.length),a=new c.a$l(r,3);return e.setAttribute("position",a),e.computeBoundingSphere(),e}function Zf(s){const e=new c.TOt(s,40);return e.computeBoundingSphere(),e}class Ps extends Re{mesh;constructor(e,t,i,n){super(e,t,i,n);const r=n.sharedGeometry.getGeometry(`${this.constructor.name}-${n.maxLod}`,()=>al(n.maxLod));this.mesh=new c.Kj0(r,Vt(t.color)),this.mesh.castShadow=!0,this.mesh.receiveShadow=!0,this.add(this.mesh),this.update(t,i)}dispose(){this.mesh.material.dispose()}update(e,t){super.update(e,t);const i=this.userData.marker,n=i.color.a<1;n!==this.mesh.material.transparent&&(this.mesh.material.transparent=n,this.mesh.material.depthWrite=!n,this.mesh.material.needsUpdate=!0),fe(this.mesh.material.color,i.color),this.mesh.material.opacity=i.color.a,this.scale.set(i.scale.x,i.scale.y,i.scale.z)}}function al(s){const e=Gd(s),t=new c.xo$(.5,e,e);return t.computeBoundingSphere(),t}const ol="axis",ll=ys,cl=[1,.15,.15],Kf={r:124/255,g:107/255,b:1,a:1},dl=!0,Xf={r:198/255,g:107/255,b:1,a:.25},hl=ne(Kf),ul=ne(Xf),er={type:ol,visible:!1,axisScale:ll,arrowScale:cl,color:hl,showCovariance:dl,covarianceColor:ul},Jf=[{label:"Axis",value:"axis"},{label:"Arrow",value:"arrow"}];class Qf extends F{dispose(){this.userData.axis?.dispose(),this.userData.arrow?.dispose(),this.userData.sphere?.dispose(),super.dispose()}details(){return this.userData.originalMessage}}class qf extends Q.d{constructor(e){super("foxglove.Poses",e)}getSubscriptions(){return[{type:"schema",schemaNames:ln,subscription:{handler:this.#e}},{type:"schema",schemaNames:Bi,subscription:{handler:this.#t}},{type:"schema",schemaNames:cn,subscription:{handler:this.#s}}]}settingsNodes(){const e=this.renderer.config.topics,t=this.handleSettingsAction,i=[];for(const n of this.renderer.topics??[]){const r=$(n,ln),a=$(n,Bi),o=r?!1:$(n,cn);if(!(r||o||a))continue;const l=e[n.name]??{},d=l.type??ol,h={type:{label:"Type",input:"select",options:Jf,value:d}};if(d==="axis"?h.axisScale={label:"Scale",input:"number",step:.5,min:0,precision:k,value:l.axisScale??ll}:(h.arrowScale={label:"Scale",input:"vec3",labels:["X","Y","Z"],step:.5,precision:k,value:l.arrowScale??cl},h.color={label:"Color",input:"rgba",value:l.color??hl}),o){const f=l.showCovariance??dl,p=l.covarianceColor??ul;h.showCovariance={label:"Covariance",input:"boolean",value:f},f&&(h.covarianceColor={label:"Covariance Color",input:"rgba",value:p})}i.push({path:["topics",n.name],node:{label:n.name,icon:"Flag",fields:h,visible:l.visible??er.visible,order:n.name.toLocaleLowerCase(),handler:t}})}return i}handleSettingsAction=e=>{const t=e.payload.path;if(e.action!=="update"||t.length!==3)return;this.saveSetting(t,e.payload.value);const i=t[1],n=this.renderables.get(i);if(n){const r=this.renderer.config.topics[i];this.#n(n,n.userData.poseMessage,n.userData.originalMessage,n.userData.receiveTime,{...er,...r})}};#e=e=>{const t=tp(e.message),i=(0,w.toNanoSec)(e.receiveTime);this.#i(e.topic,t,e.message,i)};#t=e=>{const t=sp(e.message),i=(0,w.toNanoSec)(e.receiveTime);this.#i(e.topic,t,e.message,i)};#s=e=>{const t=np(e.message),i=(0,w.toNanoSec)(e.receiveTime);this.#i(e.topic,t,e.message,i)};#i(e,t,i,n){let r=this.renderables.get(e);if(!r){const a=this.renderer.config.topics[e],o={...er,...a};r=new Qf(e,this.renderer,{receiveTime:n,messageTime:(0,w.toNanoSec)(t.header.stamp),frameId:this.renderer.normalizeFrameId(t.header.frame_id),pose:(0,L.N2)(),settingsPath:["topics",e],settings:o,topic:e,poseMessage:t,originalMessage:i,axis:void 0,arrow:void 0,sphere:void 0}),this.add(r),this.renderables.set(e,r)}this.#n(r,t,i,n,r.userData.settings)}#n(e,t,i,n,r){e.userData.receiveTime=n,e.userData.messageTime=(0,w.toNanoSec)(t.header.stamp),e.userData.frameId=this.renderer.normalizeFrameId(t.header.frame_id),e.userData.poseMessage=t,e.userData.originalMessage=i,e.userData.sphere&&(e.userData.sphere.visible=!1);const{topic:a,settings:o}=e.userData,l=r.type!==o.type||r.axisScale!==o.axisScale||!Zi(r.arrowScale,o.arrowScale)||r.color!==o.color||!e.userData.arrow&&!e.userData.axis;if(e.userData.settings=r,l)if(e.userData.settings.type==="axis"){if(e.userData.arrow&&(e.remove(e.userData.arrow),e.userData.arrow.dispose(),e.userData.arrow=void 0),!e.userData.axis){const h=new vs(a,this.renderer);e.userData.axis=h,e.add(h)}const d=e.userData.settings.axisScale*(1/ys);e.userData.axis.scale.set(d,d,d)}else{e.userData.axis&&(e.remove(e.userData.axis),e.userData.axis.dispose(),e.userData.axis=void 0);const d=N(ie(),r.color),h=fl(r.arrowScale,d);if(!e.userData.arrow){const f=new Ti(a,h,void 0,this.renderer);e.userData.arrow=f,e.add(f)}e.userData.arrow.update(h,void 0)}if("covariance"in t.pose){e.userData.pose=t.pose.pose;const h=ep(t,e.userData.settings);h?(e.userData.sphere||(e.userData.sphere=new Ps(e.userData.topic,h,void 0,this.renderer),e.add(e.userData.sphere)),e.userData.sphere.visible=e.userData.settings.showCovariance,e.userData.sphere.update(h,void 0)):e.userData.sphere&&(e.userData.sphere.visible=!1)}else e.userData.pose=t.pose}}function fl(s,e){const[t,i,n]=s;return{header:{frame_id:"",stamp:{sec:0,nsec:0}},ns:"",id:0,type:_.ARROW,action:re.ADD,pose:(0,L.N2)(),scale:{x:t,y:i,z:n},color:e,lifetime:ct,frame_locked:!0,points:[],colors:[],text:"",mesh_resource:"",mesh_use_embedded_materials:!1}}function ep(s,e){const t=s.pose.covariance,i={x:Math.sqrt(t[0]),y:Math.sqrt(t[7]),z:Math.sqrt(t[14])};return{header:s.header,ns:"",id:1,type:_.SPHERE,action:re.ADD,pose:(0,L.N2)(),scale:i,color:N(ie(),e.covarianceColor),lifetime:ct,frame_locked:!0,points:[],colors:[],text:"",mesh_resource:"",mesh_use_embedded_materials:!1}}function tp(s){return{header:Pe(s.header),pose:ee(s.pose)}}function sp(s){return{header:{stamp:de(s.timestamp),frame_id:s.frame_id??""},pose:ee(s.pose)}}function ip(s){const e=Lc(s?.covariance);return{pose:ee(s?.pose),covariance:e}}function np(s){return{header:Pe(s.header),pose:ip(s.pose)}}const pl="axis",ml=ys,gl=[1,.15,.15],bl=.2,yl=[{r:124/255,g:107/255,b:1,a:1},{r:124/255,g:107/255,b:1,a:.5}],rp="MISMATCHED_FRAME_ID",ap={sec:0,nsec:0},op={r:1,g:1,b:1,a:1},vl=[ne(yl[0]),ne(yl[1])],tr={visible:!1,type:pl,axisScale:ml,arrowScale:gl,lineWidth:bl,gradient:vl},lp=[{label:"Axis",value:"axis"},{label:"Arrow",value:"arrow"},{label:"Line",value:"line"}],cp=ie(),dp=ie(),hp=ie();class up extends F{dispose(){this.userData.axes.forEach(e=>e.dispose()),this.userData.arrows.forEach(e=>e.dispose()),this.userData.lineStrip?.dispose(),super.dispose()}details(){return this.userData.originalMessage}removeArrows(){for(const e of this.userData.arrows)this.remove(e),e.dispose();this.userData.arrows.length=0}removeAxes(){for(const e of this.userData.axes)this.remove(e),e.dispose();this.userData.axes.length=0}removeLineStrip(){this.userData.lineStrip&&(this.remove(this.userData.lineStrip),this.userData.lineStrip.dispose(),this.userData.lineStrip=void 0)}}class fp extends Q.d{constructor(e){super("foxglove.PoseArrays",e)}getSubscriptions(){return[{type:"schema",schemaNames:dn,subscription:{handler:this.#e}},{type:"schema",schemaNames:Vi,subscription:{handler:this.#s}},{type:"schema",schemaNames:cs,subscription:{handler:this.#t}}]}settingsNodes(){const e=this.renderer.config.topics,t=this.handleSettingsAction,i=[];for(const n of this.renderer.topics??[]){if(!($(n,dn)||$(n,cs)||$(n,Vi)))continue;const r=e[n.name]??{},a=r.type??sr(n),{axisScale:o,lineWidth:l}=r,d=r.arrowScale??gl,h=r.gradient??vl,f={type:{label:"Type",input:"select",options:lp,value:a}};switch(a){case"axis":f.axisScale=Da("Scale",o,ml);break;case"arrow":f.arrowScale=Vd("Scale",d);break;case"line":f.lineWidth=Ca("Line Width",l,bl);break}a!=="axis"&&(f.gradient=$d("Gradient",h)),i.push({path:["topics",n.name],node:{label:n.name,icon:$(n,cs)?"Timeline":"Flag",fields:f,visible:r.visible??tr.visible,handler:t}})}return i}handleSettingsAction=e=>{const t=e.payload.path;if(e.action!=="update"||t.length!==3)return;this.saveSetting(t,e.payload.value);const i=t[1],n=this.renderables.get(i);if(n){const r=this.renderer.config.topics[i],a={type:sr(this.renderer.topicsByName?.get(i))};this.#a(n,n.userData.poseArrayMessage,n.userData.originalMessage,n.userData.receiveTime,{...tr,...a,...r})}};#e=e=>{const t=pp(e.message),i=(0,w.toNanoSec)(e.receiveTime);this.#i(e.topic,t,e.message,i)};#t=e=>{if(!bp(e,this.renderer))return;const t=mp(e.message),i=(0,w.toNanoSec)(e.receiveTime);this.#i(e.topic,t,e.message,i)};#s=e=>{const t=gp(e.message),i=(0,w.toNanoSec)(e.receiveTime);this.#i(e.topic,t,e.message,i)};#i(e,t,i,n){let r=this.renderables.get(e);if(!r){const a=this.renderer.config.topics[e],o={type:sr(this.renderer.topicsByName?.get(e))},l={...tr,...o,...a};r=new up(e,this.renderer,{receiveTime:n,messageTime:(0,w.toNanoSec)(t.header.stamp),frameId:this.renderer.normalizeFrameId(t.header.frame_id),pose:(0,L.N2)(),settingsPath:["topics",e],settings:l,topic:e,poseArrayMessage:t,originalMessage:i,axes:[],arrows:[]}),this.add(r),this.renderables.set(e,r)}this.#a(r,t,i,n,r.userData.settings)}#n(e,t,i){const n=e.userData.settings.axisScale*(1/ys),r=Math.min(e.userData.axes.length,t.poses.length);for(let a=0;a<r;a++){const o=e.userData.axes[a];o.visible=!0,o.scale.set(n,n,n)}for(let a=e.userData.axes.length;a<t.poses.length;a++){const o=new vs(i,this.renderer);e.userData.axes.push(o),e.add(o),o.scale.set(n,n,n)}for(let a=t.poses.length;a<e.userData.axes.length;a++){const o=e.userData.axes[a];o.visible=!1}}#r(e,t,i,n,r){const a=l=>{const d=l/(t.poses.length-1),h=Qi(hp,n,r,d);return fl(e.userData.settings.arrowScale,h)},o=Math.min(e.userData.arrows.length,t.poses.length);for(let l=0;l<o;l++){const d=a(l),h=e.userData.arrows[l];h.visible=!0,h.update(d,void 0)}for(let l=e.userData.arrows.length;l<t.poses.length;l++){const d=a(l),h=new Ti(i,d,void 0,this.renderer);e.userData.arrows.push(h),e.add(h)}for(let l=t.poses.length;l<e.userData.arrows.length;l++){const d=e.userData.arrows[l];d.visible=!1}}#a(e,t,i,n,r){e.userData.receiveTime=n,e.userData.messageTime=(0,w.toNanoSec)(t.header.stamp),e.userData.frameId=this.renderer.normalizeFrameId(t.header.frame_id),e.userData.poseArrayMessage=t,e.userData.originalMessage=i;const{topic:a,settings:o}=e.userData,l=r.type!==o.type||r.axisScale!==o.axisScale||!Zi(r.arrowScale,o.arrowScale)||!Zi(r.gradient,o.gradient)||e.userData.arrows.length===0&&e.userData.axes.length===0;e.userData.settings=r;const d=N(cp,r.gradient[0]),h=N(dp,r.gradient[1]);if(l)switch(e.userData.settings.type){case"axis":e.removeArrows(),e.removeLineStrip();break;case"arrow":e.removeAxes(),e.removeLineStrip();break;case"line":{e.removeArrows(),e.removeAxes();const f=Tl(t,r.lineWidth,d,h);if(!e.userData.lineStrip){const p=new Qn(a,f,void 0,this.renderer);e.userData.lineStrip=p,e.add(p)}e.userData.lineStrip.update(f,void 0)}break}switch(r.type){case"axis":this.#n(e,t,a);for(let f=0;f<t.poses.length;f++)Sl(e.userData.axes[f],t.poses[f]);break;case"arrow":this.#r(e,t,a,d,h);for(let f=0;f<t.poses.length;f++)Sl(e.userData.arrows[f],t.poses[f]);break;case"line":{const f=Tl(t,r.lineWidth,d,h);e.userData.lineStrip?.update(f,void 0);break}}}}function sr(s){return s!=null&&cs.has(s.schemaName)?"line":pl}function Sl(s,e){const t=e.position,i=e.orientation;s.position.set(t.x,t.y,t.z),s.quaternion.set(i.x,i.y,i.z,i.w),s.updateMatrix()}function Tl(s,e,t,i){const n=[];for(let r=0;r<s.poses.length;r++){const a=r/(s.poses.length-1);n.push(Qi(ie(),t,i,a))}return{header:s.header,ns:"",id:0,type:_.LINE_STRIP,action:re.ADD,pose:(0,L.N2)(),scale:{x:e,y:1,z:1},color:op,lifetime:ap,frame_locked:!0,points:s.poses.map(r=>r.position),colors:n,text:"",mesh_resource:"",mesh_use_embedded_materials:!1}}function pp(s){return{header:Pe(s.header),poses:s.poses?.map(e=>ee(e))??[]}}function mp(s){return{header:Pe(s.header),poses:s.poses?.map(e=>ee(e?.pose))??[]}}function gp(s){return{header:{stamp:de(s.timestamp),frame_id:s.frame_id??""},poses:s.poses?.map(ee)??[]}}function bp(s,e){const{topic:t,message:i}=s;if(i.poses){const n=e.normalizeFrameId(i.header?.frame_id??"");for(const r of i.poses){const a=e.normalizeFrameId(r?.header?.frame_id??"");if(n!==a)return e.settings.errors.addToTopic(t,rp,`Path poses must all have the same frame_id. "${n}" != "${a}"`),!1}}return!0}var xl=b(20414);const wl=new c.Pa4(1,0,0),Il=new c.Pa4;function Dl(s){return{header:{frame_id:"",stamp:{sec:0,nsec:0}},ns:"",id:0,type:_.ARROW,action:re.ADD,pose:(0,xl.N2)(),scale:{x:2,y:.25,z:.25},color:s==="pose_estimate"?{r:0,g:1,b:1,a:1}:{r:1,g:0,b:1,a:1},lifetime:ct,frame_locked:!0,points:[],colors:[],text:"",mesh_resource:"",mesh_use_embedded_materials:!1}}function yp(){return{header:{frame_id:"",stamp:{sec:0,nsec:0}},ns:"",id:0,type:_.SPHERE,action:re.ADD,pose:(0,xl.N2)(),scale:{x:.25,y:.25,z:.25},color:{r:1,g:1,b:0,a:1},lifetime:ct,frame_locked:!0,points:[],colors:[],text:"",mesh_resource:"",mesh_use_embedded_materials:!1}}class vp extends Q.d{#e;#t;publishClickType="point";state="idle";#s;#i;constructor(e){super("foxglove.PublishClickTool",e),this.#e=new Ps("",yp(),void 0,this.renderer),this.#t=new Ti("",Dl(this.publishClickType),void 0,this.renderer),this.#e.visible=!1,this.#e.mesh.userData.picking=!1,this.#t.visible=!1,this.#t.shaftMesh.userData.picking=!1,this.#t.headMesh.userData.picking=!1,this.add(this.#e),this.add(this.#t),this.#n("idle")}dispose(){super.dispose(),this.#t.dispose(),this.#e.dispose(),this.renderer.input.removeListener("click",this.#a),this.renderer.input.removeListener("mousemove",this.#r)}setPublishClickType(e){this.publishClickType=e,this.#t.update(Dl(this.publishClickType),void 0),this.dispatchEvent({type:"foxglove.publish-type-change"})}start(){this.#n("place-first-point")}stop(){this.#n("idle")}#n(e){switch(this.state=e,e){case"idle":this.#s=this.#i=void 0,this.renderer.input.removeListener("click",this.#a),this.renderer.input.removeListener("mousemove",this.#r),this.dispatchEvent({type:"foxglove.publish-end"});break;case"place-first-point":this.renderer.input.addListener("click",this.#a),this.renderer.input.addListener("mousemove",this.#r),this.dispatchEvent({type:"foxglove.publish-start"});break;case"place-second-point":break}this.#o()}#r=(e,t,i)=>{if(t){switch(this.state){case"idle":break;case"place-first-point":(this.#s??=new c.Pa4).copy(t);break;case"place-second-point":(this.#i??=new c.Pa4).copy(t);break}this.#o()}};#a=(e,t,i)=>{if(t){switch(this.state){case"idle":break;case"place-first-point":this.#s=t.clone(),this.publishClickType==="point"?(this.dispatchEvent({type:"foxglove.publish-submit",publishClickType:this.publishClickType,point:{x:this.#s.x,y:this.#s.y,z:this.#s.z}}),this.#n("idle")):this.#n("place-second-point");break;case"place-second-point":if(this.#i=t.clone(),this.#s&&this.publishClickType!=="point"){const n=this.#s.clone(),r=new c._fP().setFromUnitVectors(wl,Il.subVectors(this.#i,this.#s).normalize());this.dispatchEvent({type:"foxglove.publish-submit",publishClickType:this.publishClickType,pose:{position:{x:n.x,y:n.y,z:n.z},orientation:{x:r.x,y:r.y,z:r.z,w:r.w}}})}this.#n("idle");break}this.#o()}};#o(){this.publishClickType==="point"?(this.#t.visible=!1,this.#s?(this.#e.visible=!0,this.#e.position.copy(this.#s)):this.#e.visible=!1):(this.#e.visible=!1,this.#s?(this.#t.visible=!0,this.#t.position.copy(this.#s),this.#i?this.#t.quaternion.setFromUnitVectors(wl,Il.subVectors(this.#i,this.#s).normalize()):this.#t.quaternion.set(0,0,0,1)):this.#t.visible=!1),this.renderer.queueAnimationFrame()}}var Cl=b(86073),H;(function(s){s.CUBES="CUBES",s.MODELS="MODELS",s.LINES="LINES",s.CYLINDERS="CYLINDERS",s.ARROWS="ARROWS",s.SPHERES="SPHERES",s.TEXTS="TEXTS",s.TRIANGLES="TRIANGLES"})(H||(H={}));const Sp=[H.CUBES,H.MODELS,H.LINES,H.CYLINDERS,H.ARROWS,H.SPHERES,H.TEXTS,H.TRIANGLES],Tp="INVALID_DELETION_TYPE",xp={[H.CUBES]:"cubes",[H.MODELS]:"models",[H.LINES]:"lines",[H.CYLINDERS]:"cylinders",[H.ARROWS]:"arrows",[H.SPHERES]:"spheres",[H.TEXTS]:"texts",[H.TRIANGLES]:"triangles"};class wp extends F{primitivePool;pickable=!1;#e=new Map;constructor(e,t,i,n){super(e,i,n),this.primitivePool=t}dispose(){this.children.length=0,this.#i()}updateSettings(){for(const e of this.#e.values())for(const t of Object.values(e))t.updateSettings(this.userData.settings)}setColorScheme(e){for(const t of this.#e.values())for(const i of Object.values(t))i.setColorScheme(e)}startFrame(e,t,i){if(this.visible=this.userData.settings.visible,!this.visible){this.renderer.settings.errors.clearTopic(this.topic);return}for(const n of this.#e.values())for(const r of Object.values(n)){const a=r.userData.entity;if(!a)continue;const o=r.userData.expiresAt;if(o!=null&&e>o){this.#s(a.id);break}const l=this.renderer.normalizeFrameId(a.frame_id),d=a.frame_locked?e:(0,w.toNanoSec)(a.timestamp),h=(0,Ds.S)(r,this.renderer.transformTree,t,i,l,e,d);r.visible=h;const f=this.userData.topic;if(h)this.renderer.settings.errors.removeFromTopic(f,Be.o);else{const p=(0,Be.v)(t,i,l);this.renderer.settings.errors.addToTopic(f,Be.o,p)}}}addOrUpdateEntity(e,t){let i=this.#e.get(e.id);i||(i={},this.#e.set(e.id,i));for(const n of Sp){const r=e[xp[n]].length>0;let a=i[n];r?(a||(a=this.primitivePool.acquire(n),a.name=`${e.id}:${n} on ${this.topic}`,a.userData.settingsPath=this.userData.settingsPath,a.setColorScheme(this.renderer.colorScheme),i[n]=a,this.add(a)),a.update(this.userData.topic,e,this.userData.settings,t)):a&&(this.remove(a),delete i[n],this.primitivePool.release(n,a))}}deleteEntities(e){switch(e.type){case E.SceneEntityDeletionType.MATCHING_ID:this.#s(e.id);break;case E.SceneEntityDeletionType.ALL:this.#i();break;default:this.renderer.settings.errors.addToTopic(this.topic,Tp,`Invalid deletion type ${e.type}`)}}#t(e){for(const[t,i]of Object.entries(e))i&&(this.remove(i),this.primitivePool.release(t,i))}#s(e){const t=this.#e.get(e);t&&this.#t(t),this.#e.delete(e)}#i(){for(const e of this.#e.values())this.#t(e);this.#e.clear()}}const Ip={showOutlines:!0,visible:!1,color:void 0,selectedIdVariable:void 0};class gt extends F{constructor(e,t,i={receiveTime:-1n,messageTime:-1n,frameId:"",pose:Gn(),settings:Ip,settingsPath:[],entity:void 0}){super(e,t,i)}update(e,t,i,n){this.userData.topic=e,this.userData.entity=t,this.userData.settings=i,this.userData.receiveTime=n}idFromMessage(){return this.userData.entity?.id}selectedIdVariable(){return this.getSettings()?.selectedIdVariable}getSettings(){if(this.userData.topic!=null)return this.userData.settings}details(){return this.userData.entity??{}}setColorScheme(e){}prepareForReuse(){this.userData.entity=void 0,this.userData.pose=Gn()}addError(e,t){this.renderer.settings.errors.add(this.userData.settingsPath,e,t)}clearErrors(){this.userData.settingsPath.length>0&&this.renderer.settings.errors.clearPath(this.userData.settingsPath)}}class xi extends c.Wid{onBeforeCompile(e,t){super.onBeforeCompile(e,t),e.vertexShader=e.vertexShader.replace("#include <color_pars_vertex>",`
        #include <color_pars_vertex>
        attribute float instanceOpacity;
        varying float vInstanceOpacity;
        `).replace("#include <color_vertex>",`
        #include <color_vertex>
        vInstanceOpacity = instanceOpacity;
        `),e.fragmentShader=e.fragmentShader.replace("#include <color_pars_fragment>",`
        #include <color_pars_fragment>
        varying float vInstanceOpacity;
        `).replace("#include <color_fragment>",`
        #include <color_fragment>
        diffuseColor.a = vInstanceOpacity * opacity;
        `)}}const Ml=new c.Ilk,ir=new c.Pa4,nr=new c.Pa4,El=new c.yGw,wi=new c._fP,Dp=ie();class Cp extends gt{#e;#t;#s;#i;#n;#r;#a;#o=new xi({metalness:0,roughness:1,dithering:!0});#l;#h;#c;constructor(e){super("",e,void 0),this.#l=16,this.#a=new c.lb7(new Float32Array(this.#l),1),this.#e=e.sharedGeometry.getGeometry(`${this.constructor.name}-shaft`,Mp).clone(),this.#e.setAttribute("instanceOpacity",this.#a),this.#n=new c.SPe(this.#e,this.#o,this.#l),this.#n.count=0,this.add(this.#n),this.#t=e.sharedGeometry.getGeometry(`${this.constructor.name}-head`,Ep).clone(),this.#t.setAttribute("instanceOpacity",this.#a),this.#r=new c.SPe(this.#t,this.#o,this.#l),this.#r.count=0,this.add(this.#r);const t=e.sharedGeometry.getGeometry(`${this.constructor.name}-shaftedges`,()=>Al(this.#e));this.#s=new c.L5s().copy(t),this.#s.setAttribute("instanceMatrix",this.#n.instanceMatrix),this.#h=new c.ejS(this.#s,e.instancedOutlineMaterial),this.#h.frustumCulled=!1,this.#h.userData.picking=!1,this.add(this.#h);const i=e.sharedGeometry.getGeometry(`${this.constructor.name}-headedges`,()=>_l(this.#t));this.#i=new c.L5s().copy(i),this.#i.setAttribute("instanceMatrix",this.#r.instanceMatrix),this.#c=new c.ejS(this.#i,e.instancedOutlineMaterial),this.#c.frustumCulled=!1,this.#c.userData.picking=!1,this.add(this.#c)}#d(e){if(e>this.#l){const t=Math.ceil(e*1.5)+16;this.#l=t,this.#a=new c.lb7(new Float32Array(this.#l),1),this.#n.removeFromParent(),this.#n.dispose(),this.#n=new c.SPe(this.#e,this.#o,this.#l),this.#e.setAttribute("instanceOpacity",this.#a),this.add(this.#n),this.#r.removeFromParent(),this.#r.dispose(),this.#r=new c.SPe(this.#t,this.#o,this.#l),this.#t.setAttribute("instanceOpacity",this.#a),this.add(this.#r),this.#s.dispose();const i=this.renderer.sharedGeometry.getGeometry(`${this.constructor.name}-shaftedges`,()=>Al(this.#e));this.#s=new c.L5s().copy(i),this.#s.instanceCount=t,this.#s.setAttribute("instanceMatrix",this.#n.instanceMatrix),this.#h.geometry=this.#s,this.#i.dispose();const n=this.renderer.sharedGeometry.getGeometry(`${this.constructor.name}-headedges`,()=>_l(this.#t));this.#i=new c.L5s().copy(n),this.#i.instanceCount=t,this.#i.setAttribute("instanceMatrix",this.#r.instanceMatrix),this.#c.geometry=this.#i}}#u(e){let t=!1;this.#d(e.length);const i=this.userData.settings.color?N(Dp,this.userData.settings.color):void 0;let n=0;for(const r of e){const a=i??r.color;a.a<1&&(t=!0),this.#n.setColorAt(n,fe(Ml,a)),this.#r.setColorAt(n,fe(Ml,a)),this.#a.setX(n,a.a),wi.set(r.pose.orientation.x,r.pose.orientation.y,r.pose.orientation.z,r.pose.orientation.w),this.#n.setMatrixAt(n,El.compose(ir.set(r.pose.position.x,r.pose.position.y,r.pose.position.z),wi,nr.set(r.shaft_length,r.shaft_diameter,r.shaft_diameter))),ir.add(nr.set(r.shaft_length,0,0).applyQuaternion(wi)),this.#r.setMatrixAt(n,El.compose(ir,wi,nr.set(r.head_length,r.head_diameter,r.head_diameter))),n++}this.#o.transparent!==t&&(this.#o.transparent=t,this.#o.depthWrite=!t,this.#o.needsUpdate=!0),this.#n.count===0&&e.length>0&&(this.#o.needsUpdate=!0),this.#n.count=e.length,this.#r.count=e.length,this.#s.instanceCount=e.length,this.#i.instanceCount=e.length,this.#n.instanceMatrix.needsUpdate=!0,this.#r.instanceMatrix.needsUpdate=!0,this.#a.needsUpdate=!0,this.#n.instanceColor&&(this.#n.instanceColor.needsUpdate=!0),this.#r.instanceColor&&(this.#r.instanceColor.needsUpdate=!0)}dispose(){this.#o.dispose(),this.#n.dispose(),this.#r.dispose(),this.#e.dispose(),this.#t.dispose(),this.#s.dispose(),this.#i.dispose()}update(e,t,i,n){if(super.update(e,t,i,n),t){const r=(0,w.toNanoSec)(t.lifetime);this.userData.expiresAt=r===0n?void 0:n+r,this.#u(t.arrows),this.#c.visible=i.showOutlines??!0,this.#h.visible=i.showOutlines??!0}}updateSettings(e){this.update(this.userData.topic,this.userData.entity,e,this.userData.receiveTime)}}function Mp(){const s=new c.fHI(.5,.5,1,16);return s.rotateZ(-Math.PI/2).translate(.5,0,0),s.computeBoundingSphere(),s}function Al(s){const e=new c.TOt(s,40);return e.computeBoundingSphere(),e}function Ep(){const s=new c.b_z(.5,1,16);return s.rotateZ(-Math.PI/2).translate(.5,0,0),s.computeBoundingSphere(),s}function _l(s){const e=new c.TOt(s,40);return e.computeBoundingSphere(),e}const Ap=new c.Ilk,_p=new c.Pa4,Pp=new c.Pa4,Rp=new c.yGw,Lp=new c._fP,Np=ie();class Op extends gt{#e;#t;#s=new xi({metalness:0,roughness:1,dithering:!0});#i;#n;#r;#a;#o;constructor(e){super("",e),this.#a=e.sharedGeometry.getGeometry(`${this.constructor.name}-cube`,Fp).clone(),this.#i=16,this.#e=new c.SPe(this.#a,this.#s,this.#i),this.#t=new c.lb7(new Float32Array(this.#i),1),this.#a.setAttribute("instanceOpacity",this.#t),this.#e.count=0,this.add(this.#e),this.#o=e.sharedGeometry.getGeometry(`${this.constructor.name}-edges`,()=>Up(this.#a)),this.#n=new c.L5s().copy(this.#o),this.#n.setAttribute("instanceMatrix",this.#e.instanceMatrix),this.#r=new c.ejS(this.#n,e.instancedOutlineMaterial),this.#r.frustumCulled=!1,this.#r.userData.picking=!1,this.add(this.#r)}#l(e){if(e>this.#i){const t=Math.trunc(e*1.5)+16;this.#i=t,this.#e.removeFromParent(),this.#e.dispose(),this.#e=new c.SPe(this.#a,this.#s,this.#i),this.#t=new c.lb7(new Float32Array(this.#i),1),this.#a.setAttribute("instanceOpacity",this.#t),this.add(this.#e),this.#n.dispose(),this.#n=new c.L5s().copy(this.#o),this.#n.instanceCount=t,this.#n.setAttribute("instanceMatrix",this.#e.instanceMatrix),this.#r.geometry=this.#n}}#h(e){let t=!1;this.#l(e.length);const i=this.userData.settings.color?N(Np,this.userData.settings.color):void 0;let n=0;for(const r of e){const a=i??r.color;a.a<1&&(t=!0),this.#e.setColorAt(n,fe(Ap,a)),this.#t.setX(n,a.a),this.#e.setMatrixAt(n,Rp.compose(_p.set(r.pose.position.x,r.pose.position.y,r.pose.position.z),Lp.set(r.pose.orientation.x,r.pose.orientation.y,r.pose.orientation.z,r.pose.orientation.w),Pp.set(r.size.x,r.size.y,r.size.z))),n++}this.#s.transparent!==t&&(this.#s.transparent=t,this.#s.depthWrite=!t,this.#s.needsUpdate=!0),this.#e.count===0&&e.length>0&&(this.#s.needsUpdate=!0),this.#e.count=e.length,this.#n.instanceCount=e.length,this.#e.instanceMatrix.needsUpdate=!0,this.#t.needsUpdate=!0,this.#e.instanceColor&&(this.#e.instanceColor.needsUpdate=!0)}dispose(){this.#e.dispose(),this.#a.dispose(),this.#s.dispose(),this.#n.dispose()}update(e,t,i,n){if(super.update(e,t,i,n),t){const r=(0,w.toNanoSec)(t.lifetime);this.userData.expiresAt=r===0n?void 0:n+r,this.#h(t.cubes),this.#r.visible=i.showOutlines??!0}}updateSettings(e){this.update(this.userData.topic,this.userData.entity,e,this.userData.receiveTime)}}function Fp(){const s=new c.DvJ(1,1,1);return s.computeBoundingSphere(),s}function Up(s){const e=new c.TOt(s,40);return e.computeBoundingSphere(),e}const zp=new c.Ilk,kp=new c.Pa4,jp=new c.Pa4,Gp=new c.yGw,Bp=new c._fP,Vp=ie();class $p extends gt{#e;#t;#s;#i;#n;#r;#a=new Zp;#o=new Yp;#l=new Kp;#h;#c;#d;constructor(e){super("",e),this.#t=e.sharedGeometry.getGeometry(`${this.constructor.name}-cylinder`,Wp).clone(),this.#h=16,this.#e=new c.SPe(this.#t,this.#o,this.#h),this.#e.userData.pickingMaterial=this.#l,this.#i=new c.lb7(new Float32Array(this.#h),1),this.#r=new c.lb7(new Float32Array(this.#h),1),this.#n=new c.lb7(new Float32Array(this.#h),1),this.#t.setAttribute("instanceOpacity",this.#i),this.#t.setAttribute("instanceBottomScale",this.#r),this.#t.setAttribute("instanceTopScale",this.#n),this.#e.count=0,this.add(this.#e),this.#s=e.sharedGeometry.getGeometry(`${this.constructor.name}-edges`,()=>Hp(this.#t)),this.#c=new c.L5s().copy(this.#s),this.#c.setAttribute("instanceMatrix",this.#e.instanceMatrix),this.#c.setAttribute("instanceBottomScale",this.#r),this.#c.setAttribute("instanceTopScale",this.#n),this.#d=new c.ejS(this.#c,this.#a),this.#d.frustumCulled=!1,this.#d.userData.picking=!1,this.add(this.#d)}setColorScheme(e){this.#a.color.copy(e==="dark"?Xi:Ki),this.#a.needsUpdate=!0}#u(e){if(e>this.#h){const t=Math.trunc(e*1.5)+16;this.#h=t,this.#i=new c.lb7(new Float32Array(this.#h),1),this.#r=new c.lb7(new Float32Array(this.#h),1),this.#n=new c.lb7(new Float32Array(this.#h),1),this.#t.setAttribute("instanceOpacity",this.#i),this.#t.setAttribute("instanceBottomScale",this.#r),this.#t.setAttribute("instanceTopScale",this.#n),this.#e.removeFromParent(),this.#e.dispose(),this.#e=new c.SPe(this.#t,this.#o,this.#h),this.#e.userData.pickingMaterial=this.#l,this.add(this.#e),this.#c.dispose(),this.#c=new c.L5s().copy(this.#s),this.#c.instanceCount=t,this.#c.setAttribute("instanceMatrix",this.#e.instanceMatrix),this.#c.setAttribute("instanceBottomScale",this.#r),this.#c.setAttribute("instanceTopScale",this.#n),this.#d.geometry=this.#c}}#f(e){let t=!1;this.#u(e.length);const i=this.userData.settings.color?N(Vp,this.userData.settings.color):void 0;let n=0;for(const r of e){const a=i??r.color;a.a<1&&(t=!0),this.#e.setColorAt(n,fe(zp,a)),this.#i.setX(n,a.a),this.#r.setX(n,r.bottom_scale),this.#n.setX(n,r.top_scale),this.#e.setMatrixAt(n,Gp.compose(kp.set(r.pose.position.x,r.pose.position.y,r.pose.position.z),Bp.set(r.pose.orientation.x,r.pose.orientation.y,r.pose.orientation.z,r.pose.orientation.w),jp.set(r.size.x,r.size.y,r.size.z))),n++}this.#o.transparent!==t&&(this.#o.transparent=t,this.#o.depthWrite=!t,this.#o.needsUpdate=!0),this.#e.count===0&&e.length>0&&(this.#o.needsUpdate=!0),this.#e.count=e.length,this.#c.instanceCount=e.length,this.#e.instanceMatrix.needsUpdate=!0,this.#i.needsUpdate=!0,this.#r.needsUpdate=!0,this.#n.needsUpdate=!0,this.#e.instanceColor&&(this.#e.instanceColor.needsUpdate=!0)}dispose(){this.#e.dispose(),this.#t.dispose(),this.#o.dispose(),this.#l.dispose(),this.#a.dispose(),this.#c.dispose()}update(e,t,i,n){if(super.update(e,t,i,n),t){const r=(0,w.toNanoSec)(t.lifetime);this.userData.expiresAt=r===0n?void 0:n+r,this.#f(t.cylinders),this.#d.visible=i.showOutlines??!0}}updateSettings(e){this.update(this.userData.topic,this.userData.entity,e,this.userData.receiveTime)}}function Wp(){const s=new c.fHI(.5,.5,1,16);return s.rotateX(Math.PI/2),s.computeBoundingSphere(),s}function Hp(s){const e=new c.TOt(s,40);return e.computeBoundingSphere(),e}function rr(s){return s.replace("#include <color_pars_vertex>",`
  #include <color_pars_vertex>
  attribute float instanceBottomScale, instanceTopScale;
  `).replace("#include <begin_vertex>",`
  #include <begin_vertex>
  transformed.xy *= mix(instanceBottomScale, instanceTopScale, transformed.z + 0.5);
  `)}class Yp extends xi{constructor(){super({metalness:0,roughness:1,dithering:!0})}onBeforeCompile(e,t){super.onBeforeCompile(e,t),e.vertexShader=rr(e.vertexShader)}}class Zp extends c.nls{constructor(){super(),this.defines??={},this.defines.USE_INSTANCING=!0}onBeforeCompile(e,t){super.onBeforeCompile(e,t),e.vertexShader=rr(e.vertexShader)}}class Kp extends c.jyz{constructor(){super({vertexShader:rr(c.WdD.meshbasic_vert),fragmentShader:`
          uniform vec4 objectId;
          void main() {
            gl_FragColor = objectId;
          }
        `,uniforms:{objectId:{value:[NaN,NaN,NaN,NaN]}}})}}const Xp=ie();class Jp extends gt{#e=[];constructor(e){super("",e)}#t(e){this.clear();let t=0;for(t;t<e.length;t++){const i=e[t];if(i.points.length===0)continue;let n=this.#e[t];n==null&&(n=new Qp(i,this.renderer.input.canvasSize),this.#e.push(n)),n.setPrimitive(i),n.setSettings(this.userData.settings),n.update(),n.position.set(i.pose.position.x,i.pose.position.y,i.pose.position.z),n.quaternion.set(i.pose.orientation.x,i.pose.orientation.y,i.pose.orientation.z,i.pose.orientation.w),this.add(n)}}dispose(){for(const e of this.#e)e.dispose(),e.removeFromParent();this.clear(),this.#e.length=0}update(e,t,i,n){if(super.update(e,t,i,n),t){const r=(0,w.toNanoSec)(t.lifetime);this.userData.expiresAt=r===0n?void 0:n+r,this.#t(t.lines)}}updateSettings(e){this.update(this.userData.topic,this.userData.entity,e,this.userData.receiveTime)}}class Qp extends c.Tme{#e;#t;#s;#i;#n;#r=!0;#a;#o=!0;#l;#h=!0;#c;#d;constructor(e,t){super(),this.#i=new si({worldUnits:!e.scale_invariant,linewidth:e.thickness,transparent:this.#r,depthWrite:!this.#r,resolution:t.clone()}),this.#i.linewidth=e.thickness,this.#n=new im,this.#n.resolution.set(t.x,t.y),this.#n.linewidth=e.thickness,this.#n.worldUnits=!e.scale_invariant,this.#n.needsUpdate=!0}setSettings(e){this.#h||=this.#c!==e.color,this.#c=e.color}setPrimitive(e){this.#o||=this.#l!==e,this.#l=e}update(){if(this.#l==null){this.visible=!1;return}this.visible=!0;const e=this.#l.type===E.LineType.LINE_LOOP,t=this.#l.type===E.LineType.LINE_LIST,i=this.#l.indices.length>0,n=(i?this.#l.indices.length:this.#l.points.length)+(e?1:0),r=n*3;if(this.#o){if(this.#e==null||this.#d!==this.#l.type||!this.#t||this.#t.length<r){switch(this.#e!=null&&(this.#e.dispose(),this.#t=void 0,this.#s=void 0),this.#a!=null&&this.#a.removeFromParent(),this.#d=this.#l.type,this.#l.type){case E.LineType.LINE_STRIP:case E.LineType.LINE_LOOP:{const o=new Wt.L;this.#e=o,this.#t=new Float32Array(r),this.#a=new ni.w(o,this.#i);break}case E.LineType.LINE_LIST:{this.#e=new ms.z,this.#t=new Float32Array(r),this.#a=new ps.w(this.#e,this.#i);break}}this.#a.userData.pickingMaterial=this.#n,this.userData.pickingMaterial=this.#n,this.add(this.#a)}(0,V.assert)(this.#t,"Position buffer must be initialized"),(0,V.assert)(this.#e,"Geometry must be initialized"),this.#e.instanceCount=t?n>>>1:e?n:Math.max(n-1,0),i?em(this.#t,this.#l):qp(this.#t,this.#l),this.#e.setPositions(this.#t)}if(this.#h||this.#o){const a=this.#c?N(Xp,this.#c):this.#l.colors.length===0?this.#l.color:void 0;if(a==null){(0,V.assert)(this.#e,"Line Group geometry must exist"),this.#i.color.setRGB(1,1,1);const o=n*4;(this.#s==null||this.#s.length<o)&&(this.#s=new Float32Array(o)),this.#i.vertexColors=!0,this.#i.color.setRGB(1,1,1),this.#i.opacity=1,this.#i.uniforms.opacity.value=1,i?sm(this.#s,this.#l):tm(this.#s,this.#l);const l=new c.$TI(this.#s,t?8:4,1);this.#e.setAttribute("instanceColorStart",new c.kB5(l,4,0)),this.#e.setAttribute("instanceColorEnd",new c.kB5(l,4,4))}else{this.#i.vertexColors=!1;const o=this.#i.color;fe(o,a),this.#i.uniforms.opacity.value=a.a}this.#u()}this.#o=!1,this.#h=!1}#u(){this.#l!=null&&(this.#i.lineWidth=this.#l.thickness,this.#i.transparent=this.#r,this.#i.worldUnits=!this.#l.scale_invariant,this.#i.needsUpdate=!0,this.#n.lineWidth=this.#l.thickness,this.#n.worldUnits=!this.#l.scale_invariant,this.#n.uniformsNeedUpdate=!0,this.#n.needsUpdate=!0)}dispose(){this.#a?.removeFromParent(),this.#e?.dispose(),this.#i.dispose(),this.#n.dispose()}}function qp(s,e){let t=0;(0,V.assert)(s.length>=e.points.length*3,`positionsOut must have a length (${s.length})  >= to primitive.points.length (${e.points.length}) * 3`);for(const{x:n,y:r,z:a}of e.points)s[t++]=n,s[t++]=r,s[t++]=a;e.type===E.LineType.LINE_LOOP&&s.length>3&&s.copyWithin(t,0,3)}function em(s,e){const t=e.indices;(0,V.assert)(s.length>=e.indices.length*3,`positionsOut must have a length (${s.length})  >= to primitive.indices.length (${e.indices.length}) * 3`);let i=0;for(const r of t){const{x:a,y:o,z:l}=e.points[r];s[i++]=a,s[i++]=o,s[i++]=l}e.type===E.LineType.LINE_LOOP&&s.length>3&&s.copyWithin(i,0,3)}function tm(s,e){(0,V.assert)(s.length>=e.colors.length*4,`colorsOut buffer must have a length (${s.length}) >= to the primitive.colors.length (${e.colors.length}) * 4`),(0,V.assert)(e.colors.length>0,"invariant: expected not to be using vertex colors");let t=0;for(const{r:n,g:r,b:a,a:o}of e.colors)s[t++]=U(n),s[t++]=U(r),s[t++]=U(a),s[t++]=o;e.type===E.LineType.LINE_LOOP&&s.length>4&&s.copyWithin(t,0,4)}function sm(s,e){const t=e.indices;(0,V.assert)(t.length>0,"Indices must have length"),(0,V.assert)(s.length>=t.length*4,`colorsOut buffer must have a length (${s.length}) >= to primitive.indices.length (${e.indices.length}) * 4`),(0,V.assert)(e.colors.length>0,"Invariant: expected not to be using vertex colors");let i=0;for(const r of t){const{r:a,g:o,b:l,a:d}=e.colors[r];s[i++]=U(a),s[i++]=U(o),s[i++]=U(l),s[i++]=d}e.type===E.LineType.LINE_LOOP&&s.length>4&&s.copyWithin(i,0,4)}class im extends si{constructor(){super({worldUnits:!1,vertexColors:!1,linewidth:0,transparent:!1}),this.uniforms.objectId={value:[NaN,NaN,NaN,NaN]}}onBeforeCompile(e,t){super.onBeforeCompile(e,t),e.fragmentShader=`
      uniform vec4 objectId;
      void main() {
        gl_FragColor = objectId;
      }
    `}}var nm=b(41613);function Pl(s){s instanceof c.Wid&&(s.map?.dispose(),s.lightMap?.dispose(),s.aoMap?.dispose(),s.emissiveMap?.dispose(),s.bumpMap?.dispose(),s.normalMap?.dispose(),s.displacementMap?.dispose(),s.roughnessMap?.dispose(),s.metalnessMap?.dispose(),s.alphaMap?.dispose(),s.envMap?.dispose()),s.dispose()}function Rs(s){s.traverse(e=>{if(e instanceof c.Kj0)if(e.geometry.dispose(),Array.isArray(e.material))for(const t of e.material)t instanceof c.F5T&&Pl(t);else e.material instanceof c.F5T&&Pl(e.material)})}function Rl(s){const e=[];s.traverse(t=>{const i=t;i.isLight===!0&&e.push(i)});for(const t of e)t.dispose(),t.removeFromParent()}function Ll(s,e){s.traverse(t=>{if(!(t instanceof c.Kj0))return;const i=t;if(Array.isArray(i.material))for(const n of i.material)Nl(n);else Nl(i.material);i.material=e,i.geometry.attributes.normal||i.geometry.computeVertexNormals()})}function Nl(s){s.map?.dispose(),s.lightMap?.dispose(),s.aoMap?.dispose(),s.emissiveMap?.dispose(),s.bumpMap?.dispose(),s.normalMap?.dispose(),s.displacementMap?.dispose(),s.roughnessMap?.dispose(),s.metalnessMap?.dispose(),s.alphaMap?.dispose(),s.envMap?.dispose(),s.dispose()}const rm=ie(),Jt="MODEL_FETCH_FAILED";function am(s,e){if(s.length!==e.length)return!1;for(let t=0;t<s.length;t++)if(s[t]!==e[t])return!1;return!0}class om extends gt{#e=new Map;#t=new Map;#s=0;constructor(e){super("",e)}async#i(e,t,i,n,r){let a;if(t){const l=t.findIndex(d=>i(d.primitive,e));l>=0&&(a=t.splice(l,1)[0])}if(a)return this.#o(a,e),a;const o=n(e);try{const l=await this.#a(o,{overrideMediaType:e.media_type.length>0?e.media_type:void 0});l&&(a={model:Ol(l),cachedModel:l,primitive:e},this.#o(a,e))}finally{r(o)}return a}#n(e){this.clear();const t=++this.#s,i=this.#t;this.#t=new Map;const n=this.#e;this.#e=new Map,Promise.all(e.map(async r=>{let a,o,l;if(r.url.length===0){const d=(0,nm.kn)(r.data);a=n.get(d),o=this.#e.get(d),o||(o=[],this.#e.set(d,o));try{l=await this.#i(r,a,(h,f)=>h.media_type===f.media_type&&am(h.data,f.data),h=>URL.createObjectURL(new Blob([h.data],{type:h.media_type})),h=>URL.revokeObjectURL(h))}catch(h){this.renderer.settings.errors.add(this.userData.settingsPath,Jt,`Unhandled error loading model from ${r.data.byteLength}-byte data: ${h.message}`)}}else{a=i.get(r.url),o=this.#t.get(r.url),o||(o=[],this.#t.set(r.url,o));try{l=await this.#i(r,a,(d,h)=>d.url===h.url&&d.media_type===h.media_type,d=>d.url,d=>{})}catch(d){this.renderer.settings.errors.add(this.userData.settingsPath,Jt,`Unhandled error loading model from "${r.url}": ${d.message}`)}}t===this.#s&&l&&(o.push(l),this.add(l.model),this.renderer.queueAnimationFrame())})).then(()=>{this.renderer.settings.errors.remove(this.userData.settingsPath,Jt)}).catch(console.error).finally(()=>{for(const r of i.values())for(const a of r)a.model.removeFromParent(),this.#l(a);for(const r of n.values())for(const a of r)a.model.removeFromParent(),this.#l(a);this.#r(),this.renderer.queueAnimationFrame()})}dispose(){for(const e of this.#t.values())for(const t of e)this.#l(t);this.#t.clear();for(const e of this.#e.values())for(const t of e)this.#l(t);this.#e.clear()}update(e,t,i,n){if(super.update(e,t,i,n),t){const r=(0,w.toNanoSec)(t.lifetime);this.userData.expiresAt=r===0n?void 0:n+r,this.#n(t.models)}}updateSettings(e){this.update(this.userData.topic,this.userData.entity,e,this.userData.receiveTime)}#r(){const e=this.getSettings()?.showOutlines??!0;this.traverse(t=>{t instanceof c.ejS&&t.name===bn&&(t.visible=e)})}async#a(e,t){const i=await this.renderer.modelCache.load(e,{overrideMediaType:t.overrideMediaType},n=>{this.renderer.settings.errors.add(this.userData.settingsPath,Jt,`Error loading model from "${e}": ${n.message}`)});if(!i){this.renderer.settings.errors.hasError(this.userData.settingsPath,Jt)||this.renderer.settings.errors.add(this.userData.settingsPath,Jt,`Failed to load model from "${e}"`);return}return i}#o(e,t){const i=this.userData.settings.color?N(rm,this.userData.settings.color):t.override_color?t.color:void 0;if(i){e.material||(e.material=new c.Wid({metalness:0,roughness:1,dithering:!0}),Ll(e.model,e.material)),fe(e.material.color,i);const n=i.a<1;e.material.opacity=i.a,e.material.transparent=n,e.material.depthWrite=!n,e.material.needsUpdate=!0}else e.material&&(e.model=Ol(e.cachedModel),e.material=void 0);e.model.scale.set(t.scale.x,t.scale.y,t.scale.z),e.model.position.set(t.pose.position.x,t.pose.position.y,t.pose.position.z),e.model.quaternion.set(t.pose.orientation.x,t.pose.orientation.y,t.pose.orientation.z,t.pose.orientation.w)}#l(e){e.material?.dispose(),Rs(e.model),Rs(e.cachedModel)}}function Ol(s){const e=s.clone(!0);return Rl(e),new c.ZAu().add(e)}const lm=new c.Ilk,cm=new c.Pa4,dm=new c.Pa4,hm=new c.yGw,um=new c._fP,fm=ie();class pm extends gt{#e;#t;#s;#i=new xi({metalness:0,roughness:1,dithering:!0});#n;constructor(e){super("",e),this.#e=e.sharedGeometry.getGeometry(this.constructor.name,mm).clone(),this.#n=16,this.#t=new c.SPe(this.#e,this.#i,this.#n),this.#s=new c.lb7(new Float32Array(this.#n),1),this.#e.setAttribute("instanceOpacity",this.#s),this.#t.count=0,this.add(this.#t)}#r(e){if(e>this.#n){const t=Math.trunc(e*1.5)+16;this.#n=t,this.#t.removeFromParent(),this.#t.dispose(),this.#t=new c.SPe(this.#t.geometry,this.#i,this.#n),this.#s=new c.lb7(new Float32Array(this.#n),1),this.#e.setAttribute("instanceOpacity",this.#s),this.add(this.#t)}}#a(e){let t=!1;this.#r(e.length);const i=this.userData.settings.color?N(fm,this.userData.settings.color):void 0;let n=0;for(const r of e){const a=i??r.color;a.a<1&&(t=!0),this.#t.setColorAt(n,fe(lm,a)),this.#s.setX(n,a.a),this.#t.setMatrixAt(n,hm.compose(cm.set(r.pose.position.x,r.pose.position.y,r.pose.position.z),um.set(r.pose.orientation.x,r.pose.orientation.y,r.pose.orientation.z,r.pose.orientation.w),dm.set(r.size.x,r.size.y,r.size.z))),n++}this.#i.transparent!==t&&(this.#i.transparent=t,this.#i.depthWrite=!t,this.#i.needsUpdate=!0),this.#t.count===0&&e.length>0&&(this.#i.needsUpdate=!0),this.#t.count=e.length,this.#t.instanceMatrix.needsUpdate=!0,this.#s.needsUpdate=!0,this.#t.instanceColor&&(this.#t.instanceColor.needsUpdate=!0)}dispose(){this.#t.dispose(),this.#e.dispose(),this.#i.dispose()}update(e,t,i,n){if(super.update(e,t,i,n),t){const r=(0,w.toNanoSec)(t.lifetime);this.userData.expiresAt=r===0n?void 0:n+r,this.#a(t.spheres)}}updateSettings(e){this.update(this.userData.topic,this.userData.entity,e,this.userData.receiveTime)}}function mm(){const s=new c.xo$(.5,16,16);return s.computeBoundingSphere(),s}const gm=ie();class bm extends gt{#e;#t=[];constructor(e){super("",e),this.#e=e.labelPool}#s(e){const t=this.#t.length;if(e>t)for(let i=t;i<e;i++){const n=this.#e.acquire();this.#t.push(n),this.add(n)}}#i(e){this.#s(e.length);const t=this.userData.settings.color?N(gm,this.userData.settings.color):void 0;let i=0;for(const n of e){const r=t??n.color,a=this.#t[i];if(!a)throw new Error("invariant: labels array smaller than requested");a.setText(n.text),a.setColor(U(r.r),U(r.g),U(r.b)),Vs(r.r,r.g,r.b)<.5?a.setBackgroundColor(1,1,1):a.setBackgroundColor(0,0,0),a.setOpacity(r.a),a.setLineHeight(n.font_size),a.setBillboard(n.billboard),a.setSizeAttenuation(!n.scale_invariant),a.quaternion.set(n.pose.orientation.x,n.pose.orientation.y,n.pose.orientation.z,n.pose.orientation.w),a.position.set(n.pose.position.x,n.pose.position.y,n.pose.position.z),i++}if(i<this.#t.length)for(const n of this.#t.splice(i))this.#e.release(n)}dispose(){for(const e of this.#t)this.#e.release(e)}update(e,t,i,n){if(super.update(e,t,i,n),t){const r=(0,w.toNanoSec)(t.lifetime);this.userData.expiresAt=r===0n?void 0:n+r,this.#i(t.texts)}}updateSettings(e){this.update(this.userData.topic,this.userData.entity,e,this.userData.receiveTime)}}const ym=ie(),Fl=new c.Ilk,Ul={r:0,g:1,b:0,a:1},vm="INVALID_COLOR_LENGTH",Sm="INVALID_POINT";class Tm extends gt{#e=[];constructor(e){super("",e)}#t(e){for(;e>this.#e.length;)this.#e.push(xm())}#s(e){this.#t(e.length),this.clear();let t=0;for(const i of e){const n=this.#e[t];if(!n)continue;const{geometry:r,material:a}=n;let o=!1,l=!1,d=!1;r.resize(i.points.length),r.attributes.position||r.createAttribute("position",Float32Array,3),r.attributes.normal||r.createAttribute("normal",Float32Array,3);const h=r.attributes.position,f=this.userData.settings.color?N(ym,this.userData.settings.color):i.colors.length===0?i.color:void 0;!f&&!r.attributes.color&&r.createAttribute("color",Uint8Array,4,!0);const p=r.attributes.color;for(let m=0;m<i.points.length;m++){const g=i.points[m];if(!wm(g)){this.addError(`${this.name}-${Sm}`,`Entity: ${this.userData.entity?.id}.triangles[${t}](1st index) - Point definition at index ${m} is not finite`);continue}if(l=l||h.getX(m)!==g.x||h.getY(m)!==g.y||h.getZ(m)!==g.z,h.setXYZ(m,g.x,g.y,g.z),!f&&p&&i.colors.length>0){const y=i.colors[m]??Ul;m===i.points.length-1&&y===Ul&&this.addError(`${this.name}-${vm}`,`Entity: ${this.userData.entity?.id}.triangles[${t}](1st index) - Colors array should be same size as points array, showing #00ff00 instead`);const S=U(y.r),D=U(y.g),A=U(y.b),M=y.a;d=d||p.getX(m)!==S||p.getY(m)!==D||p.getZ(m)!==A||p.getW(m)!==M,p.setXYZW(m,S,D,A,M),!o&&M<1&&(o=!0)}}if(l&&(r.computeVertexNormals(),r.computeBoundingSphere(),r.attributes.position.needsUpdate=!0),d=!a.vertexColors&&!f&&i.colors.length>0,d)a.vertexColors=!0,a.color.setRGB(1,1,1),a.opacity=1,r.attributes.color.needsUpdate=!0,a.needsUpdate=!0;else if(f){o=f.a<1;const m=fe(Fl,f);(a.vertexColors||!a.color.equals(m)||n.material.opacity!==f.a)&&(a.vertexColors=!1,a.color.copy(Fl),n.material.opacity=f.a,a.needsUpdate=!0)}a.transparent!==o&&(a.transparent=o,a.depthWrite=!o,a.needsUpdate=!0);const u=i.indices;if(u.length>0){if(!r.index||r.index.count<u.length){const m=new Uint32Array(Math.round(u.length*1.5)+16);m.set(u),r.index=new c.TlE(m,1),r.index.count=u.length}else{const m=r.index.array;let g=!1;for(let y=0;y<u.length;y++)m[y]!==u[y]&&(m[y]=u[y],g=!0);r.index.needsUpdate=g}r.setDrawRange(0,u.length)}else r.index=null;n.position.set(i.pose.position.x,i.pose.position.y,i.pose.position.z),n.quaternion.set(i.pose.orientation.x,i.pose.orientation.y,i.pose.orientation.z,i.pose.orientation.w),this.add(n),t++}}dispose(){for(const e of this.#e)e.geometry.dispose(),e.material.dispose();this.clear(),this.#e.length=0,this.clearErrors()}update(e,t,i,n){if(super.update(e,t,i,n),t){const r=(0,w.toNanoSec)(t.lifetime);this.userData.expiresAt=r===0n?void 0:n+r,this.#s(t.triangles)}}updateSettings(e){this.update(this.userData.topic,this.userData.entity,e,this.userData.receiveTime)}}function xm(){return new c.Kj0(new Et,new c.Wid({metalness:0,roughness:1,flatShading:!0,side:c.ehD}))}function wm(s){return Number.isFinite(s.x)&&Number.isFinite(s.y)&&Number.isFinite(s.z)}const Im={[H.CUBES]:Op,[H.MODELS]:om,[H.LINES]:Jp,[H.CYLINDERS]:$p,[H.ARROWS]:Cp,[H.SPHERES]:pm,[H.TEXTS]:bm,[H.TRIANGLES]:Tm};class Dm{renderer;#e=new Map;#t=!1;constructor(e){this.renderer=e}acquire(e){if(this.#t)throw new Error(`Attempt to acquire PrimitiveType.${e} after PrimitivePool was disposed`);const t=this.#e.get(e)?.pop();return t?(t.prepareForReuse(),t):new Im[e](this.renderer)}release(e,t){if(this.#t){t.dispose();return}const i=this.#e.get(e);i?i.push(t):this.#e.set(e,[t])}dispose(){for(const e of this.#e.values())for(const t of e)t.dispose();this.#e.clear(),this.#t=!0}setColorScheme(e){for(const t of this.#e.values())for(const i of t)i.setColorScheme(e)}}const Ii={showOutlines:!0,visible:!1,color:void 0,selectedIdVariable:void 0};class Cm extends Q.d{#e=new Dm(this.renderer);constructor(e){super("foxglove.SceneEntities",e)}getSubscriptions(){return[{type:"schema",schemaNames:Gi,subscription:{handler:this.#t}}]}settingsNodes(){const e=this.renderer.config.topics,t=[];for(const i of this.renderer.topics??[]){if(!$(i,Gi))continue;const n=e[i.name]??{},r={label:i.name,icon:"Shapes",order:i.name.toLocaleLowerCase(),fields:{color:{label:"Color",input:"rgba",value:n.color},showOutlines:{label:"Show outlines",input:"boolean",value:n.showOutlines??Ii.showOutlines},selectedIdVariable:{label:"Selection Variable",input:"string",help:"When selecting a SceneEntity, this global variable will be set to the entity ID",value:n.selectedIdVariable,placeholder:le}},visible:n.visible??Ii.visible,handler:this.handleSettingsAction};t.push({path:["topics",i.name],node:r})}return t}startFrame(e,t,i){for(const n of this.renderables.values())n.startFrame(e,t,i)}setColorScheme(e,t){for(const i of this.renderables.values())i.setColorScheme(e)}handleSettingsAction=e=>{const t=e.payload.path;if(e.action!=="update"||t.length!==3)return;this.saveSetting(t,e.payload.value);const i=t[1],n=this.renderables.get(i);if(n){const r=this.renderer.config.topics[i];n.userData.settings={...Ii,...r},n.updateSettings()}};#t=e=>{const t=e.topic,i=e.message;for(const n of i.deletions??[])if(n){const r=Em(n);this.#s(t).deleteEntities(r)}for(const n of i.entities??[])if(n){const r=Mm(n);this.#s(t).addOrUpdateEntity(r,(0,w.toNanoSec)(e.receiveTime))}};#s(e){let t=this.renderables.get(e);if(!t){const i=this.renderer.config.topics[e];t=new wp(e,this.#e,this.renderer,{receiveTime:-1n,messageTime:-1n,frameId:"",pose:(0,L.N2)(),settingsPath:["topics",e],topic:e,settings:{...Ii,...i}}),this.renderables.set(e,t),this.add(t)}return t}dispose(){super.dispose(),this.#e.dispose()}}function Mm(s){return{timestamp:de(s.timestamp),frame_id:s.frame_id??"",id:s.id??"",lifetime:de(s.lifetime),frame_locked:s.frame_locked??!1,metadata:s.metadata?.map(e=>({key:e?.key??"",value:e?.value??""}))??[],arrows:s.arrows?.map(Am)??[],cubes:s.cubes?.map(_m)??[],spheres:s.spheres?.map(Pm)??[],cylinders:s.cylinders?.map(Rm)??[],lines:s.lines?.map(Lm)??[],triangles:s.triangles?.map(Nm)??[],texts:s.texts?.map(Om)??[],models:s.models?.map(Fm)??[]}}function Em(s){return{timestamp:de(s.timestamp),type:s.type??E.SceneEntityDeletionType.MATCHING_ID,id:s.id??""}}function Am(s){return{pose:ee(s?.pose),shaft_length:s?.shaft_length??.8,shaft_diameter:s?.shaft_diameter??.1,head_length:s?.head_length??.2,head_diameter:s?.head_diameter??.2,color:Xe(s?.color)}}function _m(s){return{pose:ee(s?.pose),size:je(s?.size),color:Xe(s?.color)}}function Pm(s){return{pose:ee(s?.pose),size:je(s?.size),color:Xe(s?.color)}}function Rm(s){return{pose:ee(s?.pose),size:je(s?.size),bottom_scale:s?.bottom_scale??1,top_scale:s?.top_scale??1,color:Xe(s?.color)}}function Lm(s){return{type:s?.type??E.LineType.LINE_STRIP,pose:ee(s?.pose),thickness:s?.thickness??.05,scale_invariant:s?.scale_invariant??!1,points:s?.points?.map(je)??[],color:Xe(s?.color),colors:fn(s?.colors),indices:s?.indices?.map(e=>e??NaN)??[]}}function Nm(s){return{pose:ee(s?.pose),points:s?.points?.map(je)??[],color:Xe(s?.color),colors:fn(s?.colors),indices:s?.indices?.map(e=>e??NaN)??[]}}function Om(s){return{pose:ee(s?.pose),billboard:s?.billboard??!0,font_size:s?.font_size??(s?.scale_invariant??!1?16:.25),scale_invariant:s?.scale_invariant??!1,color:Xe(s?.color),text:s?.text??""}}function Fm(s){return{pose:ee(s?.pose),scale:je(s?.scale),color:Xe(s?.color),override_color:s?.override_color??!1,url:s?.url??"",media_type:s?.media_type??"",data:jt(s?.data)}}var Um=b(87373);const zm=["fixed","continuous","revolute","planar","prismatic","floating"];function km(s){const e=new DOMParser,t=s instanceof XMLDocument?s:e.parseFromString(s,"text/xml");for(let i=0;i<t.children.length;i++){const n=t.children[i];if(n.nodeName==="robot")return jm(n)}throw new Error("No robot found in URDF")}function jm(s){const e=s.getAttribute("name")??void 0;if(e==null)throw new Error("<robot> name is missing");const t=new Map,i=new Map,n=new Map;for(let r=0;r<s.children.length;r++){const a=s.children[r],o=a.getAttribute("name");if(o!=null)switch(a.nodeName){case"link":t.set(o,Gm(a));break;case"joint":i.set(o,Vm(a));break;case"material":n.set(o,zl(a));break}}return{name:e,links:t,joints:i,materials:n}}function Gm(s){const e=s.getAttribute("name")??void 0;if(e==null)throw new Error(`missing attribute "name" in ${s}`);const t={name:e,visuals:[],colliders:[]};for(let i=0;i<s.children.length;i++){const n=s.children[i];switch(n.nodeName){case"inertial":t.inertial=Bm(n);break;case"visual":t.visuals.push($m(n));break;case"collision":t.colliders.push(Wm(n));break}}return t}function Bm(s){let e,t,i;for(let n=0;n<s.children.length;n++){const r=s.children[n];switch(r.nodeName){case"origin":e=Di(r);break;case"mass":t=Zm(r);break;case"inertia":i=Hm(r);break}}if(t==null||i==null)throw new Error("<inertial> must have mass and inertia");return{origin:e??Ci(),mass:t,inertia:i}}function Vm(s){const e=s.getAttribute("name")??void 0,t=s.getAttribute("type")??void 0;let i,n,r,a,o,l,d,h,f;if(e==null)throw new Error(`missing attribute "name" in ${s}`);if(!zm.includes(t??""))throw new Error(`invalid joint type "${t}" in ${s}`);for(let p=0;p<s.children.length;p++){const u=s.children[p];switch(u.nodeName){case"origin":i=Di(u);break;case"parent":n=u.getAttribute("link")??void 0;break;case"child":r=u.getAttribute("link")??void 0;break;case"axis":if(a=Ls(u,"xyz"),a==null)throw new Error(`missing attribute "xyz" in ${u}`);break;case"calibration":o={rising:Ve(u,"rising"),falling:Ve(u,"falling")};break;case"dynamics":l={damping:Ve(u,"damping")??0,friction:Ve(u,"friction")??0};break;case"limit":d={lower:Ve(u,"lower")??0,upper:Ve(u,"upper")??0,effort:Oe(u,"effort"),velocity:Oe(u,"velocity")};break;case"mimic":{const m=u.getAttribute("joint")??void 0;if(m==null)throw new Error(`missing attribute "joint" in ${u}`);h={joint:m,multiplier:Ve(u,"multiplier")??1,offset:Ve(u,"offset")??0};break}case"safety_controller":f={softLowerLimit:Ve(u,"soft_lower_limit")??0,softUpperLimit:Ve(u,"soft_upper_limit")??0,kPosition:Ve(u,"k_position")??0,kVelocity:Oe(u,"k_velocity")};break}}if(n==null||r==null)throw new Error(`missing parent or child in ${s}`);return{name:e,jointType:t,origin:i??Ci(),parent:n,child:r,axis:a??{x:1,y:0,z:0},calibration:o,dynamics:l,limit:d,mimic:h,safetyController:f}}function $m(s){const e=s.getAttribute("name")??void 0;let t,i,n;for(let r=0;r<s.children.length;r++){const a=s.children[r];switch(a.nodeName){case"origin":t=Di(a);break;case"geometry":i=kl(a);break;case"material":n=zl(a);break}}if(i==null)throw new Error("<visual> must have geometry");return{name:e,origin:t??Ci(),geometry:i,material:n}}function Wm(s){const e=s.getAttribute("name")??void 0;let t,i;for(let n=0;n<s.children.length;n++){const r=s.children[n];switch(r.nodeName){case"origin":t=Di(r);break;case"geometry":i=kl(r);break}}if(i==null)throw new Error("<collision> must have geometry");return{name:e,origin:t??Ci(),geometry:i}}function zl(s){const e=s.getAttribute("name")??void 0;let t,i;for(let n=0;n<s.children.length;n++){const r=s.children[n];switch(r.nodeName){case"color":t=Ym(r,"rgba");break;case"texture":i=r.getAttribute("filename")??void 0;break}}return{name:e,color:t,texture:i}}function Hm(s){const e=Oe(s,"ixx"),t=Oe(s,"ixy"),i=Oe(s,"ixz"),n=Oe(s,"iyy"),r=Oe(s,"iyz"),a=Oe(s,"izz");return{ixx:e,ixy:t,ixz:i,iyy:n,iyz:r,izz:a}}function kl(s){if(s.children.length<1)throw new Error("<geometry> must contain box, cylinder, sphere, or mesh");const e=s.children[0];switch(e.nodeName){case"box":{const t=Ls(e,"size");if(t==null)throw new Error(`missing attribute "size" in ${s}`);return{geometryType:"box",size:t}}case"cylinder":{const t=Oe(e,"length"),i=Oe(e,"radius");return{geometryType:"cylinder",length:t,radius:i}}case"sphere":return{geometryType:"sphere",radius:Oe(e,"radius")};case"mesh":{const t=e.getAttribute("filename")??void 0,i=Ls(e,"scale");if(t==null)throw new Error(`missing attribute "filename" in ${s}`);return{geometryType:"mesh",filename:t,scale:i}}default:throw new Error("<geometry> must contain box, cylinder, sphere, or mesh")}}function Di(s){const e=Ls(s,"xyz")??{x:0,y:0,z:0},t=Ls(s,"rpy")??{x:0,y:0,z:0};return{xyz:e,rpy:t}}function Ls(s,e){const t=s.getAttribute(e)?.trim().split(/\s+/);if(t?.length!==3)return;const[i,n,r]=t;return{x:parseFloat(i),y:parseFloat(n),z:parseFloat(r)}}function Ym(s,e){const t=s.getAttribute(e)?.trim().split(/\s+/);if(t?.length!==4)return;const[i,n,r,a]=t;return{r:parseFloat(i),g:parseFloat(n),b:parseFloat(r),a:parseFloat(a)}}function Oe(s,e){const t=s.getAttribute(e);if(t==null)throw new Error(`missing attribute "${e}" in ${s}`);return parseFloat(t)}function Ve(s,e){const t=s.getAttribute(e);if(t!=null)return parseFloat(t)}function Zm(s){if(s.textContent==null)throw new Error(`expected float value in "${s}"`);return parseFloat(s.textContent)}function Ci(){return{xyz:{x:0,y:0,z:0},rpy:{x:0,y:0,z:0}}}async function Km(s,e){const t=new Um.$;t.rospackCommands={find:n=>`package://${n}`},t.getFileContents=e;const i=await t.parse(s);return km(i)}function ar(s){const e=s.x,t=s.y,i=s.z,n=Math.cos(i*.5),r=Math.sin(i*.5),a=Math.cos(e*.5),o=Math.sin(e*.5),l=Math.cos(t*.5),d=Math.sin(t*.5),h=n*a*l+r*o*d,f=n*o*l-r*a*d,p=n*a*d+r*o*l,u=r*a*l-n*o*d;return{x:f,y:p,z:u,w:h}}function jl(s){const{x:e,y:t,z:i,w:n}=s,r=180/Math.PI,a=n*n+e*e-t*t-i*i,o=2*(e*t+n*i),l=2*(e*i-n*t),d=2*(n*e+t*i),h=n*n-e*e-t*t+i*i,f=r*Math.atan2(d,h),p=r*Math.asin(-l),u=r*Math.atan2(o,a);return{roll:f,pitch:p,yaw:u}}function Xm(s,e,t){const i=Array(36).fill(0);return i[6*0+0]=Math.pow(s,2),i[6*1+1]=Math.pow(e,2),i[6*5+5]=Math.pow(t,2),i}var Jm=b(61969);class or extends Re{#e;#t;constructor(e,t,i,n){super(e,t,i,n);const r=this.renderer.sharedGeometry.getGeometry(`${this.constructor.name}-cube`,Gl),a=this.renderer.sharedGeometry.getGeometry(`${this.constructor.name}-cube-edges`,()=>Qm(r));this.#e=new c.Kj0(r,Vt(t.color)),this.#e.castShadow=!0,this.#e.receiveShadow=!0,this.add(this.#e),this.#t=new c.ejS(a,n.outlineMaterial),this.#t.userData.picking=!1,this.#e.add(this.#t),this.update(t,i)}dispose(){this.#e.material.dispose()}update(e,t){super.update(e,t);const i=this.userData.marker,n=i.color.a<1;n!==this.#e.material.transparent&&(this.#e.material.transparent=n,this.#e.material.depthWrite=!n,this.#e.material.needsUpdate=!0),this.#t.visible=this.getSettings()?.showOutlines??!0,fe(this.#e.material.color,i.color),this.#e.material.opacity=i.color.a,this.scale.set(i.scale.x,i.scale.y,i.scale.z)}}function Gl(){const s=new c.DvJ(1,1,1);return s.computeBoundingSphere(),s}function Qm(s){const e=new c.TOt(s,40);return e.computeBoundingSphere(),e}class lr extends Re{#e;#t;constructor(e,t,i,n){super(e,t,i,n);const r=Vt(t.color),a=n.sharedGeometry.getGeometry(`${this.constructor.name}-cylinder-${n.maxLod}`,()=>qm(n.maxLod));this.#e=new c.Kj0(a,r),this.#e.castShadow=!0,this.#e.receiveShadow=!0,this.add(this.#e);const o=n.sharedGeometry.getGeometry(`${this.constructor.name}-edges-${n.maxLod}`,()=>eg(a));this.#t=new c.ejS(o,n.outlineMaterial),this.#t.userData.picking=!1,this.#e.add(this.#t),this.update(t,i)}dispose(){this.#e.material.dispose()}update(e,t){super.update(e,t);const i=this.userData.marker,n=i.color.a<1;n!==this.#e.material.transparent&&(this.#e.material.transparent=n,this.#e.material.depthWrite=!n,this.#e.material.needsUpdate=!0),this.#t.visible=this.getSettings()?.showOutlines??!0,fe(this.#e.material.color,i.color),this.#e.material.opacity=i.color.a,this.scale.set(i.scale.x,i.scale.y,i.scale.z)}}function qm(s){const e=jd(s),t=new c.fHI(.5,.5,1,e);return t.rotateX(Math.PI/2),t.computeBoundingSphere(),t}function eg(s){const e=new c.TOt(s,40);return e.computeBoundingSphere(),e}const Ns="MESH_FETCH_FAILED";class Bl extends Re{#e;#t;#s=0;constructor(e,t,i,n){super(e,t,i,n),this.#t=Vt(t.color),this.update(t,i,!0)}dispose(){this.#e&&Rs(this.#e),this.#t.dispose()}update(e,t,i){const n=this.userData.marker;super.update(e,t);const r=this.userData.marker,a=r.color.a<1;if(a!==this.#t.transparent&&(this.#t.transparent=a,this.#t.depthWrite=!a,this.#t.needsUpdate=!0),fe(this.#t.color,r.color),this.#t.opacity=r.color.a,i===!0||r.mesh_resource!==n.mesh_resource){const o=++this.#s,l={useEmbeddedMaterials:r.mesh_use_embedded_materials},d=this.renderer.settings.errors;this.#e&&(this.remove(this.#e),Rs(this.#e),this.#e=void 0),this.#n(r.mesh_resource,l).then(h=>{if(h){if(this.#s!==o){Rs(h);return}this.#e=h,this.add(h),this.#i(),this.renderer.settings.errors.remove(this.userData.settingsPath,Ns),this.renderer.queueAnimationFrame()}}).catch(h=>{d.add(this.userData.settingsPath,Ns,`Unhandled error loading mesh from "${r.mesh_resource}": ${h.message}`)})}this.#i(),this.scale.set(r.scale.x,r.scale.y,r.scale.z)}#i(){const e=this.getSettings()?.showOutlines??!0;this.traverse(t=>{t instanceof c.ejS&&t.name===bn&&(t.visible=e)})}async#n(e,t){const i=await this.renderer.modelCache.load(e,{},r=>{this.renderer.settings.errors.add(this.userData.settingsPath,Ns,`Error loading mesh from "${e}": ${r.message}`)});if(!i){this.renderer.settings.errors.hasError(this.userData.settingsPath,Ns)||this.renderer.settings.errors.add(this.userData.settingsPath,Ns,`Failed to load mesh from "${e}"`);return}const n=i.clone(!0);return Rl(n),t.useEmbeddedMaterials||Ll(n,this.#t),n}}var tg="../../packages/studio-base/src/panels/ThreeDeeRender/renderables/Urdfs.ts";const Qt=R.ZP.getLogger(tg),Os="foxglove.Urdf",Je="/robot_description",bt="param:/robot_description",cr="/robot_description",sg="/robot_description (parameter)",Vl="ValidUrl",$l="FetchUrdf",ig="ParseUrdf",Mi=Math.PI/180,Fe=180/Math.PI,dr={r:1,g:1,b:1,a:1},ng={x:1,y:1,z:1},Wl=["X","Y","Z"],rg=["R","P","Y"],hr={visible:!1,frameLocked:!0,instanceId:"invalid"},ur={visible:!0,frameLocked:!0,label:"URDF",instanceId:"invalid",layerId:Os,url:""},Ei=new c.Pa4,Hl=new c.Pa4,Yl=new c._fP,ag=new c._fP,fr=new c.USm;var Fs;(function(s){s[s.Use=0]="Use",s[s.Ignore=1]="Ignore"})(Fs||(Fs={}));const pr=(0,Jm.Z)();class og extends F{dispose(){this.removeChildren(),this.userData.urdf=void 0,super.dispose()}removeChildren(){for(const e of this.userData.renderables.values())e.dispose();this.children.length=0,this.userData.renderables.clear()}}class lg extends Q.d{#e=new Map;#t=new Map;#s=new Map;constructor(e){super("foxglove.Urdfs",e),e.on("parametersChange",this.#h),e.addCustomLayerAction({layerId:Os,label:x.ZP.t("threeDee:addURDF"),icon:"PrecisionManufacturing",handler:this.#c});for(const[t,i]of Object.entries(e.config.layers))i?.layerId===Os&&this.#f(t,void 0)}getSubscriptions(){return[{type:"topic",topicName:Je,subscription:{handler:this.#o}},{type:"schema",schemaNames:Jr,subscription:{handler:this.#l}}]}settingsNodes(){const e=[];if(this.renderer.topicsByName?.get(Je)!=null){const n=this.renderer.config.topics[Je]??{};e.push({path:["topics",Je],node:{label:Je,icon:"PrecisionManufacturing",visible:n.visible??hr.visible,handler:this.#n,children:gr(this.#t.get(Je),this.renderer.transformTree,this.#s)}})}if(this.renderer.parameters?.get(cr)!=null){const n=this.renderer.config.topics[bt]??{},r={};e.push({path:["topics",bt],node:{label:sg,icon:"PrecisionManufacturing",fields:r,visible:n.visible??hr.visible,handler:this.#n,children:gr(this.#t.get(bt),this.renderer.transformTree,this.#s)}})}for(const[n,r]of Object.entries(this.renderer.config.layers))if(r?.layerId===Os){const a=r,d={url:{label:"URL",input:"string",placeholder:pr?"package://":void 0,help:pr?"package:// URL or http(s) URL pointing to a Unified Robot Description Format (URDF) XML file":"http(s) URL pointing to a Unified Robot Description Format (URDF) XML file",value:a.url??""}};e.push({path:["layers",n],node:{label:a.label??"Grid",icon:"PrecisionManufacturing",fields:d,visible:a.visible??ur.visible,actions:[{type:"action",id:"delete",label:"Delete"}],order:r.order,handler:this.#r,children:gr(this.#t.get(n),this.renderer.transformTree,this.#s)}})}return e}removeAllRenderables(){this.#i()}#i(){for(const[e,t]of this.#e)this.#b(e,t);for(const[e,t]of this.#t)this.#m(e,t)}startFrame(e,t,i){for(const n of this.renderables.values()){const r=n.userData.settingsPath;let a=!1;if(n.visible=n.userData.settings.visible,!n.visible){this.renderer.settings.errors.clearPath(r);continue}for(const o of n.userData.renderables.values()){const l=e,d=o.userData.frameId;if(!(0,Ds.S)(o,this.renderer.transformTree,t,i,d,e,l)){const f=(0,Be.v)(t,i,d);this.renderer.settings.errors.add(r,Be.o,f),a=!0}}a||this.renderer.settings.errors.remove(r,Be.o)}}#n=e=>{if(e.action==="update"){this.#a(e);return}};#r=e=>{const t=e.payload.path;if(e.action==="perform-node-action"){if(t.length===2&&e.payload.id==="delete"){const i=t[1];this.renderer.updateConfig(a=>{delete a.layers[i]});const n=this.renderables.get(i);n&&(n.dispose(),this.remove(n),this.renderables.delete(i));const r=this.#t.get(i);if(r)for(const{parent:a,child:o}of r)this.renderer.removeTransform(o,a,0n);this.#e.delete(i),this.#t.delete(i),this.#i(),this.updateSettingsTree(),this.renderer.updateCustomLayersCount()}return}else this.#a(e)};#a=e=>{const t=e.payload.path;if(t.length===5&&t[2]==="joints"){const i=t[1],n=t[3],r=this.#t.get(i);if(!r)return;const a=r.find(p=>p.joint.name===n);if(!a)return;const o=a.joint,l=this.renderer.transformTree.getOrCreateFrame(a.child),d=`frame:${l.id}`,h=o.jointType==="revolute"||o.jointType==="continuous",f=Ei.set(o.axis.x,o.axis.y,o.axis.z);if(h){const p=e.payload.value,u=Yl.setFromAxisAngle(f,p*Mi),m=fr.setFromQuaternion(u);l.offsetEulerDegrees=[m.x*Fe,m.y*Fe,m.z*Fe],this.saveSetting(["transforms",d,"rpyOffset"],l.offsetEulerDegrees)}else{const p=e.payload.value;f.multiplyScalar(p),l.offsetPosition=[f.x,f.y,f.z],this.saveSetting(["transforms",d,"xyzOffset"],l.offsetPosition)}}else if(t.length===3){this.saveSetting(t,e.payload.value);const i=t[1];t[1]===bt?this.#f(i,this.renderer.parameters?.get(cr)):this.#f(i,void 0)}};#o=e=>{const t=e.message.data;typeof t=="string"&&this.#f(Je,t)};#l=e=>{const t=e.message,i=t.name??[],n=t.position??[],r=(0,w.toNanoSec)(e.receiveTime);for(let a=0;a<i.length;a++){const o=i[a],l=n[a]??0,d=this.#s.get(o)?.timestamp;(d==null||r>=d)&&this.#s.set(o,{timestamp:r,position:l})}};#h=e=>{const t=e?.get(cr);typeof t=="string"&&this.#f(bt,t)};#c=e=>{Qt.info(`Creating ${Os} layer ${e}`);const t={...ur,instanceId:e};this.renderer.updateConfig(i=>{const r=1+((0,Z.maxBy)(Object.values(i.layers),a=>a?.order)?.order??0);i.layers[e]={...t,order:r}}),this.#f(e,void 0),this.updateSettingsTree()};#d(e,t){const i=this.renderables.get(e);if(!i)throw new Error("_fetchUrdf() should only be called for existing renderables");if(!mg(t)){const n=i.userData.settingsPath;this.renderer.settings.errors.add(n,Vl,`Invalid URDF URL: "${t}"`);return}if(this.renderer.settings.errors.remove(i.userData.settingsPath,Vl),i.userData.url!==t){if(i.userData.fetching){if(i.userData.fetching.url===t)return;i.userData.fetching.control.abort()}Qt.debug(`Fetching URDF from ${t}`),i.userData.fetching={url:t,control:new AbortController},fetch(t,{signal:i.userData.fetching.control.signal}).then(n=>n.text()).then(n=>{Qt.debug(`Fetched ${n.length} byte URDF from ${t}`),this.renderer.settings.errors.remove(["layers",e],$l),this.#f(e,n)}).catch(n=>{const r=n,a=!r.message.startsWith("Failed to fetch"),o=`Failed to load URDF from "${t}"${a?`: ${r.message}`:""}`;this.renderer.settings.errors.add(["layers",e],$l,o)})}}#u(e){const t=e===Je||e===bt,i=t?hr:ur,n=t?this.renderer.config.topics[e]:this.renderer.config.layers[e];return{...i,...n,instanceId:e}}#f(e,t){let i=this.renderables.get(e);if(i&&t!=null&&i.userData.urdf===t){const h=this.#u(e);i.userData.settings=h;return}this.#t.delete(e),this.#e.delete(e),this.updateSettingsTree();const n=e===Je||e===bt,r=this.renderer.fixedFrameId??"",a=n?["topics",e]:["layers",e],o=this.#u(e),l=o.url;if(i||(i=new og(e,this.renderer,{urdf:t,url:t!=null?l:void 0,fetching:void 0,renderables:new Map,receiveTime:0n,messageTime:0n,frameId:r,pose:(0,L.N2)(),settingsPath:a,settings:o}),this.add(i),this.renderables.set(e,i)),i.userData.urdf=t,i.userData.url=t!=null?l:void 0,i.userData.settings=o,i.userData.fetching=void 0,!t){i.removeChildren(),l!=null&&this.#d(e,l);return}const d=i;cg(t).then(h=>{this.#p(d,h),this.renderer.queueAnimationFrame()}).catch(h=>{const f=h;Qt.error(`Failed to parse URDF: ${f.message}`),this.renderer.settings.errors.add(a,ig,`Failed to parse URDF: ${f.message}`)})}#p(e,{robot:t,frames:i,transforms:n}){const r=this.renderer,a=e.userData.settings.instanceId;this.#b(a,i),this.#m(a,n),this.updateSettingsTree(),e.removeChildren();const o=(l,d,h)=>{const f=e.userData.url,p=hg(h,t,d,l,r,f);p.userData.settingsPath=e.userData.settingsPath,e.userData.renderables.set(p.name,p),e.add(p)};for(const l of t.links.values()){const d=l.name;for(let h=0;h<l.visuals.length;h++)o(d,h,l.visuals[h]);if(l.visuals.length===0&&l.colliders.length>0)for(let h=0;h<l.colliders.length;h++)o(d,h,l.colliders[h])}}#b(e,t){this.#e.set(e,t);for(const i of t)this.renderer.addCoordinateFrame(i)}#m(e,t){this.#t.set(e,t);const n=e===Je||e===bt?["topics",e]:["layers",e];for(const{parent:r,child:a,translation:o,rotation:l}of t)this.renderer.addTransform(r,a,0n,o,l,n)}}async function cg(s){const e=dg();try{Qt.debug(`Parsing ${s.length} byte URDF`);const t=await Km(s,e),i=Array.from(t.links.values(),r=>r.name),n=Array.from(t.joints.values(),r=>{const a=r.origin.xyz,o=ar(r.origin.rpy);return{parent:r.parent,child:r.child,translation:a,rotation:o,joint:r}});return{robot:t,frames:i,transforms:n}}catch(t){throw new Error(`Failed to parse ${s.length} byte URDF: ${t}`)}}function dg(){return async s=>{try{return Qt.debug(`fetch(${s}) requested`),await(await fetch(s)).text()}catch(e){throw new Error(`Failed to fetch "${s}": ${e}`)}}}function hg(s,e,t,i,n,r){const a=`${i}-${t}-${s.geometry.geometryType}`,o=ar(s.origin.rpy),l={position:s.origin.xyz,orientation:o},d=ug(s,e),h=s.geometry.geometryType;switch(h){case"box":{const f=s.geometry.size,p=mr(i,_.CUBE,l,f,d);return new or(a,p,void 0,n)}case"cylinder":{const f=s.geometry,p={x:f.radius*2,y:f.radius*2,z:f.length},u=mr(i,_.CUBE,l,p,d);return new lr(a,u,void 0,n)}case"sphere":{const f=s.geometry,p={x:f.radius*2,y:f.radius*2,z:f.radius*2},u=mr(i,_.CUBE,l,p,d);return new Ps(a,u,void 0,n)}case"mesh":{const p=s.geometry.filename.toLowerCase().endsWith(".dae")||!s.material?Fs.Use:Fs.Ignore,u=fg(i,l,p,s.geometry,r,d);return new Bl(a,u,void 0,n)}default:throw new Error(`Unrecognized visual geometryType: ${h}`)}}function ug(s,e){return s.material?s.material.color?s.material.color:s.material.name?e.materials.get(s.material.name)?.color??dr:dr:dr}function mr(s,e,t,i,n){return{header:{frame_id:s,stamp:{sec:0,nsec:0}},ns:"",id:0,type:e,action:re.ADD,pose:t,scale:i,color:n,lifetime:{sec:0,nsec:0},frame_locked:!0,points:[],colors:[],text:"",mesh_resource:"",mesh_use_embedded_materials:!1}}function fg(s,e,t,i,n,r){const a=i.scale??ng;return{header:{frame_id:s,stamp:{sec:0,nsec:0}},ns:"",id:0,type:_.MESH_RESOURCE,action:re.ADD,pose:e,scale:a,color:r,lifetime:{sec:0,nsec:0},frame_locked:!0,points:[],colors:[],text:"",mesh_resource:new URL(i.filename,n).toString(),mesh_use_embedded_materials:t===Fs.Use}}const pg=["https:","http:","file:","data:"];function mg(s){try{const e=new URL(s);return pr&&e.protocol==="package:"||pg.includes(e.protocol)}catch{return!1}}function gr(s,e,t){if(!s)return{};const i={};for(const{joint:r}of s){const a=r.child,o=e.getOrCreateFrame(a),{x:l,y:d,z:h}=r.origin.xyz,{x:f,y:p,z:u}=r.origin.rpy,{x:m,y:g,z:y}=r.axis,S={};switch(S.jointType={label:"Type",input:"string",readonly:!0,value:r.jointType},r.jointType){case"fixed":break;case"continuous":case"revolute":{const D=r.limit?r.limit.lower*Fe:-180,A=r.limit?r.limit.upper*Fe:180;let M;const I=t.get(r.name)?.position;if(o.offsetEulerDegrees){const P=gg(o.offsetEulerDegrees);M=yg(P,r.axis)*Fe}S.manual={label:"Manual angle",input:"number",precision:we,step:1,min:D,max:A,value:M},I!=null&&(S.jointState={label:"JointState angle",input:"number",precision:we,min:D,max:A,readonly:!0,value:I*Fe});break}case"prismatic":{const D=r.limit?.lower,A=r.limit?.upper,M=o.offsetPosition?bg(o.offsetPosition,r.axis):void 0,I=t.get(r.name)?.position;S.manual={label:"Manual position",input:"number",precision:k,step:.01,min:D,max:A,value:M},I!=null&&(S.jointState={label:"JointState position",input:"number",precision:k,min:D,max:A,readonly:!0,value:I});break}case"floating":case"planar":break}if(S.position={label:"Position",input:"vec3",labels:Wl,precision:k,readonly:!0,value:[l,d,h]},S.rotation={label:"Rotation",input:"vec3",labels:rg,precision:we,readonly:!0,value:[f*Fe,p*Fe,u*Fe]},S.parent={label:"Parent",input:"string",readonly:!0,value:r.parent},S.child={label:"Child",input:"string",readonly:!0,value:r.child},r.jointType!=="fixed"&&(S.axis={label:"Axis",input:"vec3",labels:Wl,precision:k,readonly:!0,value:[m,g,y]}),r.calibration){const{rising:D,falling:A}=r.calibration;S.calibration={label:"Calibration",input:"vec2",labels:["\u2191","\u2193"],readonly:!0,value:[D,A]}}if(r.dynamics){const{damping:D,friction:A}=r.dynamics;S.damping={label:"Damping",input:"number",precision:k,readonly:!0,value:D},S.friction={label:"Friction",input:"number",precision:k,readonly:!0,value:A}}if(r.limit){const{effort:D,velocity:A}=r.limit;if(r.jointType!=="continuous"&&r.jointType!=="fixed"){const{upper:M,lower:I}=r.limit,P=r.jointType==="revolute",O=P?M*Fe:M,z=P?I*Fe:I;S.limit={label:"Limit",input:"vec2",labels:["\u2191","\u2193"],readonly:!0,precision:P?we:k,value:[O,z]}}S.effort={label:"Limit effort",input:"number",precision:k,readonly:!0,value:D},S.velocity={label:"Limit velocity",input:"number",precision:k,readonly:!0,value:A}}if(r.mimic){const{joint:D,multiplier:A,offset:M}=r.mimic;S.mimicJoint={label:"Mimic joint",input:"string",readonly:!0,value:D},S.mimicMultiplier={label:"Mimic multiplier",input:"number",precision:k,readonly:!0,value:A},S.mimicOffset={label:"Mimic offset",input:"number",precision:k,readonly:!0,value:M}}if(r.safetyController){const{softUpperLimit:D,softLowerLimit:A,kPosition:M,kVelocity:I}=r.safetyController;S.softLimit={label:"Soft limit",input:"vec2",labels:["\u2191","\u2193"],readonly:!0,value:[D,A]},S.kPosition={label:"k_position",input:"number",precision:k,readonly:!0,value:M},S.kVelocity={label:"k_velocity",input:"number",precision:k,readonly:!0,value:I}}i[r.name]={label:r.name,fields:S,defaultExpansionState:"collapsed"}}return{joints:{label:"Joints",defaultExpansionState:"collapsed",children:i}}}function gg(s){return fr.set(s[0]*Mi,s[1]*Mi,s[2]*Mi),Yl.setFromEuler(fr)}function bg(s,e){const t=Ei.set(s[0],s[1],s[2]),i=Hl.set(e.x,e.y,e.z);t.projectOnVector(i);const n=t.length();return(t.dot(i)<0?-1:1)*n}function yg(s,e){const t=Ei.set(s.x,s.y,s.z),i=Hl.set(e.x,e.y,e.z),n=t.projectOnVector(i),r=ag.set(n.x,n.y,n.z,s.w);r.normalize();const a=2*Math.acos(r.w);return(Ei.set(r.x,r.y,r.z).dot(i)<0?-1:1)*a}var Te=b(3890);const br={...pi,stixelsEnabled:!1};function vg(s){switch(s){case Te.PointFieldDataType.UINT8:return E.NumericType.UINT8;case Te.PointFieldDataType.INT8:return E.NumericType.INT8;case Te.PointFieldDataType.UINT16:return E.NumericType.UINT16;case Te.PointFieldDataType.INT16:return E.NumericType.INT16;case Te.PointFieldDataType.UINT32:return E.NumericType.UINT32;case Te.PointFieldDataType.INT32:return E.NumericType.INT32;case Te.PointFieldDataType.FLOAT32:return E.NumericType.FLOAT32;case Te.PointFieldDataType.FLOAT64:return E.NumericType.FLOAT64;default:return E.NumericType.UNKNOWN}}class Sg{#e=new Map;decode(e){if(e.packets.length===0)return;const t=e.packets[0],i=Te.RawPacket.InferModel(t.data);if(i==null)return;const n=(0,w.toSec)(e.header.stamp),r=Te.RawPacket.MAX_POINTS_PER_PACKET*e.packets.length,a=new Te.PointCloud({stamp:n,maxPoints:r}),o=this.getTransformer(i);for(const l of e.packets)o.unpack(new Te.RawPacket(l.data),n,(0,w.toSec)(l.stamp),a);if(a.trim(),!(a.width===0||a.height===0))return{timestamp:e.header.stamp,frame_id:e.header.frame_id,pose:(0,L.N2)(),point_stride:a.point_step,fields:a.fields.map(l=>({name:l.name,offset:l.offset,type:vg(l.datatype)})),data:a.data}}getTransformer(e){let t=this.#e.get(e);return t!=null||(t=new Te.Transformer(new Te.Calibration(e)),this.#e.set(e,t)),t}}class Tg extends Q.d{#e=new Map;#t=new Sg;constructor(e){super("foxglove.VelodyneScans",e)}getSubscriptions(){return[{type:"schema",schemaNames:on,subscription:{handler:this.#s}}]}settingsNodes(){const e=this.renderer.config.topics,t=this.handleSettingsAction,i=[];for(const n of this.renderer.topics??[]){if(!$(n,on))continue;const r=e[n.name]??{},a=this.#e.get(n.name)??No,o=Un(n,a,r);o.fields.stixelsEnabled={label:"Stixel view",input:"boolean",value:r.stixelsEnabled??br.stixelsEnabled},o.handler=t,o.icon="Points",i.push({path:["topics",n.name],node:o})}return i}handleSettingsAction=e=>{const t=e.payload.path;if(e.action!=="update"||t.length!==3)return;this.saveSetting(t,e.payload.value);const i=t[1],n=this.renderables.get(i);if(n){const r=this.renderer.config.topics[i],a={...br,...r};n.updatePointCloud(n.userData.pointCloud,n.userData.originalMessage,a,n.userData.receiveTime)}};startFrame(e,t,i){for(const n of this.renderables.values())n.startFrame(e,t,i)}#s=e=>{const{topic:t}=e,i=(0,w.toNanoSec)(e.receiveTime),n=this.#t.decode(e.message);if(!n)return;let r=this.renderables.get(t);if(!r){const o=this.renderer.config.topics[t],l={...br,...o};l.colorField==null&&(Oo(l,n,{supportsPackedRgbModes:!1}),this.renderer.updateConfig(m=>{const g={...o};g.colorField=l.colorField,g.colorMode=l.colorMode,g.colorMap=l.colorMap,m.topics[t]=g}));const d=kn(l),h=Uo(l),f=zo(l),p=Jn(l),u=(0,w.toNanoSec)(n.timestamp);r=new Zo(t,this.renderer,{receiveTime:i,messageTime:u,frameId:this.renderer.normalizeFrameId(n.frame_id),pose:(0,L.N2)(),settingsPath:["topics",t],settings:l,topic:t,pointCloud:n,originalMessage:e.message,material:d,pickingMaterial:h,instancePickingMaterial:f,stixelMaterial:p}),this.add(r),this.renderables.set(t,r)}let a=this.#e.get(e.topic);(!a||a.length!==n.fields.length)&&(a=n.fields.map(o=>o.name),this.#e.set(e.topic,a),this.updateSettingsTree()),r.updatePointCloud(n,e.message,r.userData.settings,i)}}const xg=4,yr=new c.yGw;class Zl extends c.SPe{#e;constructor(e,t,i=xg){super(e,t,0),this.#e=i,this.#i()}set(e,t,i,n){const r=e.length;this.#t(r);const a=this.instanceColor.array;for(let o=0;o<r;o++){const l=e[o],d=i[o]??n;yr.makeTranslation(l.x,l.y,l.z),yr.scale(t),this.setMatrixAt(o,yr),a[o*3+0]=d.r*255|0,a[o*3+1]=d.g*255|0,a[o*3+2]=d.b*255|0}this.instanceMatrix.needsUpdate=!0,this.instanceColor&&(this.instanceColor.needsUpdate=!0)}#t(e){for(;e>=this.#e;)this.#s();this.count=e,this.instanceMatrix.count=e,this.instanceColor.count=e}#s(){this.#e=this.#e+Math.trunc(this.#e/2)+16,this.#i()}#i(){const e=this.instanceMatrix.array,t=this.instanceColor?.array,i=new Float32Array(this.#e*16),n=new Uint8ClampedArray(this.#e*3);e.length>0&&i.set(e),t&&t.length>0&&n.set(t),this.instanceMatrix=new c.lb7(i,16),this.instanceColor=new c.lb7(n,3,!0),this.instanceMatrix.setUsage(c.dj0),this.instanceColor.setUsage(c.dj0)}}class wg extends Re{#e;constructor(e,t,i,n){super(e,t,i,n);const r=_a(t),a=n.sharedGeometry.getGeometry("RenderableCube",Gl);this.#e=new Zl(a,r,t.points.length),this.#e.castShadow=!0,this.#e.receiveShadow=!0,this.add(this.#e),this.update(t,i)}dispose(){this.#e.material.dispose()}update(e,t){const i=this.userData.marker;super.update(e,t);const n=this.userData.marker,r=ae(n);r!==ae(i)&&(this.#e.material.transparent=r,this.#e.material.depthWrite=!r,this.#e.material.needsUpdate=!0),this.#e.set(n.points,n.scale,n.colors,n.color)}}class Ig extends Re{#e;#t;constructor(e,t,i,n){super(e,t,i,n),this.#e=new Et,this.#e.createAttribute("position",Float32Array,3),this.#e.createAttribute("color",Uint8Array,4,!0),this.#t=new c.woe(this.#e,hh(t)),this.add(this.#t),this.update(t,i)}dispose(){this.#t.material.dispose()}update(e,t){const i=this.userData.marker;super.update(e,t);const n=this.userData.marker,r=ae(n);r!==ae(i)&&(this.#t.material.transparent=r,this.#t.material.depthWrite=!r,this.#t.material.needsUpdate=!0),this.#t.material.size=n.scale.x;const a=n.points.length;this.#e.resize(a),this.#s(n,a),this.#i(n,a)}#s(e,t){const i=this.#e.getAttribute("position"),n=i.array;for(let r=0;r<t;r++){const a=e.points[r];n[r*3+0]=a.x,n[r*3+1]=a.y,n[r*3+2]=a.z}i.needsUpdate=!0}#i(e,t){const i=this.#e.getAttribute("color"),n=i.array;this._markerColorsToLinear(e,t,(r,a)=>{n[4*a+0]=r[0]*255|0,n[4*a+1]=r[1]*255|0,n[4*a+2]=r[2]*255|0,n[4*a+3]=r[3]*255|0}),i.needsUpdate=!0}}class Dg extends Re{#e;constructor(e,t,i,n){super(e,t,i,n);const r=n.sharedGeometry.getGeometry(`RenderableSphere-${n.maxLod}`,()=>al(n.maxLod)),a=_a(t);this.#e=new Zl(r,a,t.points.length),this.#e.castShadow=!0,this.#e.receiveShadow=!0,this.add(this.#e),this.update(t,i)}dispose(){this.#e.material.dispose()}update(e,t){const i=this.userData.marker;super.update(e,t);const n=this.userData.marker,r=ae(n);r!==ae(i)&&(this.#e.material.transparent=r,this.#e.material.depthWrite=!r,this.#e.material.needsUpdate=!0),this.#e.set(n.points,n.scale,n.colors,n.color)}}class Cg extends Re{#e;constructor(e,t,i,n){super(e,t,i,n),this.#e=n.labelPool.acquire(),this.#e.setBillboard(!0),this.add(this.#e),this.update(t,i)}dispose(){this.renderer.labelPool.release(this.#e)}update(e,t){super.update(e,t);const i=this.userData.marker;this.#e.setText(i.text),this.#e.setColor(U(i.color.r),U(i.color.g),U(i.color.b)),Vs(i.color.r,i.color.g,i.color.b)<.5?this.#e.setBackgroundColor(1,1,1):this.#e.setBackgroundColor(0,0,0),this.#e.setOpacity(i.color.a),this.#e.setLineHeight(i.scale.z),this.#e.userData.pose=i.pose}}const Mg="NOT_DIVISIBLE",Eg="EMPTY",Ag="COLORS_MISMATCH",_g="INVALID_POINT",nt={r:0,g:0,b:0,a:0};class Pg extends Re{#e;constructor(e,t,i,n){super(e,t,i,n),this.#e=new c.Kj0(new Et,dh(t)),this.#e.castShadow=!0,this.#e.receiveShadow=!0,this.add(this.#e),this.update(t,i)}dispose(){this.#e.material.dispose(),this.#e.geometry.dispose()}update(e,t){const i=this.userData.marker;super.update(e,t);const n=this.userData.marker;let r=n.points.length;if(r===0){this.renderer.settings.errors.addToTopic(this.userData.topic,Eg,"TRIANGLE_LIST: points is empty"),this.#e.geometry.resize(0);return}if(r%3!==0){const f=`${n.ns.length>0?n.ns+":":""}${n.id}`;this.renderer.settings.errors.addToTopic(this.userData.topic,Mg,`TRIANGLE_LIST: points.length ${r} is not divisible by 3 for marker ${f}`),r=Math.floor(r/3)*3}if(n.colors.length!==0&&n.colors.length!==r){const f=`${n.ns.length>0?n.ns+":":""}${n.id}`;this.renderer.settings.errors.addToTopic(this.userData.topic,Ag,`TRIANGLE_LIST: colors.length ${n.colors.length} != points.length ${r} for marker ${f}`)}const a=ae(n);a!==ae(i)&&(this.#e.material.transparent=a,this.#e.material.depthWrite=!a,this.#e.material.needsUpdate=!0);const o=this.#e.geometry;o.resize(r),o.attributes.position||o.createAttribute("position",Float32Array,3),o.attributes.normal||o.createAttribute("normal",Float32Array,3),o.attributes.color||o.createAttribute("color",Uint8Array,4,!0);const l=o.attributes.position,d=o.attributes.color;let h=!1;for(let f=0;f<r;f++){const p=n.points[f];if(!Rg(p)){this.renderer.settings.errors.addToTopic(this.userData.topic,_g,`TRIANGLE_LIST: point at index ${f} is not finite`);continue}h=h||l.getX(f)!==p.x||l.getY(f)!==p.y||l.getZ(f)!==p.z,l.setXYZ(f,p.x,p.y,p.z),zt(nt,n.colors[f]??n.color),h=h||d.getX(f)!==nt.r||d.getY(f)!==nt.g||d.getZ(f)!==nt.b||d.getW(f)!==nt.a,d.setXYZW(f,nt.r,nt.g,nt.b,nt.a)}h&&(l.needsUpdate=!0,d.needsUpdate=!0,o.computeVertexNormals(),o.computeBoundingSphere())}}function Rg(s){return Number.isFinite(s.x)&&Number.isFinite(s.y)&&Number.isFinite(s.z)}const Lg={[_.ARROW]:Ti,[_.CUBE]:or,[_.SPHERE]:Ps,[_.CYLINDER]:lr,[_.LINE_STRIP]:Qn,[_.LINE_LIST]:In,[_.CUBE_LIST]:wg,[_.SPHERE_LIST]:Dg,[_.POINTS]:Ig,[_.TEXT_VIEW_FACING]:Cg,[_.MESH_RESOURCE]:Bl,[_.TRIANGLE_LIST]:Pg};class Ng{renderer;#e=new Map;constructor(e){this.renderer=e}acquire(e,t,i,n){const r=this.#e.get(e);if(r){const o=r.pop();if(o)return o.userData.settingsPath=["topics",t],o.userData.settings={visible:!0,frameLocked:i.frame_locked},o.userData.topic=t,o.name=Ge(t,i.ns,i.id),o.update(i,n),o}return new Lg[e](t,i,n,this.renderer)}release(e){const t=e.userData.marker.type,i=this.#e.get(t);i?i.push(e):this.#e.set(t,[e])}dispose(){for(const e of this.#e.values())for(const t of e)t.dispose();this.#e.clear()}}var Og="../../packages/studio-base/src/panels/ThreeDeeRender/renderables/SceneEditor.ts";const Us=R.ZP.getLogger(Og),Fg="/api/sim2real/urdf/save",Kl="foxglove.SceneEditor",Ai=["X","Y","Z"],vr=["R","P","Y"],Sr=.01,Ug={visible:!0,frameLocked:!0,instanceId:"invalid",layerId:Kl,label:"Scene Editor",shape:"box",shapeLabel:"",selectedUrdfFileName:""};class zg extends F{dispose(){this.removeChildren(),super.dispose()}removeChildren(){for(const e of this.userData.renderables.values())e.dispose();this.children.length=0,this.userData.renderables.clear()}}class kg extends Q.d{constructor(e){super("foxglove.SceneEditor",e),this.userData.overwriteDialogOpen=!1,this.userData.savedDialogOpen=!1}dispose(){super.dispose()}startFrame(e,t,i){for(const n of this.renderables.values()){const r=n.userData.settingsPath;if(n.visible=n.userData.settings.visible,!n.visible){this.renderer.settings.errors.clearPath(r);continue}for(const a of n.userData.renderables.values()){const o=e,l=n.userData.frameId;(0,Ds.S)(a,this.renderer.transformTree,t,i,l,e,o)}}}settingsNodes(){const e={},t=this.handleSettingsAction,i=[...this.renderer.transformTree.frames()].map(([a,o])=>({label:a,value:a}));for(const a of this.renderables.values()){const o=a.userData.settings,{instanceId:l}=o,d=o.shapeLabel,h=a.userData.renderables.values().next().value,f=[h.userData.pose.position.x,h.userData.pose.position.y,h.userData.pose.position.z],p=jl(h.userData.pose.orientation),u=ne(h.userData.marker.color);let m;switch(o.shape){case"box":m={frameId:{label:"Parent Frame",input:"select",value:a.userData.frameId,options:i},"pose.position":{label:"Position",input:"vec3",labels:Ai,precision:k,step:Sr,value:f},"pose.orientation":{label:"Orientation",input:"vec3",labels:vr,precision:we,value:[p.roll,p.pitch,p.yaw]},scale:{label:"Scale",input:"vec3",labels:Ai,precision:k,step:.001,min:0,value:[h.scale.x,h.scale.y,h.scale.z]},color:{label:"Color",input:"rgba",value:u}};break;case"sphere":m={frameId:{label:"Parent Frame",input:"select",value:a.userData.frameId,options:i},"pose.position":{label:"Position",input:"vec3",labels:Ai,precision:k,step:Sr,value:f},"pose.orientation":{label:"Orientation",input:"vec3",labels:vr,precision:we,value:[p.roll,p.pitch,p.yaw]},radius:{label:"Radius",input:"number",step:.001,min:0,precision:k,value:h.scale.x},color:{label:"Color",input:"rgba",value:u}};break;case"cylinder":m={frameId:{label:"Parent Frame",input:"select",value:a.userData.frameId,options:i},"pose.position":{label:"Position",input:"vec3",labels:Ai,precision:k,step:Sr,value:f},"pose.orientation":{label:"Orientation",input:"vec3",labels:vr,precision:we,value:[p.roll,p.pitch,p.yaw]},radius:{label:"Radius",input:"number",step:.001,min:0,precision:k,value:h.scale.x},length:{label:"Length",input:"number",step:.001,min:0,precision:k,value:h.scale.z},color:{label:"Color",input:"rgba",value:u}};break;default:m={};break}e[l]={label:d,actions:[{id:"remove",type:"action",label:"Remove"}],fields:m,defaultExpansionState:"collapsed"}}const r={urdfFileName:{input:"autocomplete",label:"URDF File Name",value:"",items:this.#e()},saveButton:{input:"button",label:"",value:"Save",handler:this.saveUrdfFile},savedDialog:{input:"dialog",label:"",title:"Success",message:"Saved URDF file successfully. Please refresh the page to load objects from the new URDF file.",isOpen:this.userData.savedDialogOpen,dialogActions:[{label:"Cancel",color:"primary",variant:"outlined",handler:()=>{this.userData.savedDialogOpen=!1,this.updateSettingsTree()}},{label:"Reload",color:"success",variant:"contained",handler:()=>{window.location.reload()}}]},overwriteDialog:{input:"dialog",label:"",title:"Warning",message:"There are no objects in the scene. Do you want to overwrite the URDF file and delete all objects in it?",isOpen:this.userData.overwriteDialogOpen,dialogActions:[{label:"Cancel",color:"primary",variant:"outlined",handler:()=>{this.userData.overwriteDialogOpen=!1,this.updateSettingsTree()}},{label:"Overwrite",color:"error",variant:"contained",handler:()=>{this.saveUrdfFile(),this.userData.overwriteDialogOpen=!1,this.updateSettingsTree()}}]}};return[{path:["scene_editor"],node:{label:"Scene Editor",actions:[{id:"add-box",type:"action",label:"Add Cube",icon:"Cube"},{id:"add-sphere",type:"action",label:"Add Sphere",icon:"Circle"},{id:"add-cylinder",type:"action",label:"Add Cylinder",icon:"Cylinder"}],fields:r,children:e,defaultExpansionState:"collapsed",handler:t}}]}saveUrdfFile=()=>{let e=this.userData.selectedUrdfFileName;if(!e)return;if(this.renderables.size===0&&!this.userData.overwriteDialogOpen){this.userData.overwriteDialogOpen=!0,this.updateSettingsTree();return}let t=[];for(const d of this.renderables.values()){const h=d.userData.settings,f=d.userData.renderables.values().next().value,p=f.userData.pose,u=jl(p.orientation),m=p.position,g=d.userData.frameId,y=f.userData.marker.color;let S;h.shape==="box"?S=f.scale:h.shape==="sphere"?S={radius:f.scale.x/2}:h.shape==="cylinder"&&(S={radius:f.scale.x/2,length:f.scale.z}),t.push({frameId:g,shape:h.shape,position:{x:m.x,y:m.y,z:m.z},orientation:{roll:u.roll*Si.qW,pitch:u.pitch*Si.qW,yaw:u.yaw*Si.qW},scale:S,colorRGBA:y})}const i=JSON.stringify(t,null,2),n=/[\/\?<>\\:\*\|"]/g,r=/[\x00-\x1f\x80-\x9f]/g,a=/^\.+$/,o=/^(con|prn|aux|nul|com[0-9]|lpt[0-9])(\..*)?$/i,l=/[\. ]+$/;e=e.replace(n,"").replace(r,"").replace(a,"").replace(o,"").replace(l,""),fetch(Fg,{method:"POST",headers:{"Content-Type":"application/json",filename:e},body:i}).then(d=>{if(!d.ok)throw new Error(`Failed to save URDF file: ${d.status} ${d.statusText}`);return d.json()}).then(d=>{if(d.error)throw new Error(`Failed to save URDF file: ${d.error}`);Us.info(`Saved URDF file: ${e}`),this.userData.savedDialogOpen=!0,this.updateSettingsTree()}).catch(d=>{Us.error(d)})};saveSetting(e,t){const i=e[1],n=this.renderables.get(i),r=e[2],a=n?.userData.renderables.values().next().value;if(!n||!a)return;const o=n.userData.settings.shape;if(r==="color"){debugger;a.userData.marker.color=N(a.userData.marker.color,t),a.update(a.userData.marker,a.userData.receiveTime)}if(["scale","radius","length"].includes(r)){if(o==="box"&&Array.isArray(t)){const l={x:t[0],y:t[1],z:t[2]};debugger;a.userData.marker.scale=l,a.update(a.userData.marker,a.userData.receiveTime)}else if(o==="sphere"){const l=t;a.userData.marker.scale={x:l,y:l,z:l},a.update(a.userData.marker,a.userData.receiveTime)}else if(o==="cylinder")if(r==="radius"){const l=t;a.userData.marker.scale={x:l,y:l,z:a.userData.marker.scale.z},a.update(a.userData.marker,a.userData.receiveTime)}else{const l=t;a.userData.marker.scale={x:a.userData.marker.scale.x,y:a.userData.marker.scale.y,z:l},a.update(a.userData.marker,a.userData.receiveTime)}}r.includes("pose.")?(a.userData.pose||(a.userData.pose=(0,L.N2)()),r==="pose.position"&&Array.isArray(t)?a.userData.pose.position=(0,L.EI)(t,[0,0,0]).position:r==="pose.orientation"&&Array.isArray(t)&&(a.userData.pose.orientation=(0,L.EI)([0,0,0],t).orientation)):n.userData={...n.userData,[r]:t},this.updateSettingsTree()}#e(){const e=this.renderer.sceneExtensions.get("foxglove.Urdfs");if(!e)return[];const t=[];for(const i of e.renderables.values()){const n=i.userData?.settings?.url?.split("/").pop();n&&t.push(n)}return t}handleSettingsAction=e=>{const t=e.payload.path;if(e.action==="perform-node-action"){if(e.payload.id.startsWith("add-")&&this.#s(e.payload.id),t.length===2&&e.payload.id==="remove"){const i=t[1],n=this.renderables.get(i);if(!n)return;n.userData.renderables.forEach(r=>{r.dispose()}),this.remove(n),this.renderables.delete(i),this.updateSettingsTree(),this.renderer.updateCustomLayersCount()}return}e.action!=="update"||e.payload.path.length===0||(e.payload.input&&this.handleUserInput(e,e.payload.input),this.saveSetting(t,e.payload.value),this.updateSettingsTree())};handleUserInput=(e,t)=>{e.action!=="update"||e.payload.path.length===0||t==="autocomplete"&&e.payload.path[1]==="urdfFileName"&&(this.userData.selectedUrdfFileName=e.payload.value)};#t(e){const t=Ug,i=this.renderer.config.layers[e];return{...t,...i,instanceId:e}}#s(e){const t=(0,ke.Z)(),i=this.renderer;Us.info(`Creating ${Kl} layer ${t}`);let n=this.renderables.get(t);const r=["layers",t],a=this.renderer.transformTree.frames();let o=this.renderer.fixedFrameId||"";for(const[u,m]of a)if(u==="base"||u==="map"){o=u;break}const l=o||this.renderer.fixedFrameId||"";e=e.replace("add-","");let d=1;for(let u of this.renderables.values())u.userData.settings.shape===e&&d++;n||(n=new zg(t,this.renderer,{renderables:new Map,receiveTime:0n,messageTime:0n,frameId:l,pose:(0,L.N2)(),settingsPath:r,settings:this.#t(t)}),this.add(n),this.renderables.set(t,n));let h,f={x:0,y:0,z:0};e==="box"?(f={x:0,y:0,z:0},h={geometryType:"box",size:{x:.3,y:.3,z:.3}}):e==="sphere"?(f={x:0,y:1,z:0},h={geometryType:"sphere",radius:.3}):e==="cylinder"?(f={x:1,y:1,z:0},h={geometryType:"cylinder",radius:.3,length:.3}):h={geometryType:"box",size:{x:.3,y:.3,z:.3}},((u,m,g,y)=>{const S=jg(g,m,u,i);n?(S.userData.settingsPath=n.userData.settingsPath,n.userData.renderables.set(S.name,S),n.userData.settings={...n.userData.settings,shape:e,shapeLabel:y},n.add(S)):Us.error("renderable is null")})(o,0,{origin:{xyz:f,rpy:{x:0,y:0,z:0}},geometry:h},e.charAt(0).toUpperCase()+e.slice(1)+"-"+d),this.updateSettingsTree()}}function jg(s,e,t,i){const n=`${t}-${e}-${s.geometry.geometryType}`,r=ar(s.origin.rpy),a={position:s.origin.xyz,orientation:r},o=s.material?.color??{r:.14,g:.56,b:1,a:1},l=s.geometry.geometryType;switch(l){case"box":{const d=s.geometry.size;Us.info(`Creating box ${n} at ${JSON.stringify(a)}`);const h=Tr(t,_.CUBE,a,d,o);return new or(n,h,void 0,i)}case"cylinder":{const d=s.geometry,h={x:d.radius*2,y:d.radius*2,z:d.length},f=Tr(t,_.CUBE,a,h,o);return new lr(n,f,void 0,i)}case"sphere":{const d=s.geometry,h={x:d.radius*2,y:d.radius*2,z:d.radius*2},f=Tr(t,_.CUBE,a,h,o);return new Ps(n,f,void 0,i)}default:throw new Error(`Unrecognized visual geometryType: ${l}`)}}function Tr(s,e,t,i,n){return{header:{frame_id:s,stamp:{sec:0,nsec:0}},ns:"",id:0,type:e,action:re.ADD,pose:t,scale:i,color:n,lifetime:{sec:0,nsec:0},frame_locked:!0,points:[],colors:[],text:"",mesh_resource:"",mesh_use_embedded_materials:!1}}var Gg="../../packages/studio-base/src/panels/ThreeDeeRender/Renderer.ts";const Ce=R.ZP.getLogger(Gg),Bg=10,Xl=new c.Ilk(ga.light.background?.default),Jl=new c.Ilk(ga.dark.background?.default),xr=0,wr=1,_i=["general","followTf"],Ql="NO_FRAME_SELECTED",Vg="TF_OVERFLOW",ql="CYCLE_DETECTED",ec="FOLLOW_FRAME_NOT_FOUND",tc="foxglove.Renderer",$g=new c.Ilk,sc=new c.FM8;Object.defineProperty(mn.iT.prototype,"vertexShaderKey",{get(){return"LabelMaterial-VertexShader"},enumerable:!0,configurable:!0}),Object.defineProperty(mn.iT.prototype,"fragmentShaderKey",{get(){return this.picking?"LabelMaterial-FragmentShader-picking":"LabelMaterial-FragmentShader"},enumerable:!0,configurable:!0});class Wg extends B.Z{interfaceMode;#e;gl;maxLod=me.High;debugPicking=!1;config;settings;topics;topicsByName;parameters;variables=new Map;sceneExtensions=new Map;schemaHandlers=new Map;topicHandlers=new Map;#t=new Map;#s;#i;#n;input;outlineMaterial=new c.nls({dithering:!0});instancedOutlineMaterial=new sd({dithering:!0});cameraHandler;#r;measurementTool;publishClickTool;ros=!1;#a;#o;#l;colorScheme="light";modelCache;transformTree=new L.v8;coordinateFrameList=[];currentTime=0n;fixedFrameId;followFrameId;labelPool=new mn.$A({fontFamily:ba.R.MONOSPACE});markerPool=new Ng(this);sharedGeometry=new zd;#h=new c.FM8;#c=!1;#d;#u;#f;constructor(e,t,i){if(super(),c.Tme.DEFAULT_UP=new c.Pa4(0,0,1),this.interfaceMode=i,this.#e=e,this.config=t,this.settings=new Od(Zg(this.interfaceMode)),this.settings.on("update",()=>this.emit("settingsTreeChange",this)),this.settings.setNodesForKey(tc,[]),this.updateCustomLayersCount(),this.gl=new c.CP7({canvas:e,alpha:!0,antialias:!0}),!this.gl.capabilities.isWebGL2)throw new Error("WebGL2 is not supported");this.gl.outputEncoding=c.knz,this.gl.toneMapping=c.uL9,this.gl.autoClear=!1,this.gl.info.autoReset=!1,this.gl.shadowMap.enabled=!1,this.gl.shadowMap.type=c.dwk,this.gl.sortObjects=!0,this.gl.setPixelRatio(window.devicePixelRatio);let n=e.width,r=e.height;e.parentElement&&(n=e.parentElement.clientWidth,r=e.parentElement.clientHeight,this.gl.setSize(n,r)),this.modelCache=new Td({ignoreColladaUpAxis:t.scene.ignoreColladaUpAxis??!1,meshUpAxis:t.scene.meshUpAxis??gn,edgeMaterial:this.outlineMaterial}),this.#s=new c.xsS,this.#i=new c.Ox3,this.#i.position.set(1,1,1),this.#i.castShadow=!0,this.#i.layers.enableAll(),this.#i.shadow.mapSize.width=2048,this.#i.shadow.mapSize.height=2048,this.#i.shadow.camera.near=.5,this.#i.shadow.camera.far=500,this.#i.shadow.bias=-1e-5,this.#n=new c.vmT(16777215,16777215,.5),this.#n.layers.enableAll(),this.#s.add(this.#i),this.#s.add(this.#n),this.input=new rd(e,()=>this.cameraHandler.getActiveCamera()),this.input.on("resize",d=>this.#P(d)),this.input.on("click",d=>this.#F(d)),this.#a=new Md(this.gl,this.#s),this.#o=new _d(this),this.#o.visible=!1,this.#s.add(this.#o);const a=kd(this.gl.capabilities),o=this.gl.getDrawingBufferSize(sc);Ce.debug(`Initialized ${o.width}x${o.height} renderer (${a}x MSAA)`),this.measurementTool=new sf(this),this.publishClickTool=new vp(this);const l=o.width/o.height;switch(i){case"image":this.#r=new xu(this,{canvasSize:this.input.canvasSize,setHasCalibrationTopic:d=>{d?this.#E():this.#C()}}),this.cameraHandler=this.#r,this.#r.addEventListener("hasModifiedViewChanged",()=>{this.emit("resetViewChanged",this)}),this.#g(this.cameraHandler);break;case"3d":this.cameraHandler=new Xd(this,this.#e,l),this.#g(this.cameraHandler),this.#g(new kg(this)),this.#g(new Cl.Q(this)),this.#g(new Eu(this)),this.#g(new vh(this));break}this.#g(new wh(this)),this.#g(new Ph(this,{visible:i==="3d"})),this.#g(new Vh(this)),this.#g(new ef(this)),this.#g(new Cm(this)),this.#g(new Wc(this)),this.#g(new Vu(this)),this.#g(new mf(this)),this.#g(new Ef(this)),this.#g(new kf(this)),this.#g(new qf(this)),this.#g(new fp(this)),this.#g(new lg(this)),this.#g(new Tg(this)),this.#g(this.measurementTool),this.#g(this.publishClickTool),i==="image"&&t.imageMode.calibrationTopic==null?this.#C():(this.#T(),this.#x()),this.#b(),this.setCameraState(t.cameraState),this.animationFrame()}#p=()=>{Ce.debug(`devicePixelRatio changed to ${window.devicePixelRatio}`),this.#P(this.input.canvasSize),this.#b()};#b(){this.#f=window.matchMedia(`(resolution: ${window.devicePixelRatio}dppx)`),this.#f.addEventListener("change",this.#p,{once:!0})}dispose(){Ce.warn("Disposing renderer"),this.#f?.removeEventListener("change",this.#p),this.removeAllListeners(),this.settings.removeAllListeners(),this.input.removeAllListeners();for(const e of this.sceneExtensions.values())e.dispose();this.sceneExtensions.clear(),this.sharedGeometry.dispose(),this.modelCache.dispose(),this.labelPool.dispose(),this.markerPool.dispose(),this.#a.dispose(),this.input.dispose(),this.gl.dispose()}cameraSyncError(){return this.#u}setCameraSyncError(e){this.#u=e,this.cameraHandler.updateSettingsTree()}getPixelRatio(){return this.gl.getPixelRatio()}setCurrentTime(e){this.currentTime=e}handleSeek(e){const t=this.currentTime<e;this.clear({clearTransforms:t,resetAllFramesCursor:t})}clear({clearTransforms:e,resetAllFramesCursor:t}={clearTransforms:!1,resetAllFramesCursor:!1}){e===!0&&this.#S(),t===!0&&this.#v(),this.settings.errors.clear();for(const i of this.sceneExtensions.values())i.removeAllRenderables();this.queueAnimationFrame()}#m={index:-1,lastReadMessage:void 0,cursorTimeReached:void 0};#v(){this.#m={index:-1,lastReadMessage:void 0,cursorTimeReached:void 0},this.emit("resetAllFramesCursor",this)}handleAllFramesMessages(e){if(!e||e.length===0)return!1;const t=(0,w.fromNanoSec)(this.currentTime),i=e[this.#m.index];this.#m.lastReadMessage!=null&&i!=null&&this.#m.lastReadMessage!==i&&this.#v();let n=this.#m.index,r=this.#m.cursorTimeReached,a=this.#m.lastReadMessage;n=Math.min(n,e.length-1);let o,l=!1;for(;n<e.length-1;){if(n++,o=e[n],(0,w.isLessThan)(t,o.receiveTime)){r=t,n--;break}l||(l=!0),this.addMessageEvent(o),a=o,n===e.length-1&&(r=o.receiveTime)}return l?(this.#m={index:n,cursorTimeReached:r,lastReadMessage:a},!0):!1}#g(e){if(this.sceneExtensions.has(e.extensionId))throw new Error(`Attempted to add duplicate extensionId "${e.extensionId}"`);this.sceneExtensions.set(e.extensionId,e),this.#s.add(e)}updateConfig(e){this.config=(0,X.Uy)(this.config,e),this.emit("configChange",this)}#T(){const t=this.config.scene.transforms?.enablePreloading??!0;this.#y(ce,{handler:this.#U,shouldSubscribe:()=>!0,preload:t}),this.#y(Ke,{handler:this.#z,shouldSubscribe:()=>!0,preload:t}),this.#y(sn,{handler:this.#k,shouldSubscribe:()=>!0,preload:t}),this.#y(Xr,{handler:this.#j,shouldSubscribe:()=>!0,preload:t}),this.off("resetAllFramesCursor",this.#S),t&&this.on("resetAllFramesCursor",this.#S)}#S=()=>{this.transformTree.clear()};#x(e){const t=e?Array.from(this.sceneExtensions.values()).filter(e):this.sceneExtensions.values();for(const i of t){const n=i.getSubscriptions();for(const r of n)switch(r.type){case"schema":this.#y(r.schemaNames,r.subscription);break;case"topic":this.#D(r.topicName,r.subscription);break}}}#M(){this.topicHandlers.clear(),this.schemaHandlers.clear(),this.emit("topicHandlersChanged",this),this.emit("schemaHandlersChanged",this)}#y(e,t){for(const i of e){let n=this.schemaHandlers.get(i);n||(n=[],this.schemaHandlers.set(i,n)),n.push(t)}this.emit("schemaHandlersChanged",this)}#D(e,t){let i=this.topicHandlers.get(e);i||(i=[],this.topicHandlers.set(e,i)),i.push(t),this.emit("topicHandlersChanged",this)}#C=()=>{(0,V.assert)(this.#r,"Image mode extension should be defined when calling enable Image only mode"),this.clear({clearTransforms:!0,resetAllFramesCursor:!0}),this.#M(),this.#x(e=>e===this.#r),this.settings.addNodeValidator(this.#I)};#E=()=>{this.settings.removeNodeValidator(this.#I),this.clear({clearTransforms:!0,resetAllFramesCursor:!0}),this.#M(),this.#x(),this.#T()};#I=(e,t)=>{const{path:i,node:n}=e;i[0]==="topics"&&(n.visible===!0?t.addToTopic(i[1],"IMAGE_ONLY_TOPIC","Camera calibration information is required to display 3D topics"):t.removeFromTopic(i[1],"IMAGE_ONLY_TOPIC"))};addCustomLayerAction(e){const t=e.handler,i=(0,ke.Z)(),n={type:"action",id:`${e.layerId}-${i}`,label:e.label,icon:e.icon};this.#t.set(e.layerId,{action:n,handler:t}),this.#w()}#w(){this.settings.setNodesForKey(tc,[this.#R(),this.#L()])}#R(){return{path:["topics"],node:{enableVisibilityFilter:!0,label:x.ZP.t("threeDee:topics"),defaultExpansionState:"expanded",actions:[{id:"show-all",type:"action",label:x.ZP.t("threeDee:showAll")},{id:"hide-all",type:"action",label:x.ZP.t("threeDee:hideAll")}],children:this.settings.tree().topics?.children,handler:this.#G}}}#L(){const e=Object.keys(this.config.layers).length;return{path:["layers"],node:{label:`${x.ZP.t("threeDee:customLayers")}${e>0?` (${e})`:""}`,children:this.settings.tree().layers?.children,actions:Array.from(this.#t.values()).map(i=>i.action),handler:this.#B}}}setPickingEnabled(e){this.#c=e,e||this.setSelectedRenderable(void 0)}setColorScheme(e,t){this.colorScheme=e;const i=t?Ji($g,t):void 0;for(const n of this.sceneExtensions.values())n.setColorScheme(e,i);e==="dark"?(this.gl.setClearColor(i??Jl),this.outlineMaterial.color.set(Xi),this.outlineMaterial.needsUpdate=!0,this.instancedOutlineMaterial.color.set(Xi),this.instancedOutlineMaterial.needsUpdate=!0,this.#o.setColor(Jl,.8)):(this.gl.setClearColor(i??Xl),this.outlineMaterial.color.set(Ki),this.outlineMaterial.needsUpdate=!0,this.instancedOutlineMaterial.color.set(Ki),this.instancedOutlineMaterial.needsUpdate=!0,this.#o.setColor(Xl,.8))}setTopics(e){if(this.topics!==e){this.topics=e,this.topicsByName=e?new Map(e.map(t=>[t.name,t])):void 0,this.emit("topicsChanged",this);for(const t of this.sceneExtensions.values())this.settings.setNodesForKey(t.extensionId,t.settingsNodes())}}setParameters(e){const t=this.parameters!==e;this.parameters=e,t&&this.emit("parametersChange",e,this)}updateCustomLayersCount(){const e=Object.keys(this.config.layers).length,t=`Custom Layers${e>0?` (${e})`:""}`;this.settings.setLabel(["layers"],t)}setCameraState(e){this.cameraHandler.setCameraState(e)}getCameraState(){return this.cameraHandler.getCameraState()}canResetView(){return this.#r?.hasModifiedView()??!1}resetView(){this.#r?.resetViewModifications(),this.queueAnimationFrame()}getCurrentImage(){return this.#r?.getLatestImage()}setSelectedRenderable(e){if(this.#l===e)return;const t=this.#l;t&&(Yg(t.renderable),Ce.debug(`Deselected ${t.renderable.id} (${t.renderable.name})`)),this.#l=e,e&&(Hg(e.renderable),Ce.debug(`Selected ${e.renderable.id} (${e.renderable.name}) (instance=${e.instanceIndex})`)),this.emit("selectedRenderable",e,this),this.debugPicking||this.animationFrame()}addMessageEvent(e){const{message:t}=e,i=t,n=t,r=t,a=t;if(i.header){const o=i.header.frame_id??"";this.addCoordinateFrame(o)}else if(Array.isArray(n.markers)){for(const o of n.markers)if(o){const l=o.header?.frame_id??"";this.addCoordinateFrame(l)}}else if(Array.isArray(r.entities)){for(const o of r.entities)if(o){const l=o.frame_id??"";this.addCoordinateFrame(l)}}else typeof a.frame_id=="string"&&this.addCoordinateFrame(a.frame_id);ic(e,this.topicHandlers.get(e.topic)),ic(e,this.schemaHandlers.get(e.schemaName))}normalizeFrameId(e){return!this.ros||!e.startsWith("/")?e:e.slice(1)}addCoordinateFrame(e){const t=this.normalizeFrameId(e);this.transformTree.hasFrame(t)||(this.transformTree.getOrCreateFrame(t),this.coordinateFrameList=this.transformTree.frameList(),this.emit("transformTreeUpdated",this))}#A(e){const t=e.parent_frame_id,i=e.child_frame_id,n=(0,w.toNanoSec)(e.timestamp),r=e.translation,a=e.rotation;this.addTransform(t,i,n,r,a)}#_(e){const t=this.normalizeFrameId(e.header.frame_id),i=this.normalizeFrameId(e.child_frame_id),n=(0,w.toNanoSec)(e.header.stamp),r=e.transform.translation,a=e.transform.rotation;this.addTransform(t,i,n,r,a)}addTransform(e,t,i,n,r,a){const o=n,l=r,d=new L.wx([o.x,o.y,o.z],[l.x,l.y,l.z,l.w]),h=this.transformTree.addTransform(t,e,i,d);h===L.ug.UPDATED&&(this.coordinateFrameList=this.transformTree.frameList(),this.emit("transformTreeUpdated",this)),h===L.ug.CYCLE_DETECTED&&(this.settings.errors.add(["transforms",`frame:${t}`],ql,`Transform tree cycle detected: Received transform with parent "${e}" and child "${t}", but "${t}" is already an ancestor of "${e}". Transform message dropped.`),a&&this.settings.errors.add(a,ql,`Attempted to add cyclical transform: Frame "${e}" cannot be the parent of frame "${t}". Transform message dropped.`));const f=this.transformTree.getOrCreateFrame(t);f.transformsSize()===f.maxCapacity&&this.settings.errors.add(["transforms",`frame:${t}`],Vg,`[Warning] Transform history is at capacity (${f.maxCapacity}), old TFs will be dropped`)}removeTransform(e,t,i){this.transformTree.removeTransform(e,t,i),this.coordinateFrameList=this.transformTree.frameList(),this.emit("transformTreeUpdated",this)}animationFrame=()=>{this.#d=void 0,this.#N(this.currentTime)};queueAnimationFrame(){this.#d==null&&(this.#d=requestAnimationFrame(this.animationFrame))}setFollowFrameId(e){this.followFrameId!==e&&Ce.debug(`Setting followFrameId to ${e}`),this.followFrameId=e}#N=e=>{this.currentTime=e,this.#$(),this.#O(),this.#W(),this.gl.clear(),this.emit("startFrame",e,this);const t=this.cameraHandler.getActiveCamera();t.layers.set(xr),this.#o.visible=this.#l!=null;const i=this.followFrameId&&this.transformTree.frame(this.followFrameId)?this.followFrameId:L.W$.FALLBACK_FRAME_ID,n=this.fixedFrameId??L.W$.FALLBACK_FRAME_ID;for(const r of this.sceneExtensions.values())r.startFrame(e,i,n);this.gl.render(this.#s,t),this.#l&&(this.gl.clearDepth(),t.layers.set(wr),this.#o.visible=!1,this.gl.render(this.#s,t)),this.emit("endFrame",e,this),this.gl.info.reset()};#O(){const e=this.followFrameId!=null?this.transformTree.frame(this.followFrameId):void 0;if(e==null){this.fixedFrameId=void 0;return}const i=e.root().id;this.fixedFrameId!==i&&(this.fixedFrameId==null?Ce.debug(`Setting fixed frame to ${i}`):Ce.debug(`Changing fixed frame from "${this.fixedFrameId}" to "${i}"`),this.fixedFrameId=i)}#P=e=>{this.gl.setPixelRatio(window.devicePixelRatio),this.gl.setSize(e.width,e.height),this.cameraHandler.handleResize(e.width,e.height,window.devicePixelRatio);const t=this.gl.getDrawingBufferSize(sc);Ce.debug(`Resized renderer to ${t.width}x${t.height}`),this.animationFrame()};#F=e=>{if(!this.#c){this.setSelectedRenderable(void 0);return}if(this.measurementTool.state!=="idle"||this.publishClickTool.state!=="idle")return;this.setSelectedRenderable(void 0);const t=this.cameraHandler.getActiveCamera(),i=[];let n;for(;(n=this.#V(e))&&i.length<Bg;)i.push(n),n.renderable.visible=!1,this.gl.render(this.#s,t);for(const r of i)r.renderable.visible=!0;this.debugPicking||this.animationFrame(),Ce.debug(`Clicked ${i.length} renderable(s)`),this.emit("renderablesClicked",i,e,this)};#U=({message:e})=>{const t=da(e);this.#A(t)};#z=({message:e})=>{const t=Fc(e);for(const i of t.transforms)this.#A(i)};#k=({message:e})=>{const t=Oc(e);for(const i of t.transforms)this.#_(i)};#j=({message:e})=>{const t=ca(e);this.#_(t)};#G=e=>{const t=e.payload.path;if(e.action!=="perform-node-action"||t.length!==1||t[0]!=="topics")return;Ce.debug(`handleTopicsAction(${e.payload.id})`);const i=n=>{for(const r of this.sceneExtensions.values())for(const a of r.settingsNodes())a.path[0]==="topics"&&r.handleSettingsAction({action:"update",payload:{path:[...a.path,"visible"],input:"boolean",value:n}})};e.payload.id==="show-all"?i(!0):e.payload.id==="hide-all"&&i(!1)};#B=e=>{const t=e.payload.path;if(e.action!=="perform-node-action"||t.length!==1||t[0]!=="layers")return;Ce.debug(`handleCustomLayersAction(${e.payload.id})`);const i=e.payload.id,n=i.slice(0,-37),r=i.slice(-36),a=this.#t.get(n);if(!a)throw new Error(`No custom layer action found for "${n}"`);const{label:o,icon:l}=a.action;this.addCustomLayerAction({layerId:n,label:o,icon:l,handler:a.handler}),a.handler(r),this.updateCustomLayersCount()};#V(e){const t=this.#a.pick(e.x,e.y,this.cameraHandler.getActiveCamera(),{debug:this.debugPicking,disableSetViewOffset:this.interfaceMode==="image"});if(t===-1)return;const i=this.#s.getObjectById(t);let n,r=i;for(;r;)r.pickable===!0&&(n=r),r=r.parent??void 0;if(!n){Ce.warn(`No Renderable found for objectId ${t} (name="${i?.name}" uuid=${i?.uuid})`);return}let a;return n.pickableInstances&&(a=this.#a.pickInstance(e.x,e.y,this.cameraHandler.getActiveCamera(),n,{debug:this.debugPicking,disableSetViewOffset:this.interfaceMode==="image"}),a=a===-1?void 0:a),{renderable:n,instanceIndex:a}}#$(){if(this.followFrameId==null){this.settings.errors.add(_i,Ql,x.ZP.t("threeDee:noCoordinateFramesFound"));return}if(this.settings.errors.remove(_i,Ql),!this.transformTree.frame(this.followFrameId)){this.settings.errors.add(_i,ec,x.ZP.t("threeDee:frameNotFound",{frameId:this.followFrameId}));return}this.settings.errors.remove(_i,ec)}#W(){const e=this.input.canvasSize;this.#h.equals(e)||(this.#h.copy(e),this.#s.traverse(t=>{if(t.material){const n=t.material;n.uniforms?.resolution&&(n.uniforms.resolution.value.copy(e),n.uniformsNeedUpdate=!0)}}))}}function ic(s,e){if(e)for(const t of e)t.handler(s)}function Hg(s){s.layers.set(wr),s.traverse(e=>{e.layers.set(wr)})}function Yg(s){s.layers.set(xr),s.traverse(e=>{e.layers.set(xr)})}function Zg(s){const e=[];return e.push(s==="image"?"imageMode":"general","scene"),s==="image"&&e.push("imageAnnotations"),s==="3d"&&e.push("cameraState"),e.push("transforms","topics","layers"),s==="3d"&&e.push("publish"),Object.fromEntries(e.map(t=>[t,{}]))}const nc=(0,T.createContext)(void 0);function rc(){return(0,T.useContext)(nc)??void 0}function qt(s,e,t){const i=rc(),n=t??i;(0,T.useEffect)(()=>(n?.addListener(s,e),()=>void n?.removeListener(s,e)),[e,s,n])}var Kg=b(72994),Xg=b(85108),Jg=b(47746),Pi=b(87037),ac=b(3925),Ri=b(80078),Ir=b(83993),Dr=b(82056),Qg=b(86232),qg=b(72283),e0=b(20379),t0=b(56770),s0=b(68588),i0=b(10047),n0=b(8740),r0=b(79562),a0=b(78324),Cr=b(15328);function o0(s){return(0,v.jsx)(Cr.Z,{...s,children:(0,v.jsxs)("g",{children:[(0,v.jsx)("circle",{cx:"12.03",cy:"18.5",r:"2"}),(0,v.jsx)("path",{d:"M13.28,13.15V5H17L12,0,7.08,5h3.7v8.2a5.5,5.5,0,1,0,2.5,0ZM12,22a3.5,3.5,0,1,1,3.5-3.5A3.5,3.5,0,0,1,12,22Z"})]})})}function l0(s){return(0,v.jsx)(Cr.Z,{...s,children:(0,v.jsxs)("g",{children:[(0,v.jsx)("circle",{cx:"12",cy:"12",r:"2"}),(0,v.jsx)("path",{d:"M12,17.5A5.5,5.5,0,1,1,17.5,12,5.51,5.51,0,0,1,12,17.5Zm0-9A3.5,3.5,0,1,0,15.5,12,3.5,3.5,0,0,0,12,8.5Z"})]})})}function c0(s){return(0,v.jsx)(Cr.Z,{...s,children:(0,v.jsxs)("g",{children:[(0,v.jsx)("path",{d:"M.23,8.71l7.85,7.41L12,13.29l4,2.83,7.85-7.41S20.8,4,12,4,.23,8.71.23,8.71Z",opacity:"0.2"}),(0,v.jsx)("circle",{cx:"12.03",cy:"18.5",r:"2"}),(0,v.jsx)("path",{d:"M13.28,13.15V5H17L12,0,7.08,5h3.7v8.2a5.5,5.5,0,1,0,2.5,0ZM12,22a3.5,3.5,0,1,1,3.5-3.5A3.5,3.5,0,0,1,12,22Z"}),(0,v.jsx)("path",{d:"M16,16.12,14.6,14.67l1.46-1.37,1.37,1.45Zm2.18-2.06-1.37-1.45,1.45-1.37,1.37,1.45ZM20.34,12,19,10.55l1.45-1.37,1.38,1.45ZM22.52,10,21.15,8.49l1.31-1.24,1.37,1.46Z"}),(0,v.jsx)("path",{d:"M8.08,16.12,6.63,14.75,8,13.3l1.46,1.37ZM5.9,14.06,4.45,12.69l1.37-1.45,1.45,1.37ZM3.72,12,2.27,10.63,3.64,9.18l1.45,1.37ZM1.54,10,.23,8.71,1.6,7.25,2.91,8.49Z"})]})})}var d0=b(84877);function h0(s){const[e,t]=(0,T.useState)(!1),i=(0,T.useCallback)(n=>{s.current&&(n.type==="mouseenter"?t(!0):t(!1))},[s]);return(0,T.useEffect)(()=>{const n=s.current;if(!n)return;const r=n.closest(`.${d0.DY}`);return r?.addEventListener("mouseenter",i),r?.addEventListener("mouseleave",i),()=>{r?.removeEventListener("mouseenter",i),r?.removeEventListener("mouseleave",i)}},[s,i]),e}var u0=b(28904),f0=b(55433),p0=b(24957),oc=b(68434),Mr=b(89820),lc=b(30650),Er=b(93812),m0=b(84803),g0=b(11701);function Ar(s){return typeof s=="object"&&s&&"toJSON"in s?s.toJSON():s}function b0({interactionData:s,selectedObject:e,timezone:t}){const i=(0,g0.lk)(),n=s?.topic??"",r=Ar(e),a=(0,Z.omit)(r,"interactionData");return n.length===0?(0,v.jsx)(Er.Z,{paddingY:1,children:(0,v.jsx)(lc.ZP,{data:e,shouldExpandNode:(o,l,d)=>d<2,invertTheme:!1,postprocessValue:Ar,theme:{...i,tree:{margin:0}},hideRoot:!0})}):(0,v.jsx)(Er.Z,{paddingY:1,children:(0,v.jsx)(lc.ZP,{data:a,shouldExpandNode:()=>!1,invertTheme:!1,theme:{...i,tree:{margin:0,whiteSpace:"pre-line"}},hideRoot:!0,getItemString:(o,l,d,h,f)=>(0,m0.D)(o,l,d,h,f,t),postprocessValue:Ar,labelRenderer:(o,l,d,h)=>{const f=(0,Z.first)(o);return(0,v.jsx)("span",{style:{padding:"0 4px 0 0"},children:f})},valueRenderer:o=>(0,v.jsx)("span",{children:o})})})}const cc=b0;var y0=b(69526),v0=b(35109),S0=b(2784);function T0({addPanel:s,topic:e}){const t=S0.useCallback(()=>{s({position:"sibling",type:"RawMessages",updateIfExists:!0,getState:i=>({...i,topicPath:e})})},[s,e]);return(0,v.jsx)(v0.Z,{onClick:t,title:"Open in Raw Message panel",children:(0,v.jsxs)(Er.Z,{direction:"row",alignItems:"center",justifyContent:"space-between",padding:1,children:[(0,v.jsx)(oc.Z,{variant:"body2",children:e}),(0,v.jsx)(y0.Z,{fontSize:"small",color:"primary"})]})})}var x0=b(2784);const w0="Selected object",I0=x0.memo(function({addPanel:e,selectedObject:t,interactionsTabType:i,setInteractionsTabType:n,timezone:r}){const a=t?.object.interactionData,o=a?.originalMessage,l=a?.instanceDetails;return(0,v.jsx)(Mr.ZP,{tooltip:"Inspect objects",icon:(0,v.jsx)(p0.BaF,{}),selectedTab:i,onSelectTab:d=>n(d),children:(0,v.jsx)(Mr.KV,{name:w0,children:(0,v.jsx)(Mr.CW,{children:o?(0,v.jsxs)(v.Fragment,{children:[a.topic&&(0,v.jsx)(T0,{addPanel:e,topic:a.topic}),l?(0,v.jsx)(cc,{selectedObject:l,timezone:r}):(0,v.jsx)(v.Fragment,{}),(0,v.jsx)(cc,{selectedObject:o,interactionData:a,timezone:r})]}):(0,v.jsx)(oc.Z,{variant:"body2",color:"text.disabled",gutterBottom:!0,children:"Click an object in the 3D view to select it."})})})})});function D0(s){return(0,v.jsx)(I0,{...s})}const C0=(s,e)=>{if(s!=null)return s.metadataByIndex?.[e]},M0=s=>s?.instanceIndex!=null&&s.object.metadataByIndex!=null&&C0(s.object,s.instanceIndex)!=null||s?.object;function E0({interactiveObject:s,selectObject:e}){const t=M0(s),i=(0,T.useCallback)(()=>e(s),[s,e]);return(0,v.jsx)(Ri.Z,{"data-test":"InteractionContextMenuItem",onClick:i,children:t.interactionData?.topic})}function A0({clickedObjects:s=[],clickedPosition:e={clientX:0,clientY:0},onClose:t,selectObject:i}){return(0,v.jsx)(ac.Z,{open:!0,onClose:t,anchorReference:"anchorPosition",anchorPosition:{top:e.clientY,left:e.clientX},MenuListProps:{dense:!0},children:s.map((n,r)=>(0,v.jsx)(E0,{interactiveObject:n,selectObject:i},r))})}let Ue,_r,Pr,Rr,Lr,Nr=0,Or=0,Fr=0,Ur=0;function _0(s){Nr=Math.max(Nr,s.gl.info.render.calls),Or=Math.max(Or,s.gl.info.render.triangles),Fr=Math.max(Fr,s.gl.info.memory.textures),Ur=Math.max(Ur,s.gl.info.memory.geometries),_r?.update(s.gl.info.render.calls,Nr),Pr?.update(s.gl.info.render.triangles,Or),Rr?.update(s.gl.info.memory.textures,Fr),Lr?.update(s.gl.info.memory.geometries,Ur),Ue?.update()}function P0(){const[s,e]=(0,T.useState)(null);return qt("endFrame",(t,i)=>_0(i)),(0,T.useEffect)(()=>{if(s)return Ue=new R0,Ue.dom.style.position="relative",Ue.dom.style.zIndex="auto",_r=new es("draws","red","black"),Pr=new es("tris","cyan","black"),Rr=new es("textures","yellow","black"),Lr=new es("geometries","green","black"),Ue.addPanel(_r),Ue.addPanel(Pr),Ue.addPanel(Rr),Ue.addPanel(Lr),s.appendChild(Ue.dom),Ue.showPanel(0),()=>{if(Ue)try{s.removeChild(Ue.dom)}catch{}}},[s]),(0,v.jsx)("div",{ref:e})}class R0{#e=0;#t;dom;#s;#i;#n;#r;constructor(){this.#t=document.createElement("div"),this.#t.style.cssText="position:fixed;top:0;left:0;cursor:pointer;opacity:0.9;z-index:10000",this.#t.addEventListener("click",e=>{e.preventDefault(),this.showPanel(++this.#e%this.#t.children.length)},!1),this.dom=this.#t,this.#s=performance.now(),this.#i=this.#s,this.#n=this.addPanel(new es("MS","#9480ed","#1e1a2f")),this.#r=this.addPanel(new es("MB","#f08","#201")),this.showPanel(0)}addPanel(e){return this.#t.appendChild(e.dom),e}showPanel(e){for(let t=0;t<this.#t.children.length;t++){const i=this.#t.children[t];i.style.display=t===e?"block":"none"}this.#e=e}begin=()=>{this.#s=performance.now()};end=()=>{const e=performance.now();if(this.#n.update(e-this.#s,1e3/30),e>=this.#i+1e3){this.#i=e;const t=performance.memory;this.#r.update(t.usedJSHeapSize/1048576,t.jsHeapSizeLimit/1048576)}return e};update=()=>{this.#s=this.end()}}class es{dom;#e;#t=1/0;#s=0;#i;#n;#r;constructor(e,t,i){this.#i=e,this.#n=t,this.#r=i;const n=Math.round(window.devicePixelRatio),r=80*n,a=48*n,o=3*n,l=2*n,d=3*n,h=15*n,f=74*n,p=30*n,u=document.createElement("canvas");u.width=r,u.height=a,u.style.cssText="width:80px;height:48px";const m=u.getContext("2d");m.font=`bold ${9*n}px Helvetica,Arial,sans-serif`,m.textBaseline="top",m.fillStyle=i,m.fillRect(0,0,r,a),m.fillStyle=t,m.fillText(e,o,l),m.fillRect(d,h,f,p),m.fillStyle=i,m.globalAlpha=.9,m.fillRect(d,h,f,p),this.dom=u,this.#e=m}update(e,t){const i=Math.round(window.devicePixelRatio),n=80*i,r=3*i,a=2*i,o=3*i,l=15*i,d=74*i,h=30*i;this.#t=Math.min(this.#t,e),this.#s=Math.max(this.#s,e),this.#e.fillStyle=this.#r,this.#e.globalAlpha=1,this.#e.fillRect(0,0,n,l),this.#e.fillStyle=this.#n,this.#e.fillText(`${Math.round(e)} ${this.#i} (${Math.round(this.#t)}-${Math.round(this.#s)})`,r,a),this.#e.drawImage(this.dom,o+i,l,d-i,h,o,l,d-i,h),this.#e.fillRect(o+d-i,l,i,h),this.#e.fillStyle=this.#r,this.#e.globalAlpha=.9,this.#e.fillRect(o+d-i,l,i,Math.round((1-e/t)*h))}}var L0=b(46782),N0=b.n(L0);const dc=(()=>{const s=o,e=h;let t;var i=[],n=null,r=null;let a=null;function o(p){t=p.captureStream(30);let u=["video/webm;codecs=avc1","video/webm;codecs=vp9","video/webm;codecs=vp8","video/webm"];for(let g in u)if(MediaRecorder.isTypeSupported(u[g])){n=u[g];break}console.log("Selected MediaRecorder type:",n),n==null&&console.log("No supported type found for MediaRecorder");let m={mimeType:n,videoBitsPerSecond:25e6};i=[];try{r=new MediaRecorder(t,m)}catch(g){console.error("Exception while creating MediaRecorder:",g),alert("MediaRecorder is not supported by this browser.");return}r.onstop=d,r.ondataavailable=l,r.start()}function l(p){p.data&&p.data.size>0&&i.push(p.data)}function d(p){a=new Blob(i,{type:n});let u=Intl.DateTimeFormat("de-DE",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit"});f("recording_"+u.format(new Date).replace(", ","_").replaceAll(":",".")+".webm")}function h(){r.stop()}function f(p){return new Promise((u,m)=>{a||m("No blob created"),N0()(a,p),u()})}return{start:s,stop:e}})();var O0="../../packages/studio-base/src/panels/ThreeDeeRender/RendererOverlay.tsx";const F0=R.ZP.getLogger(O0),Li={pose:(0,v.jsx)(o0,{fontSize:"inherit"}),point:(0,v.jsx)(l0,{fontSize:"inherit"}),pose_estimate:(0,v.jsx)(c0,{fontSize:"inherit"})},U0=(0,r0.F4)`
60%, 100% {
  opacity: 0;
}
0% {
  opacity: 0;
}
40% {
  opacity: 1;
}
`,z0=(0,n0.ZL)()(s=>({iconButton:{position:"relative",fontSize:"1rem !important",pointerEvents:"auto",aspectRatio:"1","& svg:not(.MuiSvgIcon-root)":{fontSize:"1rem !important"}},rulerIcon:{transform:"rotate(45deg)"},recordButton:{position:"relative",fontSize:"1rem !important",pointerEvents:"auto",aspectRatio:"1","& svg:not(.MuiSvgIcon-root)":{fontSize:"1rem !important","&.recording":{animation:`${U0} 1s ease-in-out infinite`}}},threeDeeButton:{fontFamily:ba.R.MONOSPACE,fontFeatureSettings:s.typography.caption.fontFeatureSettings,fontSize:s.typography.caption.fontSize,fontWeight:s.typography.fontWeightBold,lineHeight:"1em"},resetViewButton:{position:"absolute",bottom:0,right:0,marginBottom:s.spacing(1),marginRight:s.spacing(1)}}));function k0(s){const e=Math.floor(s/1e3),t=Math.floor(e/60);return`${Math.floor(t/60).toString().padStart(2,"0")}:${(t%60).toString().padStart(2,"0")}:${(e%60).toString().padStart(2,"0")}`}function j0(s){const e=(0,Ae.z)(),{enqueueSnackbar:t}=(0,t0.Ds)(),{t:i}=(0,s0.$G)("threeDee"),{classes:n}=z0(),[r,a]=(0,T.useState)({clientX:0,clientY:0}),[o,l]=(0,T.useState)([]),[d,h]=(0,T.useState)(void 0),[f,p]=(0,T.useState)(void 0),u=rc(),[m,g]=(0,T.useState)(!1),[y,S]=(0,T.useState)(0);(0,T.useEffect)(()=>{u&&u.setPickingEnabled(f!=null)},[f,u]),qt("renderablesClicked",(q,vt)=>{const ge=s.canvas.getBoundingClientRect();a({clientX:ge.left+vt.x,clientY:ge.top+vt.y}),l(q),h(q.length===1?q[0]:void 0)});const[D,A]=(0,T.useState)(u?.canResetView()??!1);qt("resetViewChanged",(0,T.useCallback)(()=>{A(u?.canResetView()??!1)},[u]));const M=(0,T.useCallback)(()=>{u?.resetView()},[u]),I=(0,T.useCallback)(()=>{s.canvas&&(dc.start(s.canvas),g(!0),window._canvasRecordingStarted=Date.now())},[s.canvas]);(0,T.useEffect)(()=>{const q=setInterval(()=>{S(Date.now()-window._canvasRecordingStarted)},1e3);return()=>clearInterval(q)},[]);const P=(0,T.useCallback)(()=>{dc.stop(),g(!1)},[]),O=s.enableStats?(0,v.jsx)("div",{id:"stats",style:{position:"absolute",top:"10px",left:"10px"},children:(0,v.jsx)(P0,{})}):void 0,z=(0,T.useMemo)(()=>o.map(q=>({object:{pose:q.renderable.pose,scale:q.renderable.scale,color:void 0,interactionData:{topic:q.renderable.name,highlighted:void 0,renderable:q.renderable}},instanceIndex:q.instanceIndex})),[o]),Y=(0,T.useMemo)(()=>d?{object:{pose:d.renderable.pose,interactionData:{topic:d.renderable.topic,highlighted:!0,originalMessage:d.renderable.details(),instanceDetails:d.instanceIndex!=null?d.renderable.instanceDetails(d.instanceIndex):void 0}},instanceIndex:d.instanceIndex}:void 0,[d]);(0,T.useEffect)(()=>{u?.setSelectedRenderable(d)},[u,d]);const oe=(0,T.useRef)(null),[rt,Qe]=(0,T.useState)(!1),yt=Li[s.publishClickType],$e=(0,T.useCallback)(()=>{Qe(!0)},[]),ks=(0,i0.Z)($e),Ni=(0,Jg.Z)(),We=s.interfaceMode==="3d"&&s.canPublish&&u?.fixedFrameId!=null&&(0,v.jsxs)(v.Fragment,{children:[(0,v.jsxs)(Pi.Z,{...ks,color:s.publishActive?"info":"inherit",title:s.publishActive?"Click to cancel":"Click to publish",ref:oe,onClick:s.onClickPublish,"data-testid":"publish-button",style:{fontSize:"1rem",pointerEvents:"auto"},children:[yt,(0,v.jsx)("div",{style:{borderBottom:"6px solid currentColor",borderRight:"6px solid transparent",bottom:0,left:0,height:0,width:0,margin:Ni.spacing(.25),position:"absolute"}})]}),(0,v.jsxs)(ac.Z,{id:"publish-menu",anchorEl:oe.current,anchorOrigin:{vertical:"top",horizontal:"left"},transformOrigin:{vertical:"top",horizontal:"right"},open:rt,onClose:()=>Qe(!1),MenuListProps:{dense:!0},children:[(0,v.jsxs)(Ri.Z,{selected:s.publishClickType==="pose_estimate",onClick:()=>{s.onChangePublishClickType("pose_estimate"),Qe(!1)},children:[(0,v.jsx)(Ir.Z,{children:Li.pose_estimate}),(0,v.jsx)(Dr.Z,{disableTypography:!0,children:"Publish pose estimate"})]}),(0,v.jsxs)(Ri.Z,{selected:s.publishClickType==="pose",onClick:()=>{s.onChangePublishClickType("pose"),Qe(!1)},children:[(0,v.jsx)(Ir.Z,{children:Li.pose}),(0,v.jsx)(Dr.Z,{disableTypography:!0,children:"Publish pose"})]}),(0,v.jsxs)(Ri.Z,{selected:s.publishClickType==="point",onClick:()=>{s.onChangePublishClickType("point"),Qe(!1)},children:[(0,v.jsx)(Ir.Z,{children:Li.point}),(0,v.jsx)(Dr.Z,{disableTypography:!0,children:"Publish point"})]})]})]}),Oi=D&&(0,v.jsx)(Qg.Z,{className:n.resetViewButton,variant:"contained",color:"secondary",onClick:M,"data-testid":"reset-view",children:i("resetView")}),{onDownloadImage:js}=s,ts=(0,T.useCallback)(async()=>{const q=u?.getCurrentImage();if(!q)return;const{topic:vt,image:ge,rotation:Pt,flipHorizontal:zi,flipVertical:ss,minValue:ki,maxValue:zr}=q,Rt="header"in ge?ge.header.stamp:ge.timestamp;let ze;try{if("format"in ge)ze=await lo(ge);else{const ns=new ImageData(ge.width,ge.height);Hh(ge,{minValue:ki,maxValue:zr},ns.data),ze=await createImageBitmap(ns)}const St=Pt===90||Pt===270?ze.height:ze.width,Tt=Pt===90||Pt===270?ze.width:ze.height,Lt=document.createElement("canvas");Lt.width=St,Lt.height=Tt;const te=Lt.getContext("2d");if(!te)throw new Error("Unable to create rendering context for image download");te.translate(St/2,Tt/2),te.scale(zi?-1:1,ss?-1:1),te.rotate(Pt/180*Math.PI),te.translate(-ze.width/2,-ze.height/2),te.drawImage(ze,0,0);const Nt=await new Promise((ns,kr)=>{Lt.toBlob(ji=>{ji?ns(ji):kr(`Failed to create an image from ${St}x${Tt} canvas`)},"image/png")}),is=`${vt.replace(/^\/+/,"")}-${Rt.sec}-${Rt.nsec}`;e.logEvent(u0.q.IMAGE_DOWNLOAD),js?js(Nt,is):(0,f0.G)([{blob:Nt,fileName:is}])}catch(St){F0.error(St),t(St.toString(),{variant:"error"})}},[u,js,t,e]),Fi=(0,T.useCallback)(()=>[{type:"item",label:"Download image",onclick:ts,disabled:u?.getCurrentImage()==null}],[ts,u]),_t=(0,T.useRef)(null),Ui=h0(_t);return(0,v.jsxs)(v.Fragment,{children:[s.interfaceMode==="image"&&(0,v.jsx)(a0.i,{getItems:Fi}),(0,v.jsxs)("div",{ref:_t,style:{position:"absolute",top:"10px",right:"10px",display:"flex",flexDirection:"column",alignItems:"flex-end",gap:10,pointerEvents:"none"},children:[(s.interfaceMode==="3d"||Ui)&&(0,v.jsx)(D0,{addPanel:s.addPanel,selectedObject:Y,interactionsTabType:f,setInteractionsTabType:p,timezone:s.timezone}),s.interfaceMode==="3d"&&(0,v.jsxs)(qg.Z,{square:!1,elevation:4,style:{display:"flex",flexDirection:"column"},children:[(0,v.jsx)(Pi.Z,{className:n.iconButton,color:s.perspective?"info":"inherit",title:s.perspective?"Switch to 2D camera":"Switch to 3D camera",onClick:s.onTogglePerspective,children:(0,v.jsx)("span",{className:n.threeDeeButton,children:"3D"})}),(0,v.jsx)(Pi.Z,{"data-testid":"measure-button",className:n.iconButton,color:s.measureActive?"info":"inherit",title:s.measureActive?"Cancel measuring":"Measure distance",onClick:s.onClickMeasure,children:(0,v.jsx)(Kg.ZHY,{className:n.rulerIcon})}),(0,v.jsx)(e0.Z,{arrow:!0,title:m?"Stop recording"+(" ("+k0(y)+")"):"Start recording",children:(0,v.jsx)(Pi.Z,{style:{color:"#F00"},className:n.recordButton,onClick:m?P:I,children:(0,v.jsx)(Xg.t22,{style:{color:m?"#F00":"#747474"},className:m?"recording":""})})}),We]})]}),z.length>1&&!Y&&(0,v.jsx)(A0,{onClose:()=>l([]),clickedPosition:r,clickedObjects:z,selectObject:q=>{if(q){const vt=q.object.interactionData.renderable,ge=q.instanceIndex;l([]),h({renderable:vt,instanceIndex:ge})}}}),O,Oi]})}var hc=b(13900);const G0=new Map(["geometry_msgs/Point","geometry_msgs/PointStamped","geometry_msgs/Pose","geometry_msgs/PoseStamped","geometry_msgs/PoseWithCovariance","geometry_msgs/PoseWithCovarianceStamped","geometry_msgs/Quaternion","std_msgs/Header"].map(s=>[s,hc.ros1[s]])),B0=new Map(["geometry_msgs/Point","geometry_msgs/PointStamped","geometry_msgs/Pose","geometry_msgs/PoseStamped","geometry_msgs/PoseWithCovariance","geometry_msgs/PoseWithCovarianceStamped","geometry_msgs/Quaternion","std_msgs/Header"].map(s=>[s,hc.ros2galactic[s]]));function V0(s,e){return{header:{stamp:(0,w.fromDate)(new Date),frame_id:e},point:{x:s.x,y:s.y,z:0}}}function $0(s,e){return{header:{stamp:(0,w.fromDate)(new Date),frame_id:e},pose:s}}function W0(s,e,t,i,n){return{header:{stamp:(0,w.fromDate)(new Date),frame_id:e},pose:{covariance:Xm(t,i,n),pose:s}}}var H0="../../packages/studio-base/src/panels/ThreeDeeRender/ThreeDeeRender.tsx";const zs=R.ZP.getLogger(H0),Y0={width:"100%",height:"100%",display:"flex",position:"relative"};function uc(s,e,t,i){const[n,r]=(0,T.useState)(()=>s?.[e]??i());return(0,T.useEffect)(()=>{if(!s)return;const a=()=>r(()=>s[e]);return a(),s.addListener(t,a),()=>{s.removeListener(t,a)}},[s,t,e]),n}function Z0(s){const{context:e,interfaceMode:t,onDownloadImage:i}=s,{initialState:n,saveState:r}=e,[a,o]=(0,T.useState)(()=>{const C=n,W=(0,Z.merge)((0,Z.cloneDeep)(Bt.d),C?.cameraState),j=(0,Z.merge)((0,Z.cloneDeep)(Cl.B),C?.publish),se=C?.transforms??{};return{cameraState:W,followMode:C?.followMode??"follow-pose",followTf:C?.followTf,scene:C?.scene??{},transforms:se,topics:C?.topics??{},layers:C?.layers??{},publish:j,imageMode:C?.imageMode??{}}}),l=(0,Ze.Z)(a),{cameraState:d}=a,h=a.scene.backgroundColor,[f,p]=(0,T.useState)(null),[u,m]=(0,T.useState)(void 0),g=(0,T.useRef)(void 0);(0,T.useEffect)(()=>{const C=f?new Wg(f,l.current,t):void 0;return m(C),g.current=C,()=>{g.current?.dispose(),g.current=void 0}},[f,l,a.scene.transforms?.enablePreloading,t]);const[y,S]=(0,T.useState)(),[D,A]=(0,T.useState)(),[M,I]=(0,T.useState)(),[P,O]=(0,T.useState)(),[z,Y]=(0,T.useState)(),[oe,rt]=(0,T.useState)(),[Qe,yt]=(0,T.useState)(!1),[$e,ks]=(0,T.useState)(),[Ni,mc]=(0,T.useState)(void 0),We=(0,T.useRef)({needsRender:!1}),[Oi,js]=(0,T.useState)(),ts=uc(u,"schemaHandlers","schemaHandlersChanged",()=>new Map),Fi=uc(u,"topicHandlers","topicHandlersChanged",()=>new Map);(0,T.useEffect)(()=>{const C=()=>{if(u){const W=u.getCameraState();if(!W)return;u.setCameraState(W),o(j=>({...j,cameraState:W})),a.scene.syncCamera===!0&&e.setSharedPanelState({cameraState:W,followMode:a.followMode,followTf:u.followFrameId})}};return u?.addListener("cameraMove",C),()=>void u?.removeListener("cameraMove",C)},[a.scene.syncCamera,a.followMode,e,u?.followFrameId,u]);const _t=(0,T.useCallback)(C=>Ee.unstable_batchedUpdates(()=>{if(u){const W=u.getCameraState();u.settings.handleAction(C);const j=u.getCameraState();j!==W&&a.scene.syncCamera===!0&&e.setSharedPanelState({cameraState:j,followMode:a.followMode,followTf:u.followFrameId})}}),[a.followMode,a.scene.syncCamera,e,u]),[Ui,q]=(0,T.useState)(void 0),vt=(0,T.useCallback)(C=>q(C.settings.tree()),[]);qt("settingsTreeChange",vt,u);const ge=(0,T.useCallback)(C=>o(C.config),[]);qt("configChange",ge,u);const Pt=(0,T.useCallback)(C=>{const W=C?.renderable.idFromMessage(),j=C?.renderable.selectedIdVariable();j&&e.setVariable(j,W),e.setVariable(le,W)},[e]);qt("selectedRenderable",Pt,u),(0,T.useEffect)(()=>{e.updatePanelSettingsEditor({actionHandler:_t,enableFilter:!0,nodes:Ui??{}})},[_t,e,Ui]),(0,T.useEffect)(()=>{u&&(u.config=a,We.current.needsRender=!0)},[a,u]),(0,T.useEffect)(()=>{u&&(u.setTopics(M),We.current.needsRender=!0)},[M,u]),(0,T.useEffect)(()=>{u&&(u.ros=e.dataSourceProfile==="ros1"||e.dataSourceProfile==="ros2")},[e.dataSourceProfile,u]);const zi=(0,xe.y1)(C=>r(C),1e3,{leading:!1,trailing:!0,maxWait:1e3});(0,T.useEffect)(()=>zi(a),[a,zi]),(0,T.useEffect)(()=>{t==="image"&&e.setDefaultPanelTitle(a.imageMode.imageTopic)},[t,e,a.imageMode.imageTopic]),(0,T.useLayoutEffect)(()=>{e.onRender=(C,W)=>{Ee.unstable_batchedUpdates(()=>{if(C.currentTime&&rt(C.currentTime),C.didSeek===!0&&yt(!0),js(()=>W),S(C.colorScheme),C.appSettings){const j=C.appSettings.get(K.o.TIMEZONE);A(typeof j=="string"?j:void 0)}I(C.topics),ks(C.sharedPanelState),O(C.parameters),fc(C.currentFrame),Y(C.currentFrame),fc(C.allFrames),mc(C.allFrames)})},e.watch("allFrames"),e.watch("colorScheme"),e.watch("currentFrame"),e.watch("currentTime"),e.watch("didSeek"),e.watch("parameters"),e.watch("sharedPanelState"),e.watch("topics"),e.watch("appSettings"),e.subscribeAppSettings([K.o.TIMEZONE])},[e,u]);const[ss,ki]=(0,T.useState)(void 0);(0,T.useEffect)(()=>{if(!M){ki(void 0);return}const C=[],W=(j,se,xt)=>{let Me=se.shouldSubscribe?.(j.name);Me==null&&(a.topics[j.name]?.visible===!0||a.imageMode.annotations?.[j.name]?.visible===!0?Me=!0:Me=!1),Me&&C.push({topic:j.name,preload:se.preload,convertTo:xt})};for(const j of M){for(const se of Fi.get(j.name)??[])W(j,se);for(const se of ts.get(j.schemaName)??[])W(j,se);for(const se of j.convertibleTo??[])for(const xt of ts.get(se)??[])W(j,xt,se)}C.sort((j,se)=>j.topic.localeCompare(se.topic)),ki(j=>(0,Z.isEqual)(j,C)?j:C)},[M,a.topics,a.imageMode.calibrationTopic,a.imageMode.imageTopic,ts,Fi,a.imageMode.annotations]),(0,T.useEffect)(()=>{ss&&(zs.debug(`Subscribing to [${ss.map(C=>JSON.stringify(C)).join(", ")}]`),e.subscribe(ss))},[e,ss]),(0,T.useEffect)(()=>{u&&u.setParameters(P)},[P,u]),(0,T.useEffect)(()=>{const C=oe?(0,w.toNanoSec)(oe):void 0;if(!u||C==null)return;const W=u.currentTime;u.setCurrentTime(C),Qe&&(u.handleSeek(W),yt(!1))},[oe,u,Qe]),(0,T.useEffect)(()=>{y&&u&&(u.setColorScheme(y,h),We.current.needsRender=!0)},[h,y,u]),(0,T.useEffect)(()=>{if(!u||!oe)return;u.handleAllFramesMessages(Ni)&&(We.current.needsRender=!0)},[u,oe,Ni]),(0,T.useEffect)(()=>{if(!(!u||!z)){for(const C of z)u.addMessageEvent(C);We.current.needsRender=!0}},[z,u]),(0,T.useEffect)(()=>{(0,Z.isEqual)(d,u?.getCameraState())||(u?.setCameraState(d),We.current.needsRender=!0)},[d,u]),(0,T.useEffect)(()=>{if(!(!u||$e==null||a.scene.syncCamera!==!0))if($e.followMode!==a.followMode)u.setCameraSyncError(`Follow mode must be ${$e.followMode} to sync camera.`);else if($e.followTf!==u.followFrameId)u.setCameraSyncError(`Display frame must be ${$e.followTf} to sync camera.`);else{const C=$e.cameraState;u.setCameraState(C),We.current.needsRender=!0,o(W=>({...W,cameraState:C})),u.setCameraSyncError(void 0)}},[a.scene.syncCamera,a.followMode,u,u?.followFrameId,$e]),(0,T.useEffect)(()=>{u&&We.current.needsRender&&(u.animationFrame(),We.current.needsRender=!1)}),(0,T.useEffect)(()=>{Oi?.()},[Oi]);const zr=(0,T.useCallback)(C=>e.layout.addPanel(C),[e.layout]),[Rt,ze]=(0,T.useState)(!1);(0,T.useEffect)(()=>{const C=()=>ze(!0),W=()=>ze(!1);return u?.measurementTool.addEventListener("foxglove.measure-start",C),u?.measurementTool.addEventListener("foxglove.measure-end",W),()=>{u?.measurementTool.removeEventListener("foxglove.measure-start",C),u?.measurementTool.removeEventListener("foxglove.measure-end",W)}},[u?.measurementTool]);const St=(0,T.useCallback)(()=>{Rt?u?.measurementTool.stopMeasuring():(u?.measurementTool.startMeasuring(),u?.publishClickTool.stop())},[Rt,u]),[Tt,Lt]=(0,T.useState)(!1);(0,T.useEffect)(()=>{u?.publishClickTool.publishClickType!==a.publish.type&&(u?.publishClickTool.setPublishClickType(a.publish.type),u?.publishClickTool.stop())},[a.publish.type,u]);const te=(0,T.useMemo)(()=>({goal:a.publish.poseTopic,point:a.publish.pointTopic,pose:a.publish.poseEstimateTopic}),[a.publish.poseTopic,a.publish.pointTopic,a.publish.poseEstimateTopic]);(0,T.useEffect)(()=>{const C=e.dataSourceProfile==="ros2"?B0:G0;return e.advertise?.(te.goal,"geometry_msgs/PoseStamped",{datatypes:C}),e.advertise?.(te.point,"geometry_msgs/PointStamped",{datatypes:C}),e.advertise?.(te.pose,"geometry_msgs/PoseWithCovarianceStamped",{datatypes:C}),()=>{e.unadvertise?.(te.goal),e.unadvertise?.(te.point),e.unadvertise?.(te.pose)}},[te,e,e.dataSourceProfile]);const Nt=(0,Ze.Z)(a.publish);(0,T.useEffect)(()=>{const C=()=>Lt(!0),W=se=>{const xt=u?.followFrameId;if(xt==null){zs.warn("Unable to publish, renderFrameId is not set");return}if(!e.publish){zs.error("Data source does not support publishing");return}if(e.dataSourceProfile!=="ros1"&&e.dataSourceProfile!=="ros2"){zs.warn("Publishing is only supported in ros1 and ros2");return}try{switch(se.publishClickType){case"point":{const Me=V0(se.point,xt);e.publish(te.point,Me);break}case"pose":{const Me=$0(se.pose,xt);e.publish(te.goal,Me);break}case"pose_estimate":{const Me=W0(se.pose,xt,Nt.current.poseEstimateXDeviation,Nt.current.poseEstimateYDeviation,Nt.current.poseEstimateThetaDeviation);e.publish(te.pose,Me);break}}}catch(Me){zs.info(Me)}},j=()=>Lt(!1);return u?.publishClickTool.addEventListener("foxglove.publish-start",C),u?.publishClickTool.addEventListener("foxglove.publish-submit",W),u?.publishClickTool.addEventListener("foxglove.publish-end",j),()=>{u?.publishClickTool.removeEventListener("foxglove.publish-start",C),u?.publishClickTool.removeEventListener("foxglove.publish-submit",W),u?.publishClickTool.removeEventListener("foxglove.publish-end",j)}},[e,Nt,te,u?.followFrameId,u?.publishClickTool]);const gc=(0,T.useCallback)(()=>{Tt?u?.publishClickTool.stop():(u?.publishClickTool.start(),u?.measurementTool.stopMeasuring())},[Tt,u]),is=(0,T.useCallback)(()=>{const C=u?.getCameraState()?.perspective??!1;_t({action:"update",payload:{input:"boolean",path:["cameraState","perspective"],value:!C}})},[_t,u]),ns=(0,T.useCallback)(C=>{C.key==="3"&&(is(),C.stopPropagation(),C.preventDefault())},[is]),kr=e.dataSourceProfile==="ros1"||e.dataSourceProfile==="ros2",ji=e.publish!=null&&kr;return(0,v.jsx)(wt.Z,{isDark:y==="dark",children:(0,v.jsxs)("div",{style:Y0,onKeyDown:ns,children:[(0,v.jsx)("canvas",{ref:p,style:{position:"absolute",top:0,left:0,...(Rt||Tt)&&{cursor:"crosshair"}}}),(0,v.jsx)(nc.Provider,{value:u,children:(0,v.jsx)(j0,{interfaceMode:t,canvas:f,addPanel:zr,enableStats:a.scene.enableStats??!1,perspective:a.cameraState.perspective,onTogglePerspective:is,measureActive:Rt,onClickMeasure:St,canPublish:ji,publishActive:Tt,onClickPublish:gc,publishClickType:u?.publishClickTool.publishClickType??"point",onChangePublishClickType:C=>{u?.publishClickTool.setPublishClickType(C),u?.publishClickTool.start()},timezone:D,onDownloadImage:i})})]})})}function fc(s){if(s)for(const e of s){const t=e.message;"toJSON"in t&&(e.message=t.toJSON())}}function K0(s,e,t,i,n){return Ee.render((0,v.jsx)(T.StrictMode,{children:(0,v.jsx)(be.o,{onError:s,children:(0,v.jsx)(ot,{forwardedAnalytics:e,children:(0,v.jsx)(Z0,{context:n,interfaceMode:t,onDownloadImage:i})})})}),n.panelElement),()=>{Ee.unmountComponentAtNode(n.panelElement)}}function pc(s,e){const t=(0,qe.iY)(),i=at(),n=(0,T.useMemo)(()=>K0.bind(void 0,t,i,s,e.onDownloadImage),[t,i,s,e.onDownloadImage]);return(0,v.jsx)(Ye._,{config:e.config,highestSupportedConfigVersion:1,saveConfig:e.saveConfig,initPanel:n})}const X0=(0,ve.Z)(Object.assign(pc.bind(void 0,"3d"),{panelType:"3D",defaultConfig:{}})),J0=(0,ve.Z)(Object.assign(pc.bind(void 0,"image"),{panelType:"Image",defaultConfig:{}}))},84803:(Gs,He,b)=>{b.d(He,{D:()=>Ye});var v=b(52322),T=b(1547),Ee=b(8220),qe=b(60351),be=b(85091),ye=b(96995);const et=new ye._fP,Ae=new ye.USm;function at(xe,R,w,K){return et.set(xe,R,w,K),Ae.setFromQuaternion(et,"XYZ"),[ye.M8C.radToDeg(Ae.x),ye.M8C.radToDeg(Ae.y),ye.M8C.radToDeg(Ae.z)]}const ot=20*365*24*60*60,ve=["string","number","bigint","boolean"];function Ye(xe,R,w,K,wt,c){if(typeof R!="object"||R==null)return(0,v.jsxs)("span",{children:[w," ",K]});const le=Object.keys(R);if(le.length===2){const{sec:B,nsec:x}=R;if(typeof B=="number"&&typeof x=="number")return B<ot?(0,be.LU)({sec:B,nsec:x}):(0,v.jsx)("span",{children:(0,be.WU)({sec:B,nsec:x},c)})}if(le.length===2){const{x:B,y:x}=R;if(typeof B=="number"&&typeof x=="number"){const ke=Math.sqrt(B*B+x*x);return(0,v.jsxs)("span",{children:["norm = ",ke.toFixed(2)," ",Z(B,x)]})}const{key:X,value:V}=R;if(X!=null&&V!=null&&ve.includes(typeof X)&&ve.includes(typeof V))return`${X}: ${V}`}else if(le.length===3){const{x:B,y:x,z:X}=R;if(typeof B=="number"&&typeof x=="number"&&typeof X=="number"){const V=Math.sqrt(B*B+x*x+X*X);return(0,v.jsxs)("span",{children:["norm = ",V.toFixed(2)," ",X===0?Z(B,x):void 0]})}}else if(le.length===4){const{x:B,y:x,z:X,w:V}=R;if(typeof B=="number"&&typeof x=="number"&&typeof X=="number"&&typeof V=="number"){const[Ot,rs,It]=at(B,x,X,V);return(0,v.jsxs)("span",{children:["rpy = [",Ze(Ot),", ",Ze(rs),", ",Ze(It),"]"]})}const{r:ke,g:E,b:ce,a:Ke}=R;if(typeof ke=="number"&&typeof E=="number"&&typeof ce=="number"&&typeof Ke=="number")return(0,v.jsx)("span",{children:(0,T.Z)({r:ke*255,g:E*255,b:ce*255,a:Ke}).toHex8String()})}const F=(0,Ee.Z)(le,B=>{const x=R[B];if((0,qe.Q)(B)&&(x==null||ve.includes(typeof x)))return`${B}: ${x}`}).join(", ");return(0,v.jsxs)("span",{children:[w," ",F.length>0?F:K]})}function Z(xe,R){if(!(xe===0&&R===0))return(0,v.jsx)("span",{style:{transform:`rotate(${Math.atan2(-R,xe)}rad)`,display:"inline-block"},children:"\u2192"})}function Ze(xe,R=2){return Number(xe.toFixed(R))}}}]);

//# sourceMappingURL=studio-6291.js.map